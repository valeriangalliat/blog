<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Docker build secrets!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github.css">
  <link rel="stylesheet" href="/css/main-20220325.css">
  <link rel="icon" href="/favicon.ico" data-emoji="üèï">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="Docker build secrets!">
  <meta property="og:description" content="For a long time now, I‚Äôve been wanting to have a way when building Docker containers, to use external secrets, e.g. API or SSH keys, during build time, that wouldn‚Äôt be exposed in any layer.">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
      <li><a href="https://photography.codejam.info/">Photography</a></li>
    </ul>
    <ul class="social">
      <li>
        <a href="https://www.youtube.com/FunkyVal">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>YouTube</title>
            <use href="/img/icons/414-youtube.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://www.instagram.com/funkyval_/">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>Instagram</title>
            <use href="/img/icons/403-instagram.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://twitter.com/valeriangalliat">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>Twitter</title>
            <use href="/img/icons/407-twitter.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://github.com/valeriangalliat">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>GitHub</title>
            <use href="/img/icons/433-github.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://ko-fi.com/funkyval">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>Buy me a coffee!</title>
            <use href="/img/icons/219-heart.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="/feed.xml">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>RSS</title>
            <use href="/img/icons/412-rss.svg#icon"></use>
          </svg>
        </a>
      </li>
    </ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>Docker build secrets!</h1>
<p class="date">April 27, 2021</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>For a long time now, I‚Äôve been wanting to have a way when building
Docker containers, to use external secrets, e.g. API or SSH keys, during
build time, that wouldn‚Äôt be exposed in any layer.</p>
<p>It was possible to use build arguments and multi-stage builds to make
sure that we don‚Äôt include the secrets in the final image that we push,
but it would still leave the secrets in the intermediate layers on my
local machine. Not ideal.</p>
<h2 id="docker-18-09-and-buildkit" tabindex="-1"><a class="header-anchor" href="#docker-18-09-and-buildkit"><span>Docker 18.09 and BuildKit</span></a></h2>
<p>With BuildKit, Docker added first-class support for secrets, which makes
this even cleaner and more secure.</p>
<p>Here‚Äôs for example how to mount a <code>.netrc</code> file at build time to give
pip access to your credentials for some hosts. In your Dockerfile:</p>
<pre><code class="hljs language-dockerfile"><span class="hljs-keyword">RUN</span><span class="bash"> --mount=<span class="hljs-built_in">type</span>=secret,id=netrc,dst=/path/to/.netrc pip install -r requirements.txt</span>
</code></pre>
<p>And to build it:</p>
<pre><code class="hljs language-sh">DOCKER_BUILDKIT=1 docker build --secret id=netrc,src=~/.netrc .
</code></pre>
<h2 id="ssh-support" tabindex="-1"><a class="header-anchor" href="#ssh-support"><span>SSH support</span></a></h2>
<p>BuildKit also have a flag to forward SSH connections using <code>ssh-agent</code>.
From their <a href="https://docs.docker.com/develop/develop-images/build_enhancements/">documentation</a>:</p>
<pre><code class="hljs language-dockerfile"><span class="hljs-keyword">FROM</span> alpine

<span class="hljs-keyword">RUN</span><span class="bash"> apk add --no-cache openssh-client git</span>
<span class="hljs-keyword">RUN</span><span class="bash"> mkdir -m 700 ~/.ssh &amp;&amp; ssh-keyscan github.com &gt; ~/.ssh/known_hosts</span>

<span class="hljs-comment"># Clone private repository</span>
<span class="hljs-keyword">RUN</span><span class="bash"> --mount=<span class="hljs-built_in">type</span>=ssh git <span class="hljs-built_in">clone</span> git@github.com:myorg/myproject.git</span>
</code></pre>
<p>To build it (ignore the first two lines if you already have <code>ssh-agent</code>
running and configured):</p>
<pre><code class="hljs language-sh"><span class="hljs-comment"># Start `ssh-agent` and set environment variables</span>
<span class="hljs-built_in">eval</span> $(ssh-agent)

<span class="hljs-comment"># Add your default SSH keys to the agent</span>
ssh-add

DOCKER_BUILDKIT=1 docker build --ssh default .
</code></pre>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
  </div>
  <footer>
    <p>
      Made with üß° by <a href="/val.html">Val</a> in Montreal.<br>
      Generated from a <a href="https://github.com/valeriangalliat/blog/tree/master/2021/04/docker-build-secrets.md">public repository</a>. Feel free to <a href="/val.html#contact">contact me</a>, I'd love to hear your thoughts!
    </p>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20210719.js"></script>
</body>
</html>
