<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>gocryptfs on macOS (with and without macFUSE)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>document.documentElement.classList.add(localStorage.theme || ((matchMedia && matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light'))</script>
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github-20220617.css">
  <link rel="stylesheet" href="/css/main-20230317.css">
  <link rel="icon" href="/favicon.ico" data-emoji="üèïÔ∏è">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="gocryptfs on macOS (with and without macFUSE)">
  <meta property="og:description" content="Doing FUSE stuff on a Mac. In this post I‚Äôm taking gocryptfs as an example because that‚Äôs what I use to encrypt my offsite backups, but this can probably be applied to doing anything FUSE-related on a Mac.">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
      <li><a href="https://photography.codejam.info/">Photography</a></li>
      <li class="pull"><button title="Toggle theme" class="change-color-theme">üåù</button></li>
    </ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>gocryptfs on macOS (with and without macFUSE)</h1>
<p class="tagline">Doing FUSE stuff on a Mac</p>
<p class="date">April 26, 2024</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>In this post I‚Äôm taking gocryptfs as an example because that‚Äôs what I
use to encrypt my <a href="offsite-backup-sync.html">offsite backups</a>, but this
can probably be applied to doing anything FUSE-related on a Mac.</p>
<h2 id="gocryptfs-on-macos" tabindex="-1"><a class="header-anchor" href="#gocryptfs-on-macos"><span>gocryptfs on macOS</span></a></h2>
<p>Using gocryptfs on macOS requires <a href="https://osxfuse.github.io/">macFUSE</a>.
macFUSE (previously known as <a href="https://web.archive.org/web/20130710220229/https://osxfuse.github.io/">OSXFUSE</a>
(previously known as <a href="https://web.archive.org/web/20130704045540/http://code.google.com/p/macfuse/">MacFUSE</a>
lol TIL)) is an awesome project that allows to mount
<a href="https://www.kernel.org/doc/html/next/filesystems/fuse.html">FUSE</a>
filesystems on macOS.</p>
<p>All it takes is:</p>
<pre><code class="hljs language-sh">brew --cask install macfuse

<span class="hljs-comment"># Do the reboot dance to allow the kernel extension (see &quot;concerns&quot; below)</span>

brew install gromgit/fuse/gocryptfs-mac

<span class="hljs-comment"># Not needed but might as well have SSHFS around too</span>
brew install gromgit/fuse/sshfs-mac
</code></pre>
<div class="note">
<p><strong>Note:</strong> gocryptfs and SSHFS can‚Äôt be installed from Homebrew‚Äôs main
registry anymore <a href="https://github.com/Homebrew/homebrew-core/pull/74812#issuecomment-826895526">because</a>
they depend on macFUSE, which is not open-source.</p>
<p>This is why the above command installs from <a href="https://github.com/gromgit/homebrew-fuse">this repository</a>,
which hosts the Homebrew formulas that depend on FUSE that were dropped
from Homebrew.</p>
</div>
<h2 id="concerns-about-macfuse" tabindex="-1"><a class="header-anchor" href="#concerns-about-macfuse"><span>Concerns about macFUSE</span></a></h2>
<p>Sadly, macFUSE is not open-source. But at least it‚Äôs been updated
regularly for over 10 years, and keeps supporting the latest macOS
versions, so as long as this stays the case, I don‚Äôt mind using it.</p>
<p>That said, depending on macFUSE for a process as critical as my <a href="offsite-backup-sync.html">offsite backups</a>
means that I will need to wait for it to support a new macOS version
before I deem to upgrade. Because it‚Äôs a kernel extension, it‚Äôs
not necessarily as easy to upgrade as other userland programs.</p>
<p>The other problem is that Apple <a href="https://developer.apple.com/support/kernel-extensions/">deprecated kernel extensions</a>
in 2020 with macOS Catalina (although they still work up to this date on
later versions). This is tracked in <a href="https://github.com/osxfuse/osxfuse/issues/987">this macFUSE issue</a>
but at the time of writing, Apple doesn‚Äôt provide APIs that allow to
implement macFUSE outside of a (now deprecated) kernel extension.</p>
<p>On top of that, going with the deprecation, Apple made it
<a href="https://github.com/osxfuse/osxfuse/issues/814">annoying</a>
to install kernel extensions on ARM Macs, by having to reboot in
recovery and enabling ‚Äúreduced security‚Äù mode (which is now <a href="https://support.apple.com/en-ca/guide/security/sec7d92dc49f/web">required</a>
for kernel extensions).</p>
<p>While macFUSE works now, and have been working for many years after the
original deprecation of kernel extensions by Apple, its future is still
somewhat unclear.</p>
<p>In future versions, will macOS drop some the APIs that macFUSE depend
on, without providing viable alternatives? Or will they entirely block
kernel extensions? And in the event they do provide viable alternative
APIs, how long will it take for macFUSE to support that new version?</p>
<p>Otherwise, is any of the alternatives like
<a href="https://www.fuse-t.org/">FUSE-T</a> gonna be solid enough by then? And
more importantly, is gocryptfs gonna work with those alternatives?
Actually, it won‚Äôt, because right now
<a href="https://github.com/hanwen/go-fuse">go-fuse</a> depends explicitly on
macFUSE.</p>
<p>So, I wasn‚Äôt ready to commit to that setup without having a somewhat
viable fallback.</p>
<h2 id="gocryptfs-on-macos-without-macfuse" tabindex="-1"><a class="header-anchor" href="#gocryptfs-on-macos-without-macfuse"><span>gocryptfs on macOS without macFUSE</span></a></h2>
<p>While FUSE, as we saw, is a bit of a challenge on macOS, it‚Äôs perfectly
fine on Linux. gocryptfs and FUSE on Linux are not going anywhere.</p>
<p>Now, <a href="https://github.com/lima-vm/lima">Lima</a> is a pretty sweet way to
run a Linux VM on macOS. Similarly to <a href="https://learn.microsoft.com/en-us/windows/wsl/install">WSL</a>
on Windows, Lima can drop you in a Linux shell on your Mac, with
transparent access to your files.</p>
<p>This means you can easily install gocryptfs in that Lima environment,
and use it there. Assuming I want to get an encrypted mount of my home
directory (<code>~</code>):</p>
<pre><code class="hljs language-sh">brew install lima

limactl start

lima <span class="hljs-built_in">sudo</span> apt install gocryptfs

<span class="hljs-comment"># Init in a temp dir because Lima can&#x27;t write to the host filesystem</span>
lima gocryptfs -init -reverse /tmp/lima

<span class="hljs-comment"># From the host move the config file in the right place</span>
<span class="hljs-built_in">mv</span> /tmp/lima/.gocryptfs.reverse.conf ~

lima <span class="hljs-built_in">mkdir</span> -p /tmp/encrypted
lima gocryptfs -reverse ~ /tmp/encrypted
lima rsync --archive /tmp/encrypted <span class="hljs-string">&quot;<span class="hljs-variable">$DESTINATION</span>&quot;</span>
</code></pre>
<div class="note">
<p><strong>Note:</strong> Depending on how you connect to <code>$DESTINATION</code>, you may want to
copy/link your SSH config and keys inside the Linux home of the VM
user. For example:</p>
<pre><code class="hljs language-sh">lima <span class="hljs-built_in">ln</span> -s ~/.ssh/{config,id_ed25519*} <span class="hljs-string">&quot;<span class="hljs-subst">$(lima sh -c &#x27;echo $HOME&#x27;)</span>/.ssh&quot;</span>
</code></pre>
</div>
<h2 id="decrypting-remote-files" tabindex="-1"><a class="header-anchor" href="#decrypting-remote-files"><span>Decrypting remote files</span></a></h2>
<p>We can as easily do the opposite: use SSHFS to mount the remote
encrypted directory locally, then use gocryptfs to decrypt it and access
the files transparently.</p>
<pre><code class="hljs language-sh">lima <span class="hljs-built_in">sudo</span> apt install sshfs

lima <span class="hljs-built_in">mkdir</span> -p /tmp/encrypted /tmp/decrypted
sshfs -o idmap=user <span class="hljs-string">&quot;<span class="hljs-variable">$DESTINATION</span>&quot;</span> /tmp/encrypted
gocryptfs /tmp/encrypted /tmp/decrypted
</code></pre>
<p>At that point we can browse the decrypted tree from the Lima shell,
however we can‚Äôt access it from the host.</p>
<h2 id="accessing-decrypted-files-from-the-host" tabindex="-1"><a class="header-anchor" href="#accessing-decrypted-files-from-the-host"><span>Accessing decrypted files from the host</span></a></h2>
<p>If Lima can access files from the host, why can‚Äôt the host access files
from Lima?</p>
<p>Well, it comes down again to the ability to us FUSE. In order to access
host files, Lima starts a SSHFS server on the macOS host, and then
mounts it via SSHFS (FUSE) inside the Linux VM. That‚Äôs fine, because
Linux have absolutely no issue with FUSE stuff.</p>
<p>The other way around however, we would need FUSE on the macOS side in
order to mount a SSHFS server running inside the VM. No bueno, because
we‚Äôre doing all this jazz to avoid dealing with FUSE on macOS in the
first place. üò¨</p>
<p>So if we‚Äôre not gonna use FUSE, we need to fallback to another protocol
that‚Äôs better supported on Mac, like WebDAV.</p>
<p>The best way I‚Äôve found to do that is actually to use a simple, plain Go
WebDAV server such as <a href="https://taoofmac.com/space/til/2022/11/25/2200">this one</a>.</p>
<p>Just point the server to serve the decrypted mount point from earlier.</p>
<p>We also need to edit the Lima VM config in
<code>~/.lima/default/lima.yaml</code> to forward the port the WebDAV server is
listening on, so we can access it from the host system, such as:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">portForwards:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">guestPort:</span> <span class="hljs-number">1234</span>
</code></pre>
<p>Then on the macOS side we can do:</p>
<pre><code class="hljs language-sh"><span class="hljs-built_in">mkdir</span> -p mountpoint
mount_webdav http://localhost:1234 mountpoint
</code></pre>
<p>Before going with the custom Go solution, I‚Äôve tried
<a href="https://wiki.gnome.org/phodav">ph·ªüdav</a>, because unlike most WebDAV
servers, it doesn‚Äôt require any kind of hairy configuration, and can be
spawned in a ad hoc way that just works. But the performance wasn‚Äôt as
good as the Go version. I‚Äôve also tried NFS, but that was much even
slower.</p>
<p>That said, don‚Äôt get your hopes too high. Even with the Go version, the
performance wasn‚Äôt super fast, but I believe it‚Äôs mainly because of
being run over SSHFS, so your mileage may vary depending on the network
bandwidth you have with your offsite server. But as a fallback, I‚Äôll
call it good enough anyway.</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1784030029187588316">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
  </div>
  <footer>
    <div class="footer-inner">
      <figure>
        <a href="/val.html">
          <img alt="The author (Val) in front of a mountain" src="/img/profile.jpg">
        </a>
      </figure>
      <div class="footer-content">
        <p>
          Made with üß° by <a href="/val.html">Val</a>.
          Generated from a <abbr title="Pull requests welcome!"><a href="https://github.com/valeriangalliat/blog/tree/master/2024/04/gocryptfs-macos-macfuse.md">public repository</a></abbr>.
        </p>
        <ul class="social">
          <li>
            <a href="https://twitter.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Twitter</title>
                <use href="/img/icons/407-twitter.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://github.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>GitHub</title>
                <use href="/img/icons/433-github.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.instagram.com/funkyval_/">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Instagram</title>
                <use href="/img/icons/403-instagram.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.youtube.com/@FunkyVal">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>YouTube</title>
                <use href="/img/icons/414-youtube.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://ko-fi.com/funkyval">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Buy me a coffee!</title>
                <use href="/img/icons/219-heart.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="/feed.xml">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>RSS</title>
                <use href="/img/icons/412-rss.svg#icon"></use>
              </svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20230317.js"></script>
</body>
</html>
