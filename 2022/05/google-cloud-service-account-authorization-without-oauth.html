<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Google Cloud service account authorization without OAuth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github.css">
  <link rel="stylesheet" href="/css/main-20220617.css">
  <link rel="icon" href="/favicon.ico" data-emoji="üèïÔ∏è">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="Google Cloud service account authorization without OAuth">
  <meta property="og:description" content="Google‚Äôs OAuth documentation goes in length about how to sign a JWT with the service account key in order to call their token endpoint https://oauth2.googleapis.com/token to get an OAuth token so that you can call actual Google Cloud APIs, only to mention at the end in a small addendum that you can skip the token endpoint step altogether and just use your self-signed JWT directly. üò¨">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
    </ul>
    <ul class="social">
  <li>
    <a href="https://twitter.com/valeriangalliat">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>Twitter</title>
        <use href="/img/icons/407-twitter.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://github.com/valeriangalliat">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>GitHub</title>
        <use href="/img/icons/433-github.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://www.instagram.com/funkyval_/">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>Instagram</title>
        <use href="/img/icons/403-instagram.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://www.youtube.com/FunkyVal">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>YouTube</title>
        <use href="/img/icons/414-youtube.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://ko-fi.com/funkyval">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>Buy me a coffee!</title>
        <use href="/img/icons/219-heart.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="/feed.xml">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>RSS</title>
        <use href="/img/icons/412-rss.svg#icon"></use>
      </svg>
    </a>
  </li>
</ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>Google Cloud service account authorization without OAuth</h1>
<p class="date">May 7, 2022</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>Google‚Äôs <a href="https://developers.google.com/identity/protocols/oauth2/service-account">OAuth documentation</a>
goes in length about how to sign a JWT with the service account key in
order to call their token endpoint <code>https://oauth2.googleapis.com/token</code>
to get an OAuth token so that you can call actual Google Cloud APIs,
only to mention at the end in a small addendum that you can skip the
token endpoint step altogether and
<a href="https://developers.google.com/identity/protocols/oauth2/service-account#jwt-auth">just use your self-signed JWT directly</a>. üò¨</p>
<p>In this blog post we‚Äôll develop this last step, because it‚Äôs so much
more convenient, reliable, and there‚Äôs a few undocumented things about
it.</p>
<h2 id="the-normal-flow" tabindex="-1"><a class="header-anchor" href="#the-normal-flow"><span>The normal flow</span></a></h2>
<p>But before, let‚Äôs quickly look at the ‚Äúnormal‚Äù recommended OAuth flow.
Borrowing this diagram from their documentation:</p>
<figure class="center">
  <img alt="JWT OAuth flow" src="../../img/2022/05/jwt-flow.png">
</figure>
<ol>
<li>Create a self-signed JWT using your service account key.</li>
<li>Use it to authenticate to <code>https://oauth2.googleapis.com/token</code> to
request an OAuth token.</li>
<li>Use that OAuth token to call Google APIs.</li>
</ol>
<p>This is not bad, but having to go over the network to authenticate and
refresh tokens before they expire adds extra overhead, delay, error
handling, retry logic, and in general just an extra few things that can
go wrong.</p>
<p>And I don‚Äôt like things out of my control that can go wrong.</p>
<h2 id="the-better-flow" tabindex="-1"><a class="header-anchor" href="#the-better-flow"><span>The better flow</span></a></h2>
<p>On the other hand, the poorly documented ‚Äúservice account authorization
without OAuth method‚Äù consists in:</p>
<ol>
<li>Create a self-signed JWT using your service account key.</li>
<li>Use it directly to call Google APIs.</li>
<li>Profit.</li>
</ol>
<p>Same amount of steps, but you can imagine why I like this method better.</p>
<h2 id="implementing-direct-authorization-from-scratch" tabindex="-1"><a class="header-anchor" href="#implementing-direct-authorization-from-scratch"><span>Implementing direct authorization from scratch</span></a></h2>
<p>Typically, the Google Cloud SDK in the language of your choice takes
care of this for you (and most of the time uses this self-signed method,
because they too realize it‚Äôs a much superior method). But in some
cases, you have to reimplement the authorization step, for example
<a href="https://hookdeck.com/blog/post/how-to-call-google-cloud-apis-from-cloudflare-workers#the-problem-with-cloudflare-workers">when running on Cloudflare Workers</a>,
which I wrote about in details in that article.</p>
<p>As of today their <a href="https://developers.google.com/identity/protocols/oauth2/service-account#jwt-auth">documentation</a>
mentions the JWT must have the following header and payload:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;alg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;RS256&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;typ&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;JWT&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;kid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;SERVICE_ACCOUNT_PRIVATE_KEY_ID&quot;</span>
<span class="hljs-punctuation">}</span>
.
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;iss&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;SERVICE_ACCOUNT_EMAIL&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;sub&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;SERVICE_ACCOUNT_EMAIL&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;aud&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://SERVICE.googleapis.com/&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;iat&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1511900000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;exp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1511903600</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Where the parts in all caps are variables to adapt to your situation.
Then the JWT can be signed with RS256 (RSA signature with SHA-256), and
used in a <code>Authorization: Bearer</code> header against the service you
included in the <code>aud</code> field.</p>
<p>And it does work most of the time (again checkout <a href="https://hookdeck.com/blog/post/how-to-call-google-cloud-apis-from-cloudflare-workers#the-problem-with-cloudflare-workers">my post</a>
to see the vanilla JavaScript implementation), but in some cases like
with Google Cloud Storage, <a href="https://stackoverflow.com/q/63222450">it breaks down</a>.</p>
<h2 id="when-it-breaks-down" tabindex="-1"><a class="header-anchor" href="#when-it-breaks-down"><span>When it breaks down</span></a></h2>
<p>With Google Cloud Storage, when using the documented method with a <code>aud</code>
field of <code>https://storage.googleapis.com/</code>, we sadly <a href="https://stackoverflow.com/q/63222450">get an error</a>
when calling the API, e.g. when trying to get a file:</p>
<pre><code class="hljs language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Error</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Code</span>&gt;</span>AuthenticationRequired<span class="hljs-tag">&lt;/<span class="hljs-name">Code</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Message</span>&gt;</span>Authentication required.<span class="hljs-tag">&lt;/<span class="hljs-name">Message</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Error</span>&gt;</span>
</code></pre>
<p>Or when trying to upload a file:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">401</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Invalid Credentials&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;errors&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Invalid Credentials&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;domain&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;global&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;authError&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;locationType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;header&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;location&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Authorization&quot;</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>But the exact same code to generate a JWT works seamlessly with Pub/Sub,
Datastore and other services! Why is that? Should we fall back to using
the OAuth endpoint for those problematic services?</p>
<p>No.</p>
<h2 id="the-new-undocumented-jwt-payload" tabindex="-1"><a class="header-anchor" href="#the-new-undocumented-jwt-payload"><span>The new, undocumented JWT payload</span></a></h2>
<p>It turns out that you need to remove the <code>aud</code> field and replace it with
a <code>scope</code> field, akin to the one we would pass to the main OAuth token
endpoint.</p>
<p>In the case of Google Cloud Storage, our JWT payload would now look like
this:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;iss&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;SERVICE_ACCOUNT_EMAIL&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;sub&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;SERVICE_ACCOUNT_EMAIL&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;scope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://www.googleapis.com/auth/iam https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/devstorage.full_control&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;iat&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1511900000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;exp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1511903600</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>You can find the <a href="https://developers.google.com/identity/protocols/oauth2/scopes">full list of OAuth scopes</a>
in the Google Cloud OAuth 2.0 documentation.</p>
<p>It turns out the <code>scope</code> field is also accepted by Pub/Sub and other
services that were working fine with <code>aud</code>, so we can just make our
generic implementation use the <code>scope</code> field and be done with it. Sweet!</p>
<h2 id="bonus-how-did-i-find-out-about-that" tabindex="-1"><a class="header-anchor" href="#bonus-how-did-i-find-out-about-that"><span>Bonus: how did I find out about that?</span></a></h2>
<p>This is the story about <a href="https://stackoverflow.com/a/71834557">this answer</a>
I posted on the Stack Overflow question I linked earlier.</p>
<p>First, I dug in the <a href="https://github.com/googleapis/google-cloud-node">Google Cloud Node.js SDK</a>
to see how they implemented the service account authentication.</p>
<p>It turns out they do use the <a href="https://github.com/googleapis/google-auth-library-nodejs/blob/b48254490768799e465a8fa4aae13296ddceea53/src/auth/jwtclient.ts#L126">self-signed JWT method</a>,
in their shared auth library, but it‚Äôs conditional to a variable
<code>useJWTAccessWithScope</code> being set to <code>true</code> by the client SDK. For
example, this is <a href="https://github.com/googleapis/nodejs-pubsub/blob/ba333c2284b802cdd43df7568b553b2a90dba8d8/src/v1/publisher_client.ts#L139">where Pub/Sub sets it</a>,
and this is
<a href="https://github.com/googleapis/nodejs-storage/search?q=useJWTAccessWithScope">where GCS <strong>doesn‚Äôt</strong> set it</a>
(as of today).</p>
<p>But what if we force this variable to <code>true</code>?</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Storage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@google-cloud/storage&#x27;</span>

<span class="hljs-keyword">const</span> storage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Storage</span>()

storage.<span class="hljs-property">authClient</span>.<span class="hljs-property">useJWTAccessWithScope</span> = <span class="hljs-literal">true</span>

<span class="hljs-keyword">const</span> file = <span class="hljs-keyword">await</span> storage.<span class="hljs-title function_">bucket</span>(<span class="hljs-string">&#x27;bucket&#x27;</span>).<span class="hljs-title function_">file</span>(<span class="hljs-string">&#x27;file&#x27;</span>).<span class="hljs-title function_">get</span>()
</code></pre>
<p>By running this script with <code>NODE_DEBUG=https</code>, we can see that without
the <code>useJWTAccessWithScope</code> line, the client makes a call to
<code>https://www.googleapis.com/oauth2/v4/token</code> first, then calls
<code>https://storage.googleapis.com/storage/v1/b/bucket/o/file</code>, but with
<code>useJWTAccessWithScope</code>, it skips the first token call (and everything
works still)!</p>
<p>We can also notice that the token from the OAuth token endpoint contains
hundreds of dots (<code>.</code>) at the end, whereas the self-signed token is just
the usual 3 parts Base64URL JWT. Not an useful information, but
interesting.</p>
<p>Either way, this proved that despite not working with the method in the
documentation, self-signed authentication was effectively supported by
Google Cloud Storage. So how did that SDK-generated token differ? The
easiest is to copy that token from our <code>NODE_DEBUG=https</code> output and
parse the payload segment:</p>
<pre><code class="hljs language-sh">pbpaste | <span class="hljs-built_in">cut</span> -d. -f2 | <span class="hljs-built_in">base64</span> --decode
</code></pre>
<p>Or in Node.js:</p>
<pre><code class="hljs language-js"><span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(token.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;.&#x27;</span>)[<span class="hljs-number">1</span>], <span class="hljs-string">&#x27;base64&#x27;</span>).<span class="hljs-title function_">toString</span>()
</code></pre>
<p>There we see they use a <code>scope</code> parameter as opposed to <code>aud</code>.</p>
<p>We can track it down to the <a href="https://github.com/googleapis/google-auth-library-nodejs/blob/b48254490768799e465a8fa4aae13296ddceea53/src/auth/jwtclient.ts#L191">code of the authentication library</a>,
and we can also see where the Google Cloud Storage client
<a href="https://github.com/googleapis/nodejs-storage/blob/c3240060b3dc905013ab6fa219e975631b41f5c4/src/storage.ts#L653">defines the necessary OAuth scopes</a>.</p>
<h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion"><span>Conclusion</span></a></h2>
<p>With some investigation in the Google Cloud Node.js SDK source code and
some <code>NODE_DEBUG=https</code> debugging, we can dissect their implementation
of the self-signed service account authentication, and replicate it on
our side.</p>
<p>This enables us to use this simpler and superior mechanism that Google
uses internally, instead of the method that‚Äôs widely documented of
calling their OAuth endpoint.</p>
<p>I hope that you learnt something thanks to this article, and that it
helps you build great things! And as always, keep hacking! üöÄ</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1523114655698554880">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
  </div>
  <footer>
    <figure>
      <a href="/val.html">
        <img alt="The author (Val) looking at a beer glass shining in the beautiful sun" src="/img/profile.jpg">
      </a>
    </figure>
    <div class="footer-content">
      <p>
        Made with üß° by <a href="/val.html">Val</a>.
        Generated from a <abbr title="Pull requests welcome!"><a href="https://github.com/valeriangalliat/blog/tree/master/2022/05/google-cloud-service-account-authorization-without-oauth.md">public repository</a></abbr>.
      </p>
      <ul class="social">
  <li>
    <a href="https://twitter.com/valeriangalliat">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>Twitter</title>
        <use href="/img/icons/407-twitter.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://github.com/valeriangalliat">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>GitHub</title>
        <use href="/img/icons/433-github.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://www.instagram.com/funkyval_/">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>Instagram</title>
        <use href="/img/icons/403-instagram.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://www.youtube.com/FunkyVal">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>YouTube</title>
        <use href="/img/icons/414-youtube.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://ko-fi.com/funkyval">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>Buy me a coffee!</title>
        <use href="/img/icons/219-heart.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="/feed.xml">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>RSS</title>
        <use href="/img/icons/412-rss.svg#icon"></use>
      </svg>
    </a>
  </li>
</ul>
    </div>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20210719.js"></script>
</body>
</html>
