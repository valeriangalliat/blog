<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Archiving Google Photos offline to free up space</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>document.documentElement.classList.add(localStorage.theme || ((matchMedia && matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light'))</script>
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github-20220617.css">
  <link rel="stylesheet" href="/css/main-20230317.css">
  <link rel="icon" href="/favicon.ico" data-emoji="üèïÔ∏è">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="Archiving Google Photos offline to free up space">
  <meta property="og:description" content="Note: updated on December 30, 2023.">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
      <li><a href="https://photography.codejam.info/">Photography</a></li>
      <li class="pull"><button title="Toggle theme" class="change-color-theme">üåù</button></li>
    </ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>Archiving Google Photos offline to free up space</h1>
<p class="date">April 2, 2023</p>
      </div>
    </div>
  </header>
  <div class="content">
<div class="note">
<p><strong>Note:</strong> updated on December 30, 2023.</p>
</div>
<p>If you backup your phone photos to Google Photos automatically, and you
don‚Äôt pay for some kind of Google One subscription, you‚Äôll run sooner or
later into the 15 GB storage limit of your Google account.</p>
<p>15 GB is not a lot, especially when you consider than my Pixel 6a takes
pictures that are easily 3 to 5 MB each. üò¨</p>
<p>To be fair, if you want convenience and you value your time, Google
One‚Äôs $20/year for 100 GB is a pretty damn good deal. Same goes for the
higher options with more storage if you need.</p>
<p>But if you don‚Äôt like recurring bills like me, and you find it overkill
to keep that many old photos in the cloud, read on.</p>
<h2 id="my-protocol-for-archiving-photos-away-from-google" tabindex="-1"><a class="header-anchor" href="#my-protocol-for-archiving-photos-away-from-google"><span>My protocol for archiving photos away from Google</span></a></h2>
<p>In order to save space, I‚Äôll periodically archive my old photos outside
of Google Photos.</p>
<p>This protocol is designed to archive photos <em>from the phone</em> that are
<em>backed up</em> to Google Photos, but preserving the phone‚Äôs original
arborescence. Google Photos doesn‚Äôt have the path information, only the
filename, so backing up <em>from Google Photos</em> directly would not work for
this use case.</p>
<p>The downside is that this doesn‚Äôt cover the case where you have photos
in Google Photos that are <em>not</em> on your phone.</p>
<p>Also it‚Äôs designed for a single phone backing up to a Google Photos
account that‚Äôs used <em>solely</em> for that device. Multiple devices sharing
the same Google Photos is not supported.</p>
<p>With that said, here‚Äôs how I do it.</p>
<h3 id="1-sync-phone-to-computer" tabindex="-1"><a class="header-anchor" href="#1-sync-phone-to-computer"><span>1. Sync phone to computer</span></a></h3>
<p>First, I use <a href="https://syncthing.net/">Syncthing</a> to sync the contents of
my phone to a hard drive connected to my computer.</p>
<p>I configure Syncthing as ‚Äúsend only‚Äù on my phone, and ‚Äúreceive only‚Äù on
my computer, and I configure it to sync the root directory of my phone
(which can be tricky, <a href="syncthing-root-directory.html">but possible</a>).</p>
<p><strong>After the sync is complete, I turn off Syncthing from my computer, to
make sure no incremental updates will happen during the archive
process.</strong></p>
<h3 id="2-copy-synced-folder-to-archive" tabindex="-1"><a class="header-anchor" href="#2-copy-synced-folder-to-archive"><span>2. Copy synced folder to archive</span></a></h3>
<p>For this example, let‚Äôs assume I synced my phone to a
<code>/Volumes/Syncthing/Phone</code> directory, and I want to archive my old
photos in <code>/Volumes/Archive/Phone</code>.</p>
<p>I‚Äôll run the following command to copy the phone contents to my archive
directory (but copying from Finder also works):</p>
<pre><code class="hljs language-sh"><span class="hljs-built_in">cp</span> -a /Volumes/Syncthing/Phone/ /Volumes/Archive/Phone/
</code></pre>
<div class="note">
<p><strong>Note:</strong> the reason I copy the whole phone contents is because I want
to catch <em>all</em> photos and videos that are backed up to Google Photos.
Typically, apps like Messenger, Whats App, Signal, etc. all store photos
in different directories, so syncing only <code>DCIM/Camera</code> would not be
enough.</p>
</div>
<p>If the target directory already exists, this will append new files to it
(and overwrite them if a file already exists there)!</p>
<p>Also if the directory already exists, the trailing slashes are
important.</p>
<div class="note">
<p><strong>Note:</strong> if both directories are on the same filesystem, and you‚Äôre not
appending to an existing archive, you may use <code>mv</code> instead, but then
make sure to recreate the Syncthing directory and put back its
<code>.stfolder</code> (required for Syncthing to recognize it) and <code>.stignore</code> if
you have one!</p>
</div>
<h3 id="3-double-check-i-m-not-missing-anything" tabindex="-1"><a class="header-anchor" href="#3-double-check-i-m-not-missing-anything"><span>3. Double check I‚Äôm not missing anything</span></a></h3>
<p>If you have photos that are <em>only</em> on Google Photos but not stored on
your phone storage, the previous step didn‚Äôt archive them. You need to
make sure to download them from Google Photos in the first place.</p>
<p>Because there‚Äôs no way from Google Photos to find all photos that are
not locally saved to a specific device (other than going through them
one by one), that‚Äôs where I <a href="#bonus-script-to-list-all-your-google-photos-using-the-api">use the Google Photos API</a>
to make sure I‚Äôm not missing anything.</p>
<p>This will get technical, so if you don‚Äôt care about this part, feel free
to skip to <a href="#4-delete-everything-from-google-photos">the next step</a>.</p>
<p>First, we need a Google OAuth token with access to Google Photos. We‚Äôll
reuse <a href="../../2021/02/google-oauth-from-cli-application.html#update-local-server-redirect">my script from this other article</a>
for this, just replacing the scope with <code>https://www.googleapis.com/auth/photoslibrary.readonly</code>.
Put it in a <code>token.mjs</code> file and run it with <code>node token.mjs</code>, this will
go through the OAuth process and after you complete the authentication,
will log the access token that we‚Äôll use in the next script.</p>
<p>The following script can go in <code>photos.mjs</code> and be run with <code>node photos.mjs</code>, reusing the token from the previous step.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;node:fs/promises&#x27;</span>

<span class="hljs-keyword">const</span> accessToken = <span class="hljs-string">&#x27;YOUR_ACCESS_TOKEN&#x27;</span>

<span class="hljs-keyword">let</span> pageToken = <span class="hljs-string">&#x27;&#x27;</span>
<span class="hljs-keyword">let</span> pages = []

<span class="hljs-keyword">do</span> {
  <span class="hljs-keyword">const</span> url = <span class="hljs-string">&#x27;https://photoslibrary.googleapis.com/v1/mediaItems?pageSize=100&amp;pageToken=&#x27;</span> + <span class="hljs-built_in">encodeURIComponent</span>(pageToken)

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(url)

  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, {
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">&#x27;Authorization&#x27;</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${accessToken}</span>`</span>
    }
  })

  <span class="hljs-keyword">const</span> json = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()

  pages.<span class="hljs-title function_">push</span>(json)

  pageToken = json.<span class="hljs-property">nextPageToken</span>
} <span class="hljs-keyword">while</span> (pageToken)

<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">&#x27;pages.json&#x27;</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(pages, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>))
</code></pre>
<p>This will fetch all pages from the Google Photos API and dump them in a
<code>pages.json</code> file.</p>
<p>From there, I like to use <a href="https://jqlang.github.io/jq/">jq</a> to extract
the filenames:</p>
<pre><code class="hljs language-sh"><span class="hljs-built_in">cat</span> pages.json | jq -r <span class="hljs-string">&#x27;.[].mediaItems[].filename&#x27;</span> &gt; filenames
</code></pre>
<p>Then I use the following script to check that each filename is indeed
present in my archive:</p>
<pre><code class="hljs language-sh"><span class="hljs-built_in">cat</span> filenames | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> file; <span class="hljs-keyword">do</span> find /Volumes/Archive/Phone -name <span class="hljs-string">&quot;<span class="hljs-variable">$file</span>&quot;</span> | grep -q . || <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Missing <span class="hljs-variable">$file</span>&quot;</span>; <span class="hljs-keyword">done</span>
</code></pre>
<p>This will print the name of every file that‚Äôs on Google Photos and not
part of the backup. If any, you can find more details in <code>pages.json</code>
including a Google Photos link to find out what photo it is that needs
to be downloaded.</p>
<p>Once everything is confirmed backed up, we can continue.</p>
<h3 id="4-delete-everything-from-google-photos" tabindex="-1"><a class="header-anchor" href="#4-delete-everything-from-google-photos"><span>4. Delete everything from Google Photos</span></a></h3>
<p>Not necessarily everything, but well, everything you want to delete to
free up space.</p>
<p>You can do it from your phone, or from Google Photos on your computer,
or on the web, although in my experience, <strong>I would recommend doing it
from the phone</strong>.</p>
<p>When deleting <em>a lot</em> of photos from the web version, this tends to
confuse the phone‚Äôs syncing algorithm and I‚Äôve ended up with a bunch of
photos being re-uploaded and somehow duplicated and it was kind of a
mess to clean up.</p>
<p>It tends to <em>just work</em> when deleting from the phone. The only downside
is that the app doesn‚Äôt make it easy to select a whole bunch of photos
at once, I just have to hold my thumb for a minute with the super slow
scroll until everything is selected.</p>
<div class="note">
<p><strong>Note:</strong> at that point I like to take note of how many photos I
deleted, so I can double check the number in a later step.</p>
</div>
<h3 id="5-sync-phone-to-computer-again" tabindex="-1"><a class="header-anchor" href="#5-sync-phone-to-computer-again"><span>5. Sync phone to computer again</span></a></h3>
<p>Again with Syncthing in my case, I do a sync following the deletion.</p>
<div class="note">
<p><strong>Note:</strong> you may want to exclude <code>.trashed-*</code> files in your
<code>.stignore</code>, otherwise the photos you deleted will still be synced while
they‚Äôre in the trash.</p>
</div>
<p>Now in our example, <code>/Volumes/Syncthing/Phone</code> contains just the
photos we decided to keep around in Google Photos, while
<code>/Volumes/Archive/Phone</code> contains <em>all</em> the photos (also including the
ones we kept around).</p>
<p>On top of that, both directories contains <em>all other files</em> from the
phone, that are not managed by Google Photos.</p>
<div class="note">
<p><strong>Note:</strong> this process is not very efficient if you have a lot of files
that are not photos and videos, e.g. music and downloads. You may want
to ignore those directories in the earlier steps to avoid copying them
around unnecessarily!</p>
</div>
<h3 id="6-remove-the-overlap" tabindex="-1"><a class="header-anchor" href="#6-remove-the-overlap"><span>6. Remove the overlap</span></a></h3>
<p>To avoid that duplication, we can remove all files from the archive that
are still in the Syncthing directory. That is, all the photos/videos we
kept, as well as all the files in the phone storage that are not managed
by Google Photos.</p>
<pre><code class="hljs language-sh">(<span class="hljs-built_in">cd</span> /Volumes/Syncthing/Phone &amp;&amp; find . -<span class="hljs-built_in">type</span> f) | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> f; <span class="hljs-keyword">do</span> <span class="hljs-built_in">rm</span> -v <span class="hljs-string">&quot;/Volumes/Archive/Phone/<span class="hljs-variable">$f</span>&quot;</span>; <span class="hljs-keyword">done</span>
</code></pre>
<p>Now, the archive directory only contains what we removed from Google
Photos (and from the phone), but there‚Äôs no duplicates!</p>
<p>Bonus: we can remove all empty directories with:</p>
<pre><code class="hljs language-sh">find /Volumes/Archive/Phone -<span class="hljs-built_in">type</span> d -empty -delete
</code></pre>
<p>At that point, I also count the number of files from the backup and
makes sure it matches the number of files I deleted from Google Photos
earlier:</p>
<pre><code class="hljs language-sh">find /Volumes/Archive/Phone -<span class="hljs-built_in">type</span> f | grep -v DS_Store | <span class="hljs-built_in">wc</span> -l
</code></pre>
<h3 id="7-profit" tabindex="-1"><a class="header-anchor" href="#7-profit"><span>7. Profit!</span></a></h3>
<p>You can now enjoy all the space you freed up by archiving your photos
and videos away from Google Photos!</p>
<p>Repeat every time you‚Äôre close to running out of storage. üòâ</p>
<h2 id="what-about-motion-photos" tabindex="-1"><a class="header-anchor" href="#what-about-motion-photos"><span>What about motion photos?</span></a></h2>
<p>Google‚Äôs motion photos are the equivalent of Apple‚Äôs live photos: a
photo that also contains a short video of the ‚Äúmoment‚Äù it was captured.</p>
<p>What happens to those during our archival process? Well, it‚Äôs
complicated.</p>
<p>In short, don‚Äôt worry, they‚Äôre backed up and the little video that goes
with the motion photo is not going to be lost, but you won‚Äôt be able to
watch the ‚Äúlive‚Äù part anymore, you‚Äôll only see the still picture.</p>
<p>The reason is that Google stores the MP4 video part at the end of the JPEG
file. This doesn‚Äôt prevent displaying the image, but there‚Äôs currently
no photo viewer other than Google Photos that knows to extract that MP4
section following the JPEG data, and display it properly.</p>
<p>So if you want to see the live part of a motion photo, you‚Äôll have to
re-import it to Google Photos.</p>
<p>Alternatively, you can extract the MP4 part of the motion photo to a
different file, which you can do by using a script like
<a href="https://mjanja.ch/2021/10/stripping-embedded-mp4s-out-of-android-12-motion-photos/">detailed in this post</a>.</p>
<div class="note">
<p><strong>Note:</strong> if you use the script from the above post on macOS, you‚Äôll
need GNU <code>grep</code> in order find the byte offset of the MP4 header.</p>
<p>This means you‚Äôll have to <code>brew install coreutils</code> and replace <code>grep</code> by
<code>ggrep</code> in the script for it to work.</p>
</div>
<h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion"><span>Conclusion</span></a></h2>
<p>Archiving photos away from Google Photos is not trivial, but possible.</p>
<p>If you care about not losing any of your photos, I recommend double
checking at every step that you‚Äôre not accidentally forgetting any file.</p>
<p>When done well, this allows to periodically free up some space from your
Google account without actually having to get rid of your photos and
videos! They‚Äôll still be available on your archive hard drive if you
want to. Your old photos are not as handy as if they were in the cloud,
but you know you can access them if needed.</p>
<p>Overall, you‚Äôre probably better off just paying Google to increase your
storage, but if you‚Äôre really motivated, I hope you can find inspiration
in the process I described in this post.</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
  </div>
  <footer>
    <div class="footer-inner">
      <figure>
        <a href="/val.html">
          <img alt="The author (Val) in front of a mountain" src="/img/profile.jpg">
        </a>
      </figure>
      <div class="footer-content">
        <p>
          Made with üß° by <a href="/val.html">Val</a>.
          Generated from a <abbr title="Pull requests welcome!"><a href="https://github.com/valeriangalliat/blog/tree/master/2023/04/archiving-google-photos.md">public repository</a></abbr>.
        </p>
        <ul class="social">
          <li>
            <a href="https://twitter.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Twitter</title>
                <use href="/img/icons/407-twitter.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://github.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>GitHub</title>
                <use href="/img/icons/433-github.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.instagram.com/funkyval_/">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Instagram</title>
                <use href="/img/icons/403-instagram.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.youtube.com/@FunkyVal">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>YouTube</title>
                <use href="/img/icons/414-youtube.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://ko-fi.com/funkyval">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Buy me a coffee!</title>
                <use href="/img/icons/219-heart.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="/feed.xml">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>RSS</title>
                <use href="/img/icons/412-rss.svg#icon"></use>
              </svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20230317.js"></script>
</body>
</html>
