<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>How can rsync work on a host without shell access? ü§î</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>document.documentElement.classList.add(localStorage.theme || ((matchMedia && matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light'))</script>
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github-20220617.css">
  <link rel="stylesheet" href="/css/main-20260125.css">
  <link rel="icon" href="/favicon.ico" data-emoji="üèïÔ∏è">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="How can rsync work on a host without shell access? ü§î">
  <meta property="og:description" content="And SFTP, SCP, BorgBackup‚Ä¶. It does not. But sometimes, hosting providers use a trick so that you don‚Äôt have shell access but rsync thinks it does‚Ä¶">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
      <li><a href="/now.html">Now</a></li>
      <li class="pull"><button title="Toggle theme" class="change-color-theme">üåù</button></li>
    </ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>How can rsync work on a host without shell access? ü§î</h1>
<p class="tagline">And SFTP, SCP, BorgBackup‚Ä¶</p>
<p class="date">April 9, 2022</p>
      </div>
    </div>
  </header>
  <div class="content">
<h2 id="tldr" tabindex="-1"><a class="header-anchor" href="#tldr"><span>TLDR</span></a></h2>
<p>It does not. But sometimes, hosting providers use a trick so that you
don‚Äôt have shell access but rsync thinks it does‚Ä¶</p>
<h2 id="the-case-of-a-file-hosting-provider" tabindex="-1"><a class="header-anchor" href="#the-case-of-a-file-hosting-provider"><span>The case of a file hosting provider</span></a></h2>
<p>I use a <a href="https://www.hetzner.com/storage/storage-box?country=us">Hetzner storage box</a>
for my backups. They have a super competitive offer that can get you 1
TB of storage for ‚Ç¨2.90 per month, or 5 TB for ‚Ç¨9.90!</p>
<p>On their <a href="https://www.hetzner.com/storage/storage-box?country=us">features page</a>
they list they support a number of protocols, including <strong>SFTP, SCP,
BorgBackup, and rsync over SSH</strong>.</p>
<p>All of those protocols happen over a SSH connection, yet Hetzner doesn‚Äôt
give us SSH access to the box:</p>
<pre><code class="hljs language-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh u123456@u123456.your-storagebox.de</span>
PTY allocation request failed on channel 0

+-------------------------------------------------------------------------------+
| Your authentication works but we do not support interactive logins.           |
| For more information on how to access your Storage Box please check our Docs: |
| https://docs.hetzner.com/robot/storage-box/access/access-ssh-rsync-borg       |
+-------------------------------------------------------------------------------+

Connection to u123456.your-storagebox.de closed.
</code></pre>
<p>Let‚Äôs assume the following <code>~/.ssh/config</code> for further commands for
simplicity, so that we can just <code>ssh hetzner</code>:</p>
<pre><code class="hljs">Host hetzner
    HostName u123456.your-storagebox.de
    User u123456
</code></pre>
<p>While interactive SSH is not allowed, we can try running a command
directly:</p>
<pre><code class="hljs language-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh hetzner <span class="hljs-built_in">ls</span></span>
file1
file2
file3
</code></pre>
<p>Interesting. What other commands do they allow?</p>
<pre><code class="hljs language-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh hetzner <span class="hljs-built_in">cp</span> file3 file4</span>
Command not found
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">ssh hetzner <span class="hljs-built_in">cat</span> file1</span>
Command not found
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">ssh hetzner <span class="hljs-built_in">du</span> -sh .</span>
Command not found
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">ssh hetzner <span class="hljs-built_in">pwd</span></span>
Command not found
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">ssh hetzner <span class="hljs-built_in">whoami</span></span>
Command not found
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">ssh hetzner <span class="hljs-built_in">rm</span> file3</span>
Command not found
</code></pre>
<p>Well, not much. So by what sorcery are SFTP, SCP, BorgBackup and rsync
able to work over this connection?</p>
<pre><code class="hljs language-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sftp hetzner</span>
Connected to hetzner.
<span class="hljs-meta prompt_">sftp&gt;</span><span class="language-bash">
</span><span class="hljs-meta prompt_">
$ </span><span class="language-bash">scp file4 hetzner:</span>
file4
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">rsync -v file5 hetnzer:</span>
file5
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">ssh hetzner <span class="hljs-built_in">ls</span> file4 file5</span>
file4
file5
</code></pre>
<p>To understand, let‚Äôs dig in the internals of SFTP, SCP, BorgBackup and
rsync.</p>
<h2 id="sftp" tabindex="-1"><a class="header-anchor" href="#sftp"><span>SFTP</span></a></h2>
<p>SFTP is actually the odd one in the room. But we‚Äôll start with it
nevertheless.</p>
<p>Using <code>-v</code> to enable debug output gives one interesting line near the
end of the log:</p>
<pre><code class="hljs language-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sftp -v hetzner</span>
...
debug1: Sending subsystem: sftp
...
</code></pre>
<p>It looks like we‚Äôre dealing with something called SSH subsystems. A good
way to find more about them is to search
<a href="https://serverfault.com/questions/354615/allow-sftp-but-disallow-ssh">how to enable SFTP but disallow SSH</a>.</p>
<p>Here, we meet our SSH server subsystem again, which is typically
configured on the server as:</p>
<pre><code class="hljs language-conf">Subsystem sftp internal-sftp
</code></pre>
<p>From the <a href="https://linux.die.net/man/1/ssh"><code>ssh(1)</code></a> man page, we can
see that <code>ssh -s</code> allows to pass a subsystem where we would normally
pass a command, e.g:</p>
<pre><code class="hljs language-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh hetzner -s sftp</span>
</code></pre>
<p>This command hangs, meanings the remote server is waiting for SFTP
commands. Since it‚Äôs a binary protocol, we won‚Äôt be able to play with it
directly, but this is the connection over which a normal SFTP client
would be able to do its magic. Sweet!</p>
<h2 id="scp" tabindex="-1"><a class="header-anchor" href="#scp"><span>SCP</span></a></h2>
<p>Let‚Äôs use the verbose/debug mode trick like we did previously with SFTP:</p>
<pre><code class="hljs language-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">scp -v file4 hetzner:</span>
...
debug1: Sending command: scp -v -t .
...
</code></pre>
<p>Here, the relevant part of the debug output is where <code>scp</code> sends the
remote command <code>scp -v -t .</code>.</p>
<p><code>-v</code> is for the verbose mode we specified, but if we look at the
<a href="https://linux.die.net/man/1/scp"><code>scp(1)</code></a> man page, there‚Äôs nothing
for <code>-t</code>.</p>
<p>We can look at
<a href="https://github.com/openssh/openssh-portable/blob/90452c8b69d065b7c7c285ff78b81418a75bcd76/scp.c#L575">the source code</a>
where they parse the command line arguments:</p>
<pre><code class="hljs language-c"><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;f&#x27;</span>:    <span class="hljs-comment">/* &quot;from&quot; */</span>
    iamremote = <span class="hljs-number">1</span>;
    fflag = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">break</span>;
<span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;t&#x27;</span>:    <span class="hljs-comment">/* &quot;to&quot; */</span>
    iamremote = <span class="hljs-number">1</span>;
    tflag = <span class="hljs-number">1</span>;
</code></pre>
<p>So we learn that <code>-f</code> or <code>-t</code> are used internally to trigger the remote
mode. Because in our case we were sending a file to the remote host, we
entered <code>-t</code> mode, but if we were downloading a file form the host, we
would likely see <code>-f</code>. Let‚Äôs try:</p>
<pre><code class="hljs language-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">scp -v hetzner:file4 .</span>
...
debug1: Sending command: scp -v -f file4
...
</code></pre>
<p>So it‚Äôs through invoking <code>scp</code> on the remote host over SSH that our
local <code>scp</code> is able to transfer files. But how is that possible? We saw
earlier that basically every command but <code>ls</code> was returning ‚Äúcommand not
found‚Äù! And we can confirm <code>scp</code> is not present on the remote host:</p>
<pre><code class="hljs language-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh hetzner scp</span>
Command not found
</code></pre>
<p>Or is it? Let‚Äôs try the full command that <code>scp</code> would normally run on
the remote host‚Ä¶</p>
<pre><code class="hljs language-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh hetzner scp -t .</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh hetzner scp -f file4</span>
</code></pre>
<p>Both those commands hang, meaning that Hetzner actually ran them, and we
now have a communication channel with the remote <code>scp</code> process!</p>
<p>So Hetzner disallowed us to run <code>scp</code> directly on the remote host, but
they whitelisted the specific arguments that <code>scp</code> would internally pass
to start the remote process. Smart.</p>
<h2 id="borgbackup" tabindex="-1"><a class="header-anchor" href="#borgbackup"><span>BorgBackup</span></a></h2>
<p>Now we know the pattern, it‚Äôs easy to confirm that they do the same
whitelisting for BorgBackup. We can see that <a href="https://borgbackup.readthedocs.io/en/stable/usage/serve.html"><code>borg serve</code></a>
is used to start the remote process.</p>
<pre><code class="hljs language-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh hetzner borg</span>
Command not found
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">ssh hetzner borg --<span class="hljs-built_in">help</span></span>
Command not found
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">ssh hetzner borg serve</span>
</code></pre>
<p>The last command hangs, and again we exposed the way Borg internally
opens a communication channel with a Borg implementation on the remote
server!</p>
<h2 id="rsync" tabindex="-1"><a class="header-anchor" href="#rsync"><span>rsync</span></a></h2>
<p>One more time, we leverage the verbose mode, this time with <code>-vv</code> to get
extra debug output, to see what rsync does internally:</p>
<pre><code class="hljs language-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">rsync -vv file5 hetzner:</span>
opening connection using: ssh hetzner rsync --server -vve.LsfxCIvu . .  (7 args)
delta-transmission enabled
file5
...
</code></pre>
<p>Sweet. Let‚Äôs try to run this manually:</p>
<pre><code class="hljs language-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh hetzner rsync</span>
Command not found
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">ssh hetzner rsync --<span class="hljs-built_in">help</span></span>
Command not found
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">ssh hetzner rsync --server -vve.LsfxCIvu . .</span>
</code></pre>
<p>And again, Hetzner allowed the last command and we have an open
communication channel with the remote rsync process!</p>
<h3 id="digging-deeper-just-for-fun" tabindex="-1"><a class="header-anchor" href="#digging-deeper-just-for-fun"><span>Digging deeper just for fun</span></a></h3>
<p>If you‚Äôre curious, there‚Äôs <a href="https://serverfault.com/questions/793669/what-is-the-rsync-option-logdtprze-ilsf-for/1096808">a Server Fault question</a>
about the meaning of the <code>-vve.LsfxCIvu</code> part.</p>
<p>The answers there were a pretty good start, but there was something
fishy and unexplained about the <code>.</code> in the middle, and I wasn‚Äôt quite
satisfied. So <a href="https://serverfault.com/a/1096808">I dug I bit more</a>.</p>
<p>In the case of <code>-vve.LsfxCIvu</code>, it‚Äôs actually equivalent to <code>-v -v -e '.LsfxCIvu'</code>,
because of the way <code>popt(3)</code>'s <code>POPT_ARG_STRING</code> parses command line
options (the library used by rsync to parse options), which is quite a
common behavior for Unix commands short options.</p>
<p>The trick is that <code>-e</code> is interpreted differently when we‚Äôre in
<code>--server</code> mode, in a way that‚Äôs not related to the <code>-e</code> client option
from the man page, that is normally the short version of <code>--rsh</code>,
allowing to specify the remote shell to use.</p>
<p>Setting <code>-e</code> or <code>--rsh</code> will have the options parser populate the
<code>shell_cmd</code> variable, but <a href="https://github.com/WayneD/rsync/blob/13c4019e94015b234697c75d9d3624862e962d3c/compat.c#L160">they hijack it in server mode</a>
to populate a <code>client_info</code> variable instead, which is used
<a href="https://github.com/WayneD/rsync/blob/13c4019e94015b234697c75d9d3624862e962d3c/compat.c#L134">differently</a>,
to define a number of internal protocol compatibility options.</p>
<p>We can look at <a href="https://github.com/WayneD/rsync/blob/f44e76b65c5819edb1a5b2fbbe732d5d214b35de/options.c#L2951">the code that creates the value for the <code>-e</code> option</a>
to get an idea of what those options do. In my case:</p>
<ul>
<li><code>L</code>: symlink time-setting support</li>
<li><code>s</code>: symlink iconv translation support</li>
<li><code>f</code>: <code>flist</code> I/O-error safety support</li>
<li><code>x</code>: <code>xattr</code> hardlink optimization not desired</li>
<li><code>C</code>: support checksum seed order fix</li>
<li><code>I</code>: support <code>inplace_partial</code> behavior</li>
<li><code>v</code>: use <code>varint</code> for <code>flist</code> &amp; compat flags; negotiate checksum</li>
<li><code>u</code>: include name of <code>uid 0</code> &amp; <code>gid 0</code> in the <code>id</code> map</li>
</ul>
<p>I didn‚Äôt really need to know that <code>-vve.LsfxCIvu</code> means
<code>-v -v -e '.LsfxCIvu'</code> and not <code>-v -v -e . -L -s -f -x -C -I -v -u</code>? No.
Does this makes my life any better? Not really. But there‚Äôs an invisible
force that pushes me to spend ridiculous amounts of time to make sense
of this kind of things.</p>
<h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion"><span>Conclusion</span></a></h2>
<p>SFTP, SCP, BorgBackup and rsync all work on a client/server model, where
the command is run both on the client <em>and</em> the server, and communicate
together over SSH. It means that the command needs to be installed on
the remote server as well, and allowed to be run over SSH.</p>
<p>rsync and BorgBackup can achieve great performance to synchronize files
on a storage server like Hetzner, because despite not having shell
access on that server, the specific commands used by those tools to
start a remote process are whitelisted.</p>
<p>For other tools like <a href="https://restic.net/">restic</a>, because Hetzner
doesn‚Äôt support their custom server protocol, they are constrained to
use the more generic (and limited) commands of SFTP, which doesn‚Äôt allow
optimal performance.</p>
<p>So if you were wondering how all those tools can run code on your
storage box despite you being denied shell access, now you know!</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Join the discussion on <a href="https://x.com/valeriangalliat/status/1512854917702164494">X</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
  </div>
  <footer>
    <div class="footer-inner">
      <figure>
        <a href="/val.html">
          <img alt="The author (Val) in front of a mountain" src="/img/profile.jpg">
        </a>
      </figure>
      <div class="footer-content">
        <p>
          Made with üß° by <a href="/val.html">Val</a>.
          Generated from a <abbr title="Pull requests welcome!"><a href="https://github.com/valeriangalliat/blog/tree/master/2022/04/rsync-without-shell-access.md">public repository</a></abbr>.
        </p>
        <ul class="social">
          <li>
            <a href="https://x.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 24 24">
                <title>X</title>
                <use href="/img/icons/x.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://github.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 24 24">
                <title>GitHub</title>
                <use href="/img/icons/github.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.instagram.com/funkyval_/">
              <svg width="16" height="16" viewBox="0 0 24 24">
                <title>Instagram</title>
                <use href="/img/icons/instagram.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.youtube.com/@FunkyVal">
              <svg width="16" height="16" viewBox="0 0 24 24">
                <title>YouTube</title>
                <use href="/img/icons/youtube.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://ko-fi.com/funkyval">
              <svg width="16" height="16" viewBox="0 0 24 24">
                <title>Buy me a coffee!</title>
                <use href="/img/icons/kofi.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="/feed.xml">
              <svg width="16" height="16" viewBox="0 0 24 24">
                <title>RSS</title>
                <use href="/img/icons/rss.svg#icon"></use>
              </svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20230317.js"></script>
</body>
</html>
