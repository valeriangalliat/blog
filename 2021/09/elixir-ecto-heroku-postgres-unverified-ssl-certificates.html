<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Elixir, Ecto and Heroku Postgres: unverified SSL certificates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github.css">
  <link rel="stylesheet" href="/css/main-20220617.css">
  <link rel="icon" href="/favicon.ico" data-emoji="üèïÔ∏è">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="Elixir, Ecto and Heroku Postgres: unverified SSL certificates">
  <meta property="og:description" content="Or attempting to trace warnings with Erlang. This one took me a bit of time to sort out so I figured I‚Äôd write a blog post about it in case it can help someone else.">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
    </ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>Elixir, Ecto and Heroku Postgres: unverified SSL certificates</h1>
<p class="tagline">Or attempting to trace warnings with Erlang</p>
<p class="date">September 24, 2021</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>This one took me a bit of time to sort out so I figured I‚Äôd write a blog
post about it in case it can help someone else.</p>
<p>I have a Phoenix Elixir application that I recently deployed on one of
my servers. While it‚Äôs running smooth, I was bugged by the following
warning that was showing only in production when starting the app:</p>
<pre><code class="hljs language-elixir">[warn] <span class="hljs-symbol">Description:</span> <span class="hljs-string">&#x27;Authenticity is not established by certificate path validation&#x27;</span>
     <span class="hljs-symbol">Reason:</span> <span class="hljs-string">&#x27;Option {verify, verify_peer} and cacertfile/cacerts is missing&#x27;</span>
</code></pre>
<p>This message was repeated 10 times during boot. Spoiler, 10 is also my
Ecto <code>:pool_size</code>, but I didn‚Äôt think about that right away.</p>
<p>There was no context around that, and since the app interacts with quite
a few things over SSL, it could have come from a lot of places.</p>
<h2 id="tracing-warnings-in-elixir-investigation-and-delusion" tabindex="-1"><a class="header-anchor" href="#tracing-warnings-in-elixir-investigation-and-delusion"><span>Tracing warnings in Elixir: investigation and delusion</span></a></h2>
<p>My first reflex was to look for something similar to
<a href="https://nodejs.org/api/cli.html#cli_trace_warnings">Node.js‚Äô <code>--trace-warnings</code> option</a>.
This will add a stack trace to all warnings, making it very easy to
track where they‚Äôre from and address them.</p>
<p>Sadly, I couldn‚Äôt find anything similar with Elixir and Erlang. I
resorted to <a href="https://elixirforum.com/t/tracing-runtime-warnings/42576">asking on Elixir Forum</a>,
only to get confirmation that this wasn‚Äôt possible.</p>
<h2 id="compiling-erlang" tabindex="-1"><a class="header-anchor" href="#compiling-erlang"><span>Compiling Erlang?</span></a></h2>
<p><a href="https://github.com/erlang/otp/blob/896510977b6cf1f2f4ac817394f3d5c9061f92cf/lib/ssl/src/ssl.erl#L2833">The line that logged that warning</a>
was easy to find in the Erlang <code>ssl</code> module, but that didn‚Äôt help me
identifying what code path triggers it.</p>
<p>I thought about compiling Erlang with a patch that raises an exception
instead of logging a warning there. While that wouldn‚Äôt be the quickest
solution, it would definitely make it obvious what‚Äôs triggering that
peer validation warning.</p>
<p>What was bugging me was that I was seeing this warning only in
production, not on my development machine. And I didn‚Äôt really like the
idea of compiling my patched Erlang in production to debug in
production‚Ä¶</p>
<div class="note">
<p><strong>Note:</strong> I didn‚Äôt end up compiling Erlang to trace the warning that
way, because I was lucky to find after some trial and error what was
causing it.</p>
<p>That being said, if you run into the same kind of issue and don‚Äôt find
any alternative, this is guaranteed to give you an answer, so it‚Äôs
probably worth the effort at that point!</p>
</div>
<h2 id="going-for-a-walk" tabindex="-1"><a class="header-anchor" href="#going-for-a-walk"><span>Going for a walk</span></a></h2>
<p>I didn‚Äôt actually go for a walk, but that‚Äôs the kind of thoughts that
usually happen when you take a walk, or when you‚Äôre under the shower, so
I would have probably gotten that idea earlier if I did.</p>
<blockquote>
<p>If it‚Äôs happening only in production, it‚Äôs probably coming from one of
the production environment variables!</p>
</blockquote>
<p>For some reason, until then, I was focused on finding if there was
something odd about my Erlang build in production, or the CA
certificates configuration on the server, and while it could have come
from there, environment variables were an easy one to test.</p>
<p>So I configure my local machine with the production environment
variables, and bingo! I can repro the warning.</p>
<p>At that point it becomes very obvious to me that my database connection
is the culprit, because it‚Äôs the only thing in the environment that‚Äôs
related to SSL in a way or another.</p>
<h2 id="heroku-postgres-and-ssl-certificate-verification" tabindex="-1"><a class="header-anchor" href="#heroku-postgres-and-ssl-certificate-verification"><span>Heroku Postgres and SSL certificate verification</span></a></h2>
<p>Now that I found the offender, it‚Äôs easier to look for a specific
solution. The first result on Google for <code>heroku postgres ssl verify</code> is
<a href="https://help.heroku.com/3DELT3RK/why-can-t-my-third-party-utility-connect-to-heroku-postgres-with-ssl">this page on the Heroku support website</a>.</p>
<p>Since for some reason it requires to be logged in with an Heroku account
to view it, I‚Äôll just quote the relevant part here:</p>
<blockquote>
<p>Heroku Postgres does not currently support verifiable certificates.
Our certificates will change when the underlying hardware has issues
and we move your database away from it.</p>
</blockquote>
<p>Sweet. So it‚Äôs actually ‚Äúintended‚Äù that I get a SSL verification warning
when connecting to my Heroku Postgres database over SSL.</p>
<p>But knowing that is not enough for me. Now I identified that this
warning was acceptable and doesn‚Äôt need to be fixed per se, I need to
mute it, so that it doesn‚Äôt adds noise to the logs.</p>
<p><strong>This is particularly important</strong> because otherwise, I would hardly
notice a new SSL verification warning that would appears in another
potentially <strong>more critical part of the codebase</strong>, leaving me with
vulnerabilities.</p>
<h2 id="muting-this-particular-warning" tabindex="-1"><a class="header-anchor" href="#muting-this-particular-warning"><span>Muting this particular warning</span></a></h2>
<p><a href="https://github.com/erlang/otp/blob/896510977b6cf1f2f4ac817394f3d5c9061f92cf/lib/ssl/src/ssl.erl#L2833">As we saw earlier</a>,
for that warning to show up, we need the SSL connection‚Äôs <code>verify</code> to
be set to <code>verify_none</code>, and the <code>ssl_logger</code>'s level to be configured
to show warnings.</p>
<p>The default value of <code>verify</code> in the <code>ssl</code> module <a href="https://github.com/erlang/otp/blob/896510977b6cf1f2f4ac817394f3d5c9061f92cf/lib/ssl/src/ssl_internal.hrl#L195">is indeed <code>verify_none</code></a>,
and Ecto doesn‚Äôt seem to alter it by default. Also the default
<code>log_level</code> of the <code>ssl_logger</code> <a href="https://github.com/erlang/otp/blob/896510977b6cf1f2f4ac817394f3d5c9061f92cf/lib/ssl/src/ssl_internal.hrl#L160">is set to <code>notice</code></a>,
which is why we‚Äôre seeing that warning.</p>
<p>It seems that my only option here is to configure the SSL connection
specifically for my Ecto repository to have a log level of <code>:error</code>:</p>
<pre><code class="hljs language-elixir">config <span class="hljs-symbol">:myapp</span>, <span class="hljs-title class_">MyApp</span>.<span class="hljs-title class_">Repo</span>,
  <span class="hljs-symbol">ssl_opts:</span> [<span class="hljs-symbol">log_level:</span> <span class="hljs-symbol">:error</span>]
</code></pre>
<p>It took more hours than I‚Äôm willing to admit to come up with this patch
that turns out to be trivial. So I‚Äôm trying to feel better about myself
by spending even more hours writing a blog post about it to explain all
the details and subtleties. üòÖ</p>
<p>If you‚Äôre here to try and solve an unverified warning issue, or trace
warnings with Elixir and Erlang in general, I hoped that it was useful
to you. Have a wonderful day!</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1441563191557849090">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
  </div>
  <footer>
    <figure>
      <a href="/val.html">
        <img alt="The author (Val) looking at a beer glass shining in the beautiful sun" src="/img/profile.jpg">
      </a>
    </figure>
    <div class="footer-content">
      <p>
        Made with üß° by <a href="/val.html">Val</a>.
        Generated from a <abbr title="Pull requests welcome!"><a href="https://github.com/valeriangalliat/blog/tree/master/2021/09/elixir-ecto-heroku-postgres-unverified-ssl-certificates.md">public repository</a></abbr>.
      </p>
      <ul class="social">
        <li>
          <a href="https://twitter.com/valeriangalliat">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <title>Twitter</title>
              <use href="/img/icons/407-twitter.svg#icon"></use>
            </svg>
          </a>
        </li>
        <li>
          <a href="https://github.com/valeriangalliat">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <title>GitHub</title>
              <use href="/img/icons/433-github.svg#icon"></use>
            </svg>
          </a>
        </li>
        <li>
          <a href="https://www.instagram.com/funkyval_/">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <title>Instagram</title>
              <use href="/img/icons/403-instagram.svg#icon"></use>
            </svg>
          </a>
        </li>
        <li>
          <a href="https://www.youtube.com/FunkyVal">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <title>YouTube</title>
              <use href="/img/icons/414-youtube.svg#icon"></use>
            </svg>
          </a>
        </li>
        <li>
          <a href="https://ko-fi.com/funkyval">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <title>Buy me a coffee!</title>
              <use href="/img/icons/219-heart.svg#icon"></use>
            </svg>
          </a>
        </li>
        <li>
          <a href="/feed.xml">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <title>RSS</title>
              <use href="/img/icons/412-rss.svg#icon"></use>
            </svg>
          </a>
        </li>
      </ul>
    </div>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20210719.js"></script>
</body>
</html>
