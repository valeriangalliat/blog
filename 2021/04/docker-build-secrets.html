<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Docker build secrets!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github.css">
  <link rel="stylesheet" href="/css/main-20210601.css">
  <link rel="icon" href="data:,">
</head>
<body class="post">
  <header>
    <div class="header-inner">
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/val.html">About</a></li>
          <li><a href="https://photography.codejam.info/">Photography</a></li>
        </ul>
        <ul class="social">
          <li>
            <a href="https://www.youtube.com/FunkyVal">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>YouTube</title>
                <use href="/img/icons/414-youtube.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.instagram.com/funkyval_/">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Instagram</title>
                <use href="/img/icons/403-instagram.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Twitter</title>
                <use href="/img/icons/407-twitter.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://github.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>GitHub</title>
                <use href="/img/icons/433-github.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/in/valeriangalliat/">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>LinkedIn</title>
                <use href="/img/icons/458-linkedin.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://soundcloud.com/funkyval">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>SoundCloud</title>
                <use href="/img/icons/452-soundcloud.svg#icon"></use>
              </svg>
            </a>
          </li>
        </ul>
      </nav>
      <div class="content">
<h1>Docker build secrets!</h1>
<p class="date">April 27, 2021</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>For a long time now, I’ve been wanting to have a way when building
Docker containers, to use external secrets, e.g. API or SSH keys, during
build time, that wouldn’t be exposed in any layer.</p>
<p>It was possible to use build arguments and multi-stage builds to make
sure that we don’t include the secrets in the final image that we push,
but it would still leave the secrets in the intermediate layers on my
local machine. Not ideal.</p>
<h2 id="docker-18-09-and-buildkit"><a class="header-anchor" href="#docker-18-09-and-buildkit">Docker 18.09 and BuildKit</a></h2>
<p>With BuildKit, Docker added first-class support for secrets, which makes
this even cleaner and more secure.</p>
<p>Here’s for example how to mount a <code>.netrc</code> file at build time to give
pip access to your credentials for some hosts. In your Dockerfile:</p>
<pre><code class="hljs language-dockerfile"><span class="hljs-keyword">RUN</span><span class="bash"> --mount=<span class="hljs-built_in">type</span>=secret,id=netrc,dst=/path/to/.netrc pip install -r requirements.txt</span>
</code></pre>
<p>And to build it:</p>
<pre><code class="hljs language-sh">DOCKER_BUILDKIT=1 docker build --secret id=netrc,src=~/.netrc .
</code></pre>
<h2 id="ssh-support"><a class="header-anchor" href="#ssh-support">SSH support</a></h2>
<p>BuildKit also have a flag to forward SSH connections using <code>ssh-agent</code>.
From their <a href="https://docs.docker.com/develop/develop-images/build_enhancements/">documentation</a>:</p>
<pre><code class="hljs language-dockerfile"><span class="hljs-keyword">FROM</span> alpine

<span class="hljs-keyword">RUN</span><span class="bash"> apk add --no-cache openssh-client git</span>
<span class="hljs-keyword">RUN</span><span class="bash"> mkdir -m 700 ~/.ssh &amp;&amp; ssh-keyscan github.com &gt; ~/.ssh/known_hosts</span>

<span class="hljs-comment"># Clone private repository</span>
<span class="hljs-keyword">RUN</span><span class="bash"> --mount=<span class="hljs-built_in">type</span>=ssh git <span class="hljs-built_in">clone</span> git@github.com:myorg/myproject.git</span>
</code></pre>
<p>To build it (ignore the first two lines if you already have <code>ssh-agent</code>
running and configured):</p>
<pre><code class="hljs language-sh"><span class="hljs-comment"># Start `ssh-agent` and set environment variables</span>
<span class="hljs-built_in">eval</span> $(ssh-agent)

<span class="hljs-comment"># Add your default SSH keys to the agent</span>
ssh-add

DOCKER_BUILDKIT=1 docker build --ssh default .
</code></pre>
  </div>
  <footer>
    <p>Generated from a <a href="https://github.com/valeriangalliat/blog/tree/master/2021/04/docker-build-secrets.md">public repository</a>. Feel free to <a href="/val.html#links">contact me</a>, I'd love to hear your thoughts!</p>
  </footer>
  <script src="/js/main.js"></script>
</body>
</html>
