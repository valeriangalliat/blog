<?xml version="1.0" encoding="utf-8" ?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>CodeJam</title>
  <subtitle>Hey, I‚Äôm Val, welcome to my blog!</subtitle>
  <link href="https://www.codejam.info/feed.xml" rel="self" />
  <link href="https://www.codejam.info/" />
  <id>https://www.codejam.info/</id>
  <updated>2024-05-06T00:12:25.926Z</updated>
  <author>
    <name>Val</name>
  </author>
  <entry>
    <title>Using Google Chrome instead of Chromium in Google Cloud Functions</title>
    <link href="https://www.codejam.info/2024/05/google-chrome-cloud-functions.html" />
    <id>https://www.codejam.info/2024/05/google-chrome-cloud-functions.html</id>
    <updated>2024-05-05T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>When using Puppeteer, Playwright and similar, you need to have Chrome
installed. When you‚Äôre running on AWS Lambda or Google Cloud Functions,
it can get tricky.</p>
<p>Google Cloud Functions <em>used to</em> bundle Chromium in their base images,
but it‚Äôs been a few years it‚Äôs no longer the case. That‚Äôs where packages
like <a href="https://github.com/alixaxel/chrome-aws-lambda"><code>chrome-aws-lambda</code></a>
come in handy, by bundling Chromium directly inside a npm package, and
exposing a function that extracts the Chromium binary and returns the
path:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> chromium = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;chrome-aws-lambda&#x27;</span>)

<span class="hljs-keyword">const</span> path = <span class="hljs-keyword">await</span> chromium.<span class="hljs-property">executablePath</span>
</code></pre>
<div class="note">
<p><strong>Note:</strong> unnecessary pedantic detail: the above code doesn‚Äôt look like a function,
but <a href="https://github.com/alixaxel/chrome-aws-lambda/blob/f9d5a9ff0282ef8e172a29d6d077efc468ca3c76/source/index.ts#L147">it is, in fact</a>,
a getter function that returns a promise. üòÑ</p>
</div>
<p>However that‚Äôs Chromium, and you may have reasons to want Google Chrome
instead (mainly, proprietary codecs).</p>
<h2 id="a-totally-unrelated-note-about-aws-lambda" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/google-chrome-cloud-functions.html#a-totally-unrelated-note-about-aws-lambda"><span>A totally unrelated note about AWS Lambda</span></a></h2>
<p>This article is about Google Cloud Functions, but if you‚Äôre on AWS
Lambda, the above option is your best bet. Because of the Lambda total
size limit of 250 MB (all layers combined), it‚Äôs really hard to get a
binary of Chrome that fits in there.</p>
<p>That‚Äôs why <code>chrome-aws-lambda</code> uses <a href="https://github.com/alixaxel/lambdafs">LambdaFS</a>
under the hood, to aggressively compress the Chrome installation with
Brotli and make it fit in that limited space.</p>
<p>But again with that build, you won‚Äôt have proprietary codecs. I tried to
trim down a Chrome Linux build and compress it with the same technique
but never managed to make it fit on AWS Lambda. Recent Chrome versions
are just too big.</p>
<p>There‚Äôs another option, which is to compile Chromium yourself with
proprietary codecs. I never found any prebuilt binaries of Chromium that
include proprietary codecs (maybe because of license issues
redistributing them üôÉ) so you‚Äôre on your own here.</p>
<p><a href="https://www.remotion.dev/">Remotion</a> successfully does that for
<a href="https://www.remotion.dev/docs/lambda">Remotion Lambda</a>.
Here‚Äôs <a href="https://github.com/remotion-dev/chrome-build-instructions">their instructions</a>
to compile Chromium with proprietary codecs for Lambda.</p>
<p>Fair warning: it gets hairy, fast.</p>
<h2 id="back-to-google-cloud-functions" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/google-chrome-cloud-functions.html#back-to-google-cloud-functions"><span>Back to Google Cloud Functions</span></a></h2>
<p>Google Cloud Functions is more generous as for bundle size, so we don‚Äôt
need to resort to those tricks, and we can include a complete,
uncompressed, Google Chrome installation.</p>
<p>Google publishes <a href="https://googlechromelabs.github.io/chrome-for-testing/">Chrome for Testing</a>,
builds <a href="https://developer.chrome.com/blog/chrome-for-testing">specifically made</a>
for headless usage.</p>
<p>We can just download the latest build from there as part of the
<code>gcp-build</code> script in our <code>package.json</code>.</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;gcp-build&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;curl -s -O &#x27;https://storage.googleapis.com/chrome-for-testing-public/124.0.6367.91/linux64/chrome-linux64.zip&#x27; &amp;&amp; unzip chrome-linux64.zip &amp;&amp; rm chrome-linux64.zip&quot;</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<div class="note">
<p><strong>Note:</strong> the <code>gcp-build</code> script allows you to <a href="https://cloud.google.com/appengine/docs/standard/nodejs/running-custom-build-step">run a custom build step</a>
in Google Cloud Build, which is what Cloud Functions (both 1st and 2nd
gen, as well as Cloud Run and App Engine) use to build your function
image.</p>
<p>It would work just fine with a <code>postinstall</code> script as well, but
<code>gcp-build</code> makes sure you run it only on Google Cloud Build, which is
probably desirable in this particular case.</p>
</div>
<p>You will then have the Chrome binary in <code>chrome-linux64/chrome</code>, that
you can pass to the tool of your choice.</p>
<h2 id="with-puppeteer" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/google-chrome-cloud-functions.html#with-puppeteer"><span>With Puppeteer</span></a></h2>
<p>Courtesy of <a href="https://medium.com/@jackklpan/run-puppeteer-in-google-cloud-functions-v2-b18a353e609b">this post</a>,
with Puppeteer, you don‚Äôt need to download Chrome manually, since it
provides a nifty script to do just that.</p>
<p>Actually, Puppeteer‚Äôs <a href="https://github.com/puppeteer/puppeteer/blob/f23646b3526aa87145c17b22e9967ec8f77d82d2/packages/puppeteer/package.json#L41"><code>postinstall</code> script</a>
automatically downloads the latest version of Chrome for Testing for
your platform.</p>
<p>The caveat is that this script by default installs it to
<code>~/.cache/puppeteer</code>, which in the case of Google Cloud Build, is not
gonna be preserved in the final image. So we need to instruct Puppeteer
to install Chrome in a directory that Cloud Build will keep.</p>
<p>This can be done with the following <code>.puppeteerrc.js</code>:</p>
<pre><code class="hljs language-js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">cacheDirectory</span>: <span class="hljs-string">`<span class="hljs-subst">${__dirname}</span>/.cache/puppeteer`</span>
}
</code></pre>
<p>But even then, there‚Äôs another caveat. Puppeteer‚Äôs <code>postinstall</code> script
will only run after it gets installed. However, because of build
caching, you will get in a state where <code>node_modules</code> is restored, with
Puppeteer already installed (so <code>postinstall</code> will <em>not</em> run), but the
<code>.cache/puppeteer</code> directory will also <em>not</em> be restored.</p>
<p>To mitigate that, we need to make sure to install Chrome systematically.
Again we can leverage the <code>gcp-build</code> for that:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;gcp-build&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;npx puppeteer browsers install chrome&quot;</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<div class="note">
<p><strong>Note:</strong> you could call Puppeteer‚Äôs <code>postinstall</code> script directly by
doing <code>node node_modules/puppeteer/install.mjs</code> instead, but I found the
above command cleaner.</p>
</div>
<p>The good thing is that this script knows to not re-download Chrome if
it‚Äôs already found in the cache directory, so when the <code>postinstall</code>
script <em>does</em> run, the extra <code>gcp-build</code> command will be a no-op.</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Knex: timeout acquiring a connection, the pool is probably full</title>
    <link href="https://www.codejam.info/2024/05/knex-timeout-pool-full.html" />
    <id>https://www.codejam.info/2024/05/knex-timeout-pool-full.html</id>
    <updated>2024-05-05T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<pre><code class="hljs">Error: Knex: Timeout acquiring a connection. The pool is probably full. Are you missing a .transacting(trx) call?
</code></pre>
<p>Yes, you‚Äôre probably missing a <code>.transacting(trx)</code> call, but what‚Äôs
going on exactly?</p>
<p>Knex maintains a connection pool to your database, which you configure
with the <a href="https://knexjs.org/guide/#pool"><code>pool</code> <code>min</code> and <code>max</code> options</a>.
If <code>max</code> is 5, then Knex will keep up to 5 connections to your database
in the pool.</p>
<p>If you‚Äôre attempting to make a query and the pool is full, then it‚Äôll
wait that one of the connection frees up in order to use it.</p>
<p>Sometimes however, it will timeout doing so. One common case is a
deadlock when mixing queries inside and outside a transaction.</p>
<p>Let‚Äôs say that you start 5 transactions, but within those transactions,
you‚Äôre performing some queries <em>outside</em> of the transaction:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">await</span> knex.<span class="hljs-title function_">transaction</span>(<span class="hljs-function"><span class="hljs-params">trx</span> =&gt;</span> {
  <span class="hljs-keyword">await</span> trx.<span class="hljs-title function_">raw</span>(<span class="hljs-string">&#x27;...&#x27;</span>)
  <span class="hljs-keyword">await</span> knex.<span class="hljs-title function_">raw</span>(<span class="hljs-string">&#x27;...&#x27;</span>)
})
</code></pre>
<p>Here, the <code>knex.raw</code> statement will execute outside of the transaction
(despite being in the function, because it doesn‚Äôt use <code>trx</code>). This
means that it will use its own connection from the pool, on top of the
one <code>knex.transaction</code> already uses.</p>
<p>If you have enough of those running in parallel, you can hit a case
where there‚Äôs no available connection to execute the <code>knex.raw</code> bit. So
it‚Äôs waiting that a connection frees up. <strong>But no connection get freed up
because all the transactions are waiting for the <code>knex.raw</code> bit to
complete in order to commit!</strong></p>
<p>See the deadlock here?</p>
<p>So the solution is to make sure that all the queries you perform inside
the transaction actually use that transaction. In the above example,
it‚Äôs very obvious, but it can get trickier when you call a function that
calls another function that calls a method that makes a query but didn‚Äôt
accept a <code>trx</code> parameter and so ends up needing its own connection. üò¨</p>
<p>Now you know what to look for. üëÄ</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Prevent macOS to switch to bluetooth headphones microphone üéß</title>
    <link href="https://www.codejam.info/2024/05/macos-prevent-bluetooth-headphones-microphone.html" />
    <id>https://www.codejam.info/2024/05/macos-prevent-bluetooth-headphones-microphone.html</id>
    <updated>2024-05-05T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>Maybe like me, you have bluetooth headphones such as the Sony WH-1000XM4
that you like because they have great audio, but the built-in microphone
otherwise suck. But you don‚Äôt care because you use your MacBook‚Äôs
microphone.</p>
<p>Then, maybe also like me, you didn‚Äôt even <em>know</em> that it had a built-in
microphone in the first place, and even less that macOS was
automatically switching to that microphone when you connect your
headphones!</p>
<p>Luckily, I didn‚Äôt sound like shit on calls for too long, because my
friends quickly told me ‚Äúbro, ur mic sounds like shit‚Äù. üí©</p>
<h2 id="forcing-the-internal-microphone" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/macos-prevent-bluetooth-headphones-microphone.html#forcing-the-internal-microphone"><span>Forcing the internal microphone</span></a></h2>
<p>Now we know what‚Äôs wrong, let‚Äôs fix it. The idea is that when I connect
my bluetooth headphones, I want the audio output to go to them, but I
don‚Äôt want to switch my default microphone.</p>
<p>We can achieve that with the <strong>Audio MIDI Setup</strong> app.</p>
<p>Create an <strong>Aggregate Device</strong> (from the <code>+</code> icon at the bottom-left
corner) that has only one input: your MacBook microphone. Then set this
aggregate device as ‚Äúdefault for sound input‚Äù from the right click menu.</p>
<figure class="center">
  <img alt="Audio MIDI Setup" srcset="../../img/2024/05/macos-microphone/audio-midi-setup.png 2x">
</figure>
<p>Tada! Now connecting your headphones will leave the aggregate device
alone, meaning you‚Äôll keep using the good microphone that comes with
your laptop, without thinking about it. üëå</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Firebase Auth Admin SDK denied when using application default credentials</title>
    <link href="https://www.codejam.info/2024/05/firebase-auth-admin-denied-application-default.html" />
    <id>https://www.codejam.info/2024/05/firebase-auth-admin-denied-application-default.html</id>
    <updated>2024-05-05T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>If you‚Äôre using the Firebase Admin SDK from your development machine
e.g. to run ad hoc scripts, you may have tried to do something like
this:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> admin <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase-admin&#x27;</span>
<span class="hljs-keyword">import</span> { applicationDefault } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase-admin/app&#x27;</span>

admin.<span class="hljs-title function_">initializeApp</span>({
  <span class="hljs-attr">projectId</span>: <span class="hljs-string">&#x27;my-project&#x27;</span>,
  <span class="hljs-attr">credential</span>: <span class="hljs-title function_">applicationDefault</span>()
})

<span class="hljs-keyword">const</span> auth = admin.<span class="hljs-title function_">auth</span>()

<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> auth.<span class="hljs-title function_">getUserByEmail</span>(<span class="hljs-string">&#x27;foo@bar.com&#x27;</span>)

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user)
</code></pre>
<p>After all, it works just fine with other Firebase APIs like Firestore.</p>
<p>But in the above case, you‚Äôd be getting the following error (spread onto
lines for readability):</p>
<pre><code class="hljs">FirebaseAuthError: //cloud.google.com/docs/authentication/.

If you are getting this error with curl or similar tools, you may need
to specify &#x27;X-Goog-User-Project&#x27; HTTP header for quota and billing
purposes.

For more information regarding &#x27;X-Goog-User-Project&#x27; header, please
check https://cloud.google.com/apis/docs/system-parameters.

Raw server response:

{
  &quot;error&quot;: {
    &quot;code&quot;: 403,
    &quot;message&quot;: &quot;Your application has authenticated using end user credentials from the Google Cloud SDK or Google Cloud Shell which are not supported by the identitytoolkit.googleapis.com. We recommend configuring the billing/quota_project setting in gcloud or using a service account through the auth/impersonate_service_account setting. For more information about service accounts and how to use them in your application, see https://cloud.google.com/docs/authentication/. If you are getting this error with curl or similar tools, you may need to specify &#x27;X-Goog-User-Project&#x27; HTTP header for quota and billing purposes. For more information regarding &#x27;X-Goog-User-Project&#x27; header, please check https://cloud.google.com/apis/docs/system-parameters.&quot;,
    &quot;errors&quot;: [
      {
        &quot;message&quot;: &quot;Your application has authenticated using end user credentials from the Google Cloud SDK or Google Cloud Shell which are not supported by the identitytoolkit.googleapis.com. We recommend configuring the billing/quota_project setting in gcloud or using a service account through the auth/impersonate_service_account setting. For more information about service accounts and how to use them in your application, see https://cloud.google.com/docs/authentication/. If you are getting this error with curl or similar tools, you may need to specify &#x27;X-Goog-User-Project&#x27; HTTP header for quota and billing purposes. For more information regarding &#x27;X-Goog-User-Project&#x27; header, please check https://cloud.google.com/apis/docs/system-parameters.&quot;,
        &quot;domain&quot;: &quot;usageLimits&quot;,
        &quot;reason&quot;: &quot;accessNotConfigured&quot;,
        &quot;extendedHelp&quot;: &quot;https://console.developers.google.com&quot;
      }
    ],
    &quot;status&quot;: &quot;PERMISSION_DENIED&quot;,
    &quot;details&quot;: [
      {
        &quot;@type&quot;: &quot;type.googleapis.com/google.rpc.ErrorInfo&quot;,
        &quot;reason&quot;: &quot;SERVICE_DISABLED&quot;,
        &quot;domain&quot;: &quot;googleapis.com&quot;,
        &quot;metadata&quot;: {
          &quot;service&quot;: &quot;identitytoolkit.googleapis.com&quot;,
          &quot;consumer&quot;: &quot;projects/123456&quot;
        }
      }
    ]
  }
}
}
</code></pre>
<p>So what‚Äôs going on? Well <code>applicationDefault()</code> works with the
application default credentials as created by
<a href="https://cloud.google.com/sdk/gcloud/reference/auth/application-default/login"><code>gcloud auth application-default login</code></a>,
which live in <code>~/.config/gcloud/application_default_credentials.json</code>.</p>
<p>In my case, those credentials didn‚Äôt have access to Firebase Auth for a
reason I did not try to understand.</p>
<p>However, what <em>did</em> have access to Firebase Auth is the application
default credentials as created by <a href="https://firebase.google.com/docs/cli#sign-in-test-cli"><code>firebase login</code></a>,
which live in <code>~/.config/firebase/*_application_default_credentials.json</code>.</p>
<p>Firebase‚Äôs <code>applicationDefault()</code>, despite being a method of the
Firebase SDK, <a href="https://github.com/firebase/firebase-admin-node/blob/ddcf965511e2f03853bad7658b5c61b85c306580/src/app/credential-internal.ts#L485">does <em>not</em> know</a>
about the Firebase application default credentials, and instead only
uses the Google Cloud credentials. üòÖ</p>
<p>However it supports reading the credentials file from the
<code>GOOGLE_APPLICATION_CREDENTIALS</code> environment variable, so we can run the
script like this:</p>
<pre><code class="hljs language-sh">GOOGLE_APPLICATION_CREDENTIALS=~/.config/firebase/*_application_default_credentials.json node script.js
</code></pre>
<div class="note">
<p><strong>Note:</strong> I left a wildcard <code>*</code> in the path above because Firebase
application default credentials contain your user and organization name.
It‚Äôll work out of the box if you are only connected to a single Firebase
identity, but you‚Äôll have to be more specific otherwise.</p>
</div>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Send Cloudflare Workers logs to Google Cloud Logging using Logpush</title>
    <link href="https://www.codejam.info/2024/05/cloudflare-workers-logs-gcp-logging-logpush.html" />
    <id>https://www.codejam.info/2024/05/cloudflare-workers-logs-gcp-logging-logpush.html</id>
    <updated>2024-05-05T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>Cloudflare Workers are great, until they become a key part of your
production system and you realize you don‚Äôt have any logs. üòÖ</p>
<p>Something didn‚Äôt work the way it should? Woops, sorry, can‚Äôt do much
about that, I have no trace of what happened. ü§∑</p>
<p>Not ideal.</p>
<div class="note">
<p><strong>Note:</strong> sure there‚Äôs the option to tail logs from the dashboard and
the CLI, but it turns out most of the logs I need don‚Äôt get logged while
I‚Äôm watching. üëÄ</p>
</div>
<p>For a while, the alternative was to replace <code>console.log</code> statements by
<code>fetch</code> requests to something that will actually persist logs. Fine, but
still not ideal.</p>
<p>Thankfully they introduced <a href="https://blog.cloudflare.com/logpush-for-workers/">Logpush for Workers</a>
back in 2022, which finally gave us a way to forward worker logs to a
number of <a href="https://developers.cloudflare.com/logs/get-started/enable-destinations/">destinations</a>,
including Amazon S3, Google Cloud Storage, Datadog, Elasticsearch,
BigQuery and more.</p>
<p>But none of those options was Google Cloud Logging. And I like to
centralize my logs in Google Cloud Logging. Bummer.</p>
<h2 id="leveraging-the-http-destination" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/cloudflare-workers-logs-gcp-logging-logpush.html#leveraging-the-http-destination"><span>Leveraging the HTTP destination</span></a></h2>
<p>One of those options though is an arbitrary <a href="https://developers.cloudflare.com/logs/get-started/enable-destinations/http/">HTTP destination</a>.</p>
<p>With that, I should be able to integrate any log backend I want.</p>
<p>What if I made a Cloudflare Worker to handle the logs of my other
workers? That log drain worker probably shouldn‚Äôt drain logs to itself
to avoid an infinite recursion, but I could fallback in one of the other
integrations just for this one.</p>
<h2 id="configuring-a-logpush-handler" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/cloudflare-workers-logs-gcp-logging-logpush.html#configuring-a-logpush-handler"><span>Configuring a Logpush handler</span></a></h2>
<p>In order to use Cloudflare Logpush, <a href="https://developers.cloudflare.com/logs/about/">you need to be under the Cloudflare Enterprise plan</a>.
However there‚Äôs an exception for the Cloudflare Workers logs! Then all
you need is the <a href="https://developers.cloudflare.com/workers/platform/pricing/">Workers Paid</a>
plan.</p>
<p>You can configure a log handler from your dashboard, in <strong>Analytics &amp;
Logs &gt; Logs &gt; Add Logpush job</strong>. Select <strong>Workers trace events</strong> as a
dataset, select the fields you care about (more on that later), and
configure your HTTP endpoint.</p>
<p>This UI looks like a recent addition! When I originally worked on this,
Logpush was only configurable <a href="https://developers.cloudflare.com/logs/get-started/enable-destinations/http/#manage-via-api">by using the Cloudflare HTTP API</a>.</p>
<p>For the record, and because it gives you more control over the Logpush
settings, here‚Äôs how you would do this with the API.</p>
<p>First, you need an API token, which you can create from <strong>My Profile &gt;
API Tokens</strong>.</p>
<p>While the API docs often reference the usage of API keys with
<code>X-Auth-Email</code> and <code>X-Auth-Key</code> headers, those API keys have complete
permissions over your account, and I would recommend against using them
if you have a better alternative.</p>
<p>The better alternative: API <em>tokens</em>, which lets you scope permissions.
In our case, we want to create a custom token with permissions of
<code>Zone.Logs.Edit</code>. That token can then be used in a <code>Authorization: Bearer</code> header.</p>
<p>Here‚Äôs how you would list existing Logpush jobs:</p>
<pre><code class="hljs language-sh">curl \
  -H <span class="hljs-string">&quot;Authorization: Bearer <span class="hljs-variable">$TOKEN</span>&quot;</span> \
  <span class="hljs-string">&#x27;https://api.cloudflare.com/client/v4/accounts/my-account-id/logpush/jobs&#x27;</span>
</code></pre>
<p>Where <code>my-account-id</code> is your account ID, that you can find for example
in the <strong>Workers &amp; Pages &gt; Overview</strong> page on the right.</p>
<p>To create a job:</p>
<pre><code class="hljs language-sh">curl \
  -H <span class="hljs-string">&quot;Authorization: Bearer <span class="hljs-variable">$TOKEN</span>&quot;</span> \
  -H <span class="hljs-string">&#x27;Content-Type: application/json&#x27;</span> \
  <span class="hljs-string">&#x27;https://api.cloudflare.com/client/v4/accounts/my-account-id/logpush/jobs&#x27;</span> \
  --data <span class="hljs-string">&#x27;{
  &quot;name&quot;: &quot;test&quot;,
  &quot;output_options&quot;: {
    &quot;field_names&quot;: [&quot;DispatchNamespace&quot;, &quot;Entrypoint&quot;, &quot;Event&quot;, &quot;EventTimestampMs&quot;, &quot;EventType&quot;, &quot;Exceptions&quot;, &quot;Logs&quot;, &quot;Outcome&quot;, &quot;ScriptName&quot;, &quot;ScriptTags&quot;, &quot;ScriptVersion&quot;],
    &quot;timestamp_format&quot;: &quot;rfc3339&quot;
  },
  &quot;destination_conf&quot;: &quot;https://my.worker.workers.dev&quot;,
  &quot;dataset&quot;: &quot;workers_trace_events&quot;,
  &quot;enabled&quot;: true
}&#x27;</span>
</code></pre>
<p>Where the API shines compared to the UI, is that you can configure a
number of <a href="https://developers.cloudflare.com/api/operations/post-accounts-account_identifier-logpush-jobs#request-body">extra options</a>
like <code>max_upload_bytes</code>, <code>max_upload_interval_seconds</code> and
<code>max_upload_records</code>, to make sure Logpush makes requests within
acceptable limits for your endpoint.</p>
<p>In our case, the Logpush handler is also a Cloudflare worker so the max
body size will be between 100 MB and 500 MB <a href="https://developers.cloudflare.com/workers/platform/limits/#request-limits">depending on your plan</a>.
But also, Cloudflare workers have a <a href="https://developers.cloudflare.com/workers/platform/limits/">memory limit</a>
of 128 MB so that‚Äôs something to take into account as well. Oh and keep
in mind <a href="https://community.cloudflare.com/t/workers-memory-limit/491329/2">this memory limit is per-isolate</a>
meaning that multiple requests could hit the same isolate. So adjust
accordingly, but I don‚Äôt have a silver bullet for this one. üôÉ</p>
<div class="note">
<p><strong>Note:</strong> in my experience, setting <code>timestamp_format</code> to <code>rfc3339</code>
doesn‚Äôt do anything? I‚Äôm still only getting <code>TimestampMs</code> fields in
milliseconds (which interestingly is neither a <code>unix</code> (seconds) nor
<code>unixnano</code> (nanoseconds) timestamp, which are the other two possible
options).</p>
</div>
<p>In order to update a job, you‚Äôll need the <code>id</code> that was returned by the
create request, or simply fetch it with the list request. It‚Äôs gonna be
like the create request but you append the log ID in the end, e.g.
<code>logpush/jobs/12345</code>, it‚Äôs a <code>PUT</code> request, and all fields are optional.</p>
<p>To delete a job, same but it‚Äôs a <code>DELETE</code> request with no body.</p>
<h2 id="the-logpush-http-destination-protocol" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/cloudflare-workers-logs-gcp-logging-logpush.html#the-logpush-http-destination-protocol"><span>The Logpush HTTP destination protocol</span></a></h2>
<p>I didn‚Äôt find documentation about what the HTTP destination is supposed
to accept, so here‚Äôs what I figured out:</p>
<ul>
<li>It sends a <code>POST</code> request to the configured URL.</li>
<li>The body is gzipped.</li>
<li>The uncompressed body is a newline-delimited JSON of ‚Äúevents‚Äù, e.g.:</li>
</ul>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span><span class="hljs-attr">&quot;DispatchNamespace&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Entrypoint&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Event&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">&quot;RayID&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;87ed87f80cf22d84&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Request&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">&quot;URL&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://test.workers.dev/&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Method&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;GET&quot;</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Response&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">&quot;Status&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">200</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;EventTimestampMs&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1714878560011</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;EventType&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;fetch&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Exceptions&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Logs&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">&quot;Level&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;log&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;bar&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;foo&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;TimestampMs&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1714878560016</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Outcome&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ok&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;ScriptName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;ScriptTags&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;ScriptVersion&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">&quot;ID&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;1e7519b3-08e2-441d-ae10-7c8c6d3b7e17&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Tag&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">&quot;DispatchNamespace&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Entrypoint&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Event&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">&quot;RayID&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;87ed87fb49cb2d84&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Request&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">&quot;URL&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://test.workers.dev/&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Method&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;GET&quot;</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Response&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">&quot;Status&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">200</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;EventTimestampMs&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1714878560532</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;EventType&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;fetch&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Exceptions&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Logs&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">&quot;Level&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;log&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;bar&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;foo&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;TimestampMs&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1714878560532</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Outcome&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ok&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;ScriptName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;ScriptTags&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;ScriptVersion&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">&quot;ID&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;1e7519b3-08e2-441d-ae10-7c8c6d3b7e17&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Tag&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<p>When you configure the HTTP destination, you get a chance to choose
which of those fields are included. You‚Äôll get a different set of fields
depending on the kind of dataset you‚Äôre dealing with, but in the scope
of this article we‚Äôre focusing on worker logs.</p>
<p>For reference, here‚Äôs the list of supported <a href="https://developers.cloudflare.com/logs/reference/log-fields/zone/">zone-scoped datasets</a>
and <a href="https://developers.cloudflare.com/logs/reference/log-fields/account/">account-scoped datasets</a>.
Zone-scoped datasets like DNS logs are tied to a specific ‚Äúzone‚Äù
(a specific domain), while account-scoped datasets like worker logs are
global to your account (workers don‚Äôt belong to a particular zone).</p>
<h2 id="writing-the-worker" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/cloudflare-workers-logs-gcp-logging-logpush.html#writing-the-worker"><span>Writing the worker</span></a></h2>
<p>The worker will need to decompress the gzipped body, split it into lines
and send the individual logs to the Google Cloud Logging API.</p>
<p>Calling Google Cloud APIs from Cloudflare Workers is a bit of a
challenge because the Node.js SDK is not compatible with the workers
environment, so we need to reimplement the whole authentication process.
But it‚Äôs a problem <a href="https://www.codejam.info/2022/02/how-to-call-google-cloud-apis-from-cloudflare-workers.html">we‚Äôve already solved in the past</a>
so it should be no big deal. üòé</p>
<p>First let‚Äôs start with the base of the worker, including decompressing
the body:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-keyword">async</span> fetch (request) {
    <span class="hljs-keyword">if</span> (request.<span class="hljs-property">method</span> !== <span class="hljs-string">&#x27;POST&#x27;</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;&#x27;</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">405</span> })
    }

    <span class="hljs-keyword">const</span> ds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DecompressionStream</span>(<span class="hljs-string">&#x27;gzip&#x27;</span>)
    <span class="hljs-keyword">const</span> stream = request.<span class="hljs-property">body</span>.<span class="hljs-title function_">pipeThrough</span>(ds)
    <span class="hljs-keyword">const</span> body = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(stream).<span class="hljs-title function_">text</span>()
    <span class="hljs-keyword">const</span> logs = body.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;\n&#x27;</span>)

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> json <span class="hljs-keyword">of</span> logs) {
      <span class="hljs-keyword">if</span> (json.<span class="hljs-title function_">trim</span>() === <span class="hljs-string">&#x27;&#x27;</span>) {
        <span class="hljs-keyword">continue</span>
      }

      <span class="hljs-keyword">const</span> log = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(json)

      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(log)
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>()
  }
}
</code></pre>
<p>To do that, we use the native
<a href="https://developer.mozilla.org/en-US/docs/Web/API/DecompressionStream"><code>DecompressionStream</code></a>,
that we can then <a href="https://stackoverflow.com/a/72718732/4324668">convert to text</a>
with <code>await new Response(stream).text()</code>.</p>
<h2 id="calling-the-google-cloud-logging-api" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/cloudflare-workers-logs-gcp-logging-logpush.html#calling-the-google-cloud-logging-api"><span>Calling the Google Cloud Logging API</span></a></h2>
<p>Now let‚Äôs see how we can call the Google Cloud Logging API. Again, we
can‚Äôt use the Google Cloud Node.js SDK, so we need to call the REST API
manually. Everything about authentication is explained in
<a href="https://www.codejam.info/2022/02/how-to-call-google-cloud-apis-from-cloudflare-workers.html">this post</a>
so I won‚Äôt cover that again. Read that article to understand how to deal
with Google Cloud API authentication from a Cloudflare worker!</p>
<p>When it comes to Google Cloud Logging specifically, you‚Äôll need an <code>aud</code>
of <code>https://logging.googleapis.com/</code> in your JWT. The rest of this post
will assume you generated a <code>token</code> variable thanks to the
aforementioned article.</p>
<p>In order to write logs, we need to call the <a href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/entries/write"><code>entries:write</code></a>
endpoint.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(
  <span class="hljs-string">`https://logging.googleapis.com/v2/entries:write`</span>,
  {
    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>,
      <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">entries</span>: [
        {
          <span class="hljs-attr">logName</span>: <span class="hljs-string">`projects/my-project-id/logs/my-log-id`</span>,
          <span class="hljs-attr">resource</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;generic_node&#x27;</span>,
            <span class="hljs-attr">labels</span>: {
              <span class="hljs-comment">// project_id: &#x27;...&#x27;,</span>
              <span class="hljs-comment">// location: &#x27;...&#x27;,</span>
              <span class="hljs-comment">// namespace: &#x27;...&#x27;,</span>
              <span class="hljs-comment">// node_id: &#x27;...&#x27;</span>
            }
          },
          <span class="hljs-comment">// severity: &#x27;DEFAULT&#x27;,</span>
          <span class="hljs-attr">timestamp</span>: <span class="hljs-string">&#x27;2024-05-05T17:38:47.512Z&#x27;</span>,
          <span class="hljs-attr">jsonPayload</span>: {
            <span class="hljs-attr">foo</span>: <span class="hljs-string">&#x27;bar
          }
        }
      ]
    })
  }
)
</span></code></pre>
<p>Replace <code>my-project-id</code> by your project ID. <code>my-log-id</code> can be anything.</p>
<p>Here I chose to use a <code>generic_node</code> resource type, but there‚Äôs
<a href="https://cloud.google.com/logging/docs/api/v2/resource-list#resource-types">quite a lot of other choices</a>
so feel free to use what makes the most sense to you.</p>
<p>The resource type that you chose will have a number of associated labels
that you can feed. In this example I included the <code>generic_node</code> labels.
<code>project_id</code> doesn‚Äôt really need to be set because it will be
automatically populated from the project ID in your <code>logName</code>. The other
ones are also optional. Put what makes the most sense for your data!</p>
<p>There‚Äôs a number of other fields you can set on each <a href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry">log entry</a>
in the <code>entries</code> array, but I kept it simple for this example.</p>
<p>You can for example tune the
<a href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry#LogSeverity"><code>severity</code></a>,
e.g. to distinguish <code>WARNING</code> and <code>ERROR</code> logs appropriately.</p>
<h2 id="formatting-logpush-logs-to-google-cloud-logging-entries" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/cloudflare-workers-logs-gcp-logging-logpush.html#formatting-logpush-logs-to-google-cloud-logging-entries"><span>Formatting Logpush logs to Google Cloud Logging entries</span></a></h2>
<p>Let‚Äôs look in a bit more details at a worker log received from Logpush:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;DispatchNamespace&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;Entrypoint&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;Event&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;RayID&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;87ed87f80cf22d84&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;Request&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;URL&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://test.workers.dev/&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;Method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;GET&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;Response&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;Status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;EventTimestampMs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1714878560011</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;EventType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;fetch&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;Exceptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;Logs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;Level&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;log&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;Message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;bar&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;foo&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;TimestampMs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1714878560016</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;Outcome&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ok&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;ScriptName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;ScriptTags&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;ScriptVersion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;ID&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1e7519b3-08e2-441d-ae10-7c8c6d3b7e17&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;Message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;Tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>And here‚Äôs the associated <a href="https://developers.cloudflare.com/logs/reference/log-fields/account/workers_trace_events/">docs</a>.</p>
<p>As we can see, we get one entry per ‚Äúevent‚Äù which in this case, is a
whole HTTP request completing.</p>
<p>Then for this particular HTTP request, we‚Äôve got an array of <code>Logs</code> that
the worker outputted during its runtime.</p>
<div class="note">
<p><strong>Note:</strong> interestingly, the above log <code>[&quot;bar&quot;, &quot;foo&quot;]</code> was generated
by:</p>
<pre><code class="hljs language-js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;foo&#x27;</span>, <span class="hljs-string">&#x27;bar&#x27;</span>)
</code></pre>
<p>So it looks like the <code>Message</code> array is the reverse of the arguments
order that was passed to <code>console.log</code>.</p>
<p>Weird, but OK.</p>
</div>
<p>From there, it‚Äôs up to you how you translate that to Google Cloud
Logging entries. You could:</p>
<ol>
<li>Use the whole ‚Äúevent‚Äù as a single log entry and dig in the <code>Logs</code>
property to see the actual logs. Then you could set the log severity
based on the response status code, e.g. <code>ERROR</code> if the status is
<code>&gt;=400</code>.</li>
<li>Store the HTTP request ‚Äúevent‚Äù without logs in a separate entry, then
map the <code>Logs</code> array to individual log entries. Then you could map
the <code>Level</code> property to a log severity and have more granularity that
way.</li>
</ol>
<p>For this post, I‚Äôll take the lazy approach and just shove the whole
thing in the <code>jsonPayload</code>. üòÑ</p>
<p>Building off the <a href="https://www.codejam.info/2024/05/cloudflare-workers-logs-gcp-logging-logpush.html#writing-the-worker">worker base from earlier</a>:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> entries = []

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> json <span class="hljs-keyword">of</span> logs) {
  <span class="hljs-keyword">if</span> (json.<span class="hljs-title function_">trim</span>() === <span class="hljs-string">&#x27;&#x27;</span>) {
    <span class="hljs-keyword">continue</span>
  }

  <span class="hljs-keyword">const</span> log = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(json)

  entries.<span class="hljs-title function_">push</span>({
    <span class="hljs-attr">logName</span>: <span class="hljs-string">`projects/my-project-id/logs/my-log-id`</span>,
    <span class="hljs-attr">resource</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;generic_node&#x27;</span>,
      <span class="hljs-attr">labels</span>: {
        <span class="hljs-attr">namespace</span>: log.<span class="hljs-property">ScriptName</span>
      }
    },
    <span class="hljs-attr">severity</span>: log.<span class="hljs-property">Event</span>.<span class="hljs-property">Response</span>.<span class="hljs-property">Status</span> &gt;= <span class="hljs-number">400</span> ? <span class="hljs-string">&#x27;ERROR&#x27;</span> : <span class="hljs-string">&#x27;DEFAULT&#x27;</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(log.<span class="hljs-property">EventTimestampMs</span>).<span class="hljs-title function_">toISOString</span>(),
    <span class="hljs-attr">jsonPayload</span>: log
  })
}
</code></pre>
<p>Then as we saw before, we can push those entries to Google Cloud
Logging:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(
  <span class="hljs-string">`https://logging.googleapis.com/v2/entries:write`</span>,
  {
    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>,
      <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      entries
    })
  }
)
</code></pre>
<h2 id="make-your-workers-use-logpush" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/cloudflare-workers-logs-gcp-logging-logpush.html#make-your-workers-use-logpush"><span>Make your workers use Logpush!</span></a></h2>
<p>The final step is to enable Logpush on your workers. By default, even if
you have Logpush destinations enabled, they won‚Äôt be used unless
explicitly enabled at the worker level as well.</p>
<p>You can do that from the UI in your worker page, in <strong>Logs &gt; Event logs
Workers Logpush</strong>. If you use the Wrangler CLI, make sure to also set
<code>logpush = true</code> in your <code>wrangler.toml</code>!</p>
<h2 id="final-thoughts" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/cloudflare-workers-logs-gcp-logging-logpush.html#final-thoughts"><span>Final thoughts</span></a></h2>
<p>Getting your Cloudflare Workers logs onto Google Cloud Logging is not
easy, and using a Cloudflare worker for the integration layer makes it
even harder, but it‚Äôs also kinda cool if you ask me. üòè</p>
<p>You should now have everything you need to implement that, from the
details of using the Cloudflare API to create Logpush jobs and tune it
in a way you can‚Äôt do from the UI, implementing a HTTP Logpush
destination with gzip support, parsing the Logpush payload, all the way
to translating it for Google Cloud Logging and push it using the raw
HTTP API in an environment where the official SDK is not supported.</p>
<p>I hope you learnt a thing or two thanks to this post, and that your logs
are being happily ingested now! ü´∂</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1787213611267674227">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Next.js: make Firebase Auth signInWithRedirect work with Safari</title>
    <link href="https://www.codejam.info/2024/05/nextjs-firebase-auth-safari.html" />
    <id>https://www.codejam.info/2024/05/nextjs-firebase-auth-safari.html</id>
    <updated>2024-05-04T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>Had that
<a href="https://github.com/firebase/firebase-js-sdk/issues/6716">issue</a>
back in 2022 and it‚Äôs now a pretty
<a href="https://firebase.google.com/docs/auth/web/redirect-best-practices">well-understood</a>
problem, but better write about it later than never. üòÇ</p>
<p>Essentially, in Safari 16.1+ (and now Firefox 109+), there are more
aggressive restrictions on third-party cookies that mess with the way
Firebase Auth <code>signInWithRedirect</code> is implemented.</p>
<p>By default, your app could be running on <code>https://myapp.com</code> but
<code>signInWithRedirect</code> would redirect to
<code>https://myapp.firebaseapp.com/__/auth</code> and then back to your app in
order to handle the auth. The message passing with third-party cookies
between those two hosts is no longer possible in Safari, Firefox, and
soon Chrome.</p>
<p>Firebase docs now document <a href="https://firebase.google.com/docs/auth/web/redirect-best-practices">5 options</a>
to solve that.</p>
<ol>
<li>If you host your app on Firebase, make sure your Firebase config
<code>authDomain</code> point to your custom domain and not
<code>myapp.firebaseapp.com</code>. Because Firebase hosts your app, it will
automatically handle the special <code>__/auth</code> path.</li>
<li>Use <code>signInWithPopup</code> which doesn‚Äôt depend on third-party cookies.</li>
<li>If your frontend is not hosted on Firebase, proxy requests from
<code>https://myapp.com/__auth/*</code> to <code>https://myapp.firebaseapp.com/__/auth/*</code>
so there‚Äôs no cross-domain concerns.</li>
<li>Download the relevant files from
<code>https://myapp.firebaseapp.com/__/auth/*</code> and ‚Äúself-host‚Äù them on
your app.</li>
<li>Handle provider auth by yourself.</li>
</ol>
<p>In my case, I‚Äôm not hosting the website on Firebase, and I don‚Äôt want to
use <code>signInWithPupup</code>, so the proxy looks like a solid option.</p>
<p>In a Next.js app, it‚Äôs as easy as adding the following to
<code>next.config.js</code>:</p>
<pre><code class="hljs language-js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-keyword">async</span> rewrites () {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">beforeFiles</span>: [
        {
          <span class="hljs-attr">source</span>: <span class="hljs-string">&#x27;/__/auth/:path*&#x27;</span>,
          <span class="hljs-attr">destination</span>: <span class="hljs-string">`https://myapp.firebaseapp.com/__/auth/:path*`</span>
        }
      ]
    }
  }
}
</code></pre>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>PostgreSQL: swap tables with dependent views</title>
    <link href="https://www.codejam.info/2024/05/postgresql-swap-tables-dependent-views.html" />
    <id>https://www.codejam.info/2024/05/postgresql-swap-tables-dependent-views.html</id>
    <updated>2024-05-04T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>Sometimes, you need to do some maintenance on a table, and doing a
<em>table swap</em> is a good tool to avoid downtime (e.g. if the maintenance
would lock aggressively and run for a long time). The idea is as
follows:</p>
<ol>
<li>Clone the source table.</li>
<li>Perform the maintenance.</li>
<li>Make sure they‚Äôre in sync if needs be.</li>
<li>When the maintenance is over, in a transaction, drop the source
table, and rename the clone to the original name.</li>
</ol>
<p>It can get a bit more complicated than that if you have foreign keys,
but I won‚Äôt cover that in this article.</p>
<p>However, another way it gets more complicated is when you have <em>views</em>
that depend on the table you want to swap:</p>
<pre><code class="hljs language-sql"><span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> example;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> example_swap RENAME <span class="hljs-keyword">TO</span> example;
</code></pre>
<pre><code class="hljs">ERROR: cannot drop table example because other objects depend on it
DETAIL: view example_view depends on table example
</code></pre>
<p>In this case, we need to update <code>example_view</code> (and all other views that
depend on <code>example</code>) to reference the <code>example_swap</code> table before we
perform the actual swap.</p>
<p>If this is a one-off swap, fine, but if you‚Äôre doing the swap as part of
some automated maintenance task, that won‚Äôt do it.</p>
<h2 id="automatically-swapping-dependent-views" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/postgresql-swap-tables-dependent-views.html#automatically-swapping-dependent-views"><span>Automatically swapping dependent views</span></a></h2>
<p>In my case, the dependent views don‚Äôt change very often (if at all), so
I went with a static list of the views that depend on the table I need
to swap.</p>
<p>Then I use the following script to swap the views:</p>
<pre><code class="hljs language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> pg_temp.replace_view_table(view_schema text, view_name text, old_table text, new_table text) <span class="hljs-keyword">RETURNS</span> void <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    view_definition text;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> definition <span class="hljs-keyword">INTO</span> view_definition
    <span class="hljs-keyword">FROM</span> pg_views
    <span class="hljs-keyword">WHERE</span> schemaname <span class="hljs-operator">=</span> view_schema
    <span class="hljs-keyword">AND</span> viewname <span class="hljs-operator">=</span> view_name;

    view_definition :<span class="hljs-operator">=</span> REPLACE(view_definition, old_table, new_table);

    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-string">&#x27;CREATE OR REPLACE VIEW &#x27;</span> <span class="hljs-operator">||</span> view_schema <span class="hljs-operator">||</span> <span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-operator">||</span> view_name <span class="hljs-operator">||</span> <span class="hljs-string">&#x27; AS &#x27;</span> <span class="hljs-operator">||</span> view_definition;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<p>This function will redefine the view to point to the new swap table. It
does a basic search and replace in the SQL definition of the view, so
you need to make sure the table name doesn‚Äôt conflict with anything else
in there.</p>
<div class="note">
<p><strong>Note:</strong> I‚Äôm using <code>pg_temp</code> so that the function is local to the
current database connection. I don‚Äôt want to leave it around permanently
in that case.</p>
</div>
<p>You can now perform the swap as follows:</p>
<pre><code class="hljs language-sql"><span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> pg_temp.replace_view_table(<span class="hljs-string">&#x27;public&#x27;</span>, <span class="hljs-string">&#x27;example_view&#x27;</span>, <span class="hljs-string">&#x27;example&#x27;</span>, <span class="hljs-string">&#x27;example_swap&#x27;</span>);
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> example;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> example_swap RENAME <span class="hljs-keyword">TO</span> example;
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<p>The renaming of the table will automatically propagate to the dependent
views, they won‚Äôt keep referencing the now gone <code>example_swap</code> table,
they‚Äôll properly point to <code>example</code>! ü•≥</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Vercel monorepo: properly cache Yarn installs</title>
    <link href="https://www.codejam.info/2024/05/vercel-monorepo-cache-yarn-installs.html" />
    <id>https://www.codejam.info/2024/05/vercel-monorepo-cache-yarn-installs.html</id>
    <updated>2024-05-04T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>So you have a Vercel app that‚Äôs part of a monorepo. You may have noticed
that by default it installs the whole monorepo dependencies, and you may
have already <a href="https://www.codejam.info/2024/05/vercel-monorepo-single-project-dependencies-yarn.html">addressed that</a>!</p>
<p>But either way, you have another problem: Yarn downloads all your
dependencies on every single build. That‚Äôs pretty time consuming. It
doesn‚Äôt seem that dependencies are getting cached at all.</p>
<p>Vercel <a href="https://github.com/orgs/vercel/discussions/222#discussioncomment-2036114">recommends</a>
setting a <code>ENABLE_ROOT_PATH_BUILD_CACHE=1</code> environment variable to
<a href="https://vercel.com/changelog/faster-build-times-for-monorepos">make build times faster in monorepos</a>.</p>
<p>It sounds great, but in my experience it didn‚Äôt do anything, and I‚Äôm not
<a href="https://github.com/orgs/vercel/discussions/222#discussioncomment-2745510">the</a>
<a href="https://github.com/orgs/vercel/discussions/222#discussioncomment-5105483">only</a>
<a href="https://github.com/orgs/vercel/discussions/222#discussioncomment-7077684">one</a>.</p>
<p>It <a href="https://github.com/orgs/vercel/discussions/222#discussioncomment-5166537"><em>seems</em></a>
that regardless of <code>ENABLE_ROOT_PATH_BUILD_CACHE</code>, Vercel doesn‚Äôt
cache Yarn‚Äôs cache folder <code>.yarn/cache</code>, and Yarn 3 and greater will
download everything again if this directory is not present, regardless
of the state of <code>node_modules</code>.</p>
<p>So the key is to force Yarn‚Äôs cache folder to be inside a directory that
Vercel actually caches.</p>
<p>I <a href="https://github.com/orgs/vercel/discussions/222#discussioncomment-4295643">tried</a>
setting it inside the root <code>node_modules</code> by doing
<code>YARN_CACHE_FOLDER=../../node_modules/.yarn-cache yarn workspaces focus</code>,
which worked at first, but quickly encountered some
<a href="https://github.com/orgs/vercel/discussions/222#discussioncomment-5165657">issues</a>
when the cache was reused across different build states.</p>
<p>Luckily, thanks to <a href="https://github.com/vercel/turbo/issues/785#issuecomment-1060054306">this comment</a>
on a totally unrelated issue, I discovered I could put the cache in
<code>.next/cache</code> instead, and I never had issues since then!</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;installCommand&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;YARN_CACHE_FOLDER=.next/cache/yarn-cache yarn workspaces focus&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Vercel monorepo: install only a single project dependencies with Yarn</title>
    <link href="https://www.codejam.info/2024/05/vercel-monorepo-single-project-dependencies-yarn.html" />
    <id>https://www.codejam.info/2024/05/vercel-monorepo-single-project-dependencies-yarn.html</id>
    <updated>2024-05-04T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>If you have a Vercel app as part of a monorepo, it may bother you that
by default every build installs the whole monorepo dependencies.</p>
<p>If the Vercel app is the <em>main</em> project in the monorepo, it should go
unnoticed, but if you have a bunch of other packages whose dependencies
differ a lot from that of the Vercel app, then it will be very obvious
that you‚Äôre spending a lot of time installing useless stuff on every
build.</p>
<p>If you‚Äôre using a modern version of Yarn, aka not ‚ÄúYarn classic‚Äù, aka
Yarn ‚ÄúBerry‚Äù and later, which would be Yarn 4 today, then you can use
<a href="https://yarnpkg.com/cli/workspaces/focus"><code>yarn workspaces focus</code></a> to
do just that.</p>
<p><a href="https://v3.yarnpkg.com/cli/workspaces/focus">In Yarn 3</a>, you need to
install the <code>workspace-tools</code> plugin via <code>yarn plugin import workspace-tools</code> for this to work. In Yarn 4, the command is supported
out of the box.</p>
<p><code>yarn workspaces focus</code>, when run from inside a specific workspace
directory, will install that workspace dependencies, as well as the
dependencies of all the workspaces it depends on.</p>
<div class="note">
<p><strong>Note:</strong> if you‚Äôre using <code>nodeLinker: node-modules</code>, the <code>node_modules</code>
layout may differ a bit, especially the fact that packages from your
other workspaces are no longer installed at the root of the monorepo.</p>
<p>This will make it obvious if you‚Äôre implicitly depending on packages
that are part of your monorepo but not depended on by your specific
workspace.</p>
</div>
<p>In order to configure that on Vercel, you can configure the following in
<code>vercel.json</code>:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;installCommand&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;yarn workspaces focus&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<div class="note">
<p><strong>Note:</strong> you‚Äôll probably want to mirror that configuration inside your
app settings in the Vercel dashboard in <strong>Settings &gt; Build &amp; Development
Settings &gt; Install Command</strong>, otherwise after you deploy, Vercel will
warn you that ‚Äúthe configuration of the current production deployment
differ from your current project settings‚Äù.</p>
</div>
<h2 id="making-it-work-with-vercel-cache" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/vercel-monorepo-single-project-dependencies-yarn.html#making-it-work-with-vercel-cache"><span>Making it work with Vercel cache</span></a></h2>
<p>There‚Äôs one more problem. Now you download only the dependencies of your
project, which is much better, but on subsequent builds, Yarn keeps
re-downloading everything again. It‚Äôs like there‚Äôs no cache!</p>
<p>That‚Äôs because Vercel and Yarn 3 and greater don‚Äôt play well together.
Yarn needs its <code>.yarn/cache</code> and Vercel doesn‚Äôt cache it between builds.</p>
<p>More details in <a href="https://www.codejam.info/2024/05/vercel-monorepo-cache-yarn-installs.html">this other post</a>. üòâ</p>
<p>TLDR: use the following command.</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;installCommand&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;YARN_CACHE_FOLDER=.next/cache/yarn-cache yarn workspaces focus&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Swift: detect space (virtual desktop) changes</title>
    <link href="https://www.codejam.info/2024/05/swift-detect-space-virtual-desktop-changes.html" />
    <id>https://www.codejam.info/2024/05/swift-detect-space-virtual-desktop-changes.html</id>
    <updated>2024-05-04T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>In a macOS app, you can
<a href="https://stackoverflow.com/a/56435288/4324668">get an event</a>
when <a href="https://stackoverflow.com/a/73548661/4324668">the active space changes</a>.
This happens e.g. if you have multiple virtual desktops, or full screen
windows, and you swap between ‚Äúspaces‚Äù, using the 3 fingers swipe on the
trackpad, or the <kbd>Ctrl</kbd> + <kbd>Left</kbd> and <kbd>Right</kbd>
shortcuts.</p>
<pre><code class="hljs language-swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObserver</span> {
  <span class="hljs-keyword">init</span>() {
    <span class="hljs-type">NSWorkspace</span>.shared.notificationCenter.addObserver(
      forName: <span class="hljs-type">NSWorkspace</span>.activeSpaceDidChangeNotification,
      object: <span class="hljs-literal">nil</span>,
      queue: <span class="hljs-literal">nil</span>,
      using: <span class="hljs-keyword">self</span>.spaceDidChange
    )
  }

  <span class="hljs-keyword">func</span> <span class="hljs-title function_">spaceDidChange</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">notification</span>: <span class="hljs-type">Notification</span>) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Desktop (space) changed&quot;</span>)
  }
}
</code></pre>
<p>Looks like there‚Äôs an alternative way to call it:</p>
<pre><code class="hljs language-swift">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObserver</span> {
  <span class="hljs-keyword">init</span>() {
    <span class="hljs-type">NSWorkspace</span>.shared.notificationCenter.addObserver(
      <span class="hljs-keyword">self</span>,
      selector: <span class="hljs-keyword">#selector</span>(<span class="hljs-keyword">self</span>.spaceDidChange),
      name: <span class="hljs-type">NSWorkspace</span>.activeSpaceDidChangeNotification,
      object: <span class="hljs-literal">nil</span>
    )
  }

  <span class="hljs-keyword">func</span> <span class="hljs-title function_">spaceDidChange</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">notification</span>: <span class="hljs-type">Notification</span>) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Desktop (space) changed&quot;</span>)
  }
}
</code></pre>
<p>Whatever works for you!</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Use Gmail to send emails with a custom domain for free (secret trick) üòè</title>
    <link href="https://www.codejam.info/2024/05/gmail-send-custom-domain-free.html" />
    <id>https://www.codejam.info/2024/05/gmail-send-custom-domain-free.html</id>
    <updated>2024-05-03T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>So you want to use Gmail with a custom domain without paying a Google
Workspace subscription? Well, it‚Äôs possible!</p>
<p>The main tradeoff with that is that Gmail will
<a href="https://support.google.com/mail/answer/1311182">display</a>
your emails on the recipient side with a ‚Äúvia gmail.com‚Äù next to your
email.</p>
<figure class="center">
  <img alt="Sender card showing ‚Äúvia gmail.com‚Äù" srcset="../../img/2024/05/gmail/via.png 2x">
</figure>
<p>The second tradeoff is that while the email will appear with your custom
domain, the Gmail address that you use will also show in the source
headers of the email, so a technical user could find it.</p>
<p>The last tradeoff is that you won‚Äôt be able to sign your emails with
DKIM.</p>
<p>If you‚Äôre fine with that, then read on!</p>
<h2 id="configuring-gmail-smtp-as-an-external-smtp-in-gmail" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/gmail-send-custom-domain-free.html#configuring-gmail-smtp-as-an-external-smtp-in-gmail"><span>Configuring Gmail SMTP as an external SMTP in Gmail üôÉ</span></a></h2>
<p>Gmail allows you to add external SMTP servers, to send emails using
other email addresses that you own. You can find that in <strong>Settings &gt;
Accounts and Import &gt; Send mail as</strong>.</p>
<p>However, Gmail can itself be used as a SMTP server for <em>other apps</em> to
send emails via your Gmail account. That in itself is a bit of a hidden
trick, and is explained <a href="https://noted.lol/setup-gmail-smtp-sending-2023/">here</a>.</p>
<p>In short: <a href="https://myaccount.google.com/security">in your Google account security settings</a>,
in <strong>2-Step Verification &gt; App passwords</strong>, add a new app password.</p>
<figure class="center">
  <img alt="App passwords" srcset="../../img/2024/05/gmail/app-passwords.png 2x">
</figure>
<div class="note">
<p><strong>Note:</strong> that section may not show for you‚Ä¶ on my side it seems to
show only if I already have existing app passwords but it‚Äôs completely
missing otherwise!</p>
<p>Luckily you can still access it via its <a href="https://myaccount.google.com/apppasswords">direct URL</a>.</p>
</div>
<p>Then you can use the following SMTP settings:</p>
<pre><code class="hljs">Host: smtp.gmail.com
Port: 587
Encryption: TLS
User: you@gmail.com
Password: the password generated earlier
</code></pre>
<p>Where it gets funky is that you can use those SMTP settings
<a href="https://support.google.com/domains/answer/9437157">from inside Gmail itself</a>,
like if you were adding an external SMTP server!</p>
<p>Again, in <strong>Settings &gt; Accounts and Import &gt; Send mail as</strong>, you can
<strong>Add another email address</strong>. Use your custom email address in the
email field e.g. <code>you@yourdomain.com</code>. Then use the SMTP settings from
above. In the SMTP settings, the user needs to be your Gmail account,
e.g. <code>you@gmail.com</code>, and not <code>you@yourdomain.com</code>.</p>
<p>Gmail will then need to verify that you own that email by sending you a
confirmation email. Once the verification done, you can start sending
emails using your custom domain! (You may have to reload the page as I
did otherwise sending an email using the new address would hang
forever.)</p>
<h2 id="why-is-that-even-allowed" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/gmail-send-custom-domain-free.html#why-is-that-even-allowed"><span>Why is that even allowed?</span></a></h2>
<p>It‚Äôs nice that Gmail does that verification step to confirm you do
really own that address, because they definitely don‚Äôt want Gmail
servers to be used to send nonlegitimate emails. But not all providers
and SMTP servers are that cautious. If I can make Gmail servers send
emails on the behalf of my domain, what prevents anyone to do the same
with their own servers?</p>
<p>Well, I‚Äôm glad you asked. Turns out anyone can, unless you configure
DKIM and DMARC.</p>
<h3 id="dkim-and-dmarc" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/gmail-send-custom-domain-free.html#dkim-and-dmarc"><span>DKIM &amp; DMARC</span></a></h3>
<p>With DKIM, you generate a keypair, configure the private key on your
SMTP server to sign your emails, and configure the public key on your
DNS so that the servers receiving your emails can check the signature
against your public key.</p>
<p>DMARC is also configured on your DNS and lets you define rules about how
to deal with emails that don‚Äôt pass DKIM validation (ignore, mark as
spam, or block), as well as endpoints to receive reports (so you have a
way to know if you misconfigured something and your emails are getting
blocked).</p>
<h3 id="you-need-google-workspace-for-that" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/gmail-send-custom-domain-free.html#you-need-google-workspace-for-that"><span>You need Google Workspace for that</span></a></h3>
<p>However as I mentioned in the beginning, that nifty Gmail setup doesn‚Äôt
let you use DKIM. You can‚Äôt configure a private key on Gmail‚Äôs SMTP
servers for them to sign emails from your custom domain. That‚Äôs a Google
Workspace <a href="https://support.google.com/a/answer/180504">feature</a> that you
have to pay for.</p>
<p>So for this trick to work, you need to not have DMARC configured, or
have your DMARC configuration allow unsigned emails.</p>
<h3 id="what-about-spf" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/gmail-send-custom-domain-free.html#what-about-spf"><span>What about SPF?</span></a></h3>
<p>Interestingly, SPF doesn‚Äôt help with that situation, because it
<a href="https://postmarkapp.com/guides/spf#understanding-the-limitations-of-spf">acts on the <code>Return-Path</code></a>
and not the <code>From</code> header.</p>
<p>In the case of the Gmail setup above, the email headers would look like:</p>
<pre><code class="hljs">From: you@yourdomain.com
Return-Path: you@gmail.com
</code></pre>
<p>(As I mentioned above, that‚Äôs where the Gmail email appears in the
source and could be seen by technical users.)</p>
<p>SPF validates against the <code>Return-Path</code>, so it will check that the
server sending the email is indeed allowed to send emails on behalf of
<code>gmail.com</code>, which Gmail servers are. No fucks are given about
<code>yourdomain.com</code> at that point.</p>
<p>Because of this weakness in SPF, that‚Äôs why even if SPF validation
passes, Gmail displays the ‚Äúvia‚Äù label when the <code>From</code> and <code>Return-Path</code>
domains don‚Äôt match <a href="https://postmarkapp.com/blog/dkim-and-the-via-label-in-gmail">and the email is not signed with DKIM</a>.
This gives you a chance to know that the email is not authenticated and
sent through a third party.</p>
<h2 id="it-doesn-t-work-across-gmail-accounts" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/gmail-send-custom-domain-free.html#it-doesn-t-work-across-gmail-accounts"><span>It doesn‚Äôt work across Gmail accounts</span></a></h2>
<p>One thing to note, which you‚Äôre probably not likely to run into, but
well, I do weird things sometimes, is that this setup <em>doesn‚Äôt work
across different Gmail accounts</em>.</p>
<p>By that, I mean that if you set up an ‚Äúapp password‚Äù on <code>you2@gmail.com</code>,
and you configure it as the outbound SMTP server for <code>you@gmail.com</code> to
send emails from <code>you@yourdomain.com</code>, <strong>it won‚Äôt work</strong>.</p>
<p>Your emails will be sent, but it won‚Äôt show the custom email domain, it
will show from <code>you2@gmail.com</code> instead. The trick only works when the
same Gmail account is used in both places.</p>
<p>If this section makes no sense to you, don‚Äôt worry about it. It‚Äôs quite
a niche setup to try, but I thought I‚Äôd mention anyway if it can be
useful to anyone trying to do the same thing.</p>
<h2 id="wrapping-up" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/05/gmail-send-custom-domain-free.html#wrapping-up"><span>Wrapping up</span></a></h2>
<p>I hope this trick will be useful to you!</p>
<p>As far as I‚Äôm concerned, because I wanted to avoid the ‚Äúvia‚Äù label and I
wanted to be able to set up DKIM, I went with <a href="https://www.zoho.com/mail/">Zoho Mail</a>
(not affiliated). They try really hard to hide it, but they
<a href="https://help.zoho.com/portal/en/community/topic/free-plan-mail-accounts-details">actually</a>
have a <a href="https://www.zoho.com/mail/help/adminconsole/subscription.html#:~:text=under%20Zoho%20Workplace-,free%20plan,-%3A%20Using%20this%20plan">free plan</a>
with up to 5 GB of storage, which I don‚Äôt care about because I just
configure it as an outbound SMTP server that doesn‚Äôt store anything. üòÑ</p>
<p>Either way, you should now be all set to send emails with your own
domain. Enjoy! ü§ô</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1786553405659545823">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>gocryptfs on macOS (with and without macFUSE)</title>
    <link href="https://www.codejam.info/2024/04/gocryptfs-macos-macfuse.html" />
    <id>https://www.codejam.info/2024/04/gocryptfs-macos-macfuse.html</id>
    <updated>2024-04-26T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>In this post I‚Äôm taking gocryptfs as an example because that‚Äôs what I
use to encrypt my <a href="https://www.codejam.info/2024/04/offsite-backup-sync.html">offsite backups</a>, but this
can probably be applied to doing anything FUSE-related on a Mac.</p>
<h2 id="gocryptfs-on-macos" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/gocryptfs-macos-macfuse.html#gocryptfs-on-macos"><span>gocryptfs on macOS</span></a></h2>
<p>Using gocryptfs on macOS requires <a href="https://osxfuse.github.io/">macFUSE</a>.
macFUSE (previously known as <a href="https://web.archive.org/web/20130710220229/https://osxfuse.github.io/">OSXFUSE</a>
(previously known as <a href="https://web.archive.org/web/20130704045540/http://code.google.com/p/macfuse/">MacFUSE</a>
lol TIL)) is an awesome project that allows to mount
<a href="https://www.kernel.org/doc/html/next/filesystems/fuse.html">FUSE</a>
filesystems on macOS.</p>
<p>All it takes is:</p>
<pre><code class="hljs language-sh">brew --cask install macfuse

<span class="hljs-comment"># Do the reboot dance to allow the kernel extension (see &quot;concerns&quot; below)</span>

brew install gromgit/fuse/gocryptfs-mac

<span class="hljs-comment"># Not needed but might as well have SSHFS around too</span>
brew install gromgit/fuse/sshfs-mac
</code></pre>
<div class="note">
<p><strong>Note:</strong> gocryptfs and SSHFS can‚Äôt be installed from Homebrew‚Äôs main
registry anymore <a href="https://github.com/Homebrew/homebrew-core/pull/74812#issuecomment-826895526">because</a>
they depend on macFUSE, which is not open-source.</p>
<p>This is why the above command installs from <a href="https://github.com/gromgit/homebrew-fuse">this repository</a>,
which hosts the Homebrew formulas that depend on FUSE that were dropped
from Homebrew.</p>
</div>
<h2 id="concerns-about-macfuse" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/gocryptfs-macos-macfuse.html#concerns-about-macfuse"><span>Concerns about macFUSE</span></a></h2>
<p>Sadly, macFUSE is not open-source. But at least it‚Äôs been updated
regularly for over 10 years, and keeps supporting the latest macOS
versions, so as long as this stays the case, I don‚Äôt mind using it.</p>
<p>That said, depending on macFUSE for a process as critical as my <a href="https://www.codejam.info/2024/04/offsite-backup-sync.html">offsite backups</a>
means that I will need to wait for it to support a new macOS version
before I deem to upgrade. Because it‚Äôs a kernel extension, it‚Äôs
not necessarily as easy to upgrade as other userland programs.</p>
<p>The other problem is that Apple <a href="https://developer.apple.com/support/kernel-extensions/">deprecated kernel extensions</a>
in 2020 with macOS Catalina (although they still work up to this date on
later versions). This is tracked in <a href="https://github.com/osxfuse/osxfuse/issues/987">this macFUSE issue</a>
but at the time of writing, Apple doesn‚Äôt provide APIs that allow to
implement macFUSE outside of a (now deprecated) kernel extension.</p>
<p>On top of that, going with the deprecation, Apple made it
<a href="https://github.com/osxfuse/osxfuse/issues/814">annoying</a>
to install kernel extensions on ARM Macs, by having to reboot in
recovery and enabling ‚Äúreduced security‚Äù mode (which is now <a href="https://support.apple.com/en-ca/guide/security/sec7d92dc49f/web">required</a>
for kernel extensions).</p>
<p>While macFUSE works now, and have been working for many years after the
original deprecation of kernel extensions by Apple, its future is still
somewhat unclear.</p>
<p>In future versions, will macOS drop some the APIs that macFUSE depend
on, without providing viable alternatives? Or will they entirely block
kernel extensions? And in the event they do provide viable alternative
APIs, how long will it take for macFUSE to support that new version?</p>
<p>Otherwise, is any of the alternatives like
<a href="https://www.fuse-t.org/">FUSE-T</a> gonna be solid enough by then? And
more importantly, is gocryptfs gonna work with those alternatives?
Actually, it won‚Äôt, because right now
<a href="https://github.com/hanwen/go-fuse">go-fuse</a> depends explicitly on
macFUSE.</p>
<p>So, I wasn‚Äôt ready to commit to that setup without having a somewhat
viable fallback.</p>
<h2 id="gocryptfs-on-macos-without-macfuse" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/gocryptfs-macos-macfuse.html#gocryptfs-on-macos-without-macfuse"><span>gocryptfs on macOS without macFUSE</span></a></h2>
<p>While FUSE, as we saw, is a bit of a challenge on macOS, it‚Äôs perfectly
fine on Linux. gocryptfs and FUSE on Linux are not going anywhere.</p>
<p>Now, <a href="https://github.com/lima-vm/lima">Lima</a> is a pretty sweet way to
run a Linux VM on macOS. Similarly to <a href="https://learn.microsoft.com/en-us/windows/wsl/install">WSL</a>
on Windows, Lima can drop you in a Linux shell on your Mac, with
transparent access to your files.</p>
<p>This means you can easily install gocryptfs in that Lima environment,
and use it there. Assuming I want to get an encrypted mount of my home
directory (<code>~</code>):</p>
<pre><code class="hljs language-sh">brew install lima

limactl start

lima sudo apt install gocryptfs

<span class="hljs-comment"># Init in a temp dir because Lima can&#x27;t write to the host filesystem</span>
lima gocryptfs -init -reverse /tmp/lima

<span class="hljs-comment"># From the host move the config file in the right place</span>
<span class="hljs-built_in">mv</span> /tmp/lima/.gocryptfs.reverse.conf ~

lima <span class="hljs-built_in">mkdir</span> -p /tmp/encrypted
lima gocryptfs -reverse ~ /tmp/encrypted
lima rsync --archive /tmp/encrypted <span class="hljs-string">&quot;<span class="hljs-variable">$DESTINATION</span>&quot;</span>
</code></pre>
<div class="note">
<p><strong>Note:</strong> Depending on how you connect to <code>$DESTINATION</code>, you may want to
copy/link your SSH config and keys inside the Linux home of the VM
user. For example:</p>
<pre><code class="hljs language-sh">lima <span class="hljs-built_in">ln</span> -s ~/.ssh/{config,id_ed25519*} <span class="hljs-string">&quot;<span class="hljs-subst">$(lima sh -c &#x27;echo $HOME&#x27;)</span>/.ssh&quot;</span>
</code></pre>
</div>
<h2 id="decrypting-remote-files" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/gocryptfs-macos-macfuse.html#decrypting-remote-files"><span>Decrypting remote files</span></a></h2>
<p>We can as easily do the opposite: use SSHFS to mount the remote
encrypted directory locally, then use gocryptfs to decrypt it and access
the files transparently.</p>
<pre><code class="hljs language-sh">lima sudo apt install sshfs

lima <span class="hljs-built_in">mkdir</span> -p /tmp/encrypted /tmp/decrypted
sshfs -o idmap=user <span class="hljs-string">&quot;<span class="hljs-variable">$DESTINATION</span>&quot;</span> /tmp/encrypted
gocryptfs /tmp/encrypted /tmp/decrypted
</code></pre>
<p>At that point we can browse the decrypted tree from the Lima shell,
however we can‚Äôt access it from the host.</p>
<h2 id="accessing-decrypted-files-from-the-host" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/gocryptfs-macos-macfuse.html#accessing-decrypted-files-from-the-host"><span>Accessing decrypted files from the host</span></a></h2>
<p>If Lima can access files from the host, why can‚Äôt the host access files
from Lima?</p>
<p>Well, it comes down again to the ability to us FUSE. In order to access
host files, Lima starts a SSHFS server on the macOS host, and then
mounts it via SSHFS (FUSE) inside the Linux VM. That‚Äôs fine, because
Linux have absolutely no issue with FUSE stuff.</p>
<p>The other way around however, we would need FUSE on the macOS side in
order to mount a SSHFS server running inside the VM. No bueno, because
we‚Äôre doing all this jazz to avoid dealing with FUSE on macOS in the
first place. üò¨</p>
<p>So if we‚Äôre not gonna use FUSE, we need to fallback to another protocol
that‚Äôs better supported on Mac, like WebDAV.</p>
<p>The best way I‚Äôve found to do that is actually to use a simple, plain Go
WebDAV server such as <a href="https://taoofmac.com/space/til/2022/11/25/2200">this one</a>.</p>
<p>Just point the server to serve the decrypted mount point from earlier.</p>
<p>We also need to edit the Lima VM config in
<code>~/.lima/default/lima.yaml</code> to forward the port the WebDAV server is
listening on, so we can access it from the host system, such as:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">portForwards:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">guestPort:</span> <span class="hljs-number">1234</span>
</code></pre>
<p>Then on the macOS side we can do:</p>
<pre><code class="hljs language-sh"><span class="hljs-built_in">mkdir</span> -p mountpoint
mount_webdav http://localhost:1234 mountpoint
</code></pre>
<p>Before going with the custom Go solution, I‚Äôve tried
<a href="https://wiki.gnome.org/phodav">ph·ªüdav</a>, because unlike most WebDAV
servers, it doesn‚Äôt require any kind of hairy configuration, and can be
spawned in a ad hoc way that just works. But the performance wasn‚Äôt as
good as the Go version. I‚Äôve also tried NFS, but that was much even
slower.</p>
<p>That said, don‚Äôt get your hopes too high. Even with the Go version, the
performance wasn‚Äôt super fast, but I believe it‚Äôs mainly because of
being run over SSHFS, so your mileage may vary depending on the network
bandwidth you have with your offsite server. But as a fallback, I‚Äôll
call it good enough anyway.</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1784030029187588316">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Encrypted offsite backup system: syncing üì≤</title>
    <link href="https://www.codejam.info/2024/04/offsite-backup-sync.html" />
    <id>https://www.codejam.info/2024/04/offsite-backup-sync.html</id>
    <updated>2024-04-26T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<div class="note">
<ol>
<li><a href="https://www.codejam.info/2024/04/offsite-backup-storage.html">Encrypted offsite backup system: storage üíæ</a></li>
<li>Encrypted offsite backup system: syncing üì≤</li>
</ol>
</div>
<p>In <a href="https://www.codejam.info/2024/04/offsite-backup-storage.html">the previous post</a> I decided to go with
a <a href="https://www.hetzner.com/storage/storage-box/">Hetzner Storage Box</a>
for my backups.</p>
<p>It supports a number of file transfer protocols as well as first-class
support for backup protocols like BorgBackup and Restic, and of course,
the venerated rsync.</p>
<p>I ended up settling for rsync, because it‚Äôs a lower level option than
BorgBackup and Restic, that gives me a ton of freedom do design my
backup system the way I want.</p>
<p>rsync is also incredibly simple to use and understand, and at the end of
the day it just syncs files from one place to another. There‚Äôs nothing
specific to rsync in the layout of my backups, so I don‚Äôt actually
<em>need</em> rsync for the backups to be usable. That‚Äôs a massive advantage.</p>
<p>It comes to the cost of having to take care of everything else myself,
in particular encryption, as well as incremental backups (which I chose
to not implement, although it‚Äôs <a href="https://www.codejam.info/2024/04/offsite-backup-sync.html#bonus-implementing-incremental-backups">possible</a>).</p>
<h2 id="other-tools-i-tried" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-sync.html#other-tools-i-tried"><span>Other tools I tried</span></a></h2>
<p>I also tried BorgBackup, Restic, Kopia, Duplicaciy, Duplicity.</p>
<p>Having chosen Hetzner as a backend, Kopia, Duplicacy and Duplicity
didn‚Äôt have native support so they were reduced to syncing over SFTP
which put them at a disadvantaged for speed compared to the other
options that had native support on Hetzner.</p>
<p>On top of that here‚Äôs a few notes of what turned me off for each of
those:</p>
<ul>
<li><strong>Kopia:</strong> I encountered issues setting it up with SFTP.</li>
<li><strong>Duplicacy:</strong>
<ul>
<li>Setting up the CLI wasn‚Äôt straightforward, had to resort to finding
info in some random forum posts.</li>
<li>Doesn‚Äôt support SSH aliases.</li>
<li>No way to configure a SSH key without being prompted every time.</li>
<li>May ask for SSH password / key in the middle of a backup so you
can‚Äôt just walk away.</li>
</ul>
</li>
<li><strong>Duplicity:</strong> can‚Äôt easily garbage collect old backups because they
all depend on each other, so it makes regaining space pretty cumbersome.</li>
<li><strong>Restic:</strong> was pretty impressed overall but rsync was significantly
faster despite both having native support on Hetzner.</li>
<li><strong>BorgBackup:</strong> I definitely tried it back then but it doesn‚Äôt seem
that I took any notes like for the other ones‚Ä¶ maybe I should try it
again at some point? With rsync it‚Äôs probably the one that would fit
the best my use case, but I guess I like how transparent is rsync.</li>
</ul>
<h2 id="syncing" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-sync.html#syncing"><span>Syncing</span></a></h2>
<p>The actual syncing part is super easy. I‚Äôm just going with a basic:</p>
<pre><code class="hljs language-sh">rsync <span class="hljs-string">&quot;<span class="hljs-variable">$SOURCE</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$DESTINATION</span>&quot;</span> --archive --delete
</code></pre>
<p>I‚Äôm also adding <code>--no-specials</code> and <code>--no-devices</code> if I‚Äôm backing up a
directory that could have some of those special handles.</p>
<p>I add <code>--exclude-from exclude-file</code> to ignore a bunch of patterns that
don‚Äôt need to be backed up.</p>
<p>And finally, I‚Äôm customizing the output with <code>--itemize-changes</code> and
<code>--info=progress2</code>.</p>
<h2 id="encryption" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-sync.html#encryption"><span>Encryption</span></a></h2>
<p>That‚Äôs where things get spicy, because rsync doesn‚Äôt do encryption
itself.</p>
<p>I found a blog post about <a href="https://www.gamecreatures.com/blog/2016/06/19/encrypted-offsite-rsync-backups/">encrypted offsite backups with rsync</a>
which is exactly what I was trying to do. It uses
<a href="https://vgough.github.io/encfs/">EncFS</a> as the encryption layer.</p>
<p>I ended up using <a href="https://nuetzlich.net/gocryptfs/">gocryptfs</a> on my
side, mainly because it‚Äôs still actively maintained.</p>
<p>gocryptfs allows you to have an encrypted directory on disk, and mount
the decrypted version to use it. But they also have a ‚Äúreverse‚Äù mode,
where you can mount a directory into its encrypted representation.
That‚Äôs what I need. (I just want the encryption for syncing to my remote
storage, the data is already encrypted on disk at a lower level
otherwise.)</p>
<p>With gocryptfs, that looks like:</p>
<pre><code class="hljs language-sh">gocryptfs -reverse -init /path/to/directory
gocryptfs -reverse /path/to/directory /path/to/mount
</code></pre>
<p>From there, I can apply my rsync command to sync the encrypted
<code>/path/to/mount</code> with my Hetzner server!</p>
<p>Not that complicated after all.</p>
<p>Well‚Ä¶ except if you‚Äôre running macOS. This rabbit hole is deep enough
that it <a href="https://www.codejam.info/2024/04/gocryptfs-macos-macfuse.html">deserves its own blog post</a>. üôÉ</p>
<h2 id="making-the-encrypted-rsync-output-intelligible" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-sync.html#making-the-encrypted-rsync-output-intelligible"><span>Making the encrypted rsync output intelligible</span></a></h2>
<p>Now we‚Äôre syncing an encrypted directory, the output of rsync only shows
the encrypted paths. That‚Äôs OK, but I don‚Äôt like it. I wish I saw the
<em>actual</em> files it was transferring, so that if one of them takes a long
time, I can instantly identify if it‚Äôs a file that should or not be
included in the backup anyway. Maybe just add it to my ignore list.</p>
<p>Luckily, gocryptfs provides an API to translated encrypted paths to
their plaintext version!</p>
<p>This comes through a separate util, <code>gocryptfs-xray</code>, that‚Äôs not
included in the Homebrew version, so we need to compile gocryptfs from
source:</p>
<pre><code class="hljs language-sh">git <span class="hljs-built_in">clone</span> https://github.com/rfjakob/gocryptfs

<span class="hljs-comment"># Checkout the version you actually want, or YOLO and build from `main`</span>
<span class="hljs-comment"># git checkout v2.4.0</span>

./build-without-openssl
</code></pre>
<p>Then make sure to add the <code>gocryptfs</code> and <code>gocryptfs-xray</code> binaries
somewhere that‚Äôs in your <code>PATH</code> (or just run them from there if you
prefer).</p>
<p><code>gocryptfs-xray</code> needs access to the gocryptfs <code>ctlsock</code>, a socket to
communicate with the gocryptfs process. You get one by adding <code>-ctlsock /path/to/ctlsock</code> to your <code>gocryptfs</code> invocation.</p>
<p>Then, we can parse the rsync output and translate any encrypted path in
its decrypted version. I made a script for that:
<a href="https://github.com/valeriangalliat/gocryptfs-rsync/blob/master/gocryptfs-rsync-pretty"><code>gocryptfs-rsync-pretty</code></a>.
Just pipe the rsync output to it:</p>
<pre><code class="hljs language-sh">rsync ... 2&gt;&amp;1 | gocryptfs-rsync-pretty /path/to/ctlsock /path/to/mount
</code></pre>
<h2 id="putting-it-all-together" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-sync.html#putting-it-all-together"><span>Putting it all together</span></a></h2>
<p>We now have a functional encrypted offsite backup system! It‚Äôs a
combination of:</p>
<ul>
<li>gocryptfs to mount an encrypted representation of a directory,</li>
<li>rsync to sync it to a remote host,</li>
<li>a small script to make the rsync output intelligible.</li>
</ul>
<p>In <a href="https://github.com/valeriangalliat/gocryptfs-rsync">this repo</a> you
can find the code I use to combine those 3 elements.</p>
<p>It‚Äôs not much more than:</p>
<pre><code class="hljs language-sh">gocryptfs -reverse -ctlsock /path/to/ctlsock /path/to/directory /path/to/mount

rsync <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span> /path/to/mount <span class="hljs-string">&quot;<span class="hljs-variable">$DESTINATION</span>&quot;</span> 2&gt;&amp;1 \
    | gocryptfs-rsync-pretty /path/to/ctlsock /path/to/mount
</code></pre>
<h2 id="bonus-implementing-incremental-backups" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-sync.html#bonus-implementing-incremental-backups"><span>Bonus: implementing incremental backups</span></a></h2>
<p>In my solution above, the backups are not incremental. I‚Äôm just syncing
the <em>current</em> state to the remote host, but I keep no history of the
previous ‚Äúsnapshots‚Äù. This could be an issue, for example, if I end up
running a backup <em>after</em> my systems gets compromised or after I lose
some data, then my backup is useless.</p>
<p>This is fine with me because I also do incremental backups that just
don‚Äôt happen to be offsite. I guess I‚Äôm not edging against my house
burning down or getting my computers and drives robbed, <em>while at the
same time</em> having experienced some kind of data loss that I‚Äôve
accidentally propagated to my offsite server. üôÉ</p>
<p>Anyway, in order to add incremental backups to the equation, we could
use <a href="https://github.com/cytopia/linux-timemachine">Linux Time Machine</a>
(which also works very well on Mac despite the name üòÅ).</p>
<p>It works very much like macOS Time Machine, pretty much down to the
underlying way the incremental backups are implemented on the
filesystem: each ‚Äúsnapshot‚Äù gets its own directory, but then files that
didn‚Äôt change since the latest snapshot are just hardlinked to avoid
duplication! So essentially, only the files that changed get stored, but
you still have a full picture of the snapshot because the other files
are hardlinked in the right place!</p>
<p>This is genius, and turns out this is provided by rsync through the
<code>--link-dest</code> option. Linux Time Machine adds a nice, easy to use
frontend to it which is very appreciated.</p>
<p>Building off our work from above, we can simply replace the <code>rsync</code>
command by <code>timemachine</code>:</p>
<pre><code class="hljs language-sh">gocryptfs -reverse -ctlsock /path/to/ctlsock /path/to/directory /path/to/mount

timemachine <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span> /path/to/mount <span class="hljs-string">&quot;<span class="hljs-variable">$DESTINATION</span>&quot;</span> 2&gt;&amp;1 \
    | gocryptfs-rsync-pretty /path/to/ctlsock /path/to/mount
</code></pre>
<p>This is possible because hard links are supported by Hetzner, and thanks
to native rsync support, they can be preserved along the way!</p>
<div class="note">
<p><strong>Note:</strong> I haven‚Äôt tested <code>gocryptfs-rsync-pretty</code> with the output of
<code>timemachine</code>, but because <code>timemachine</code> wraps rsync, it should work out
of the box, or require only basic tuning of the underlying rsync output.
Let me know if you try it!</p>
</div>
<h2 id="wrapping-up" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-sync.html#wrapping-up"><span>Wrapping up</span></a></h2>
<p>Despite only writing this today, I‚Äôve been using this system for <em>two
years</em> already! (Time flies omg.)</p>
<p>The commits I‚Äôve added over time were mostly to refine the rsync output
parsing, so looks like the core of the script was pretty solid from the
get go.</p>
<p>That setup survived at least two macOS upgrades, and I‚Äôve been using it
on my Linux machines as well.</p>
<p>So feel free to use <a href="https://github.com/valeriangalliat/gocryptfs-rsync">gocryptfs-rsync</a>
for your own backups, or use it as an inspiration to build your own
backup system! Cheers. ‚úåÔ∏è</p>
<div class="note">
<ol>
<li><a href="https://www.codejam.info/2024/04/offsite-backup-storage.html">Encrypted offsite backup system: storage üíæ</a></li>
<li>Encrypted offsite backup system: syncing üì≤</li>
</ol>
</div>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1784030027967062106">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Encrypted offsite backup system: storage üíæ</title>
    <link href="https://www.codejam.info/2024/04/offsite-backup-storage.html" />
    <id>https://www.codejam.info/2024/04/offsite-backup-storage.html</id>
    <updated>2024-04-26T07:00:00.000Z</updated>
    <content type="html"><![CDATA[<div class="note">
<ol>
<li>Encrypted offsite backup system: storage üíæ</li>
<li><a href="https://www.codejam.info/2024/04/offsite-backup-sync.html">Encrypted offsite backup system: syncing üì≤</a></li>
</ol>
</div>
<p><strong>Threat model:</strong> my house burns. Or someone breaks in and takes my
computers and hard drives. Everything‚Äôs encrypted so I‚Äôm not so worried
about them gaining access to my data but I‚Äôm concerned about losing my
data.<br>
<strong>Solution:</strong> offsite backup system.</p>
<p><strong>But then‚Ä¶ threat model:</strong> breach in the company / data center that hosts
my offsite backups, from a third-party attack or from maleovlent
employees.<br>
<strong>Solution:</strong> <em>end-to-end encrypted</em> offsite backup system.</p>
<h2 id="requirements" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-storage.html#requirements"><span>Requirements</span></a></h2>
<p>I have over 4 TB of data and I want a bit of buffer, so I‚Äôm only gonna
consider solutions for 5 TB of storage.</p>
<h2 id="comparison" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-storage.html#comparison"><span>Comparison</span></a></h2>
<p>Let‚Äôs start with everything I considered for offsite storage. If you
know better options, let me know!</p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Plan</th>
      <th>Storage</th>
      <th>Monthly price (billed annually)</th>
      <th>Monthly price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://www.sync.com/pricing/">Sync</a></td>
      <td>Teams+ Unlimited</td>
      <td>6 TB</td>
      <td>20 CAD</td>
      <td>24 CAD</td>
    </tr>
    <tr>
      <td><a href="https://web.archive.org/web/20221101213929/https://www.dropbox.com/plans"><s>Dropbox</s></a></td>
      <td><s>Standard</s></td>
      <td><s>5 TB</s></td>
      <td><s>15 USD</s></td>
      <td><s>18 USD</s></td>
    </tr>
    <tr>
      <td colspan="5">
        <em>Discontinued.</em>
      </td>
    </tr>
    <tr>
      <td><a href="https://www.dropbox.com/plans">Dropbox</a></td>
      <td>Business</td>
      <td>9 TB</td>
      <td>26 CAD</td>
      <td>31 CAD</td>
    </tr>
    <tr>
      <td><a href="https://one.google.com/about/plans"><s>Google One</s></a></td>
      <td><s>5 TB</s></td>
      <td><s>5 TB</s></td>
      <td><s>20.83 USD</s></td>
      <td><s>24.99 USD</s></td>
    </tr>
    <tr>
    <tr>
      <td colspan="5">
        <em>Discontinued. Google One doesn't offer more than 2 TB now so
        it's not an option anymore.</em>
      </td>
    </tr>
    <tr>
      <td><a href="https://learn.microsoft.com/en-us/answers/questions/577943/how-to-get-unlimited-onedrive-storage-for-my-enter"><s>OneDrive</s></a></td>
      <td><s>Business (Plan 2)</s></td>
      <td><s>Unlimited</s></td>
      <td><s>65 USD</s></td>
      <td></td>
    </tr>
    <tr>
      <td colspan="5">
        <em>Discontinued. OneDrive only offers up to 1 TB now. They used
        to have unlimited storage if you have 5 or more users with
        "Business (Plan 2)" at 13 USD per user.</em>
      </td>
    </tr>
    <tr>
      <td><a href="https://www.box.com/en-ca/pricing">Box Drive</a></td>
      <td>Business</td>
      <td>Unlimited</td>
      <td>63 CAD</td>
      <td>84 CAD</td>
    </tr>
    <tr>
      <td colspan="5">
        <em>21/28 CAD per user per month but need at least 3 users.</em>
      </td>
    </tr>
    <tr>
      <td><a href="https://mega.io/pricing">MEGA</a></td>
      <td>Pro II</td>
      <td>8 TB</td>
      <td>16.66 EUR</td>
      <td>19.99 EUR</td>
    </tr>
    <tr>
      <td colspan="2"><a href="https://www.backblaze.com/cloud-storage/pricing">Backblaze B2</a></td>
      <td>5 TB</td>
      <td colspan="2">30 USD*</td>
    </tr>
    <tr>
      <td colspan="5">
        <em>*And $0.01/GB to access the data, so that would be 50 USD
        for me to download my entire 5 TB backup once.</em>
      </td>
    </tr>
    <tr>
      <td colspan="2"><a href="https://www.backblaze.com/cloud-backup/pricing">Backblaze Computer Backup</a></td>
      <td>Unlimited</td>
      <td>8.25 USD*</td>
      <td>9 USD*</td>
    </tr>
    <tr>
      <td colspan="5">
        <em>*Per machine. And can only use through their own proprietary
        backup software with serious limitations.</em>
      </td>
    </tr>
    <tr>
      <td colspan="2"><a href="https://www.linode.com/products/object-storage/">Linode Object Storage</a></td>
      <td>5 TB</td>
      <td colspan="2">100 USD*</td>
    </tr>
    <tr>
      <td colspan="5">
        <em>*1 TB outbound transfer included, after that $0.005/GB, so
        that would be 20 USD for me to download my entire 5 TB backup
        once.</em>
      </td>
    </tr>
    <tr>
      <td><a href="https://www.apple.com/ca/icloud/#compare-plans">iCloud</a></td>
      <td>6 TB</td>
      <td>6 TB</td>
      <td colspan="2">39.99 CAD</td>
    </tr>
    <tr>
      <td><a href="https://www.hetzner.com/storage/storage-box/">Hetzner Storage Box</a></td>
      <td>BX21</td>
      <td>5 TB</td>
      <td colspan="2">10.90 EUR</td>
    </tr>
    <tr>
      <td><a href="https://www.hetzner.com/storage/storage-share/">Hetzner Storage Share</a></td>
      <td>NX21</td>
      <td>5 TB</td>
      <td colspan="2">14.19 EUR</td>
    </tr>
  </tbody>
</table>
<h2 id="diving-in" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-storage.html#diving-in"><span>Diving in</span></a></h2>
<h3 id="backblaze-computer-backup" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-storage.html#backblaze-computer-backup"><span>Backblaze Computer Backup</span></a></h3>
<p>Backblaze Computer Backup is incredibly cheap with 9 USD per month for
<em>unlimited storage</em>, but keep in mind the price is per machine, and
everything needs to go through their own proprietary backup software. No
Linux support, no way to customize the backup strategy, no way to script
it. The software needs to call home at least once a month otherwise data
gets deleted.</p>
<p>While the backups are encrypted, by default <a href="https://help.backblaze.com/hc/en-us/articles/217664688-Can-you-tell-me-more-about-the-encryption-Backblaze-uses">Backblaze can decrypt them</a>,
however they also provide a way to make the backups end-to-end
encrypted, which is nice.</p>
<p>So if you‚Äôre fine with the terms and limitations of their backup
software, then it‚Äôs by far the cheapest option and it seems convenient
to use.</p>
<h3 id="box-drive" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-storage.html#box-drive"><span>Box Drive</span></a></h3>
<p>Another ‚Äúunlimited storage‚Äù option without as many limitations as
Backblaze Computer Backup is Box Drive. It‚Äôs 63 CAD per month
though so quite a lot pricier. But if you have <em>a lot</em> of data and want
more control over it, that may be very well worth it.</p>
<p>It‚Äôs even cheaper than the unlimited OneDrive storage that Microsoft was
offering at some point for 65 USD per month.</p>
<p>Box Drive comes with a decent web interface as well as a native app for
macOS, Windows, iPhone and Android.</p>
<p>However keep in mind that it‚Äôs gonna behave like Dropbox and iCloud:
it‚Äôs great as a virtual remote drive that has a local copy of some or
all files, but it may not be what you want from a backup solution.</p>
<div class="note">
<p><strong>Note:</strong> on macOS, the app uses the <a href="https://developer.apple.com/documentation/fileprovider/nonreplicated_file_provider_extension">Nonreplicated File Provider extension</a>
to provide the syncing.</p>
</div>
<p>As far as encryption goes, it doesn‚Äôt seem that anything prevents Box to
access your data, so it‚Äôs something you have to be comfortable with.</p>
<h3 id="mega" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-storage.html#mega"><span>MEGA</span></a></h3>
<p>Pretty decent option at 16.66 EUR for 8 TB. Like the above, it comes
with an app, and it also supports Linux on top of macOS and Windows!</p>
<p>It‚Äôs basically a mix of the 2 products mentioned above. You can back up
entire devices to it, but also use it as a shared drive, so that‚Äôs
pretty neat.</p>
<p>However unlike the Box Drive app, all the files in the synced folder
must be present locally. There‚Äôs no way to have synced files being on
the server only and being downloaded on demand only when you need them
(and delete just the local copy afterwards).</p>
<div class="note">
<p><strong>Note:</strong> it seems that MEGA uses its own watching and syncing
algorithm, and they only use macOS‚Äôs <a href="https://developer.apple.com/documentation/findersync">Finder Sync API</a>
in order to provide feedback in the Finder UI about whether files are
synced or not.</p>
</div>
<p>So like for Box Drive, if you like the way it behaves, it‚Äôs a pretty
cheap and convenient solution. If you want more flexibility, they do
offer a SDK but you‚Äôll have to write C++. There‚Äôs also a
<a href="https://rclone.org/mega/">Rclone integration for MEGA</a> so that‚Äôs neat
to interact with the storage from the CLI and make something more custom
with it.</p>
<p>In terms of encryption, MEGA seems pretty solid because everything is
end-to-end encrypted with a key derived from your account password. If
you forget your password and recovery key, you‚Äôre out of luck, but that
also means MEGA can‚Äôt read your data. Thumbs up for me.</p>
<h3 id="hetzner-storage-box" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-storage.html#hetzner-storage-box"><span>Hetzner Storage Box</span></a></h3>
<p>At 10.90 EUR for 5 TB, it‚Äôs the cheapest option here to be <em>actually</em>
flexible. You don‚Äôt need a proprietary app to use it. Instead it
supports the following <a href="https://www.hetzner.com/storage/storage-box/">protocols</a>:</p>
<ul>
<li>FTP</li>
<li>FTPS</li>
<li>SFTP</li>
<li>SCP</li>
<li>Samba/CIFS</li>
<li>BorgBackup over SSH</li>
<li>Restic over SSH</li>
<li>Rclone over SFTP</li>
<li>rsync over SSH</li>
<li>HTTPS</li>
<li>WebDAV</li>
</ul>
<p>This is quite impressive, as it supports a number of popular backup
software, so unlike the options above, you don‚Äôt need to use a backup
or syncing software made by the storage provider. Hetzner only does the
storage (and does it well), and you can use the backup or syncing
software of your choice, whose only focus is to do just that (and do it
well). Now we‚Äôre talking.</p>
<p>Most of those protocols are gonna be useful for listing, retrieving and
uploading files, and the few options ‚Äúover SSH‚Äù are gonna be
particularly performant at incremental backups.</p>
<p>While backup and syncing software often have an option to working over
SFTP or similar, it‚Äôs usually pretty inefficient when you need to diff
the local and remote state in order to upload only what changed.</p>
<p>However, when paired with a companion command on the server, like is the
case with BorgBackup, Restic and rsync above, the process can be much,
much more efficient, because the client/server programs can exchange
just the minimum amount of metadata in order to determine what changed
and what needs to be transferred.</p>
<p><strong>This makes the Hetzner Storage Box a killer option if you‚Äôre gonna use
one of those natively supported options above.</strong></p>
<p>The encryption is gonna depend on the protocol you use. The files are
obviously stored encrypted on disk, and everything but FTP will transfer
the files encrypted, however only BorgBackup and Restic actually perform
end-to-end encryption of the files (meaning that Hetzner can‚Äôt decrypt
them).</p>
<p>If you want to use any other protocol and also want end-to-end
encryption, you can still implement it yourself as another layer. See
more <a href="https://www.codejam.info/2024/04/offsite-backup-sync.html">in the next article</a>. üòâ</p>
<h3 id="hetzner-storage-share" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-storage.html#hetzner-storage-share"><span>Hetzner Storage Share</span></a></h3>
<p>A bit pricier than the Storage Box at 14.19 EUR for 5 TB, and the use
case is a bit different. It‚Äôs a hosted
<a href="https://nextcloud.com/">Nextcloud</a> instance.</p>
<p>They have an app for Windows, macOS and Linux, as well as mobile apps. I
only tried the macOS app and it acts as a shared folder just like
Dropbox would.</p>
<p>At the time of writing, the desktop app will download all the files
locally, <a href="https://help.nextcloud.com/t/mac-desktop-client-dont-download-files-only-show-the-files/101987/4">there‚Äôs no way</a>
to browse the remote data without downloading everything locally first.
For me and my 5 TB, that‚Äôs a problem.</p>
<p>Also keep in mind Nextcloud <a href="https://help.nextcloud.com/t/end-to-end-encryption-zero-knowledge/172209">doesn‚Äôt support end-to-end encryption</a>.</p>
<p>So the Hetzner Storage Share looks like a pretty sweet option with a
decent price if you want a synced folder, but it doesn‚Äôt cut it for my
backups.</p>
<h2 id="bonus-why-not-gcp-and-aws" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-storage.html#bonus-why-not-gcp-and-aws"><span>Bonus: why not GCP and AWS?</span></a></h2>
<p><a href="https://cloud.google.com/">Google Cloud Platform</a> and <a href="https://aws.amazon.com/">Amazon Web Services</a>
both offer solutions that could help. So you may wonder why I‚Äôm not
considering a pure cloud storage service like <a href="https://cloud.google.com/storage">GCS</a>
or <a href="https://aws.amazon.com/s3/">S3</a>, or alternatively, a VM with
persistent disk on <a href="https://cloud.google.com/products/compute">GCE</a> or
<a href="https://aws.amazon.com/ec2/">EC2</a>.</p>
<p>Well, I did consider those option, that‚Äôs actually the one I
professionally work with most of the time, but they definitely did not
fit the bill for my personal usage.</p>
<h3 id="gcs-s3" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-storage.html#gcs-s3"><span>GCS/S3</span></a></h3>
<p>As usual with cloud computing, the pricing is hard to predict. Not
because the pricing model is unpredictable <em>per se</em> (although it‚Äôs
complex, it‚Äôs also relatively clear). But because my potential usage is
unpredictable without gathering data by running real-world simulations.</p>
<p>GCS and S3 charge not only for the amount of data stored, but also the
read/write operations and download bandwidth.</p>
<p>Depending on the selected storage class, either the storage itself is
expensive but reading/writing and downloading are relatively cheap, or
the storage is cheap but reading/writing and downloading gets much, much
more expensive.</p>
<p>GCS and S3 are pretty similar for this in pricing. So for my 5 TB, I
could either:</p>
<ul>
<li>Pay $100 per month for storage and spend $15 to download my entire backup.</li>
<li>Pay $50 per month for storage and spend $50 to download my entire backup.</li>
<li>Pay $20 per month for storage and spend $200 to download my entire backup.</li>
</ul>
<p>And it‚Äôs not a precise number because it‚Äôs really, really hard to
predict how many operations I will actually use. And it would be totally
possible that I‚Äôm missing some egress bandwidth fee on top of what‚Äôs
already factored in the data retrieval fees, and it could easily
surprise bump the bill by something like $400 in case of downloading the
entire backup.</p>
<p>Not down to take the risk.</p>
<h3 id="gce-ec2-vm" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-storage.html#gce-ec2-vm"><span>GCE/EC2 VM</span></a></h3>
<p>On GCE, it would cost ~$200 per month for a 5 TB HDD. Downloading the
entire backup would cost $400.</p>
<p>On EC2, that would be ~$80 per month for a 5 TB HDD, and $500 to
download the entire backup.</p>
<p>Not in my price range <em>at all</em>.</p>
<h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/04/offsite-backup-storage.html#conclusion"><span>Conclusion</span></a></h2>
<p>The <a href="https://www.codejam.info/2024/04/offsite-backup-storage.html#hetzner-storage-box">Hetzner Storage Box</a> was by far the best
option for me. It‚Äôs pretty cheap, and offers a ton of flexibility with
SFTP access as well as support for a number of protocols like rsync,
Restic and BorgBackup. End-to-end encryption comes for free with Restic
and BorgBackup, and can still be implemented ‚Äúmanually‚Äù otherwise.</p>
<p>All the other storage providers require a specific app that can‚Äôt be
customized to my needs, except for the <a href="https://www.codejam.info/2024/04/offsite-backup-storage.html#bonus-why-not-gcp-and-aws">cloud providers</a>
that are even more flexible but also insanely more expensive (and whose
pricing model can easily result in very costly surprises).</p>
<p>Also except for MEGA and Backblaze Computer Backup (as an option), the
other solutions don‚Äôt support end-to-end encryption.</p>
<p>So I subscribed for a 5 TB Hetzner Storage Box. Now, let‚Äôs see how I
<a href="https://www.codejam.info/2024/04/offsite-backup-sync.html">implemented end-to-end encryption and syncing</a>
with it!</p>
<div class="note">
<ol>
<li>Encrypted offsite backup system: storage üíæ</li>
<li><a href="https://www.codejam.info/2024/04/offsite-backup-sync.html">Encrypted offsite backup system: syncing üì≤</a></li>
</ol>
</div>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1784030026759110978">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Duplicated ESM and CJS package in bundle</title>
    <link href="https://www.codejam.info/2024/02/esm-cjs-dupe.html" />
    <id>https://www.codejam.info/2024/02/esm-cjs-dupe.html</id>
    <updated>2024-02-18T08:00:00.000Z</updated>
    <content type="html"><![CDATA[<div class="note">
<p><strong>Note:</strong> for context we‚Äôre in a Next.js TypeScript project, using
Webpack as a bundler, but I could see this happening with similar tools.</p>
<p>The problem occurred with the <a href="https://www.npmjs.com/package/firebase"><code>firebase</code></a>
package, but again that could happen with other packages.</p>
</div>
<p>So we upgrade the Firebase SDK by a few minor versions, and suddenly,
our JS bundle size blows up. Like, 50 kB more of (gzipped) JS shipped on
every page. Not good.</p>
<p>Luckily we have <a href="https://github.com/hashicorp/nextjs-bundle-analysis">tests</a>
to catch this kind of thing.</p>
<p>Further <a href="https://nextjs.org/docs/app/building-your-application/optimizing/bundle-analyzer">investigation</a>
shown that we were shipping <code>@firebase/app</code> and <code>@firebase/auth</code> twice. ü§î</p>
<h2 id="the-problem" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/02/esm-cjs-dupe.html#the-problem"><span>The problem</span></a></h2>
<p>We use <a href="https://github.com/gladly-team/next-firebase-auth">next-firebase-auth</a>
to integrate Firebase Auth with Next.js. next-firebase-auth imports
specifically <code>firebase/app</code> and <code>firebase/auth</code>.</p>
<p>In our own code, we use <code>import</code> to import our dependencies:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { getApp } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/app&#x27;</span>
<span class="hljs-keyword">import</span> { getAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/auth&#x27;</span>
</code></pre>
<p>But next-firebase-auth, while they do the same in their
<a href="https://github.com/gladly-team/next-firebase-auth/blob/d51bf07eecf727ef3df45587e4008551b0cb4803/src/initFirebaseClientSDK.ts#L1-L2">TypeScript source code</a>,
is actually bundled down (also with Webpack) to a <a href="https://socket.dev/npm/package/next-firebase-auth/files/1.0.2/build/index.browser.js">CJS file</a>.</p>
<p>The code is minified, but you can see it uses <code>require</code>:</p>
<pre><code class="hljs language-js"><span class="hljs-number">324</span>:<span class="hljs-function"><span class="hljs-params">e</span>=&gt;</span>{e.<span class="hljs-property">exports</span>=<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;firebase/app&quot;</span>)},<span class="hljs-number">610</span>:<span class="hljs-function"><span class="hljs-params">e</span>=&gt;</span>{e.<span class="hljs-property">exports</span>=<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;firebase/auth&quot;</span>)}
</code></pre>
<p>The problem is that the version of the Firebase SDK we upgraded to
contains <a href="https://github.com/firebase/firebase-js-sdk/pull/6981">this PR</a>,
that makes <code>@firebase/auth</code> export both ESM and CJS variants of their
<code>browser</code> bundle, whereas before they only exposed the ESM version for
the browser.</p>
<p>Concretely, this means that before this PR, the <code>package.json</code> of
<code>@firebase/auth</code> looked like:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;exports&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;.&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;default&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./dist/esm2017/index.js&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>And after:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;exports&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;.&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;default&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./dist/esm2017/index.js&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;browser&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">&quot;require&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./dist/browser-cjs/index.js&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;import&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./dist/esm2017/index.js&quot;</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Because initially there was no <code>browser</code> entry, Webpack picked the
<code>default</code> value for both <code>import</code> and <code>require</code>, which turns out to be
the ESM bundle.</p>
<p>However after that change, we now have a different bundle configured
depending if it‚Äôs imported with <code>import</code> or <code>require</code>. As
<a href="https://webpack.js.org/guides/package-exports/#import">documented</a>
Webpack will map <code>import</code> calls to the file under <code>import</code> in the
<code>package.json</code>, and <code>require</code> to the <code>require</code> field, which makes sense.</p>
<p>However this is a problem for us as we saw earlier, we use <code>import</code> in
our own codebase, but the distribution bundle of next-firebase-auth
(like probably many other packages in the ecosystem) only comes with a
CJS file using <code>require</code>.</p>
<p>This means our own code will use <code>@firebase/auth/dist/esm2017/index.js</code>,
while next-firebase-auth will use <code>@firebase/auth/dist/browser-cjs/index.js</code>.</p>
<p>Not only this increases our bundle size unnecessarily, but it breaks the
Firebase SDK as it depends on shared global state, and now different
parts of the codebase point to a different, isolated version of the SDK.</p>
<h2 id="this-sucks-and-nobody-s-to-blame-really" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/02/esm-cjs-dupe.html#this-sucks-and-nobody-s-to-blame-really"><span>This sucks, and nobody‚Äôs to blame really</span></a></h2>
<ul>
<li>It‚Äôs absolutely reasonable for the Firebase SDK to expose a different
browser bundle for <code>import</code> and <code>require</code>.</li>
<li>It‚Äôs absolutely reasonable, and even expected, that Webpack maps
<code>import</code> and <code>require</code> calls to the matching field in <code>package.json</code>.</li>
<li>It‚Äôs absolutely reasonable for next-firebase-auth to export a single
CJS bundle (that‚Äôs how npm packages look like since npm is a thing).</li>
</ul>
<p>It‚Äôs just a result of the giant fracture in the ecosystem between CJS
and ESM imports. It‚Äôs probably for the best, and I look forward to ESM
being widespread enough that we don‚Äôt encounter those problems, but the
transition is long and painful. It‚Äôs been 3-4 years I‚Äôm dealing with
this kind of issues as a package maintainer, and they tend to be
particularly time consuming, and takes away time to fix real problems or
implement new features.</p>
<h2 id="the-solution" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/02/esm-cjs-dupe.html#the-solution"><span>The solution</span></a></h2>
<p>As far as I‚Äôm concerned, for that particular instance of this problem,
the solution was to configure Webpack to alias <code>firebase/app</code> and
<code>firebase/auth</code> (the parts of the Firebase SDK used by
next-firebase-auth) to their ESM bundle, so this same bundle gets used
regardless if imported with <code>import</code> or <code>require</code>.</p>
<p>In the Webpack config:</p>
<pre><code class="hljs language-js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">&#x27;firebase/app&#x27;</span>: <span class="hljs-built_in">require</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;firebase/app&#x27;</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-string">&#x27;index.cjs.js&#x27;</span>, <span class="hljs-string">&#x27;index.mjs&#x27;</span>),
      <span class="hljs-string">&#x27;firebase/auth&#x27;</span>: <span class="hljs-built_in">require</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;firebase/auth&#x27;</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-string">&#x27;index.cjs.js&#x27;</span>, <span class="hljs-string">&#x27;index.mjs&#x27;</span>)
    }
  }
}
</code></pre>
<p>It‚Äôs something we‚Äôll have to maintain as we update the Firebase SDK, if
they were to change the layout of their distribution files, since this
doesn‚Äôt bother parsing the <code>package.json</code> <code>exports</code> field, but it‚Äôs good
enough.</p>
<h2 id="bonus" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/02/esm-cjs-dupe.html#bonus"><span>Bonus</span></a></h2>
<p>For reference, a <a href="https://github.com/webpack/webpack/issues/15967">related GitHub issue</a>
and <a href="https://github.com/webpack/webpack/discussions/18082">discussion</a>.</p>
<p>I‚Äôve also tried using
<a href="https://webpack.js.org/configuration/resolve/#resolveconditionnames"><code>resolve.conditionNames</code></a>
as follows, as a more generic fix to force <em>all</em> packages to use the ESM
build if present:</p>
<pre><code class="hljs language-js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">conditionNames</span>: [<span class="hljs-string">&#x27;import&#x27;</span>, <span class="hljs-string">&#x27;default&#x27;</span>]
  }
}
</code></pre>
<p>This would have been great as it would prevent similar (but maybe less
noticeable) duplication issues to happen in the dependency graph,
however, as you can expect, this will break some packages (in my case
some <code>@babel/runtime</code> imports), so I couldn‚Äôt go with that.</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1759280799852179929">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Identify the current system cursor in Swift</title>
    <link href="https://www.codejam.info/2024/02/current-system-cursor-swift.html" />
    <id>https://www.codejam.info/2024/02/current-system-cursor-swift.html</id>
    <updated>2024-02-04T08:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>Let‚Äôs say for some reason you have a Swift app, and you want to know
what‚Äôs the currently displayed macOS cursor (even when the cursor is
outside of your app).</p>
<p>Well, it‚Äôs tricker than you would expect.</p>
<h2 id="exploring-nscursor-currentsystem" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/02/current-system-cursor-swift.html#exploring-nscursor-currentsystem"><span>Exploring <code>NSCursor.currentSystem</code></span></a></h2>
<p>AppKit do expose <a href="https://developer.apple.com/documentation/appkit/nscursor/1533611-currentsystem"><code>NSCursor.currentSystem</code></a>
that returns a <code>NSCursor</code> instance for the current system:</p>
<blockquote>
<p>This method returns the current system cursor regardless of which
application set the cursor, and whether Cocoa or Carbon APIs were used
to set it.</p>
</blockquote>
<p>However, there‚Äôs no property on <code>NScursor</code> that lets it identify itself,
e.g. a <code>NSCursor</code> instance doesn‚Äôt <em>claim</em> to be a <code>NSCursor.arrow</code> or
<code>NSCursor.iBeam</code> or whatnot. You only get a hot spot point and the
cursor pixel data.</p>
<p>One would think we can test <code>NSCursor.currentSystem</code> against all the
known cursors to know which one is used, e.g.: <code>NSCursor.currentSystem == NSCursor.arrow</code>.</p>
<p>But this doesn‚Äôt work, because of a key detail. The return value of
<code>NSCursor.currentSystem</code> is:</p>
<blockquote>
<p>A cursor whose image and hot spot match those of the
currently-displayed cursor on the system.</p>
</blockquote>
<p>This is important, because while the hot spot and image data will indeed
match that of the current cursor, the implicit part is that the
<em>reference</em> of that <code>NSCursor</code> object will differ.</p>
<p>Actually, every time I access <code>NSCursor.currentSystem</code> I get a different
<code>NSCursor</code> reference:</p>
<pre><code class="hljs language-swift"><span class="hljs-keyword">import</span> Cocoa

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">NSObject</span>, <span class="hljs-title class_">NSApplicationDelegate</span> {
  <span class="hljs-keyword">func</span> <span class="hljs-title function_">applicationDidFinishLaunching</span>(<span class="hljs-keyword">_</span>: <span class="hljs-type">Notification</span>) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;currentSystem&quot;</span>, <span class="hljs-type">NSCursor</span>.currentSystem<span class="hljs-operator">!</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;currentSystem&quot;</span>, <span class="hljs-type">NSCursor</span>.currentSystem<span class="hljs-operator">!</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;currentSystem&quot;</span>, <span class="hljs-type">NSCursor</span>.currentSystem<span class="hljs-operator">!</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;arrow&quot;</span>, <span class="hljs-type">NSCursor</span>.arrow)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;arrow&quot;</span>, <span class="hljs-type">NSCursor</span>.arrow)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;arrow&quot;</span>, <span class="hljs-type">NSCursor</span>.arrow)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;iBeam&quot;</span>, <span class="hljs-type">NSCursor</span>.iBeam)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;iBeam&quot;</span>, <span class="hljs-type">NSCursor</span>.iBeam)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;iBeam&quot;</span>, <span class="hljs-type">NSCursor</span>.iBeam)
  }
}

<span class="hljs-keyword">let</span> app <span class="hljs-operator">=</span> <span class="hljs-type">NSApplication</span>.shared
<span class="hljs-keyword">let</span> delegate <span class="hljs-operator">=</span> <span class="hljs-type">AppDelegate</span>()

app.delegate <span class="hljs-operator">=</span> delegate
app.run()
</code></pre>
<div class="note">
<p><strong>Note:</strong> to run this, put it in a file e.g. <code>test.swift</code> and run with
<code>swift test.swift</code>.</p>
<p>Or <a href="https://github.com/apple/swift/issues/68785#issuecomment-1904624571">at the time of writing</a>:</p>
<pre><code class="hljs language-sh">DYLD_FRAMEWORK_PATH=/System/Library/Frameworks /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift test.swift
</code></pre>
<p>Otherwise it currently fails with:</p>
<pre><code class="hljs">JIT session error: Symbols not found: [ _OBJC_CLASS_$_NSCursor, _OBJC_CLASS_$_NSApplication ]
</code></pre>
</div>
<pre><code class="hljs">currentSystem &lt;NSCursor: 0x600003f001b0&gt;
currentSystem &lt;NSCursor: 0x600003f04a20&gt;
currentSystem &lt;NSCursor: 0x600003f7f1e0&gt;
arrow &lt;NSCursor: 0x600003f7cab0&gt;
arrow &lt;NSCursor: 0x600003f7cab0&gt;
arrow &lt;NSCursor: 0x600003f7cab0&gt;
iBeam &lt;NSCursor: 0x600003f7cb40&gt;
iBeam &lt;NSCursor: 0x600003f7cb40&gt;
iBeam &lt;NSCursor: 0x600003f7cb40&gt;
</code></pre>
<p>We can see the <code>currentSystem</code> cursor is a different object reference
every time it‚Äôs accessed, while <code>arrow</code> and <code>iBeam</code> are constant.</p>
<p>So we can‚Äôt identify the system cursor by comparing references. Bummer.</p>
<h2 id="going-creative" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/02/current-system-cursor-swift.html#going-creative"><span>Going creative</span></a></h2>
<p>Well if we can‚Äôt compare references, then we need to do with whatever it
is that we have: a hot spot point and pixel data.</p>
<p>Actually, we can probably get away with just the pixel data: since
conveniently the
<a href="https://developer.apple.com/documentation/foundation/data"><code>Data</code></a> type
is already
<a href="https://developer.apple.com/documentation/swift/hashable"><code>Hashable</code></a>,
we can simply stuff all the known cursors image data in a dictionary,
and try and identify the <code>currentSystem</code> cursor that way:</p>
<pre><code class="hljs language-swift"><span class="hljs-keyword">import</span> Cocoa

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">NSObject</span>, <span class="hljs-title class_">NSApplicationDelegate</span> {
  <span class="hljs-keyword">func</span> <span class="hljs-title function_">applicationDidFinishLaunching</span>(<span class="hljs-keyword">_</span>: <span class="hljs-type">Notification</span>) {
    <span class="hljs-keyword">let</span> cursors: [<span class="hljs-type">String</span>: <span class="hljs-type">NSCursor</span>] <span class="hljs-operator">=</span> [
      <span class="hljs-string">&quot;arrow&quot;</span>: .arrow,
      <span class="hljs-string">&quot;iBeam&quot;</span>: .iBeam,
      <span class="hljs-string">&quot;crosshair&quot;</span>: .crosshair,
      <span class="hljs-string">&quot;closedHand&quot;</span>: .closedHand,
      <span class="hljs-string">&quot;openHand&quot;</span>: .openHand,
      <span class="hljs-string">&quot;pointingHand&quot;</span>: .pointingHand,
      <span class="hljs-string">&quot;resizeLeft&quot;</span>: .resizeLeft,
      <span class="hljs-string">&quot;resizeRight&quot;</span>: .resizeRight,
      <span class="hljs-string">&quot;resizeLeftRight&quot;</span>: .resizeLeftRight,
      <span class="hljs-string">&quot;resizeUp&quot;</span>: .resizeUp,
      <span class="hljs-string">&quot;resizeDown&quot;</span>: .resizeDown,
      <span class="hljs-string">&quot;resizeUpDown&quot;</span>: .resizeUpDown,
      <span class="hljs-string">&quot;disappearingItem&quot;</span>: .disappearingItem,
      <span class="hljs-string">&quot;iBeamCursorForVerticalLayout&quot;</span>: .iBeamCursorForVerticalLayout,
      <span class="hljs-string">&quot;operationNotAllowed&quot;</span>: .operationNotAllowed,
      <span class="hljs-string">&quot;dragLink&quot;</span>: .dragLink,
      <span class="hljs-string">&quot;dragCopy&quot;</span>: .dragCopy,
      <span class="hljs-string">&quot;contextualMenu&quot;</span>: .contextualMenu,
    ]

    <span class="hljs-keyword">var</span> index: [<span class="hljs-type">Data</span>: <span class="hljs-type">String</span>] <span class="hljs-operator">=</span> [:]

    <span class="hljs-keyword">for</span> (name, cursor) <span class="hljs-keyword">in</span> cursors {
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> image <span class="hljs-operator">=</span> cursor.image.tiffRepresentation {
        index[image] <span class="hljs-operator">=</span> name
      }
    }

    <span class="hljs-type">Timer</span>.scheduledTimer(
      withTimeInterval: <span class="hljs-number">1</span>, repeats: <span class="hljs-literal">true</span>,
      block: { <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> cursor <span class="hljs-operator">=</span> index[<span class="hljs-type">NSCursor</span>.currentSystem<span class="hljs-operator">?</span>.image.tiffRepresentation <span class="hljs-operator">??</span> <span class="hljs-type">Data</span>()] {
          <span class="hljs-built_in">print</span>(cursor)
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Not found&quot;</span>)
        }
      })
  }
}

<span class="hljs-keyword">let</span> app <span class="hljs-operator">=</span> <span class="hljs-type">NSApplication</span>.shared
<span class="hljs-keyword">let</span> delegate <span class="hljs-operator">=</span> <span class="hljs-type">AppDelegate</span>()

app.delegate <span class="hljs-operator">=</span> delegate
app.run()
</code></pre>
<p>In my experience, this does great at identifying <code>arrow</code>, <code>pointingHand</code>
and <code>iBeam</code>. I don‚Äôt see the other default cursors used that much at
all.</p>
<p>And then other macOS UI elements use cursors that are not exposed
through <code>NSCursor</code>. The crosshair from the native screen capture tool is
not the same as <code>NSCursor.crosshair</code>, and the camera from the window
selection of that same tool is not exposed either. As for window
resizing cursors, they‚Äôre different from the ones exposed in
<code>NSCursor.resize*</code>.</p>
<p>Either way, this get the job done the vast majority of the time!</p>
<p>We can go a step further by hooking this up to a
<a href="https://developer.apple.com/documentation/appkit/nsresponder/1525114-mousemoved"><code>mouseMoved</code></a>
event:</p>
<pre><code class="hljs language-swift"><span class="hljs-type">NSEvent</span>.addGlobalMonitorForEvents(matching: [.mouseMoved]) { <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> cursor <span class="hljs-operator">=</span> index[<span class="hljs-type">NSCursor</span>.currentSystem<span class="hljs-operator">?</span>.image.tiffRepresentation <span class="hljs-operator">??</span> <span class="hljs-type">Data</span>()] {
    <span class="hljs-built_in">print</span>(cursor)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Not found&quot;</span>)
  }
}
</code></pre>
<p>This works quite well, but hashing the <code>currentSystem</code> cursor image data
on every mouse moved event (they can happen at quite a high rate) sounds
a bit aggressive.</p>
<p>If I was gonna use that code, I would probably debounce the events to
every 200 ms or so prior to resolving the cursor to avoid spending that
much CPU cycles computing hashes of the same image that just happens to
have a different <code>NSCursor</code> object reference. This will introduce a bit
of inaccuracy around cursor transitions but depending on your
application, this may or may not be a problem.</p>
<h2 id="aggressive-optimizing" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/02/current-system-cursor-swift.html#aggressive-optimizing"><span>Aggressive optimizing</span></a></h2>
<p>The above to work quite well, but even though I didn‚Äôt bother
benchmarking it, the mechanism of it makes me slightly uneasy about the
performance (although the debounce would help a lot).</p>
<p>However, if we take a step back, we can use a different approach that is
much easier from a computing perspective.</p>
<p>We noticed that in most cases, the only 3 cursors we‚Äôll run into are
arrow, pointing hand and I-beam. Luckily, they all have a different TIFF
image size!</p>
<pre><code class="hljs language-swift"><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;arrow&quot;</span>, <span class="hljs-type">NSCursor</span>.arrow.image.tiffRepresentation<span class="hljs-operator">!</span>.count)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;pointingHand&quot;</span>, <span class="hljs-type">NSCursor</span>.pointingHand.image.tiffRepresentation<span class="hljs-operator">!</span>.count)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;iBeam&quot;</span>, <span class="hljs-type">NSCursor</span>.iBeam.image.tiffRepresentation<span class="hljs-operator">!</span>.count)
</code></pre>
<pre><code class="hljs">arrow 204152
pointingHand 20892
iBeam 85056
</code></pre>
<div class="note">
<p><strong>Note:</strong> I say luckily, because many of the standard cursors actually
have the same image byte size, as seen here:</p>
<pre><code class="hljs">11932 crosshair
11932 resizeDown
11932 resizeLeft
11932 resizeLeftRight
11932 resizeRight
11932 resizeUp
11932 resizeUpDown
204152 arrow
20892 closedHand
20892 openHand
20892 pointingHand
22812 contextualMenu
22812 disappearingItem
22812 dragCopy
22812 operationNotAllowed
6172 iBeamCursorForVerticalLayout
7132 dragLink
85056 iBeam
</code></pre>
<p>In fact, <code>arrow</code> and <code>iBeam</code> are unique in that aspect! So all we have
to be fine with is <code>closedHand</code> and <code>openHand</code> being mistaken for
<code>pointingHand</code>, which is probably fine, especially <code>openHand</code> and
<code>closeHand</code> are seldom if ever used.</p>
</div>
<p>We can then simplify the earlier example to:</p>
<pre><code class="hljs language-swift"><span class="hljs-keyword">import</span> Cocoa

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">NSObject</span>, <span class="hljs-title class_">NSApplicationDelegate</span> {
  <span class="hljs-keyword">func</span> <span class="hljs-title function_">applicationDidFinishLaunching</span>(<span class="hljs-keyword">_</span>: <span class="hljs-type">Notification</span>) {
    <span class="hljs-keyword">let</span> cursors: [<span class="hljs-type">String</span>: <span class="hljs-type">NSCursor</span>] <span class="hljs-operator">=</span> [
      <span class="hljs-string">&quot;arrow&quot;</span>: .arrow,
      <span class="hljs-string">&quot;iBeam&quot;</span>: .iBeam,
      <span class="hljs-string">&quot;pointingHand&quot;</span>: .pointingHand,
    ]

    <span class="hljs-keyword">var</span> index: [<span class="hljs-type">Int</span>: <span class="hljs-type">String</span>] <span class="hljs-operator">=</span> [:]

    <span class="hljs-keyword">for</span> (name, cursor) <span class="hljs-keyword">in</span> cursors {
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> image <span class="hljs-operator">=</span> cursor.image.tiffRepresentation {
        index[image.count] <span class="hljs-operator">=</span> name
      }
    }

    <span class="hljs-type">NSEvent</span>.addGlobalMonitorForEvents(matching: [.mouseMoved]) { <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> cursor <span class="hljs-operator">=</span> index[<span class="hljs-type">NSCursor</span>.currentSystem<span class="hljs-operator">?</span>.image.tiffRepresentation<span class="hljs-operator">?</span>.count <span class="hljs-operator">??</span> <span class="hljs-number">0</span>] {
        <span class="hljs-built_in">print</span>(cursor)
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Not found&quot;</span>)
      }
    }
  }
}

<span class="hljs-keyword">let</span> app <span class="hljs-operator">=</span> <span class="hljs-type">NSApplication</span>.shared
<span class="hljs-keyword">let</span> delegate <span class="hljs-operator">=</span> <span class="hljs-type">AppDelegate</span>()

app.delegate <span class="hljs-operator">=</span> delegate
app.run()
</code></pre>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Swift: convert a delegate to async</title>
    <link href="https://www.codejam.info/2024/02/swift-delegate-to-async.html" />
    <id>https://www.codejam.info/2024/02/swift-delegate-to-async.html</id>
    <updated>2024-02-04T08:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>Let‚Äôs say we‚Äôre using
<a href="https://developer.apple.com/documentation/avfoundation">AVFoundation</a>
to do a screen capture in Swift. We want to response to
<code>didStartRecordingTo</code> and <code>didFinishRecordingTo</code> ‚Äúevents‚Äù, which is done
through the use of a delegate such as:</p>
<pre><code class="hljs language-swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RecordingDelegate</span>: <span class="hljs-title class_">NSObject</span>, <span class="hljs-title class_">AVCaptureFileOutputRecordingDelegate</span> {
  <span class="hljs-keyword">func</span> <span class="hljs-title function_">fileOutput</span>(<span class="hljs-keyword">_</span>: <span class="hljs-type">AVCaptureFileOutput</span>, <span class="hljs-params">didStartRecordingTo</span> <span class="hljs-keyword">_</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">from</span> <span class="hljs-keyword">_</span>: [<span class="hljs-type">AVCaptureConnection</span>])
  {
    <span class="hljs-comment">// Stuff</span>
  }

  <span class="hljs-keyword">func</span> <span class="hljs-title function_">fileOutput</span>(
    <span class="hljs-keyword">_</span>: <span class="hljs-type">AVCaptureFileOutput</span>, <span class="hljs-params">didFinishRecordingTo</span> <span class="hljs-keyword">_</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">from</span> <span class="hljs-keyword">_</span>: [<span class="hljs-type">AVCaptureConnection</span>],
    <span class="hljs-params">error</span>: <span class="hljs-type">Error</span>?
  ) {
    <span class="hljs-comment">// Stuff</span>
  }
}

<span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">AVCaptureSession</span>()
<span class="hljs-keyword">let</span> input <span class="hljs-operator">=</span> <span class="hljs-type">AVCaptureScreenInput</span>()
<span class="hljs-keyword">let</span> output <span class="hljs-operator">=</span> <span class="hljs-type">AVCaptureMovieFileOutput</span>()
<span class="hljs-keyword">let</span> delegate <span class="hljs-operator">=</span> <span class="hljs-type">RecordingDelegate</span>()

session.addInput(input)
session.addOutput(output)
session.startRunning()
output.startRecording(to: <span class="hljs-type">URL</span>(filePath: <span class="hljs-string">&quot;test.mov&quot;</span>), recordingDelegate: delegate)
</code></pre>
<p>That‚Äôs all good but the delegate makes my life a bit harder in terms of
managing the control flow of the code.</p>
<p>I would much rather something using async/await, e.g. (hypothetical code):</p>
<pre><code class="hljs language-swift"><span class="hljs-keyword">let</span> events <span class="hljs-operator">=</span> output.startRecording(to: <span class="hljs-type">URL</span>(filePath: <span class="hljs-string">&quot;test.mov&quot;</span>))

<span class="hljs-keyword">await</span> events.didStartRecording

<span class="hljs-comment">// Do stuff now the recording has started</span>

output.stopRecording()

<span class="hljs-keyword">await</span> events.didFinishRecording

<span class="hljs-comment">// Do stuff now the recording is finished</span>
</code></pre>
<p>In order to achieve that, we need a bit of plumbing code. Let‚Äôs add
callbacks to our delegate:</p>
<pre><code class="hljs language-swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RecordingDelegate</span>: <span class="hljs-title class_">NSObject</span>, <span class="hljs-title class_">AVCaptureFileOutputRecordingDelegate</span> {
  <span class="hljs-keyword">var</span> didStartRecording: () -&gt; <span class="hljs-type">Void</span> <span class="hljs-operator">=</span> {}
  <span class="hljs-keyword">var</span> didFinishRecording: (<span class="hljs-keyword">_</span> error: <span class="hljs-type">Error</span>?) -&gt; <span class="hljs-type">Void</span> <span class="hljs-operator">=</span> { <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span> }

  <span class="hljs-keyword">func</span> <span class="hljs-title function_">fileOutput</span>(<span class="hljs-keyword">_</span>: <span class="hljs-type">AVCaptureFileOutput</span>, <span class="hljs-params">didStartRecordingTo</span> <span class="hljs-keyword">_</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">from</span> <span class="hljs-keyword">_</span>: [<span class="hljs-type">AVCaptureConnection</span>])
  {
    <span class="hljs-keyword">self</span>.didStartRecording()
  }

  <span class="hljs-keyword">func</span> <span class="hljs-title function_">fileOutput</span>(
    <span class="hljs-keyword">_</span>: <span class="hljs-type">AVCaptureFileOutput</span>, <span class="hljs-params">didFinishRecordingTo</span> <span class="hljs-keyword">_</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">from</span> <span class="hljs-keyword">_</span>: [<span class="hljs-type">AVCaptureConnection</span>],
    <span class="hljs-params">error</span>: <span class="hljs-type">Error</span>?
  ) {
    <span class="hljs-keyword">self</span>.didFinishRecording(error)
  }
}
</code></pre>
<p>From there, we can use the <a href="https://developer.apple.com/documentation/swift/withcheckedcontinuation(function:_:)"><code>withCheckedContinuation</code></a>
function to convert a callback to an async result:</p>
<pre><code class="hljs language-swift"><span class="hljs-keyword">let</span> delegate <span class="hljs-operator">=</span> <span class="hljs-type">RecordingDelegate</span>()

<span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> didStartRecording: () <span class="hljs-operator">=</span> withCheckedContinuation { continuation <span class="hljs-keyword">in</span>
  delegate.didStartRecording <span class="hljs-operator">=</span> {
    continuation.resume()
  }
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> didFinishRecording: () <span class="hljs-operator">=</span> withCheckedContinuation { continuation <span class="hljs-keyword">in</span>
  delegate.didFinishRecording <span class="hljs-operator">=</span> { error <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error <span class="hljs-operator">=</span> error {
      continuation.resume(throwing: error)
    } <span class="hljs-keyword">else</span> {
      continuation.resume()
    }
  }
}

output.startRecording(to: <span class="hljs-type">URL</span>(filePath: <span class="hljs-string">&quot;test.mov&quot;</span>), recordingDelegate: delegate)

<span class="hljs-keyword">await</span> didStartRecording

<span class="hljs-comment">// Do stuff now the recording has started</span>

output.stopRecording()

<span class="hljs-keyword">await</span> didFinishRecording

<span class="hljs-comment">// Do stuff now the recording is finished</span>
</code></pre>
<p>Thanks to <code>withCheckedContinuation</code>, we can get an async result for the
<code>didStartRecording</code> and <code>didFinishRecording</code> events, that we‚Äôre free to
<code>await</code> whenever is most convenient!</p>
<div class="note">
<p><strong>Note:</strong> the code above is not perfect. In some cases, we may get an
event on <code>didFinishRecordingTo</code> with an error, before
<code>didStartRecordingTo</code> was called at all. In that case, that example
would just hang forever.</p>
</div>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>Life update: Squamish, climbing, skiing‚Ä¶</title>
    <link href="https://www.codejam.info/2024/01/now.html" />
    <id>https://www.codejam.info/2024/01/now.html</id>
    <updated>2024-01-21T08:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>In last <a href="https://www.codejam.info/2023/03/now.html">update</a>, I was <a href="https://www.codejam.info/2023/03/now.html#what-do-you-think-of-the-now-page">reflecting</a>
on how I didn‚Äôt like that the content of the now page was ephemeral. So
I moved it to a normal blog post, a bit like a year in review post
except it doesn‚Äôt have to be about a particular year, but just some ad
hoc update.</p>
<h2 id="moved-to-squamish" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/01/now.html#moved-to-squamish"><span>Moved to Squamish</span></a></h2>
<p>In November 2023, I moved from Montreal to Squamish in western Canada,
British Columbia.</p>
<p>Squamish is a relatively small town (25,000 people), 1 hour drive north
of Vancouver. It‚Äôs in the middle of mountains and that‚Äôs why I‚Äôm here.</p>
<p>After 8 years in Montreal, in flat, flat Quebec, it was time for me to
move back to the mountains. While the BC mountains are 8,000 km away
from the ones I grew up in (French Alps), it instantly felt like home.</p>
<figure class="grid">
  <img alt="Plane" srcset="../../img/2024/01/now/plane.jpg 2x">
  <img alt="City" srcset="../../img/2024/01/now/city.jpg 2x">
</figure>
<p>I packed a U-Haul U-Box container from Montreal and had it shipped to
Vancouver. Took approximately 2 weeks, not too bad. Then rented a van to
move my stuff back home. Experience was flawless, and hardly beatable
for the price.</p>
<p>I didn‚Äôt bring any furniture, but it allowed me to keep my guitars and
vinyls collection and other emotional items, as well as all my sport
gear (including my road bike), tools, kitchen stuff and so on, so I
didn‚Äôt have to start from scratch all over again. It‚Äôs good not having
to buy a screwdriver, can opener and all those small things you think
about only when you need them.</p>
<figure class="grid">
  <img alt="U-Box" srcset="../../img/2024/01/now/box.jpg 2x">
  <img alt="Van" srcset="../../img/2024/01/now/van.jpg 2x">
</figure>
<p>Despite being small, the place I moved in has quite a nice view. Also
bought a car for the first time since I‚Äôm in Canada. Quite necessary
since there‚Äôs no carsharing option in Squamish.</p>
<figure class="grid">
  <img alt="View" srcset="../../img/2024/01/now/view.jpg 2x">
  <img alt="Car" srcset="../../img/2024/01/now/car.jpg 2x">
</figure>
<p>Overall, it‚Äôs a perfect base camp for rock climbing, mountain and gravel
biking, hiking, trail running and skiing (resort and backcountry).
That‚Äôs for the sports I‚Äôm doing, but there‚Äôs even more to this place!</p>
<h2 id="climbed-in-red-rocks-nevada" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/01/now.html#climbed-in-red-rocks-nevada"><span>Climbed in Red Rocks, Nevada</span></a></h2>
<p>With a couple of friends, spent two weeks in Las Vegas to go climb in
the Red Rocks canyon. This was an epic trip, and had fantastic climbing,
bouldering and hiking. (Last picture was during a day trip to Zion.)</p>
<figure class="grid">
  <img alt="Red Rocks" srcset="../../img/2024/01/now/red-rocks-1.jpg 2x">
  <img alt="Red Rocks" srcset="../../img/2024/01/now/red-rocks-2.jpg 2x">
  <img alt="Red Rocks" srcset="../../img/2024/01/now/red-rocks-3.jpg 2x">
  <img alt="Red Rocks" srcset="../../img/2024/01/now/red-rocks-4.jpg 2x">
  <img alt="Zion" srcset="../../img/2024/01/now/zion.jpg 2x">
</figure>
<h2 id="scarface" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/01/now.html#scarface"><span>Scarface</span></a></h2>
<p>A month before moving to Squamish, I crashed on my bike while commuting.
A combination of tires being too old, low pressure, being on gravel,
going fast, and a small bump, resulted in blowing the front tire, which
somehow escalated into dislodging the front wheel.</p>
<p>It felt like the ground vanishing under me (super weird feeling), and a
fraction of a second later I was on the floor.</p>
<p>Cracked my helmet (no brain damage thankfully), teared open my face in a
major way along the line of my jaw, and ‚Äúroad rash‚Äù all over my arms and
hands. Had to get stitches on my face. Wound got infected after that (if
the wound smells funky, take antibiotics, lesson learnt). Left me with a
fat scar on my face.</p>
<p>It‚Äôs mostly just cosmetic as far as I can tell. Life goes on.</p>
<h2 id="skiing" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2024/01/now.html#skiing"><span>Skiing</span></a></h2>
<p>Ski season‚Äôs on! Apparently not the best season here in BC in terms of
snow, but still orders of magnitude better than what I was used to
around Montreal. Can‚Äôt complain. Got big mountains and more powder than
I‚Äôve ever seen even on ‚Äúbad‚Äù days.</p>
<p>Did some backcountry early season when avalanche risk was essentially
non-existent. Moved to the resort (Whistler) as snow piled up and
avalanche risk increased. Bought a beacon, shovel and probe and gonna do
an avalanche training soon so I can go back to the backcountry safely.</p>
<figure class="video">
  <iframe src="https://www.youtube.com/embed/FdTZBoKhI4g" allowfullscreen></iframe>
</figure>
<p>The video above is on the main channel, but I‚Äôve started using my
<a href="https://www.youtube.com/@FonkyVal">secondary channel</a> a bit more to
publish skiing videos! I didn‚Äôt want to flood the main channel with
skiing stuff since it‚Äôs mostly focused on music in the first place. Go
subscribe!</p>
]]></content>
  </entry>
  <entry>
    <title>Branch Verve office chair: make it taller!</title>
    <link href="https://www.codejam.info/2023/07/branch-verve-office-chair-taller.html" />
    <id>https://www.codejam.info/2023/07/branch-verve-office-chair-taller.html</id>
    <updated>2023-07-28T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>I recently bought the <a href="https://www.branchfurniture.ca/products/verve-chair">Verve chair</a>
by Branch as an upgrade for my office. It was quite pricey, but not
Herman Miller pricey, and it‚Äôs really comfortable.</p>
<p>Before that, I was sitting on the <a href="https://www.ikea.com/ca/en/p/jaervfjaellet-office-chair-with-armrests-grann-white-70521855/">J√ÑRVFJ√ÑLLET chair from Ikea</a>,
and to be fair, for half the price of the Verve chair, it was easily 80%
of the comfort. I had no trouble sitting on it all day long, and that‚Äôs
even without putting the armrests because I like to play guitar!</p>
<p><strong>Anyways, I‚Äôve had only one complaint about the Verve chair: it‚Äôs too
short!</strong> Its highest setting is still pretty low, and that just doesn‚Äôt
cut it for 1. me being a tall guy and 2. my workstation being a tad
higher than your typical office desk.</p>
<p>Quite a number of reviews did mention that issue, but you know how it
is, I only searched the reviews for that particular problem once I
encountered it. üò¨</p>
<h2 id="how-to-make-the-chair-taller" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2023/07/branch-verve-office-chair-taller.html#how-to-make-the-chair-taller"><span>How to make the chair taller</span></a></h2>
<p>As far as I know, this is gonna be applicable to pretty much any office
chair. <strong>The best thing you can do is replace the gas cylinder for a
taller one.</strong></p>
<p>Luckily, this seems to be standard, and the Verve chair was no
exception. I‚Äôve got <a href="https://amzn.to/455kzjv">one off Amazon</a>. Pretty
much any replacement ones I browsed through were taller than the one
that came with the chair, and tall enough for me. Double check the size
for your particular situation though!</p>
<p>In order to replace the cylinder, I also had to buy a
<a href="https://amzn.to/44BRIDD">mallet</a> in order to pop the old one out
without damaging it. (Really, get a mallet if you don‚Äôt have one, I
struggled pretty hard with a hammer and couldn‚Äôt get it out, then a
single tap with the mallet once I got it got the job done.)</p>
<p>I‚Äôve also got some <a href="https://amzn.to/3Y9d3lr">replacement casters with brakes</a>
because <a href="https://www.codejam.info/2021/01/ikea-office-chair-lock-wheels-uneven-floor.html">my floor is still slanted</a>.
If even with a new cylinder your chair is not tall enough, you can
consider getting some those <a href="https://amzn.to/3OxpnbT">rollerblade-style casters</a>
that are gonna be taller than standard wheels, and apparently have a
bunch of advantages like not damaging floors, working better on carpets,
and being smoother in general, and obviously a sick look. Although I
didn‚Äôt get to try them yet.</p>
<h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2023/07/branch-verve-office-chair-taller.html#conclusion"><span>Conclusion</span></a></h2>
<figure class="center">
  <img alt="Verve chair in my office" src="https://www.codejam.info/img/2023/07/verve/chair.jpg">
</figure>
<p>In the beginning I was so disappointed to find that I couldn‚Äôt use my
brand new chair because it was too short, but at the end of the day it
was actually pretty easy to fix. A $30 replacement gas cylinder and a
cheap mallet got the job done in no time.</p>
<p>That being said, given the price of the chair,  I wish I didn‚Äôt have to
go through that extra trouble.</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
  <entry>
    <title>V√∂lkl Touristick ski poles &amp; Komperdell Ice-Flex baskets</title>
    <link href="https://www.codejam.info/2023/07/volkl-touristick-komperdell-ice-flex.html" />
    <id>https://www.codejam.info/2023/07/volkl-touristick-komperdell-ice-flex.html</id>
    <updated>2023-07-27T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>I recently bought adjustable ski poles as I was getting into backcountry
skiing. I got the <a href="https://volkl.com/en-ca/p/touristick-ac-poles-adjustable-2023">V√∂lkl Touristick AC</a>.</p>
<p>The poles are great. They‚Äôre lightweight (224 g per pole), the extended
grip is super convenient, and they feel really solid.</p>
<p>However the ‚Äúpowder baskets‚Äù they came with are as tiny as they look on
the product picture. In fact, they have a diameter of 7 cm, which is
just 1 cm more than my groomer poles baskets. üòÖ</p>
<p>Here‚Äôs a comparison of the stock basket (right) with an actual, 10 cm
powder basket (left).</p>
<figure class="center">
  <img alt="" src="https://www.codejam.info/img/2023/07/poles/comparison.jpg">
</figure>
<p>This is much smaller than the competition for backcountry touring ski
poles. For example the <a href="https://www.atomic.com/en-ca/shop/product/bct-touring-aj5005732.html">Atomic BCT Touring</a>
comes with 8.5 cm baskets, and their <a href="https://www.atomic.com/en-ca/shop/product/backland-fr-aj5005314.html">Backland
Freeride</a>
model comes with 9.7 cm baskets. The <a href="https://www.blackdiamondequipment.com/en_US/product/traverse-ski-poles/">Black Diamond Traverse</a>
have 10 cm baskets, and the <a href="https://www.black-crows.com/ca/fr/p/-batons-oxus/101724-020-115.html">Black Crows
Oxus</a>
have 9 cm baskets.</p>
<p>Even a random <a href="https://amzn.to/3OyATE8">cheap powder basket you find on Amazon</a>
is 8.7 cm.</p>
<p>Those small stock baskets provide little to no flotation on deep fluffy
powder. And what do we backcountry skiers like to ski the most? Deep.
Fluffly. Powder.</p>
<figure class="grid grid-2">
  <img alt="" src="https://www.codejam.info/img/2023/07/poles/deep.jpg">
  <img alt="" src="https://www.codejam.info/img/2023/07/poles/powder.jpg">
  <figcaption>You can evaluate the performance of the stock baskets on the second image.</figcaption>
</figure>
<p>So why am I writing this instead of buying the aforementioned cheap
powder baskets on Amazon and installing it on my new poles?</p>
<h2 id="introducing-the-komperdell-ice-flex-system" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2023/07/volkl-touristick-komperdell-ice-flex.html#introducing-the-komperdell-ice-flex-system"><span>Introducing the Komperdell Ice-Flex system</span></a></h2>
<p>It turns out the Touristick poles come with a proprietary basket system
by Komperdell. It means you can‚Äôt just screw on any replacement baskets.
It‚Äôs only compatible with Komperdell Ice-Flex‚Ñ¢ baskets.</p>
<p>It‚Äôs defined as a <strong>‚Äúmoveable basket system, that adapts up to 28¬∞ to the
slope inclination‚Äù</strong>. It‚Äôs not exactly obvious what this means, so I
made a quick video to show the mechanism.</p>
<figure class="video">
  <iframe src="https://www.youtube.com/embed/hloFNTuovyo" allowfullscreen></iframe>
</figure>
<p>It doesn‚Äôt seem that this mechanism is widely adopted. I‚Äôve only found
it on Komperdell‚Äôs own poles and V√∂lkl. Depending on where you live
around the world, it may be extremely hard if not impossible to put your
hand on a wider, compatible basket.</p>
<div class="note">
<p><strong>Note:</strong> don‚Äôt confuse it with the Vario basket system (which is
defined as ‚Äúeasy and quick to change‚Äù) because the mounting mechanism is
not gonna be compatible, although it seems a bit more common.</p>
<p>Sidenote, the Ice-Flex baskets were definitely <em>not</em> easy and quick to
change. It took quite a lot of force to clip the basket to the tip, and
same to remove it. Although after a few times taking off and on the
same basket and clip piece, it gets much easier.</p>
</div>
<p>On their website you can look for baskets
<a href="https://www.komperdell.com/en/Poles/Accessories/Baskets/?order=price-desc&amp;p=1&amp;properties=0b437375a8a343b89a327d5f8d327cf0">specifically compatible with the Ice-Flex system</a>,
but they don‚Äôt ship outside Europe, and even if you do live in Europe,
paying ‚Ç¨20 for a ‚Ç¨11.95 pair of baskets is quite steep.</p>
<p>You‚Äôve got 4 options:</p>
<ul>
<li><a href="https://www.komperdell.com/en/Regular-UL-Iceflake-Basket/K9949-925-UNI">Regular UL Ice-Flex basket</a></li>
<li><a href="https://www.komperdell.com/en/Ice-Flex-Basket/K9396-925-UNI">Regular Ice-Flex basket</a></li>
<li><a href="https://www.komperdell.com/en/Large-UL-Iceflake-Basket/K9950-925-UNI">Large UL Ice-Flex basket</a></li>
<li><a href="https://www.komperdell.com/en/Ice-Flex-Winter-Basket-XL/K9385-925-UNI">Large Ice-Flex basket</a></li>
</ul>
<p>It‚Äôs not clear to me what UL means (maybe ultralight?), but it‚Äôs
basically the ‚Äúrounded hexagon‚Äù shape you can see on the right in <a href="https://www.codejam.info/img/2023/07/poles/comparison.jpg">this
picture</a>, while the other kind (not UL) is a
more standard snowflake shape.</p>
<p>They don‚Äôt list the basket diameters on the website, but my guess based
on the ones I managed to get is:</p>
<ul>
<li><strong>Regular UL Ice-Flex basket:</strong> 7 cm <small>(assuming those are the ones that came with my poles)</small></li>
<li><strong>Regular snowflake Ice-Flex basket:</strong> 8.5 cm <small>(I don‚Äôt have those, but they list 8.5 cm on <a href="https://www.tradeinn.com/trekkinn/en/komperdell-ice-flex-winter-basket/136969928/p">this site</a>)</small></li>
<li><strong>Large UL Ice-Flex basket:</strong> 9.5 cm</li>
<li><strong>Large snowflake Ice-Flex basket:</strong> 10 cm</li>
</ul>
<p>I hope you found the information you were looking for. Let me know if
you have any questions or if you want to add any extra information that
could make this post even more useful.</p>
<p>Hopefully someday Komperdell will distribute those wider baskets in
North America. Cheers!</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
]]></content>
  </entry>
</feed>
