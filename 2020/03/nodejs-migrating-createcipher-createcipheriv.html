<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Node.js: migrating from createCipher to createCipheriv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github.css">
  <link rel="stylesheet" href="/css/main-20220617.css">
  <link rel="icon" href="/favicon.ico" data-emoji="üèïÔ∏è">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="Node.js: migrating from createCipher to createCipheriv">
  <meta property="og:description" content="If you still use the createCipher and createDecipher methods of the crypto module, you‚Äôre likely getting the following deprecation warnings when running your code:">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
    </ul>
    <ul class="social">
  <li>
    <a href="https://twitter.com/valeriangalliat">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>Twitter</title>
        <use href="/img/icons/407-twitter.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://github.com/valeriangalliat">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>GitHub</title>
        <use href="/img/icons/433-github.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://www.instagram.com/funkyval_/">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>Instagram</title>
        <use href="/img/icons/403-instagram.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://www.youtube.com/FunkyVal">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>YouTube</title>
        <use href="/img/icons/414-youtube.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://ko-fi.com/funkyval">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>Buy me a coffee!</title>
        <use href="/img/icons/219-heart.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="/feed.xml">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>RSS</title>
        <use href="/img/icons/412-rss.svg#icon"></use>
      </svg>
    </a>
  </li>
</ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>Node.js: migrating from <code>createCipher</code> to <code>createCipheriv</code></h1>
<p class="date">March 14, 2020</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>If you still use the <code>createCipher</code> and <code>createDecipher</code> methods of the
<code>crypto</code> module, you‚Äôre likely getting the following deprecation
warnings when running your code:</p>
<pre><code class="hljs">(node:477082) [DEP0106] DeprecationWarning: crypto.createCipher is deprecated.
(node:468005) [DEP0106] DeprecationWarning: crypto.createDecipher is deprecated.
</code></pre>
<p>This is because this method didn‚Äôt allow for passing an initialization
vector (IV), and instead derived the IV from the key using the OpenSSL
<code>EVP_BytesToKey</code> derivation function, using a <code>null</code> salt meaning that
the IV would be deterministic for a given key which is an issue for
ciphers with counter mode like CTR, GCM and CCM.</p>
<p>Your code might have looked like:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> cipher = crypto.<span class="hljs-title function_">createCipher</span>(<span class="hljs-string">&#x27;aes256&#x27;</span>, key)
</code></pre>
<p>If you want to make this code backwards compatible, you need to call
OpenSSL‚Äôs <code>EVP_BytesToKey</code> function yourself, typically through
<a href="https://www.npmjs.com/package/evp_bytestokey">this module</a> which makes
it available in JS userland.</p>
<p>However the reason this function is deprecated in the first place is
because you shouldn‚Äôt use it, and instead use a random unpredictable IV,
which requires you to change your code to something like this:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> iv = crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">16</span>)
<span class="hljs-keyword">const</span> cipher = crypto.<span class="hljs-title function_">createCipher</span>(<span class="hljs-string">&#x27;aes256&#x27;</span>, key, iv)
</code></pre>
<p>Here, for AES-256 in CBC mode (<code>aes256</code> being aliased to <code>AES-256-CBC</code> by
OpenSSL), the IV size is expected to be the same as the block size,
which is always 16 bytes.</p>
<p>In order to decrypt the message, you will need the IV as well. Typically
you‚Äôd store the IV together with the message, as the important part is
for the IV to not be predictable ahead of time.</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
  </div>
  <footer>
    <figure>
      <a href="/val.html">
        <img alt="The author (Val) looking at a beer glass shining in the beautiful sun" src="/img/profile.jpg">
      </a>
    </figure>
    <div class="footer-content">
      <p>
        Made with üß° by <a href="/val.html">Val</a>.
        Generated from a <abbr title="Pull requests welcome!"><a href="https://github.com/valeriangalliat/blog/tree/master/2020/03/nodejs-migrating-createcipher-createcipheriv.md">public repository</a></abbr>.
      </p>
      <ul class="social">
  <li>
    <a href="https://twitter.com/valeriangalliat">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>Twitter</title>
        <use href="/img/icons/407-twitter.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://github.com/valeriangalliat">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>GitHub</title>
        <use href="/img/icons/433-github.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://www.instagram.com/funkyval_/">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>Instagram</title>
        <use href="/img/icons/403-instagram.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://www.youtube.com/FunkyVal">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>YouTube</title>
        <use href="/img/icons/414-youtube.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="https://ko-fi.com/funkyval">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>Buy me a coffee!</title>
        <use href="/img/icons/219-heart.svg#icon"></use>
      </svg>
    </a>
  </li>
  <li>
    <a href="/feed.xml">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <title>RSS</title>
        <use href="/img/icons/412-rss.svg#icon"></use>
      </svg>
    </a>
  </li>
</ul>
    </div>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20210719.js"></script>
</body>
</html>
