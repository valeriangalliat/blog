<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Firefox credit card autofill not working on Linux</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>document.documentElement.classList.add(localStorage.theme || ((matchMedia && matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light'))</script>
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github-20220617.css">
  <link rel="stylesheet" href="/css/main-20230317.css">
  <link rel="icon" href="/favicon.ico" data-emoji="üèïÔ∏è">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="Firefox credit card autofill not working on Linux">
  <meta property="og:description" content="Firefox 79 introduced credit card autofill capability back in summer 2020. The feature is limited to a few regions, starting with US, and now supporting US, CA, UK, FR and DE.">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
      <li><a href="https://photography.codejam.info/">Photography</a></li>
      <li class="pull"><button title="Toggle theme" class="change-color-theme">üåù</button></li>
    </ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>Firefox credit card autofill not working on Linux</h1>
<p class="date">May 5, 2022</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>Firefox 79 <a href="https://techdows.com/2020/07/firefox-autofiil-credit-card.html">introduced</a>
credit card autofill capability back in summer 2020. The feature is
limited to a few regions, starting with US, and now supporting US, CA,
UK, FR and DE.</p>
<p>Today, I‚Äôm using Firefox 101 in Canada, and I noticed this feature
wasn‚Äôt working on my Linux computer. In this post I‚Äôll show what the
problem was, how I debugged it and especially how I fixed it!</p>
<h2 id="symptoms" tabindex="-1"><a class="header-anchor" href="#symptoms"><span>Symptoms</span></a></h2>
<p>I know I have a few credit cards saved in my Firefox Sync account, they
work perfectly on macOS and Android versions of Firefox, and Firefox was
configured to sync them. Yet, the ‚Äúsaved credit cards‚Äù window in the
privacy preferences pane was empty!</p>
<figure class="center">
  <img alt="Empty credit cards window" src="../../img/2022/05/firefox-saved-credit-cards.png">
</figure>
<p>Also if I clicked the <strong>Add</strong> button and try to add a credit
card (e.g. <code>4111111111111111</code> for a Visa card to pass the validation for
testing), the <strong>Save</strong> button was completely unresponsive.</p>
<h2 id="debugging" tabindex="-1"><a class="header-anchor" href="#debugging"><span>Debugging</span></a></h2>
<p>I opened the browser console from ‚Äúmore tools‚Äù in the application menu.
Every time I clicked <strong>Save</strong>, an error would pop: ‚ÄúUser canceled OS
unlock entry‚Äù.</p>
<pre><code class="hljs">[Exception... &quot;User canceled OS unlock entry&quot; nsresult: &quot;0x80004004 (NS_ERROR_ABORT)&quot; location: &quot;JS frame :: resource://gre/modules/OSKeyStore.jsm :: encrypt :: line 332&quot; data: no] OSKeyStore.jsm:332:24
</code></pre>
<p>Luckily this problem is already reported <a href="https://bugs.archlinux.org/task/74373">on the Arch Linux bug tracker</a>,
and the solution seems to be to install a software providing
<code>org.freedesktop.secrets</code>, which as of today is either <code>gnome-keyring</code>
or <code>keepassxc</code>.</p>
<p>I installed <code>gnome-keyring</code> and had to reboot for it to start
automatically (ain‚Äôt no time to figure how this thing work under the
hood for now). Yet the bug persisted, despite people on that thread
mentioning this solves the issue for them!</p>
<p>The ‚ÄúUser canceled OS unlock entry‚Äù exception is thrown
during the <a href="https://github.com/mozilla/gecko-dev/blob/bf243bc817f97b0bb74af710bd9d874370468e8b/toolkit/modules/OSKeyStore.jsm#L333"><code>OSKeyStore.encrypt</code></a>
call, because the <code>ensureLoggedIn</code> function determined we were not
authenticated. The underlying reason seemed to be the
<a href="https://github.com/mozilla/gecko-dev/blob/bf243bc817f97b0bb74af710bd9d874370468e8b/toolkit/modules/OSKeyStore.jsm#L254"><code>nativeOSKeyStore.asyncGenerateSecret</code></a>
call returning <code>NS_ERROR_FAILURE</code>.</p>
<p>More likely Firefox wasn‚Äôt able to generate a secret in GNOME Keyring.
So I installed <a href="https://en.wikipedia.org/wiki/Seahorse_(software)">Seahorse</a>
to test it myself, and indeed, I couldn‚Äôt store new secrets from there
either, it would fail with <code>No such secret collection at path: /</code>. This
bug is also <a href="https://wiki.archlinux.org/title/GNOME/Keyring#No_such_secret_collection_at_path:_/">documented</a>
on the ArchWiki, but sadly the solution there didn‚Äôt work for me.</p>
<h2 id="the-underlying-issue" tabindex="-1"><a class="header-anchor" href="#the-underlying-issue"><span>The underlying issue</span></a></h2>
<p>I use LightDM autologin to automatically start my compositor on boot
(where I <a href="https://www.codejam.info/2021/08/lock-screen-as-login-screen-linux.html">greet myself with a lock screen</a>).
It turns out GNOME Keyring doesn‚Äôt play well with autologin. From the
<a href="https://wiki.archlinux.org/title/GNOME/Keyring#Using_the_keyring">ArchWiki</a>:</p>
<blockquote>
<p>To use automatic unlocking with automatic login, you can set a blank
password for the default keyring. Note that the contents of the
keyring are stored unencrypted in this case.</p>
</blockquote>
<p>That‚Äôs not ideal. And I already have a primary password configured in
Firefox so it would suck to set a second one on GNOME Keyring just for
Firefox to deal with credit cards differently‚Ä¶</p>
<p>In the end I decided to ditch my automatic login and go back to TTY
login and <a href="https://wiki.archlinux.org/title/Sway#Automatically_on_TTY_login">starting Sway automatically upon login on TTY1</a>.
This is the recommended way to start Sway anyway, and they officially
don‚Äôt support display managers, so that definitely can‚Äôt hurt.</p>
<p>All I had to do was to edit <code>/etc/pam.d/login</code> according to the ‚Äúwhen
using console-based login‚Äù instructions of the <a href="https://wiki.archlinux.org/title/GNOME/Keyring#PAM_step">PAM
step</a> in the
GNOME Keyring page on ArchWiki, appending the following:</p>
<pre><code class="hljs">auth       optional     pam_gnome_keyring.so
session    optional     pam_gnome_keyring.so auto_start
</code></pre>
<h2 id="the-keepassxc-alternative" tabindex="-1"><a class="header-anchor" href="#the-keepassxc-alternative"><span>The KeePassXC alternative</span></a></h2>
<p>In the bug tracker there‚Äôs also <a href="https://bugs.archlinux.org/task/74373#comment207641">an answer</a>
describing how to fix this issue with KeePassXC:</p>
<blockquote>
<ol>
<li>KeePassXC needs to be running.</li>
<li>The secret service integration must be enabled in settings.</li>
<li>A database must be setup where at least one group is accessible to the secret service.</li>
</ol>
</blockquote>
<p>That‚Äôs a solid alternative, but then if I want secrets to be properly
secured, I need to add another password to that KeePassXC database, on
top of my encrypted filesystem password, login password and Firefox
primary password. That starts to be quite a lot of passwords‚Ä¶ so I‚Äôll
stick with GNOME Keyring for now because it‚Äôs able to reuse my login
password for that purpose.</p>
<h2 id="final-words" tabindex="-1"><a class="header-anchor" href="#final-words"><span>Final words</span></a></h2>
<p>I now have a successful credit card sync and autofill in Firefox on
Linux! I hope this becomes a bit simpler in the future, but at least I
learnt a thing or two about the underlying implementation and the
technical challenges and tradeoffs it involves.</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
  </div>
  <footer>
    <div class="footer-inner">
      <figure>
        <a href="/val.html">
          <img alt="The author (Val) in front of a mountain" src="/img/profile.jpg">
        </a>
      </figure>
      <div class="footer-content">
        <p>
          Made with üß° by <a href="/val.html">Val</a>.
          Generated from a <abbr title="Pull requests welcome!"><a href="https://github.com/valeriangalliat/blog/tree/master/2022/05/firefox-credit-card-autofill-not-working-on-linux.md">public repository</a></abbr>.
        </p>
        <ul class="social">
          <li>
            <a href="https://twitter.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Twitter</title>
                <use href="/img/icons/407-twitter.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://github.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>GitHub</title>
                <use href="/img/icons/433-github.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.instagram.com/funkyval_/">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Instagram</title>
                <use href="/img/icons/403-instagram.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.youtube.com/@FunkyVal">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>YouTube</title>
                <use href="/img/icons/414-youtube.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://ko-fi.com/funkyval">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Buy me a coffee!</title>
                <use href="/img/icons/219-heart.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="/feed.xml">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>RSS</title>
                <use href="/img/icons/412-rss.svg#icon"></use>
              </svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20230317.js"></script>
</body>
</html>
