<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Authy: reversed üîê</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github.css">
  <link rel="stylesheet" href="/css/main-20220617.css">
  <link rel="icon" href="/favicon.ico" data-emoji="üèïÔ∏è">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="Authy: reversed üîê">
  <meta property="og:description" content="I recently signed up for SendGrid for a new business. It seems like a nice tool to send my transactional emails.">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
    </ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>Authy: reversed üîê</h1>
<p class="date">September 28, 2021</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>I recently signed up for SendGrid for a new business. It seems like a
nice tool to send my transactional emails.</p>
<p>One thing with SendGrid though is that they enforce 2FA. You can‚Äôt
access your account without enabling 2FA first. That‚Äôs great, except one
thing:</p>
<p><strong>They only offer two options for 2FA: Authy and SMS.</strong></p>
<p>That‚Äôs somewhat understandable, because SendGrid belongs to Twilio, who
also owns Authy. By forcing SendGrid users on Authy, and making sure
that they can‚Äôt easily use any of the competitor 2FA apps, they boost
their Authy adoption metrics, and that will certainly make investors
happy. Users? Not so much.</p>
<p>But I‚Äôm not a Authy user, and I don‚Äôt plan to be. I definitely will not
install the Authy app just for this. ‚ÄúUse the alternative SMS 2FA
method‚Äù you‚Äôll say? But that‚Äôs less secure on top of having a poor user
experience. I‚Äôd rather <a href="totp-2fa-support-any-password-manager.html">use my existing password manager for this</a>
which is much faster and more convenient.</p>
<div class="note">
<p><strong>Note:</strong> if you don‚Äôt care about the technical details and just want to
transfer your Authy secrets to another authenticator, check out
<a href="https://github.com/valeriangalliat/authy-user-client">Authy user client</a>.</p>
<p>Otherwise, keep reading, I‚Äôll give you all the details about it! ‚úåÔ∏è</p>
</div>
<h2 id="here-we-go-again" tabindex="-1"><a class="header-anchor" href="#here-we-go-again"><span>Here we go again</span></a></h2>
<p>Every time I face a situation like this, I reverse.
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-existing-clients.html">I love</a>
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html">reversing</a>
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-understanding-browserid.html">things</a>,
especially when it helps me make my life better. I‚Äôll spend
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html">days</a>,
even
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html">weeks</a>
doing what‚Äôs necessary to achieve what I want.</p>
<p>Maybe that means decompiling apps and running them through a debugger,
or patching APKs to wipe certificate pinning mechanism in order to
<a href="https://www.codejam.info/2021/07/intercept-macos-app-traffic-mitmproxy.html">intercept the TLS traffic through a logging proxy</a>.</p>
<p>Often though, things are even easier. In the case of Authy, they have a
<a href="https://chrome.google.com/webstore/detail/authy/gaedmjdfmmahhbjefcbgaolhhanlaolb">Chrome app</a>
that we can easily debug to understand how the protocol work. The best
thing about it? Someone already did a lot of the work and <a href="https://randomoracle.wordpress.com/2017/02/15/extracting-otp-seeds-from-authy/">documented it</a>.
Sweet.</p>
<div class="note">
<p><strong>Note:</strong> I noticed later that <a href="https://github.com/alexzorin/authy">someone wrote a similar program in Go</a>.</p>
<p>The main difference is that it‚Äôs intended to be used alongside an
existing Authy app and account, instead of replacing it completely, but
a lot of the code is the same. If Go is more your jam, check it out!</p>
</div>
<h2 id="understanding-the-implementation" tabindex="-1"><a class="header-anchor" href="#understanding-the-implementation"><span>Understanding the implementation</span></a></h2>
<p>That article <a href="https://randomoracle.wordpress.com/2017/02/15/extracting-otp-seeds-from-authy/">I linked earlier</a>
gives us a good starting point:</p>
<ol>
<li>Authy uses TOTP in the background.</li>
<li>They generate TOTP using SHA-1, 7 digits, and a period of 10 seconds
(whereas most implementations are SHA-1, 6 digits and 30 seconds).</li>
<li>They check the codes against the neighbouring periods, not only the
current one, which is how they allow codes to be valid for 20 seconds
even if the underlying implementation uses 10 seconds periods.</li>
<li>By debugging the <a href="https://chrome.google.com/webstore/detail/authy/gaedmjdfmmahhbjefcbgaolhhanlaolb">Chrome app</a>,
you can easily extract your Authy secrets and import them in your
favorite authenticator app or password manager.</li>
</ol>
<p>That‚Äôs awesome, but we‚Äôre not there yet. I don‚Äôt want to <em>have to use
Authy</em> (even once) in order to <em>not use Authy later</em>.</p>
<p>A mystery still remains. Since during 2FA setup they don‚Äôt ever show a
QR code or give access to a TOTP URI or plaintext secret, how do this
secret ever reach the Authy app? Is it cryptographically derived from
the phone number, the service name, and other parameters? How does the
Authy app automagically knows what secret to generate the codes with?</p>
<p>Well, as it often turns out, the easiest answer is often the right one.
By inspecting the network traffic of the Chrome app, we clearly see
that‚Ä¶ the secrets are directly retrieved from the Authy servers.</p>
<p>Now, how do we write our own code that fetches the secrets from the
Authy servers, without installing the Authy app? Let me tell you.</p>
<h2 id="documenting-the-protocol" tabindex="-1"><a class="header-anchor" href="#documenting-the-protocol"><span>Documenting the protocol</span></a></h2>
<p>If we install the Chrome app, use our phone number to sign up or log in,
and generate a one-time code, the following happens:</p>
<ol>
<li>The app checks the status of the given number on the Authy servers.</li>
<li>If the user doesn‚Äôt exist, it creates it.</li>
<li>Then it starts a device registration flow, which consists in sending
a code to the user‚Äôs device via a call, SMS, or a push notification
to an existing Authy app if any.</li>
<li>By inputting that code in the Chrome app, it can finalize the
registration flow and gets its own ID and ‚Äúsecret seed‚Äù.</li>
<li>It uses that seed as TOTP secret to generate a code for the next 3
periods, and sends those 3 codes along with its device ID to sync the
Authy state. This is how we retrieve the plaintext secrets for all
the services associated with that account.</li>
</ol>
<p>Additionally, all the requests contain an API key that‚Äôs public and
hardcoded in the Chrome app.</p>
<div class="note">
<p><strong>Note:</strong> the secrets for each 2FA entry are unique to each Authy
installation. This means that the secrets in the app on one device
will be different from the secrets on another device (including our own
client).</p>
<p>I expect they use that to make the secrets revocable. If you remove one
of your Authy devices, the secret seeds associated with it are going to
be invalidated and the codes generated by this device are no longer
valid.</p>
</div>
<p>With that in mind, we can write an API client.</p>
<h2 id="making-a-client" tabindex="-1"><a class="header-anchor" href="#making-a-client"><span>Making a client</span></a></h2>
<p>At that point you‚Äôll be interested to look at the code of <a href="https://github.com/valeriangalliat/authy-user-client">Authy user client</a>.</p>
<p>I won‚Äôt copy everything here, but I essentially made a quick
<a href="https://github.com/valeriangalliat/authy-user-client/blob/c77d5c6e56619b012079482da4d7b9d269bab485/index.js#L38">API wrapper</a>
that allows me to define every method very concisely:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> checkUserStatus = <span class="hljs-title function_">api</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.country_code}</span>-<span class="hljs-subst">${p.cellphone}</span>/status`</span>,
  <span class="hljs-attr">search</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>]
})

<span class="hljs-keyword">const</span> createUser = <span class="hljs-title function_">api</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;/users/new&#x27;</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;email&#x27;</span>, <span class="hljs-string">&#x27;cellphone&#x27;</span>, <span class="hljs-string">&#x27;country_code&#x27;</span>]
})

<span class="hljs-keyword">const</span> startRegistration = <span class="hljs-title function_">api</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices/registration/start`</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;via&#x27;</span>, <span class="hljs-string">&#x27;signature&#x27;</span>, <span class="hljs-string">&#x27;device_app&#x27;</span>]
})

<span class="hljs-keyword">const</span> completeRegistration = <span class="hljs-title function_">api</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices/registration/complete`</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;pin&#x27;</span>]
})

<span class="hljs-keyword">const</span> listDevices = <span class="hljs-title function_">api</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices`</span>,
  <span class="hljs-attr">search</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;otp1&#x27;</span>, <span class="hljs-string">&#x27;otp2&#x27;</span>, <span class="hljs-string">&#x27;otp3&#x27;</span>, <span class="hljs-string">&#x27;device_id&#x27;</span>]
})

<span class="hljs-keyword">const</span> deleteDevice = <span class="hljs-title function_">api</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices/<span class="hljs-subst">${p.delete_device_id}</span>/delete`</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;otp1&#x27;</span>, <span class="hljs-string">&#x27;otp2&#x27;</span>, <span class="hljs-string">&#x27;otp3&#x27;</span>, <span class="hljs-string">&#x27;device_id&#x27;</span>]
})

<span class="hljs-keyword">const</span> enableMultiDevice = <span class="hljs-title function_">api</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices/enable`</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;otp1&#x27;</span>, <span class="hljs-string">&#x27;otp2&#x27;</span>, <span class="hljs-string">&#x27;otp3&#x27;</span>, <span class="hljs-string">&#x27;device_id&#x27;</span>]
})

<span class="hljs-keyword">const</span> disableMultiDevice = <span class="hljs-title function_">api</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices/disable`</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;otp1&#x27;</span>, <span class="hljs-string">&#x27;otp2&#x27;</span>, <span class="hljs-string">&#x27;otp3&#x27;</span>, <span class="hljs-string">&#x27;device_id&#x27;</span>]
})

<span class="hljs-keyword">const</span> sync = <span class="hljs-title function_">api</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices/<span class="hljs-subst">${p.device_id}</span>/apps/sync`</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;otp1&#x27;</span>, <span class="hljs-string">&#x27;otp2&#x27;</span>, <span class="hljs-string">&#x27;otp3&#x27;</span>, <span class="hljs-string">&#x27;device_id&#x27;</span>]
})
</code></pre>
<p>We‚Äôll also need a method to generate a TOTP codes using Authy settings:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> base32 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;rfc-3548-b32&#x27;</span>)
<span class="hljs-keyword">const</span> totpGenerator = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;totp-generator&#x27;</span>)

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getOtp</span> (secret) {
  <span class="hljs-comment">// `totpGenerator` wants Base32, Authy uses hex.</span>
  secret = base32.<span class="hljs-title function_">encode</span>(<span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(secret, <span class="hljs-string">&#x27;hex&#x27;</span>))
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">totpGenerator</span>(secret, { <span class="hljs-attr">digits</span>: <span class="hljs-number">7</span>, <span class="hljs-attr">period</span>: <span class="hljs-number">10</span> })
}
</code></pre>
<p>The main difference here is that Authy stores the TOTP secrets in
hexadecimal while most TOTP libraries and services expect Base32 as
defined in <a href="https://datatracker.ietf.org/doc/html/rfc3548#section-5">RFC 3548</a>,
so we need to do a quick conversion.</p>
<p>It‚Äôs a bit stupid because the first thing totp-generator does is
<a href="https://github.com/bellstrand/totp-generator/blob/af64a977b2aee17d0f0d3e607afa0af2a9a4814b/index.js#L11">converting the secret back to hex</a>
but there‚Äôs no way to avoid that by specifying a custom encoding, so be
it.</p>
<p>Then we also need an helper method to generate the 3 next codes in the
time period sequence:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getOtps</span> (secret) {
  <span class="hljs-comment">// `totpGenerator` wants Base32, Authy uses hex.</span>
  secret = base32.<span class="hljs-title function_">encode</span>(<span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(secret, <span class="hljs-string">&#x27;hex&#x27;</span>))

  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">otp1</span>: <span class="hljs-title function_">totpGenerator</span>(secret, { <span class="hljs-attr">digits</span>: <span class="hljs-number">7</span>, <span class="hljs-attr">period</span>: <span class="hljs-number">10</span>, now }),
    <span class="hljs-attr">otp2</span>: <span class="hljs-title function_">totpGenerator</span>(secret, { <span class="hljs-attr">digits</span>: <span class="hljs-number">7</span>, <span class="hljs-attr">period</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">now</span>: now + <span class="hljs-number">10_000</span> }),
    <span class="hljs-attr">otp3</span>: <span class="hljs-title function_">totpGenerator</span>(secret, { <span class="hljs-attr">digits</span>: <span class="hljs-number">7</span>, <span class="hljs-attr">period</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">now</span>: now + <span class="hljs-number">20_000</span> })
  }
}
</code></pre>
<p>This depends on <a href="https://github.com/bellstrand/totp-generator/pull/37">this PR on totp-generator</a>
which might or might not be merged when you read this.</p>
<p>From there I export those methods to be used in the CLI, or by other
Node.js programs.</p>
<h2 id="making-a-cli" tabindex="-1"><a class="header-anchor" href="#making-a-cli"><span>Making a CLI</span></a></h2>
<p>From there, we can use the awesome <a href="https://www.npmjs.com/package/prompts">prompts</a>
package to build an interactive CLI that dumps the TOTP secrets from
your Authy account.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>)
<span class="hljs-keyword">const</span> prompts = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;prompts&#x27;</span>)
<span class="hljs-keyword">const</span> uri = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;uri-tag&#x27;</span>).<span class="hljs-property">default</span>
<span class="hljs-keyword">const</span> authy = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;authy-user-client&#x27;</span>)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">prompt</span> (params) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">prompts</span>({ ...params, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;value&#x27;</span> })

  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">value</span>) {
    process.<span class="hljs-title function_">exit</span>()
  }

  <span class="hljs-keyword">return</span> res.<span class="hljs-property">value</span>
}

<span class="hljs-keyword">const</span> countryCode = <span class="hljs-keyword">await</span> <span class="hljs-title function_">prompt</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;number&#x27;</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Country code:&#x27;</span>, <span class="hljs-attr">initial</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">1</span> })
<span class="hljs-keyword">const</span> phoneNumber = <span class="hljs-keyword">await</span> <span class="hljs-title function_">prompt</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;number&#x27;</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;phoneNumber&#x27;</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Phone number:&#x27;</span>, <span class="hljs-attr">validate</span>: <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value !== <span class="hljs-string">&#x27;&#x27;</span> })

<span class="hljs-keyword">const</span> status = <span class="hljs-keyword">await</span> authy.<span class="hljs-title function_">checkUserStatus</span>({ <span class="hljs-attr">country_code</span>: countryCode, <span class="hljs-attr">cellphone</span>: phoneNumber })
<span class="hljs-keyword">let</span> authyId = status.<span class="hljs-property">authy_id</span>

<span class="hljs-keyword">if</span> (!authyId) {
  <span class="hljs-keyword">const</span> email = <span class="hljs-keyword">await</span> <span class="hljs-title function_">prompt</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;text&#x27;</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Email:&#x27;</span> })
  <span class="hljs-keyword">const</span> registration = <span class="hljs-keyword">await</span> authy.<span class="hljs-title function_">createUser</span>({ email, <span class="hljs-attr">country_code</span>: countryCode, <span class="hljs-attr">cellphone</span>: phoneNumber })
  authyId = registration.<span class="hljs-property">authy_id</span>
}

<span class="hljs-keyword">const</span> via = <span class="hljs-keyword">await</span> <span class="hljs-title function_">prompt</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;select&#x27;</span>,
  <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Authentication method:&#x27;</span>,
  <span class="hljs-attr">choices</span>: [
    { <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Push&#x27;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;push&#x27;</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Call&#x27;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;call&#x27;</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;SMS&#x27;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;sms&#x27;</span> }
  ]
})

<span class="hljs-keyword">await</span> authy.<span class="hljs-title function_">startRegistration</span>({
  <span class="hljs-attr">authy_id</span>: authyId,
  via,

  <span class="hljs-comment">// Not sure why, but works better with this. ü§∑</span>
  <span class="hljs-attr">signature</span>: crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">32</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">&#x27;hex&#x27;</span>)
})

<span class="hljs-keyword">const</span> pin = <span class="hljs-keyword">await</span> <span class="hljs-title function_">prompt</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;number&#x27;</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;PIN:&#x27;</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">validate</span>: <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value !== <span class="hljs-string">&#x27;&#x27;</span> })
<span class="hljs-keyword">const</span> registrationResponse = <span class="hljs-keyword">await</span> authy.<span class="hljs-title function_">completeRegistration</span>({ <span class="hljs-attr">authy_id</span>: authyId, pin })

<span class="hljs-keyword">const</span> deviceId = registrationResponse.<span class="hljs-property">device</span>.<span class="hljs-property">id</span>
<span class="hljs-keyword">const</span> secretSeed = registrationResponse.<span class="hljs-property">device</span>.<span class="hljs-property">secret_seed</span>

<span class="hljs-keyword">const</span> syncResponse = <span class="hljs-keyword">await</span> authy.<span class="hljs-title function_">sync</span>({
  <span class="hljs-attr">authy_id</span>: authyId,
  <span class="hljs-attr">device_id</span>: deviceId,
  ...authy.<span class="hljs-title function_">getOtps</span>(secretSeed)
})

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> app <span class="hljs-keyword">of</span> syncResponse.<span class="hljs-property">apps</span>) {
  <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(uri<span class="hljs-string">`otpauth://totp/<span class="hljs-subst">${app.name}</span>`</span>)

  url.<span class="hljs-property">search</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>({
    <span class="hljs-comment">// Authy uses hex, everything else uses Base32.</span>
    <span class="hljs-attr">secret</span>: authy.<span class="hljs-title function_">hexToBase32</span>(app.<span class="hljs-property">secret_seed</span>),
    <span class="hljs-attr">digits</span>: app.<span class="hljs-property">digits</span>,
    <span class="hljs-attr">period</span>: <span class="hljs-number">10</span>
  }))

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${app.name}</span>: <span class="hljs-subst">${url}</span>`</span>)
}
</code></pre>
<p>This will list all the associated apps with a <a href="https://github.com/google/google-authenticator/wiki/Key-Uri-Format">standard TOTP URI</a>
to be used in any compliant authenticator or password manager.</p>
<p>You can look at <a href="https://github.com/valeriangalliat/authy-user-client/blob/master/cli.js">the full source</a>
for the implementation of individual calls for more fine-grained
control!</p>
<h2 id="wrapping-up" tabindex="-1"><a class="header-anchor" href="#wrapping-up"><span>Wrapping up</span></a></h2>
<p>Thanks to this, we can work around services that force the Authy app for
2FA and extract the secret and settings to use them with our favorite
authenticator app.</p>
<p>Was this overkill? Hell yeah. But was it fun? Of course!</p>
<p>Still, I hope this can be useful to you if you run into the same issue.
You can just use the CLI and happily move on with your life and your
favorite TOTP provider! üéâ</p>
<div class="note">
<p><strong>Note:</strong> if you need help understanding and documenting other
undocumented APIs and protocols, <a href="/val.html#contact">let me know</a>, I‚Äôm
currently available for <a href="/freelance.html">contracting</a> projects
and I‚Äôll be happy to help you with that. ‚úåÔ∏è</p>
</div>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1442826926545121284">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
  </div>
  <footer>
    <figure>
      <a href="/val.html">
        <img alt="The author (Val) looking at a beer glass shining in the beautiful sun" src="/img/profile.jpg">
      </a>
    </figure>
    <div class="footer-content">
      <p>
        Made with üß° by <a href="/val.html">Val</a>.
        Generated from a <abbr title="Pull requests welcome!"><a href="https://github.com/valeriangalliat/blog/tree/master/2021/09/authy-reversed.md">public repository</a></abbr>.
      </p>
      <ul class="social">
        <li>
          <a href="https://twitter.com/valeriangalliat">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <title>Twitter</title>
              <use href="/img/icons/407-twitter.svg#icon"></use>
            </svg>
          </a>
        </li>
        <li>
          <a href="https://github.com/valeriangalliat">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <title>GitHub</title>
              <use href="/img/icons/433-github.svg#icon"></use>
            </svg>
          </a>
        </li>
        <li>
          <a href="https://www.instagram.com/funkyval_/">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <title>Instagram</title>
              <use href="/img/icons/403-instagram.svg#icon"></use>
            </svg>
          </a>
        </li>
        <li>
          <a href="https://www.youtube.com/FunkyVal">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <title>YouTube</title>
              <use href="/img/icons/414-youtube.svg#icon"></use>
            </svg>
          </a>
        </li>
        <li>
          <a href="https://ko-fi.com/funkyval">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <title>Buy me a coffee!</title>
              <use href="/img/icons/219-heart.svg#icon"></use>
            </svg>
          </a>
        </li>
        <li>
          <a href="/feed.xml">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <title>RSS</title>
              <use href="/img/icons/412-rss.svg#icon"></use>
            </svg>
          </a>
        </li>
      </ul>
    </div>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20210719.js"></script>
</body>
</html>
