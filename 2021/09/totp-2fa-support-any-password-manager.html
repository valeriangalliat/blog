<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>TOTP/2FA support with ANY password manager (you read that right)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github.css">
  <link rel="stylesheet" href="/css/main-20210924.css">
  <link rel="icon" href="data:," data-emoji="üèï">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="TOTP/2FA support with ANY password manager (you read that right)">
  <meta property="og:description" content="As I‚Äôm writing an article on how I reversed the Authy proprietary 2FA protocol to generate their codes from my own password manager and authenticator, I realized that I didn‚Äôt write about the hack I use to support TOTP in any password manager (especially the ones that don‚Äôt support it out of the box).">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
      <li><a href="/resources/freelance.html">Freelance</a></li>
      <li><a href="https://photography.codejam.info/">Photography</a></li>
    </ul>
    <ul class="social">
      <li>
        <a href="https://www.youtube.com/FunkyVal">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>YouTube</title>
            <use href="/img/icons/414-youtube.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://www.instagram.com/funkyval_/">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>Instagram</title>
            <use href="/img/icons/403-instagram.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://twitter.com/valeriangalliat">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>Twitter</title>
            <use href="/img/icons/407-twitter.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://github.com/valeriangalliat">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>GitHub</title>
            <use href="/img/icons/433-github.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://www.linkedin.com/in/valeriangalliat/">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>LinkedIn</title>
            <use href="/img/icons/458-linkedin.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="/feed.xml">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>RSS</title>
            <use href="/img/icons/412-rss.svg#icon"></use>
          </svg>
        </a>
      </li>
    </ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>TOTP/2FA support with ANY password manager (you read that right)</h1>
<p class="date">September 28, 2021</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>As I‚Äôm writing an article on <a href="authy-reversed.html">how I reversed the Authy proprietary 2FA protocol</a>
to generate their codes from my own password manager and authenticator,
I realized that I didn‚Äôt write about the hack I use to <strong>support
<abbr title="Time-based one-time password">TOTP</abbr> in any password
manager</strong> (especially the ones that don‚Äôt support it out of the box).</p>
<p>So I‚Äôll start with that.</p>
<p>See, I explained some time ago <a href="../08/why-i-switched-to-firefox-lockwise-as-my-password-manager.html">why I switched to Firefox Lockwise as my password manager</a>.
In this post, I compare it to Bitwarden, and I go through some of the
<a href="../08/why-i-switched-to-firefox-lockwise-as-my-password-manager.html#cons">Lockwise cons</a>,
one of them being <a href="../08/why-i-switched-to-firefox-lockwise-as-my-password-manager.html#no-totp-support">the lack of TOTP support</a>.</p>
<p>I said that while it would be nice to have native support for TOTP, I
already had my own authenticator app based on the <a href="https://www.npmjs.com/package/totp-generator">totp-generator</a>
package. I since made that app a lot nicer and shared it on
<a href="https://totp.vercel.app/">totp.vercel.app</a>! ü¶Ñ</p>
<p>It‚Äôs called <a href="https://totp.vercel.app/">TOTP with a password manager that doesn‚Äôt support TOTP üòÖ</a>
(yes, the emoji is part of the name) because I suck at naming things and
that‚Äôs the most explicit name that I came up with.</p>
<div class="note">
<p><strong>Note:</strong> everything you need to know in order to use it is on the link
above, but if you want to learn how it works in more technical details,
keep reading!</p>
</div>
<h2 id="why-would-you-do-that" tabindex="-1"><a class="header-anchor" href="#why-would-you-do-that">Why would you do that?</a></h2>
<p>Maybe like me you really like Lockwise or another password manager
that doesn‚Äôt support TOTP, and that‚Äôs not enough of a reason to migrate
to another app like Bitwarden, especially where TOTP support only comes
in the paid version.</p>
<p>And you don‚Äôt want to install Yet Another App‚Ñ¢ to do this.</p>
<p>Maybe a bit of a niche, I‚Äôll admit.</p>
<h2 id="how-does-it-work" tabindex="-1"><a class="header-anchor" href="#how-does-it-work">How does it work?</a></h2>
<p>First things first, you probably want to <a href="https://github.com/valeriangalliat/totp">check out the repo on GitHub</a>.</p>
<p>The principle is pretty simple. Most password managers will recognize
login forms on websites (e.g. username and password fields). Upon
submission, they‚Äôll prompt you to save the credentials you just entered,
so that the next time you encounter this form, it‚Äôll be able to autofill
the boxes and you just have to click ‚Äúlog in‚Äù.</p>
<p>Additionally, if you log in later with a different username on the same
site, it‚Äôll also ask you to save it, and now every time you come back to
that form, you‚Äôll be able to chose amongst all the credentials that you
saved.</p>
<p><a href="https://totp.vercel.app/">TOTP with a password manager that doesn‚Äôt support TOTP üòÖ</a>
looks like a login form, walks like a login form, and quacks like a
login form:</p>
<pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span>
</code></pre>
<p>(Yes, it‚Äôs that easy.)</p>
<p>This means that whatever you put in there, your password manager will
prompt you to store upon submission of the form. With that trick, <strong>we
can store arbitrary data in any password manager</strong>.</p>
<p>To retrieve that data, the user simply clicks on the username or
password field and chose from the list of all the saved items. We can
then read the values directly from the form fields. For example if the
above HTML was in a <code>&lt;form id=&quot;form&quot;&gt;</code>:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { username, password } = form.elements
<span class="hljs-built_in">console</span>.log(username.value, password.value)
</code></pre>
<p>Since <a href="https://stackoverflow.com/questions/11708092/detecting-browser-autofill">it‚Äôs a bit tricky</a>
to reliably detect when inputs are autofilled (the <code>change</code> event is not
usually triggered), we‚Äôll use a Big Blue Button‚Ñ¢ that reads ‚ÄúGet
TOTP üöÄ‚Äù instead. Good enough.</p>
<figure class="center">
  <img alt="TOTP form" src="../../img/2021/09/totp-form-1.png">
</figure>
<p>When that button is clicked, we use <a href="https://www.npmjs.com/package/totp-generator">totp-generator</a>
to generate a code for the secret that‚Äôs in the password field.</p>
<p>If the TOTP settings differ from the standard SHA-1 algorithm, 6 digits
and 30 seconds period, you can also paste a somewhat standard
<a href="https://github.com/google/google-authenticator/wiki/Key-Uri-Format"><code>otpauth://</code> URI</a>
thanks to the following code:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> totp = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;totp-generator&#x27;</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">totpFromUriOrSecret</span> (<span class="hljs-params">value</span>) </span>{
  <span class="hljs-keyword">if</span> (!value.startsWith(<span class="hljs-string">&#x27;otpauth://&#x27;</span>)) {
    <span class="hljs-comment">// Directly the secret, use default options.</span>
    <span class="hljs-keyword">return</span> totp(value)
  }

  <span class="hljs-keyword">const</span> search = <span class="hljs-keyword">new</span> URLSearchParams(<span class="hljs-keyword">new</span> URL(value).search)
  <span class="hljs-keyword">const</span> { secret, algorithm, digits, period } = <span class="hljs-built_in">Object</span>.fromEntries(search)

  <span class="hljs-keyword">return</span> totp(secret, { algorithm, digits, period })
}
</code></pre>
<p>For convenience, we can automatically copy the code to the user‚Äôs clipboard:</p>
<pre><code class="hljs language-js">navigator.clipboard.writeText(code)
</code></pre>
<h2 id="scanning-qr-codes" tabindex="-1"><a class="header-anchor" href="#scanning-qr-codes">Scanning QR codes</a></h2>
<p>But that‚Äôs not enough. While some services will give us an option to
retrieve the plaintext secret or a <code>otpauth://</code> URI, a lot will only
give a QR code to scan, and some will even give <em>nothing</em> and force you
to use Authy‚Äôs proprietary TOTP implementation (luckily, I already
<a href="authy-reversed.html">reversed that</a> so that you don‚Äôt have to).</p>
<p>For that, I‚Äôll add two options: scan a QR code using the device camera,
or import a QR code from an existing image (like a screenshot).</p>
<figure class="center">
  <img alt="TOTP form" src="../../img/2021/09/totp-form-2.png">
</figure>
<p>Luckily, there‚Äôs a <a href="https://www.npmjs.com/package/qr-scanner">QR scanner</a>
package that makes that really easy.</p>
<h3 id="using-the-camera" tabindex="-1"><a class="header-anchor" href="#using-the-camera">Using the camera</a></h3>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> QrScanner = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;qr-scanner&#x27;</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleTotpUri</span> (<span class="hljs-params">uri</span>) </span>{
  <span class="hljs-keyword">const</span> search = <span class="hljs-keyword">new</span> URLSearchParams(<span class="hljs-keyword">new</span> URL(uri).search)

  form.username.value = search.get(<span class="hljs-string">&#x27;issuer&#x27;</span>)
  form.password.value = uri
}

<span class="hljs-keyword">const</span> video = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">&#x27;video&#x27;</span>)

<span class="hljs-keyword">const</span> qrScanner = <span class="hljs-keyword">new</span> QrScanner(video, <span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
  qrScanner.stop()
  handleTotpUri(result)
})

qrScanner.start()
</code></pre>
<p>During the scan, the QR scanner will show the camera feed in the given
video element.</p>
<p>On successful scan, we parse the URI to get the <code>issuer</code> value (the
service that issued that secret) and fill the username field with it to
give a meaningful name to our secret. Then we can store the full URI in
the password field.</p>
<h3 id="from-file-upload" tabindex="-1"><a class="header-anchor" href="#from-file-upload">From file upload</a></h3>
<p>We‚Äôll support two ways to upload files. With a regular file input, and
with drag and drop.</p>
<p>For the file input, the following will do:</p>
<pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file&quot;</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { file } = form.elements

file.addEventListener(<span class="hljs-string">&#x27;change&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  handleFile(file.files[<span class="hljs-number">0</span>])
})
</code></pre>
<p>And for the drag and drop, the
<a href="https://www.npmjs.com/package/drag-drop">drag-drop</a> package makes it
trivial for us:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> dragDrop = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;drag-drop&#x27;</span>)

dragDrop(<span class="hljs-string">&#x27;body&#x27;</span>, {
  onDrop (files) {
    handleFile(files[<span class="hljs-number">0</span>])
  },
  onDragEnter (event) {
    <span class="hljs-built_in">document</span>.body.classList.add(<span class="hljs-string">&#x27;drag-drop&#x27;</span>)
  },
  onDragLeave (event) {
    <span class="hljs-built_in">document</span>.body.classList.remove(<span class="hljs-string">&#x27;drag-drop&#x27;</span>)
  }
})
</code></pre>
<p>Here we toggle a class on the <code>&lt;body&gt;</code> element during drag and drop to
make it obvious that we‚Äôre accepting files to be dropped here.</p>
<p>Now, all we need is to write the <code>handleFile</code> function that‚Äôs used by
both of those, where we scan the uploaded file and parse the TOTP URI in it.</p>
<pre><code class="hljs language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleFile</span> (<span class="hljs-params">file</span>) </span>{
  QrScanner.scanImage(file)
    .then(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
      handleTotpUri(result)
    })
}
</code></pre>
<h2 id="manually-editing-totp-settings" tabindex="-1"><a class="header-anchor" href="#manually-editing-totp-settings">Manually editing TOTP settings</a></h2>
<p>Lastly, we might encounter situations where we only have the secret and
specific TOTP settings (algorithm, digits and period), but no TOTP URI.</p>
<p>To support that, we need to add an ‚Äúadvanced‚Äù mode allowing to edit the
individual settings, and automatically generating the proper URI in the
password field to be stored.</p>
<p>We‚Äôll start by adding a hamburger menu that will open the detailed
settings.</p>
<figure class="center">
  <img alt="TOTP form" src="../../img/2021/09/totp-form-3.png">
</figure>
<p>This will toggle the following form:</p>
<figure class="center">
  <img alt="TOTP form" src="../../img/2021/09/totp-details-form.png">
</figure>
<p>Here, I added for convenience a ‚ÄúAuthy‚Äù button that will automatically
set the settings to 7 digits and a 10 seconds period, because that‚Äôs the
main use case I have for this.</p>
<p>When any of those settings change, I generate a new URI to put in the
password field:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { username, password, secret, algorithm, digits, period } = form.elements

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updatePasswordFromDetails</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> uri = <span class="hljs-keyword">new</span> URL(password.value.startsWith(<span class="hljs-string">&#x27;otpauth://&#x27;</span>) ? password.value : <span class="hljs-string">`otpauth://totp/<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(username.value)}</span>`</span>)
  <span class="hljs-keyword">const</span> search = <span class="hljs-keyword">new</span> URLSearchParams(uri.search)

  search.set(<span class="hljs-string">&#x27;secret&#x27;</span>, secret.value)
  search.set(<span class="hljs-string">&#x27;algorithm&#x27;</span>, algorithm.value)
  search.set(<span class="hljs-string">&#x27;digits&#x27;</span>, digits.value)
  search.set(<span class="hljs-string">&#x27;period&#x27;</span>, period.value)

  uri.search = search
  password.value = uri.toString()
}

secret.addEventListener(<span class="hljs-string">&#x27;change&#x27;</span>, updatePasswordFromDetails)
algorithm.addEventListener(<span class="hljs-string">&#x27;change&#x27;</span>, updatePasswordFromDetails)
digits.addEventListener(<span class="hljs-string">&#x27;change&#x27;</span>, updatePasswordFromDetails)
period.addEventListener(<span class="hljs-string">&#x27;change&#x27;</span>, updatePasswordFromDetails)
</code></pre>
<h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion">Conclusion</a></h2>
<p>And this is it! You know everything that‚Äôs behind <a href="https://totp.vercel.app/">totp.vercel.app</a>.</p>
<p>Did you find this useful? Did you like that I explained some of the code
behind it in this blog post? Don‚Äôt hesitate to let me know and <a href="https://twitter.com/valeriangalliat">ping me on Twitter</a>!</p>
<p>Until next time, keep hacking! üêø</p>
  </div>
  <footer>
    <p>
      Made with üß° by <a href="/val.html">Val</a> in Montreal.<br>
      Generated from a <a href="https://github.com/valeriangalliat/blog/tree/master/2021/09/totp-2fa-support-any-password-manager.md">public repository</a>. Feel free to <a href="/val.html#contact">contact me</a>, I'd love to hear your thoughts!
    </p>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20210719.js"></script>
</body>
</html>
