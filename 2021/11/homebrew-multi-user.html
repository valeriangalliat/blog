<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Using Homebrew on a multi-user system (don‚Äôt)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github.css">
  <link rel="stylesheet" href="/css/main-20211017.css">
  <link rel="icon" href="/favicon.ico" data-emoji="üèï">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="Using Homebrew on a multi-user system (don‚Äôt)">
  <meta property="og:description" content="I‚Äôve recently started working at a new company, where I‚Äôve got the freedom to use my own rig, which is especially nice if I want to work while travelling without having to bring two laptops with me.">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
      <li><a href="https://photography.codejam.info/">Photography</a></li>
    </ul>
    <ul class="social">
      <li>
        <a href="https://www.youtube.com/FunkyVal">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>YouTube</title>
            <use href="/img/icons/414-youtube.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://www.instagram.com/funkyval_/">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>Instagram</title>
            <use href="/img/icons/403-instagram.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://twitter.com/valeriangalliat">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>Twitter</title>
            <use href="/img/icons/407-twitter.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://github.com/valeriangalliat">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>GitHub</title>
            <use href="/img/icons/433-github.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://ko-fi.com/funkyval">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>Buy me a coffee!</title>
            <use href="/img/icons/219-heart.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="/feed.xml">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>RSS</title>
            <use href="/img/icons/412-rss.svg#icon"></use>
          </svg>
        </a>
      </li>
    </ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>Using Homebrew on a multi-user system (don‚Äôt)</h1>
<p class="date">November 17, 2021</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>I‚Äôve recently <a href="https://twitter.com/valeriangalliat/status/1460337357094326275">started working at a new company</a>,
where I‚Äôve got the freedom to use my own rig, which is especially nice
if I want to work while travelling without having to bring two laptops
with me.</p>
<p>But setting up a work environment on my personal computer actually
brings a number of concerns, mainly about:</p>
<ul>
<li>Environment variables.</li>
<li>Development tools and configurations.</li>
<li>Shell history.</li>
</ul>
<p>Whether it‚Äôs my personal Google Cloud context leaking in my work
environment, work SSH keys being available in my personal projects,
various unrelated developer tokens and credentials cohabiting in the
same environment, and work-specific commands popping in my personal
shell history and making me press the up arrow even more than I already
do, it quickly feels like poor hygiene to keep everything under the same
user.</p>
<p>And while some of those tools allow to authenticate with multiple
accounts and offer ways to configure them individually and switch
between contexts, I‚Äôve seen enough mistakes happen by juggling between
staging and production environments in the same session that adding my
personal credentials to the mix sounds like a recipe for disaster.</p>
<p>So after realizing that merging my personal projects with my
professional environment was a bad idea, I decided to create a dedicated
user for work, this way everything would be neatly contained. Meet the
multi-user system.</p>
<h2 id="sharing-a-homebrew-is-nice-but-brew-not-so-much" tabindex="-1"><a class="header-anchor" href="#sharing-a-homebrew-is-nice-but-brew-not-so-much"><span>Sharing a homebrew is nice üç∫, but <code>brew</code> not so much</span></a></h2>
<p>The main issue I ran doing that was about running <a href="https://brew.sh/">Homebrew</a>,
the tool I install macOS packages with, and which I happen to use both
personally and for work.</p>
<p>Out of the box, if you install it from one user, it‚Äôll just fail to do
anything when run from another user because of permission issues.</p>
<h3 id="the-evil-shared-group-writable-permissions" tabindex="-1"><a class="header-anchor" href="#the-evil-shared-group-writable-permissions"><span>The evil: shared group writable permissions</span></a></h3>
<p>Turns out I‚Äôm
<a href="https://medium.com/@leifhanack/homebrew-multi-user-setup-e10cb5849d59">not</a>
<a href="https://stackoverflow.com/questions/41840479/how-to-use-homebrew-on-a-multi-user-macos-sierra-setup">the</a>
<a href="https://gist.github.com/jaibeee/9a4ea6aa9d428bc77925">only</a>
<a href="https://newbedev.com/how-to-use-homebrew-on-a-multi-user-macos-sierra-setup">one</a>
to try to do this, a simple search for this yields a fuckton of results!
And they all mostly share the same ‚Äútip‚Äù which is some variant of:</p>
<pre><code class="hljs language-sh">chgrp -R admin /usr/<span class="hljs-built_in">local</span>/*
chmod -R g+w /usr/<span class="hljs-built_in">local</span>/*
</code></pre>
<p>Some variants use <code>brew --prefix</code> instead of hardcoding <code>/usr/local</code>,
some use a custom group instead of <code>admin</code>. Either way, it‚Äôs all the
same, and it appears to work at first, until it doesn‚Äôt.</p>
<p>The problem is that Homebrew is <em>not</em> designed to be used by multiple
Unix users. A given Homebrew installation is only meant to be used by a
single non-root user.</p>
<p>By giving write access to a given group (in the above example, <code>admin</code>),
that is shared by all the users you want to call <code>brew</code> from, you get
the illusion that you allowed <code>brew</code> to be used by multiple users.</p>
<p>But the issue is that the default <a href="https://en.wikipedia.org/wiki/Umask"><code>umask</code></a>
that <code>brew</code> uses doesn‚Äôt add group write access, meaning that as you
use <code>brew</code>, more and more parts of the state will not be writable by the
other users in your group.</p>
<p>For example if after running the earlier hack, you run <code>brew install some-package</code> as user <code>foo</code>, then you won‚Äôt be able to <code>brew uninstall some-package</code> or <code>brew update some-package</code> as user <code>bar</code>, because the
permission for the newly created files won‚Äôt have group write access.</p>
<p>This means that if you instal packages from different users, <code>brew update</code> will very quickly fail to run on <em>any</em> of those users because
none have access to <em>everything</em> anymore. Sure, you can solve that by
running the <code>chmod</code> hack again, but that‚Äôs flaky and won‚Äôt event prevent
every edge cases.</p>
<p>You see setups as crazy as running the <code>chmod</code> command in <code>~/.zshrc</code> or
similar to prevent this, which will still fall apart if you don‚Äôt open a
new terminal session every time right before running <code>brew</code>, on top of
being a performance nightmare!</p>
<h3 id="the-bad-separate-homebrew-installations" tabindex="-1"><a class="header-anchor" href="#the-bad-separate-homebrew-installations"><span>The bad: separate Homebrew installations</span></a></h3>
<p>Another approach that‚Äôs <a href="https://stackoverflow.com/a/55021458/4324668">not</a>
<a href="https://docs.brew.sh/Installation#alternative-installs">as</a>
<a href="https://code.roygreenfeld.com/cookbook/homebrew-multi-user-setup.html">widespread</a>
as the first one is to maintain a separate <code>brew</code> installation per user,
e.g. somewhere under the home directory as opposed to the default global
location.</p>
<p>That sounds like a great idea and would be my favorite way if it wasn‚Äôt
for the fact that <strong>pretty much every package I wanted to install needed
to be compiled from source because the prebuilt binaries only works with
the default global prefix</strong>!</p>
<p>This makes <code>brew</code> effectively unusable as it can take ages to compile
complete dependency trees that way.</p>
<p>On top of that you can read the following in the <a href="https://docs.brew.sh/Installation#alternative-installs">official documentation</a>
which definitely doesn‚Äôt make me want to go that way:</p>
<blockquote>
<p>However do yourself a favour and use the installer to install to the
default prefix. Some things may not build when installed elsewhere.
One of the reasons Homebrew just works relative to the competition is
<strong>because</strong> we recommend installing here. <em>Pick another prefix at your
peril!</em></p>
</blockquote>
<p>This confirms my first feeling about this method: Homebrew is <em>not</em>
designed to be installed outside of its default prefix and you‚Äôll run
into all sort of issues if you do. I don‚Äôt like spending my time fixing
issues like these so I‚Äôll pass.</p>
<h3 id="the-good-dedicate-a-single-user-account-to-homebrew" tabindex="-1"><a class="header-anchor" href="#the-good-dedicate-a-single-user-account-to-homebrew"><span>The good: dedicate a single user account to Homebrew</span></a></h3>
<p>This is what‚Äôs recommended for multi-user systems
<a href="https://docs.brew.sh/FAQ#why-does-homebrew-say-sudo-is-bad">in the Homebrew FAQ</a>.
Sadly this page is not well ranked when looking for how to to use
Homebrew in a multi-user system (unlike the previous hacks) and I only
found it write writing this post. The fun thing is that it‚Äôs also the
approach that I decided to use for myself and was about to document
here!</p>
<blockquote>
<p>If you need to run Homebrew in a multi-user environment, consider
creating a separate user account especially for use of Homebrew.</p>
</blockquote>
<p>So while I‚Äôm in fact not inventing anything new here, hopefully I can
help this solution to be better ranked and prevent people from running
into the issues that are guaranteed to happen with the earlier hacks!</p>
<p>The solution is simple. Because <strong>Homebrew is not designed to be used by
multiple users</strong>, and it‚Äôs <strong>not designed to be installed anywhere else than
the default location</strong>, what you want to do instead is to install
Homebrew in its <strong>default location</strong> with a <strong>dedicated user</strong> that you
switch to in order to use it.</p>
<p>Sounds annoying? Just use <code>sudo</code>! While Homebrew
<a href="https://docs.brew.sh/FAQ#why-does-homebrew-say-sudo-is-bad">documents</a>
that it &quot;refuses to work using <code>sudo</code>&quot;, this is not exactly true.
Homebrew refuses to work as root, but you can still use <code>sudo</code> to use it
as another, non-root user!</p>
<p>Typically, if you installed Homebrew in its default location from the
user <code>foo</code>, and now you‚Äôre user <code>bar</code> and want to run <code>brew update</code>:</p>
<pre><code class="hljs language-sh">sudo -Hu foo brew update
</code></pre>
<ul>
<li>The <code>-H</code> option will make sure that the <code>HOME</code> directory is set
to that of the impersonated user (here <code>foo</code>) instead of the
<em>impersonating user</em> (here <code>bar</code>), so that Homebrew can maintain its
cache and other local state in the proper user‚Äôs home.</li>
<li>The <code>-u</code> option allows to specify the user to impersonate instead of
the default of <code>root</code>.</li>
</ul>
<p>This will effectively run <code>brew update</code> like if you had switched to user
<code>foo</code> prior to running it, but without going through the hassle of
actually switching users every single time.</p>
<p>And for what it‚Äôs worth, you don‚Äôt need to create a new, dedicated user
for <code>brew</code>. In my case, since both my users are effectively, me, I
simply installed Homebrew from my personal user and use <code>sudo</code> to run
<code>brew</code> commands from my work user.</p>
<p>To make things even nicer, you can even add an alias in the <code>~/.zshrc</code>
of the user that needs to use <code>sudo</code>:</p>
<pre><code class="hljs language-sh"><span class="hljs-built_in">alias</span> brew=<span class="hljs-string">&#x27;sudo -Hu foo brew&#x27;</span>
</code></pre>
<h2 id="wrapping-up" tabindex="-1"><a class="header-anchor" href="#wrapping-up"><span>Wrapping up</span></a></h2>
<p>That‚Äôs all for today. I hope this helped you figure your bug-free,
multi-user Homebrew situation! Peace. ‚úå</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1461136995544096773">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
  </div>
  <footer>
    <p>
      Made with üß° by <a href="/val.html">Val</a> in Montreal.<br>
      Generated from a <a href="https://github.com/valeriangalliat/blog/tree/master/2021/11/homebrew-multi-user.md">public repository</a>. Feel free to <a href="/val.html#contact">contact me</a>, I'd love to hear your thoughts!
    </p>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20210719.js"></script>
</body>
</html>
