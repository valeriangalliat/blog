<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Batch updating npm packages license</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github.css">
  <link rel="stylesheet" href="/css/main-20210601.css">
  <link rel="icon" href="data:,">
  <meta property="og:title" content="Batch updating npm packages license">
  <meta property="og:description" content="Since a few weeks, npm have deprecated the old package.json license format (where we specify an object with type and url), and it now must be just a string.">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
      <li><a href="https://photography.codejam.info/">Photography</a></li>
    </ul>
    <ul class="social">
      <li>
        <a href="https://www.youtube.com/FunkyVal">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>YouTube</title>
            <use href="/img/icons/414-youtube.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://www.instagram.com/funkyval_/">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>Instagram</title>
            <use href="/img/icons/403-instagram.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://twitter.com/valeriangalliat">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>Twitter</title>
            <use href="/img/icons/407-twitter.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://github.com/valeriangalliat">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>GitHub</title>
            <use href="/img/icons/433-github.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://www.linkedin.com/in/valeriangalliat/">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>LinkedIn</title>
            <use href="/img/icons/458-linkedin.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://soundcloud.com/funkyval">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>SoundCloud</title>
            <use href="/img/icons/452-soundcloud.svg#icon"></use>
          </svg>
        </a>
      </li>
    </ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>Batch updating npm packages license</h1>
<p class="date">May 25, 2015</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>Since a few weeks, npm have <a href="https://github.com/npm/npm/commit/8669f7d88c472ccdd60e140106ac43cca636a648">deprecated</a> the old <code>package.json</code>
<code>license</code> format (where we specify an object with <code>type</code> and <code>url</code>), and
it now must be just a string.</p>
<p>I needed the old format because npm didn’t support the <a href="http://unlicense.org/">Unlicense</a> yet,
but it looks like it’s not the case anymore!</p>
<p>So I basically have to change the following:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;license&quot;</span>: {
    <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;Unlicense&quot;</span>,
    <span class="hljs-attr">&quot;url&quot;</span>: <span class="hljs-string">&quot;http://unlicense.org/&quot;</span>
  }
}
</code></pre>
<p>to this:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;license&quot;</span>: <span class="hljs-string">&quot;Unlicense&quot;</span>
}
</code></pre>
<p>for all the packages I have under the Unlicense (roughly 30 packages).</p>
<h2 id="automation" tabindex="-1"><a class="header-anchor" href="#automation">Automation</a></h2>
<p>I did not want to do this by hand, so I automated this with some
commands. I did not wrote this script at once, but here’s what’s
resulting of my <code>history</code>, with a drastic cleanup (there was <em>a lot</em> of
trial and error) and comments:</p>
<pre><code class="hljs language-sh"><span class="hljs-comment"># Get all the packages I contribute to</span>
curl -s <span class="hljs-string">&#x27;https://www.npmjs.com/~valeriangalliat&#x27;</span> | grep /package/ | sed <span class="hljs-string">&#x27;s,.*/package/,,;s/&quot;.*//&#x27;</span> &gt; my-packages

<span class="hljs-comment"># Get the URL of non-deprecated packages</span>
cat my-packages | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> package; <span class="hljs-keyword">do</span>
    node -e <span class="hljs-string">&quot;var x = <span class="hljs-subst">$(npm info <span class="hljs-string">&quot;<span class="hljs-variable">$package</span>&quot;</span>)</span>;&quot;</span><span class="hljs-string">&#x27; if (!x.deprecated) console.log(x.repository.url.replace(&quot;git+https&quot;, &quot;https&quot;))&#x27;</span>
<span class="hljs-keyword">done</span> &gt; repos

<span class="hljs-comment"># Clone all repositories</span>
cat repos | xargs -L1 git <span class="hljs-built_in">clone</span>

<span class="hljs-comment"># Get the directory names</span>
cat repos | xargs -L1 basename &gt; <span class="hljs-built_in">dirs</span>

<span class="hljs-comment"># Update the license</span>
cat <span class="hljs-built_in">dirs</span> | sed <span class="hljs-string">&#x27;s,$,/package.json,&#x27;</span> | xargs sed -i <span class="hljs-string">&#x27;/license/{N;/Unlicense/{N;N;s/.*/  &quot;license&quot;: &quot;Unlicense&quot;,/;}}&#x27;</span>

<span class="hljs-comment"># Check the update</span>
cat <span class="hljs-built_in">dirs</span> | xargs -I{} git -C {} diff

<span class="hljs-comment"># Commit</span>
cat <span class="hljs-built_in">dirs</span> | xargs -I{} git -C {} commit -am <span class="hljs-string">&#x27;Update package license format&#x27;</span>

<span class="hljs-comment"># Get the repositories where a change occurred (otherwise the commit was not done)</span>
cat <span class="hljs-built_in">dirs</span> | xargs -I{} sh -c <span class="hljs-string">&#x27;cd {} &amp;&amp; git log -n 1 | grep -q &quot;Update package license format&quot; &amp;&amp; echo {}&#x27;</span> &gt; updated

<span class="hljs-comment"># Bump patch (commit and tag)</span>
cat updated | xargs -I{} npm version patch -m <span class="hljs-string">&#x27;Bump %s&#x27;</span>

<span class="hljs-comment"># Check commits to push</span>
cat updated | xargs -I{} git -C {} <span class="hljs-built_in">log</span> origin/master..

<span class="hljs-comment"># Push, install dependencies and publish</span>
cat updated | xargs -I{} sh -c <span class="hljs-string">&#x27;cd {} &amp;&amp; git push &amp;&amp; npm install &amp;&amp; npm publish&#x27;</span>
</code></pre>
<h2 id="was-it-worth-it" tabindex="-1"><a class="header-anchor" href="#was-it-worth-it">Was it worth it?</a></h2>
<p>In the end, I think it took way more time to write this script (and blog
post) than doing it manually. But it was also <em>incredibly more fun</em>!</p>
<p>I hope this may be useful to other people in the same case as me, so it
will be actually productive, in addition to be fun.</p>
  </div>
  <footer>
    <p>Generated from a <a href="https://github.com/valeriangalliat/blog/tree/master/2015/05/batch-updating-npm-packages-license.md">public repository</a>. Feel free to <a href="/val.html#links">contact me</a>, I'd love to hear your thoughts!</p>
  </footer>
  <script src="/js/main.js"></script>
</body>
</html>
