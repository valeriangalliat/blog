<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Bypass SQLite exclusive lock üîê</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github.css">
  <link rel="stylesheet" href="/css/main-20211017.css">
  <link rel="icon" href="/favicon.ico" data-emoji="üèï">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="Bypass SQLite exclusive lock üîê">
  <meta property="og:description" content="‚ÄúError: database is locked‚Äù is not an acceptable answer. There‚Äôs a number of ways SQLite can lock a database file, and if you‚Äôre encountering a ‚Äúdatabase is locked‚Äù error, according to the internet, you have two options:">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
      <li><a href="https://photography.codejam.info/">Photography</a></li>
    </ul>
    <ul class="social">
      <li>
        <a href="https://www.youtube.com/FunkyVal">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>YouTube</title>
            <use href="/img/icons/414-youtube.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://www.instagram.com/funkyval_/">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>Instagram</title>
            <use href="/img/icons/403-instagram.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://twitter.com/valeriangalliat">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>Twitter</title>
            <use href="/img/icons/407-twitter.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://github.com/valeriangalliat">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>GitHub</title>
            <use href="/img/icons/433-github.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="https://www.linkedin.com/in/valeriangalliat/">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>LinkedIn</title>
            <use href="/img/icons/458-linkedin.svg#icon"></use>
          </svg>
        </a>
      </li>
      <li>
        <a href="/feed.xml">
          <svg width="16" height="16" viewBox="0 0 16 16">
            <title>RSS</title>
            <use href="/img/icons/412-rss.svg#icon"></use>
          </svg>
        </a>
      </li>
    </ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>Bypass SQLite exclusive lock üîê</h1>
<p class="tagline">‚ÄúError: database is locked‚Äù is not an acceptable answer</p>
<p class="date">October 14, 2021</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>There‚Äôs a <a href="https://www.sqlite.org/lockingv3.html">number of ways</a> SQLite
can lock a database file, and if you‚Äôre encountering a ‚Äúdatabase is
locked‚Äù error, according to <a href="https://stackoverflow.com/questions/151026/how-do-i-unlock-a-sqlite-database">the internet</a>,
you have two options:</p>
<ol>
<li>If you control the software that created the lock, go and fix the
problematic queries.</li>
<li>You‚Äôre fucked.</li>
</ol>
<p>By ‚Äúyou‚Äôre fucked‚Äù I mean that your seemingly only option is to <strong>copy
the whole database file and query the copy</strong>. If working off a one-time
snapshot of the database work for you, awesome, problem solved:</p>
<pre><code class="hljs language-sh">$ <span class="hljs-built_in">echo</span> .tables | sqlite3 db.sqlite
Error: database is locked
$ cp db.sqlite db-snapshot.sqlite
$ <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;.tables&#x27;</span> | sqlite3 db-snapshot.sqlite
actual_table
</code></pre>
<p>But it seems that‚Äôs not a good enough solution for many people (including myself)
and we‚Äôre desperately trying to <a href="https://stackoverflow.com/questions/7857755/is-it-possible-to-open-a-locked-sqlite-database-in-read-only-mode">perform</a>
<a href="https://www.linuxquestions.org/questions/linux-server-73/can-i-open-sqlite-datbase-in-read-only-mode-4175578075/">read-only</a>
<a href="https://github.com/skeeto/emacsql/issues/34">queries</a>
<a href="https://www.reddit.com/r/firefox/comments/aw01gq/how_to_disable_sqlite_database_locking_for/">on a</a>
<a href="https://dba.stackexchange.com/questions/45368/how-do-i-prevent-sqlite-database-locks">locked</a>
SQLite database.</p>
<p>This is especially useful for <strong>Firefox</strong> and <strong>Chrome</strong> SQLite files
because both browsers have a bad tendency to keep them permanently
locked, preventing us to access the database without closing the browser
first.</p>
<p>In my case, I want to poll a specific table, and while technically the
database is small enough that it‚Äôs not a problem to copy it over and
over to query it periodically, <strong>I just don‚Äôt like this idea</strong>
and I believe there <em>must</em> be a better way.</p>
<p>So let me tell you the better way.</p>
<h2 id="the-better-way" tabindex="-1"><a class="header-anchor" href="#the-better-way"><span>The better way</span></a></h2>
<p>SQLite <a href="https://www.sqlite.org/c3ref/open.html">allows passing</a> a
<a href="https://www.sqlite.org/uri.html"><code>file:</code> URI</a> instead of a filename
(e.g. <code>file:db.sqlite</code> instead of <code>db.sqlite</code>), which comes with the
extra ability to pass query string parameters.</p>
<p>Some of those are aliases for flags you could otherwise set when opening
the connexion, for example <a href="https://github.com/sqlite/sqlite/blob/8436f53ebe369e0d646068d3b25ea11673debf0e/src/main.c#L3023"><code>mode=ro</code></a>
is equivalent to setting <a href="https://www.sqlite.org/c3ref/c_open_autoproxy.html"><code>SQLITE_OPEN_READONLY</code></a>
and <a href="https://github.com/sqlite/sqlite/blob/8436f53ebe369e0d646068d3b25ea11673debf0e/src/main.c#L3011"><code>cache=private</code></a>
the same as <a href="https://www.sqlite.org/c3ref/c_open_autoproxy.html"><code>SQLITE_OPEN_PRIVATECACHE</code></a>.</p>
<p>But we also have other parameters that have a deeper implementation that
would otherwise be inaccessible to the SQLite user (no configuration
flags for those). In particular, <a href="https://github.com/sqlite/sqlite/blob/8436f53ebe369e0d646068d3b25ea11673debf0e/src/pager.c#L4913"><code>nolock</code></a>
and <a href="https://github.com/sqlite/sqlite/blob/8436f53ebe369e0d646068d3b25ea11673debf0e/src/pager.c#L4915"><code>immutable</code></a>.</p>
<p>While <code>nolock</code> only prevents this connection from locking the database
and doesn‚Äôt do anything about the fact a lock is already being held by
another connection, the <code>immutable</code> is especially interesting for us.
From its <a href="https://www.sqlite.org/c3ref/open.html">documentation</a>:</p>
<blockquote>
<p>The immutable parameter is a boolean query parameter that indicates
that the database file is stored on read-only media. When <code>immutable</code>
is set, SQLite assumes that the database file cannot be changed, and
so the database is opened read-only and <strong>all locking and change
detection is disabled</strong>.</p>
<p><strong>Caution:</strong> setting the immutable property on a database file that
does in fact change can result in incorrect query results and/or
<a href="https://www.sqlite.org/rescode.html#corrupt"><code>SQLITE_CORRUPT</code></a> errors.</p>
<p><strong>See also:</strong> <a href="https://www.sqlite.org/c3ref/c_iocap_atomic.html"><code>SQLITE_IOCAP_IMMUTABLE</code></a>.</p>
</blockquote>
<p>Even though <code>SQLITE_IOCAP_IMMUTABLE</code> is not an option per se, but a
particular characteristic of the IO device, we can force SQLite to treat
the database as if was on an read-only device by setting <code>immutable=1</code>,
which has the particularity of disabling all locking mechanisms,
<strong>including that of respecting existing locks</strong>.</p>
<p>With this trick, we can rewrite the previous fix:</p>
<pre><code class="hljs language-sh">$ <span class="hljs-built_in">echo</span> .tables | sqlite3 db.sqlite
Error: database is locked
$ <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;.tables&#x27;</span> | sqlite3 <span class="hljs-string">&#x27;file:db.sqlite?immutable=1&#x27;</span>
actual_table
</code></pre>
<p>This doesn‚Äôt require creating a copy of the file that you want to
query it despite it being locked by another active connection!</p>
<p>The only caveat is because SQLite doesn‚Äôt expect that file to be
updated, changes wont be reflected in that immutable connexion, so it‚Äôs
still like you‚Äôre querying a snapshot, it‚Äôs just that you don‚Äôt have to
physically copy the database in order to read it.</p>
<p>Also as mentioned earlier, if the underlying database is updated, this
might result in errors when querying over the immutable connection.
Because of that, I would recommending opening a new connection every
time you want to query the database.</p>
<h2 id="applying-it-to-a-sqlite-driver" tabindex="-1"><a class="header-anchor" href="#applying-it-to-a-sqlite-driver"><span>Applying it to a SQLite driver</span></a></h2>
<p>It‚Äôs nice to be able to do that with the CLI, but how do we do that from
a program that uses a SQLite driver? In my case I‚Äôm using
<a href="https://www.npmjs.com/package/sqlite3"><code>sqlite3</code></a> with Node.js, but the
method should be very similar in your language of choice.</p>
<p>Because the <code>immutable</code> option is only available in the <a href="https://www.sqlite.org/uri.html">URI filename</a>
format, we need to pass this kind of URI to our driver, e.g.
<code>file:db.sqlite?immutable=1</code> as opposed to <code>db.sqlite</code>.</p>
<p>The URI format is not enabled by default and you need to pass the
<a href="https://www.sqlite.org/c3ref/c_open_autoproxy.html"><code>SQLITE_OPEN_URI</code></a>
flag in order to enable it.</p>
<p>With <code>sqlite3</code>, this looks like this:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> sqlite3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;sqlite3&#x27;</span>)
<span class="hljs-keyword">const</span> db = <span class="hljs-keyword">new</span> sqlite3.Database(<span class="hljs-string">&#x27;file:db.sqlite?immutable=1&#x27;</span>, sqlite3.OPEN_READONLY | sqlite3.OPEN_URI)
</code></pre>
<p>We need to precise <code>OPEN_READONLY</code> because <code>OPEN_URI</code> alone is not a
valid mode, and by passing an explicit mode, we‚Äôre effectively
overriding the <a href="https://github.com/mapbox/node-sqlite3/blob/918052b538b0effe6c4a44c74a16b2749c08a0d2/src/database.cc#L135">default</a>
of <code>SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE | SQLITE_OPEN_FULLMUTEX</code>.</p>
<h2 id="wrapping-up" tabindex="-1"><a class="header-anchor" href="#wrapping-up"><span>Wrapping up</span></a></h2>
<p>I hope you enjoyed this trick! If you find a better way to do this, or
a way that allows to reflect underlying database updates without
reloading the connection, please <a href="/val.html#contact">let me know</a>, I‚Äôd
love to know about it!</p>
<p>And as usual, keep hacking. üòú</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1448722067638177795">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
  </div>
  <footer>
    <p>
      Made with üß° by <a href="/val.html">Val</a> in Montreal.<br>
      Generated from a <a href="https://github.com/valeriangalliat/blog/tree/master/2021/10/bypass-sqlite-exclusive-lock.md">public repository</a>. Feel free to <a href="/val.html#contact">contact me</a>, I'd love to hear your thoughts!
    </p>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20210719.js"></script>
</body>
</html>
