<?xml version="1.0" encoding="utf-8" ?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>CodeJam</title>
  <subtitle>Hey, I‚Äôm Val, welcome to my blog!</subtitle>
  <link href="https://www.codejam.info/feed.xml" rel="self" />
  <link href="https://www.codejam.info/" />
  <id>https://www.codejam.info/</id>
  <updated>2021-11-08T23:11:41.395Z</updated>
  <author>
    <name>Val</name>
  </author>
  <entry>
    <title>ImageMagick crop with percentage like CSS background-position</title>
    <link href="https://www.codejam.info/2021/11/imagemagick-crop-percentage-css-background-position.html" />
    <id>https://www.codejam.info/2021/11/imagemagick-crop-percentage-css-background-position.html</id>
    <updated>2021-11-08T05:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>Another one of those posts that are probably only useful to me, but who
knows!</p>
<p>I‚Äôve been wanting to crop images with ImageMagick in a way that mimics
what the CSS <code>background-position</code> property does.</p>
<h2 id="how-does-background-position-behave" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/11/imagemagick-crop-percentage-css-background-position.html#how-does-background-position-behave"><span>How does <code>background-position</code> behave?</span></a></h2>
<p>Let‚Äôs say I have a picture that I‚Äôm making shorter, e.g. a 1:1 picture
that I want to make 16:9, and I want to make sure to keep it centered
both horizontally and vertically. I would use the following:</p>
<pre><code class="hljs language-css"><span class="hljs-selector-class">.element</span> {
  <span class="hljs-attribute">background-position</span>: <span class="hljs-number">50%</span> <span class="hljs-number">50%</span>;
}
</code></pre>
<p>In this particular case, we can easily mimic that with ImageMagick.
Let‚Äôs assume <code>input.jpg</code> is currently a 1080x1080 square picture, and we
want to scale it down to a 640x360 16:9 landscape:</p>
<pre><code class="hljs language-sh">convert input.jpg -resize 640x -gravity center -crop 640x360+0+0 output.jpg
</code></pre>
<p>But <code>-gravity</code> only allows us to align top (<code>north</code>), center or bottom
(<code>south</code>). What if we wanted a percentage in between?</p>
<p>In the case of <code>background-position</code>, 0% would align the picture at the
top, and 100% at the bottom. Anything in between would allow to navigate
in that range.</p>
<h2 id="applying-it-to-imagemagick" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/11/imagemagick-crop-percentage-css-background-position.html#applying-it-to-imagemagick"><span>Applying it to ImageMagick</span></a></h2>
<p>Let‚Äôs pretend we can‚Äôt do <code>-gravity south</code> to align the crop at the bottom,
and convert our 100% offset to a pixels offset. It would be equal to the
original picture height minus the target crop height, or in the case of
our example, <code>640 - 360</code>, which is 280 pixels.</p>
<pre><code class="hljs language-sh">convert input.jpg -resize 640x -crop 640x360+0+280 output.jpg
</code></pre>
<p>Similarly, our 75% becomes <code>75 / 100 * (640 - 360)</code>, which is 210.</p>
<p>But it gets a bit annoying to calculate that manually every time.
Instead, let me introduce the <code>magick</code> command!</p>
<h2 id="the-magick-command" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/11/imagemagick-crop-percentage-css-background-position.html#the-magick-command"><span>The <code>magick</code> command</span></a></h2>
<p><code>magick</code> behaves very similarly to <code>convert</code>, but supports some extra
features like the ability to embed calculations directly in the cropping
options!</p>
<pre><code class="hljs language-sh">magick input.jpg -resize 640x -crop <span class="hljs-string">&#x27;640x360+0+%[fx:75/100*(h-360)]&#x27;</span> output.jpg
</code></pre>
<p>Here, the only variable we have to manually write down is the cropped
height, which we already need to know to perform the crop in the first
place.</p>
<p>With that, it gets easy to adjust the percentage in a way that‚Äôs
consistent with what <code>background-position</code> would otherwise do, without
having to do the math by hand.</p>
<p>It was already possible to do this by combining <code>identify</code> and a command
line calculator like <code>bc</code>, but having the option to do that so easily in
the <code>-crop</code> option is definitely nicer!</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>Elixir: intercepting Phoenix LiveView events in JavaScript</title>
    <link href="https://www.codejam.info/2021/11/elixir-intercepting-phoenix-liveview-events-javascript.html" />
    <id>https://www.codejam.info/2021/11/elixir-intercepting-phoenix-liveview-events-javascript.html</id>
    <updated>2021-11-05T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>Recently, I was dealing with a Phoenix LiveView where I wanted to
intercept some events from the LiveSocket to take specific action in
JavaScript.</p>
<p>Typically, I wanted to know when a form was done being submitted and
processed by the backend <strong>even if that event didn‚Äôt trigger a DOM
change</strong>.</p>
<h2 id="the-use-case" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/11/elixir-intercepting-phoenix-liveview-events-javascript.html#the-use-case"><span>The use case</span></a></h2>
<p>To give the context, I have a <code>&lt;span&gt;</code> that is transformed to a <code>&lt;form&gt;</code>
on click. For reactivity, this is done in JavaScript. When the form is
submitted, it triggers a Phoenix event that might or might not update
the DOM.</p>
<p>I don‚Äôt want to reset the state back to the <code>&lt;span&gt;</code> on submission,
because it would temporarily show the old text until the update is
processed by the backend and the DOM is updated, which causes a quick
text flash.</p>
<p>In the happy path where the form submission triggers a DOM update
Phoenix resets the DOM to the <code>&lt;span&gt;</code> and everything is good, but
if we just added a bunch of spaces to the existing text and the backend
decides to trim the value, Phoenix is smart enough to notice that since
the input state didn‚Äôt change, it doesn‚Äôt need to update the DOM. This
is great, except it leaves us with the open <code>&lt;form&gt;</code> even if the
submission was handled successfully.</p>
<p>To deal with this, I wanted a way to tell from JavaScript when the form
submission was <em>completed</em> so that I can make sure to reset the <code>&lt;span&gt;</code>
only then (to avoid the quick text flash mentioned earlier).</p>
<h2 id="using-phoenix-liveview-hooks" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/11/elixir-intercepting-phoenix-liveview-events-javascript.html#using-phoenix-liveview-hooks"><span>Using Phoenix LiveView hooks?</span></a></h2>
<p>The first thing I thought about was to use LiveView hooks as documented
in <a href="https://hexdocs.pm/phoenix_live_view/js-interop.html">JavaScript interoperability</a>.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> { Socket } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;phoenix&#x27;</span>
<span class="hljs-keyword">import</span> { LiveSocket } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;phoenix_live_view&#x27;</span>

<span class="hljs-keyword">const</span> csrfToken = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">&quot;meta[name=&#x27;csrf-token&#x27;]&quot;</span>).getAttribute(<span class="hljs-string">&#x27;content&#x27;</span>)

<span class="hljs-keyword">const</span> liveSocket = <span class="hljs-keyword">new</span> LiveSocket(<span class="hljs-string">&#x27;/live&#x27;</span>, Socket, {
  <span class="hljs-attr">params</span>: { <span class="hljs-attr">_csrf_token</span>: csrfToken },
  <span class="hljs-attr">hooks</span>: {
    <span class="hljs-attr">ElementUpdated</span>: {
      updated (e) {
        <span class="hljs-built_in">this</span>.el.dispatchEvent(<span class="hljs-keyword">new</span> CustomEvent(<span class="hljs-string">&#x27;phx:element-updated&#x27;</span>))
      }
    }
  }
})

liveSocket.connect()
</code></pre>
<p>By adding <code>phx-hook=&quot;ElementUpdated&quot;</code> on the elements we want to get
notified for updates, we trigger the hook we defined, which here
dispatches a custom <code>phx:element-updated</code> on the node. This allows us to
handle that event at the node level instead of trying to handle every
single case directly from the hook, which is very nice and decoupled if
you ask me.</p>
<p>For example you could now do:</p>
<pre><code class="hljs language-js">someElement.addEventListener(<span class="hljs-string">&#x27;phx:element-updated&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// Deal with the fact this element got updated!</span>
})
</code></pre>
<p>Sadly, this didn‚Äôt work for me because the <code>updated</code> hook only fires
when the element is‚Ä¶ updated, which is not the case if the form
submission completes but doesn‚Äôt result in a state change. Bummer.</p>
<h2 id="leveraging-the-phx-page-loading-stop-window-event" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/11/elixir-intercepting-phoenix-liveview-events-javascript.html#leveraging-the-phx-page-loading-stop-window-event"><span>Leveraging the <code>phx:page-loading-stop</code> <code>window</code> event</span></a></h2>
<p>This is the easiest solution. Unlike the one I talk about after, it
doesn‚Äôt give any granularity on the kind of event that was sent or
received, but it‚Äôs very easy to implement.</p>
<p>In my case, I use <a href="https://alpinejs.dev/">Alpine</a> so my code looks something like this:</p>
<pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">x-data</span>=<span class="hljs-string">&quot;{ edit: false }&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;edit = true&quot;</span> @<span class="hljs-attr">click.outside</span>=<span class="hljs-string">&quot;edit = false&quot;</span> @<span class="hljs-attr">phx:page-loading-stop.window</span>=<span class="hljs-string">&quot;edit = false&quot;</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">x-show</span>=<span class="hljs-string">&quot;!edit&quot;</span>&gt;</span><span class="hljs-comment">&lt;!-- ... --&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">x-show</span>=<span class="hljs-string">&quot;edit&quot;</span> <span class="hljs-attr">phx-submit</span>=<span class="hljs-string">&quot;edit_whatever&quot;</span>&gt;</span><span class="hljs-comment">&lt;!-- ... --&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- ... --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>We start with a state of <code>edit: false</code>. When that element is clicked, we
switch the <code>&lt;span&gt;</code> to a <code>&lt;form&gt;</code> to let the user edit it. On
submission, if the DOM is refreshed, Phoenix will reset the state
anyways and we‚Äôre back to the <code>&lt;span&gt;</code>, but if it‚Äôs not (e.g. input not
modified), we can still handle the <code>page-loading-stop</code> event to go back
to <code>&lt;span&gt;</code> mode. Sweet!</p>
<div class="note">
<p><strong>Note:</strong> if you don‚Äôt use Alpine, you can just listen to the
<code>phx:page-loading-stop</code> event on the <code>window</code> object:</p>
<pre><code class="hljs language-js">addEventListener(<span class="hljs-string">&#x27;phx:page-loading-stop&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// Your code here!</span>
})
</code></pre>
</div>
<h2 id="monkey-patching-the-livesocket" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/11/elixir-intercepting-phoenix-liveview-events-javascript.html#monkey-patching-the-livesocket"><span>Monkey patching the LiveSocket üôà</span></a></h2>
<p>Oh yeah, we love monkey patching. If you use Phoenix LiveView your code
should look something like this (I left alone the Alpine part because
it‚Äôs not relevant to this example).</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> { Socket } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;phoenix&#x27;</span>
<span class="hljs-keyword">import</span> { LiveSocket } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;phoenix_live_view&#x27;</span>

<span class="hljs-keyword">const</span> csrfToken = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">&quot;meta[name=&#x27;csrf-token&#x27;]&quot;</span>).getAttribute(<span class="hljs-string">&#x27;content&#x27;</span>)

<span class="hljs-keyword">const</span> liveSocket = <span class="hljs-keyword">new</span> LiveSocket(<span class="hljs-string">&#x27;/live&#x27;</span>, Socket, {
  <span class="hljs-attr">params</span>: { <span class="hljs-attr">_csrf_token</span>: csrfToken }
})

liveSocket.connect()
</code></pre>
<p>From there, we can intercept the <code>push</code> method on the LiveSocket
channel. That will in turn allow us to add an event handler to the
<code>receive</code> event for a given push, so that we can not only get the full
response from Phoenix, but can also tell from what event it originated!</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> channel = <span class="hljs-built_in">Object</span>.values(liveSocket.roots)[<span class="hljs-number">0</span>].channel
<span class="hljs-keyword">const</span> pushImpl = channel.push

channel.push = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wrappedPush</span> (<span class="hljs-params">event, payload, timeout</span>) </span>{
  <span class="hljs-keyword">const</span> push = pushImpl.call(<span class="hljs-built_in">this</span>, event, payload, timeout)

  push.receive(<span class="hljs-string">&#x27;ok&#x27;</span>, <span class="hljs-function"><span class="hljs-params">resp</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(event, payload, resp)
  })

  <span class="hljs-keyword">return</span> push
}
</code></pre>
<p>In the case of my <code>&lt;form&gt;</code> example earlier, <code>event</code> is set to the string
<code>event</code>, <code>resp</code> would contain a <code>diff</code> object that really only makes
sense to Phoenix (or be an empty object if nothing was updated), and the
<code>payload</code> would look something like this:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;form&quot;</span>,
  <span class="hljs-attr">&quot;event&quot;</span>: <span class="hljs-string">&quot;edit_whatever&quot;</span>,
  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-string">&quot;URL encoded string of the form elements&quot;</span>
}
</code></pre>
<p>This gives pretty useful informations that can allow to hook to LiveView
events in a much more granular manner!</p>
<p>While I didn‚Äôt end up needing that method, I found this trick during my
numerous attempts at dealing with that issue and I found it would be
pretty useful to documented as it‚Äôs pretty easy to implement and I
didn‚Äôt find anything similar online.</p>
<h2 id="further-reading" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/11/elixir-intercepting-phoenix-liveview-events-javascript.html#further-reading"><span>Further reading</span></a></h2>
<p>If you enjoy reading about this topic, I encourage you to read those two
articles I stumbled upon during my research on this subject.</p>
<ul>
<li><a href="http://blog.pthompson.org/alpine-js-and-liveview">Integrating Phoenix LiveView with JavaScript and AlpineJS</a>
by <a href="http://blog.pthompson.org/">Patrick Thompson</a>, for a cool demo of
using hooks and events to make LiveView and Alpine play nice together
(but sadly not nice enough for my edge case).</li>
<li><a href="https://elixirschool.com/blog/live-view-with-channels/">Using channels with LiveView for better UX</a>
by <a href="https://twitter.com/sm_debenedetto">Sophie DeBenedetto</a>, to extend
the LiveSocket with a custom channel that allow passing granular
messages to the client. It‚Äôs pretty complex and it kinda scared me at
first to be honest, but if my <a href="https://www.codejam.info/2021/11/monkey-patching-the-livesocket">monkey patch</a>
solution wasn‚Äôt flexible enough for you, this one surely will!</li>
</ul>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>JSDoc: TypeScript inside JavaScript and not the other way around ü§Ø</title>
    <link href="https://www.codejam.info/2021/10/jsdoc-typescript-inside-javascript.html" />
    <id>https://www.codejam.info/2021/10/jsdoc-typescript-inside-javascript.html</id>
    <updated>2021-10-17T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>This post is inspired by this great <a href="https://speakeasyjs.com/">Speakeasy JS</a>
talk by <a href="https://austingil.com/">Austin Gil</a>. üíØ</p>
<figure class="video">
  <iframe src="https://www.youtube.com/embed/iP5XwRT2tNw" allowfullscreen></iframe>
</figure>
<p>Even though I was familiar with the concept of type checking JS files
with TypeScript through JSDoc, I‚Äôve always seen it as a way to
<strong>transition to TypeScript</strong>. You would progressively add
TypeScript-compatible JSDoc to an existing JavaScript project until
everything is covered, to ultimately transition to the actual TypeScript
syntax.</p>
<p>But it never crossed my mind to use TypeScript with JSDoc as an end
goal. Until I saw that talk.</p>
<h2 id="the-problem-with-compiled-javascript" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/jsdoc-typescript-inside-javascript.html#the-problem-with-compiled-javascript"><span>The problem with compiled JavaScript</span></a></h2>
<p>The main reason I don‚Äôt use TypeScript is not because of TypeScript
itself (even though there‚Äôs a lot to say here). It‚Äôs because I don‚Äôt
like to compile my JavaScript in the first place, at least not when it‚Äôs
intended for Node.js.</p>
<p>It‚Äôs the same reason I don‚Äôt use <a href="https://flow.org/">Flow</a>,
<a href="https://elm-lang.org/">Elm</a>, <a href="https://dart.dev/">Dart</a>,
<a href="https://babeljs.io/">Babel</a> or <a href="https://coffeescript.org/">CoffeeScript</a>.</p>
<p>JavaScript being an interpreted language, it naturally comes with the
ability to directly run your code. <strong>This is an incredibly convenient
thing.</strong></p>
<ul>
<li>It‚Äôs fast as fuck because there‚Äôs nothing to compile.</li>
<li>You can inspect and debug directly what you write without any extra
tool or configuration.</li>
<li>Your stack traces will be readable and usable out of the box.</li>
<li>Every tool and service you use will (mostly) understand your code by
default, because it‚Äôs <em>native</em> and doesn‚Äôt require special treatment.</li>
</ul>
<p>That‚Äôs a lot of time saved right there by not having to maintain custom
configurations on all the tools and services you use, on top of the fact
you need to install, configure, update and maintain a number of extra
tools, pipelines, workflows, which you‚Äôll also need to teach to
everybody who‚Äôs going to work with you because we all do those things a
little bit differently.</p>
<p>Now, there are benefits to invest in this extra work, so if the cost of
compiling your JavaScript is worth it for you, or you just enjoy the
process, that‚Äôs fine! As far as I‚Äôm concerned, I don‚Äôt enjoy a single
bit of it.</p>
<h2 id="separate-type-definitions-hell" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/jsdoc-typescript-inside-javascript.html#separate-type-definitions-hell"><span>Separate type definitions hell üî•</span></a></h2>
<p>Static types are useful and there‚Äôs no argument that having type
checking is generally a beneficial thing. For that reason, more and more
people want types with the libraries they‚Äôre going to use.</p>
<p>I maintain <a href="https://github.com/valeriangalliat">quite a few</a> open source
JavaScript libraries, and on the most popular ones, people have
requested (or better, contributed) TypeScript definitions, whether it‚Äôs
directly in the package repository or on <a href="https://github.com/DefinitelyTyped/DefinitelyTyped">Definitely Typed</a>.</p>
<p>While this comes from a good intention, it causes a number of issues for
everybody involved:</p>
<ul>
<li>
<p>When added directly to the package repository, types represent extra
work for the maintainers who initially wrote a JavaScript project and
didn‚Äôt want to write, maintain, and deal with a TypeScript project.</p>
</li>
<li>
<p>Types are pretty much always added as manually written, static <code>.d.ts</code>
files, because it would represent a lot more work (on top of being
extremely bold and opinionated) to convert the project to TypeScript,
and nobody really wants to do that.</p>
<p>This means there‚Äôs no guarantee that the types will match what the JS
code is actually doing. It‚Äôs a best effort that worked good enough for
whoever contributed it.</p>
</li>
<li>
<p>On top of that, the maintainers (e.g. me) might ‚Äúforget‚Äù to update the
previously contributed TypeScript definitions when they make changes.
The more changes there is, the more likely the types won‚Äôt be updated
because of the amount of extra work it represents.</p>
<p>This means that the included types will most certainly drift out of
sync with the actual code (even more than they already are) until it
breaks someone‚Äôs build and they contribute a fix.</p>
</li>
</ul>
<p>As a maintainer, what can I do?</p>
<ul>
<li>Should I reject a PR that add type definitions because I‚Äôm not ready
to commit to the extra work required to maintain them?</li>
<li>Should I merge the PR only at the condition that the person becomes a
core contributor and maintain the types in future updates?</li>
<li>Should I merge the PR but put a note somewhere that types are
community contributed and might drift out of sync from the JavaScript
code, a bit like I do for translations contributed in languages that I
don‚Äôt speak?</li>
</ul>
<p>I don‚Äôt like any of those choices. Luckily, most of my projects are
small enough that the types don‚Äôt represent a lot of extra work, plus
everybody seems to be happy with type definitions covering only the
happy path which is usually a small subset of the codebase.</p>
<p>So for now I just merge the PRs and let TypeScript users contribute
improvements and bug fixes over time as they need them. It seems that
they‚Äôre used to having things partially broken all the time and they
prefer to have inaccurate or incomplete types than no types.</p>
<h2 id="having-the-best-of-both-worlds" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/jsdoc-typescript-inside-javascript.html#having-the-best-of-both-worlds"><span>Having the best of both worlds</span></a></h2>
<p>Out of sympathy for those users (I truly think they deserve something
better), and also because I do believe in the benefits of static typing
(as much as I hate compiling an interpreted language), I decided to
start my <a href="https://github.com/valeriangalliat/node-firefox-sync">latest JavaScript library</a>
with TypeScript definitions in mind from the start.</p>
<p>Thanks to the talk I shared in the beginning of this post, I decided to
write my JSDoc comments in a way that the TypeScript compiler can
consume. Here‚Äôs a few examples:</p>
<details>
  <summary><a href="https://github.com/valeriangalliat/node-firefox-sync/blob/master/auth/oauth.js"><code>auth/oauth.js</code></a></summary>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>)
<span class="hljs-keyword">const</span> base = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./oauth-base&#x27;</span>)

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@typedef <span class="hljs-type">{Object}</span> <span class="hljs-variable">SyncOAuthChallengeImpl</span></span>
 * <span class="hljs-doctag">@property <span class="hljs-type">{crypto.KeyPairKeyObjectResult}</span> <span class="hljs-variable">keyPair</span></span>
 * <span class="hljs-doctag">@typedef <span class="hljs-type">{base.OAuthChallenge &amp; SyncOAuthChallengeImpl}</span> <span class="hljs-variable">SyncOAuthChallenge</span></span>
 */</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@param <span class="hljs-type">{SyncOAuthChallenge}</span> <span class="hljs-variable">challenge</span></span>
 * <span class="hljs-doctag">@param <span class="hljs-type">{base.OAuthResult}</span> <span class="hljs-variable">result</span></span>
 * <span class="hljs-doctag">@param <span class="hljs-type">{Object}</span> </span>[options]
 * <span class="hljs-doctag">@param <span class="hljs-type">{string}</span> </span>[options.clientId] - OAuth client ID.
 * <span class="hljs-doctag">@param <span class="hljs-type">{string}</span> </span>[options.scope] - OAuth scope.
 * <span class="hljs-doctag">@param <span class="hljs-type">{string}</span> </span>[options.tokenEndpoint] - OAuth token endpoint.
 * <span class="hljs-doctag">@param <span class="hljs-type">{string}</span> </span>[options.tokenServerUrl] - TokenServer URL.
 * <span class="hljs-doctag">@returns <span class="hljs-type">{Promise&lt;import(&#x27;../types&#x27;).SyncCredentials&gt;}</span></span>
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">complete</span> (<span class="hljs-params">challenge, result, options</span>) </span>{
  <span class="hljs-comment">// Actual code.</span>
}

<span class="hljs-built_in">module</span>.exports = { complete }
</code></pre>
</details>
<details>
  <summary><a href="https://github.com/valeriangalliat/node-firefox-sync/blob/master/types.js"><code>types.js</code></a></summary>
<pre><code class="hljs language-js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@typedef <span class="hljs-type">{Object}</span> <span class="hljs-variable">SyncOptions</span></span>
 * <span class="hljs-doctag">@property <span class="hljs-type">{string}</span> </span>[authServerUrl]
 * <span class="hljs-doctag">@property <span class="hljs-type">{string}</span> </span>[authorizationUrl]
 * <span class="hljs-doctag">@property <span class="hljs-type">{string}</span> </span>[tokenEndpoint]
 * <span class="hljs-doctag">@property <span class="hljs-type">{string}</span> </span>[tokenServerUrl]
 * <span class="hljs-doctag">@property <span class="hljs-type">{import(&#x27;./auth/oauth-base&#x27;).OAuthOptions}</span> </span>[oauthOptions]
 *
 * <span class="hljs-doctag">@typedef <span class="hljs-type">{Object}</span> <span class="hljs-variable">OAuthToken</span></span>
 * <span class="hljs-doctag">@property <span class="hljs-type">{string}</span> <span class="hljs-variable">access_token</span></span>
 * <span class="hljs-doctag">@property <span class="hljs-type">{string}</span> <span class="hljs-variable">scope</span></span>
 * <span class="hljs-doctag">@property <span class="hljs-type">{number}</span> <span class="hljs-variable">expires_in</span></span>
 *
 * <span class="hljs-doctag">@typedef <span class="hljs-type">{Object}</span> <span class="hljs-variable">SyncToken</span></span>
 * <span class="hljs-doctag">@property <span class="hljs-type">{string}</span> <span class="hljs-variable">id</span></span>
 * <span class="hljs-doctag">@property <span class="hljs-type">{string}</span> <span class="hljs-variable">key</span></span>
 *
 * <span class="hljs-doctag">@typedef <span class="hljs-type">{Object}</span> <span class="hljs-variable">SyncKeyBundle</span></span>
 * <span class="hljs-doctag">@property <span class="hljs-type">{string}</span> <span class="hljs-variable">encryptionKey</span></span>
 * <span class="hljs-doctag">@property <span class="hljs-type">{string}</span> <span class="hljs-variable">hmacKey</span></span>
 * <span class="hljs-doctag">@property <span class="hljs-type">{string}</span> <span class="hljs-variable">kid</span></span>
 *
 * <span class="hljs-doctag">@typedef <span class="hljs-type">{Object}</span> <span class="hljs-variable">SyncCredentials</span></span>
 * <span class="hljs-doctag">@property <span class="hljs-type">{OAuthToken}</span> <span class="hljs-variable">oauthToken</span></span> - The OAuth token required to authenticate to the TokenServer.
 * <span class="hljs-doctag">@property <span class="hljs-type">{SyncKeyBundle}</span> <span class="hljs-variable">syncKeyBundle</span></span> - The Sync key bundle required to decrypt the collection keys.
 * <span class="hljs-doctag">@property <span class="hljs-type">{SyncToken}</span> <span class="hljs-variable">token</span></span> - The token object required to call the Firefox Sync API.
 * <span class="hljs-doctag">@property <span class="hljs-type">{number}</span> <span class="hljs-variable">tokenIssuedAt</span></span> - Timestamp in milliseconds of when the token was issued to preemptively refresh it.
 */</span>

<span class="hljs-comment">// Does nothing but required for TypeScript to import this file.</span>
<span class="hljs-built_in">module</span>.exports = {}
</code></pre>
</details>
<p>Because I was writing that library from scratch and not adding types to
an existing project, this came at a lower cost, and yielded two major
benefits:</p>
<ul>
<li>I can leverage TypeScript for type checking even though the code is
pure JavaScript.</li>
<li>I can let TypeScript derivate <strong>accurate</strong> type definitions from the
source code.</li>
</ul>
<p>Since the <code>.d.ts</code> files are automatically generated as opposed to being
manually maintained, this drastically reduces the chance for them to go
out of sync or be inaccurate, especially because the code itself is also
type checked (this is important because TypeScript will otherwise
happily generate totally broken type definitions from JSDoc comments
that don‚Äôt pass type checking).</p>
<p>Also for that same reason, if the types were to be incomplete (there‚Äôs
still a number of <code>any</code> in this project, I admit), contributors will
have to add them as JSDoc comments to the JavaScript source and not just
to a ‚Äúdead‚Äù <code>.d.ts</code> file, making the code safer as a side effect by
increasing the actual type checking coverage, and guaranteeing that the
exported types match the underlying implementation. Not only this tests
code against the types, but as importantly, <strong>it tests the types against
the code</strong>.</p>
<h2 id="why-this-works-best-for-me" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/jsdoc-typescript-inside-javascript.html#why-this-works-best-for-me"><span>Why this works best for me</span></a></h2>
<p>With this pattern, I can still <strong>write, run and debug native JavaScript
code</strong>.</p>
<p>This is what makes me <strong>efficient at what I‚Äôm doing</strong>. My development is
not slowed down by constantly running a compiler, dealing with the extra
complexity that comes with debugging transpiled code, and time spent
fixing type errors on non-production code.</p>
<p>When I write a piece of code, it‚Äôs rarely going to be perfect,
production quality code from the start. It takes me dozens of iterations
and rewriting pieces of it until I reach a point where I‚Äôm satisfied.
Only when I‚Äôm done I‚Äôll clean up and refactor whatever parts need extra
love, handle the edge cases, and make the linter happy. This is when,
and only when, I want to run the type checks. There‚Äôs no point in having
blocking type checks on code that I‚Äôll rewrite or remove a minute later.</p>
<div class="note">
<p><strong>Note:</strong> this last point is a problem that I had specifically with the
<code>ts-node</code> utility, but <code>tsc</code> itself is more forgiving and will output a
runnable JS code even when there‚Äôs type errors.</p>
<p>Also while writing this section, I stumbled upon <code>ts-node --transpile-only</code>
that allows running the code even if it doesn‚Äôt pass type validation,
which seems like a must-have during development. I‚Äôm kinda sour that
it took me a 4 months post-burnout retirement kind of step back to
finally find about it, after fighting with this problem for years. üò¨</p>
</div>
<h2 id="the-chicken-and-egg-problem-between-js-and-d-ts" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/jsdoc-typescript-inside-javascript.html#the-chicken-and-egg-problem-between-js-and-d-ts"><span>The chicken and egg problem between <code>.js</code> and <code>.d.ts</code></span></a></h2>
<p>I didn‚Äôt share the commands I use to do the type checking and derive the
<code>.d.ts</code> files from the JSDoc comments yet, and you‚Äôre probably dying to
know them. üòâ</p>
<p>But first, I need to share something else with you. See, I usually have
this kind of structure for packages I publish on npm:</p>
<pre><code class="hljs">my-cool-package
‚îú‚îÄ‚îÄ index.js
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ test.js
</code></pre>
<p>It seems that the natural way to <a href="https://www.typescriptlang.org/docs/handbook/declaration-files/dts-from-js.html#tsconfig">extract type definitions</a>
would be:</p>
<pre><code class="hljs language-sh">tsc *.js --allowJs --declaration --emitDeclarationOnly
</code></pre>
<p>Which yields:</p>
<pre><code class="hljs">my-cool-package
‚îú‚îÄ‚îÄ <span class="hljs-addition">index.d.ts</span>
‚îú‚îÄ‚îÄ index.js
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ <span class="hljs-addition">test.d.ts</span>
‚îî‚îÄ‚îÄ test.js</code></pre>
<p>You‚Äôll quickly notice that there‚Äôs something funky with this method of
doing things.</p>
<ul>
<li>We generate <code>.d.ts</code> files from <code>.js</code> files.</li>
<li>TypeScript has an <strong>hardcoded</strong> rule where it systematically imports
any <code>.d.ts</code> file that‚Äôs next to an imported <code>.js</code> file. This is
regardless of your explicit <code>include</code> and <code>exclude</code> patterns and
there‚Äôs no way to turn off this behavior.</li>
<li>TypeScript refuses to overwrite input files (and that‚Äôs a good thing).</li>
</ul>
<p>But guess what? <code>test.js</code> imports <code>index.js</code> (so that it can, you know,
test it).</p>
<p>The problem here is that while this command will run fine the first
time, <a href="https://github.com/microsoft/TypeScript/issues/16749">subsequent runs will fail</a>
because TypeScript will <em>always</em> consider a <code>.d.ts</code> that is next to an
included <code>.js</code> file to be part of its inputs and will refuse to
overwrite it. And even if it allowed to overwrite the declaration files,
we would still be loading the stale <code>.d.ts</code> instead of using the
up-to-date JSDoc types, which sounds like a hot mess.</p>
<p>You might tell me that hey, we don‚Äôt really need a <code>.d.ts</code> to be
generated for the test file, and you would be right. Replacing <code>*.js</code> by
<code>index.js</code> in the above example does fix the problem.</p>
<p>But sometimes, I‚Äôm dealing with a more complex package where the
structure would look something like this:</p>
<pre><code class="hljs">my-cool-package
‚îú‚îÄ‚îÄ index.js
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ <span class="hljs-addition">some-other-file.js</span>
‚îî‚îÄ‚îÄ test.js</code></pre>
<p>As soon as <code>index.js</code> imports <code>some-other-file.js</code>, we‚Äôre off the happy
path for TypeScript again.</p>
<p>I wrote about this in more details in <a href="https://www.codejam.info/2021/10/typescript-cannot-write-file-overwrite-input.html">cannot write file <code>.d.ts</code> because it would overwrite input file</a>,
and you have many options to go about this, including splitting the code
in a <code>src</code> or <code>dist</code> directory or some combination of both, and while
they all solve this particular problem, they also all leak into other
aspects that you‚Äôll have to work around.</p>
<p>For example in the ‚Äúcomplex‚Äù case above, you might want to allow
your users to <code>import 'my-cool-package/some-other-file'</code>, and not just
<code>import 'my-cool-package'</code>. How wild would that be?</p>
<p>Apparently, wild enough that most of the recommended solutions for the
earlier problem will fail to deliver types information for that use
case, or require you to do crazy things like copying your <code>package.json</code>
to the <code>dist</code> directory and publishing from there.</p>
<h2 id="the-simple-hack-that-just-works" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/jsdoc-typescript-inside-javascript.html#the-simple-hack-that-just-works"><span>The simple hack that just works</span></a></h2>
<p>Because I prefer a simple hack that just works to a fix that will break
other things and require a cascade of other fixes, I settled for the
following command:</p>
<pre><code class="hljs"><span class="hljs-addition">rm -f *.d.ts && </span>tsc *.js --allowJs --declaration --emitDeclarationOnly</code></pre>
<p>It‚Äôs simple, reliable, it works and I understand every bit of why it
works and why it needs to be there (as much as I hate that it needs to
be there in the first place).</p>
<p>I also added <code>--removeComments</code> and replaced <code>--allowJs</code> by <code>--checkJs</code>
to make sure that the code passes type checking when I generate the
final definitions.</p>
<p>In my <code>package.json</code>, the final <code>scripts</code> property looks like this:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;scripts&quot;</span>: {
    <span class="hljs-attr">&quot;check&quot;</span>: <span class="hljs-string">&quot;tsc *.js --checkJs --noEmit&quot;</span>,
    <span class="hljs-attr">&quot;lint&quot;</span>: <span class="hljs-string">&quot;standard&quot;</span>,
    <span class="hljs-attr">&quot;prepare&quot;</span>: <span class="hljs-string">&quot;npm run lint &amp;&amp; npm run types&quot;</span>,
    <span class="hljs-attr">&quot;types&quot;</span>: <span class="hljs-string">&quot;rm *.d.ts &amp;&amp; tsc *.js --checkJs --declaration --emitDeclarationOnly --removeComments&quot;</span>
  }
}
</code></pre>
<p>As always, I use <a href="https://standardjs.com/"><code>standard</code></a> to lint my code,
and in the <a href="https://docs.npmjs.com/cli/v7/using-npm/scripts#life-cycle-scripts"><code>prepare</code></a>
script, the code is linted, typed checked and the definitions are
updated.</p>
<p>There‚Äôs also a convenience <code>check</code> script that doesn‚Äôt emits the
declaration files, to be used for quick checks during development.</p>
<h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/jsdoc-typescript-inside-javascript.html#conclusion"><span>Conclusion</span></a></h2>
<p>As usual with TypeScript it was a pain in the ass to get this to work
and (also as usual) I had to resort to a hack at the end of the day. But
that‚Äôs mostly because I‚Äôm a perfectionist and I wasn‚Äôt happy with having
just the happy path working. üòú</p>
<p>Still, I believe that this method allows to reduce the gap between
TypeScript and JavaScript, while <strong>getting rid of manual work</strong>, making
the JavaScript code <strong>safer</strong>, and making the type definitions <strong>more
accurate and reliable</strong> by tightly coupling them to the code.</p>
<p>Because it yields <strong>most of the benefit</strong> at the <strong>lowest cost and
initial investment</strong>, TypeScript-aware JSDoc comments is likely to
become my go-to for writing JS libraries from now on.</p>
<p>What do you think of this solution? Have you used it yourself, or did
this make you want to type your projects this way? Feel free to <a href="https://www.codejam.info/val.html#contact">reach out</a>
and let me know. And as usual, keep hacking! ‚ú®</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1449783928970256394">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>TypeScript: cannot write file .d.ts because it would overwrite input file</title>
    <link href="https://www.codejam.info/2021/10/typescript-cannot-write-file-overwrite-input.html" />
    <id>https://www.codejam.info/2021/10/typescript-cannot-write-file-overwrite-input.html</id>
    <updated>2021-10-16T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>There‚Äôs <a href="https://stackoverflow.com/questions/42609768/typescript-error-cannot-write-file-because-it-would-overwrite-input-file">countless</a>
<a href="https://stackoverflow.com/questions/46914070/how-to-exclude-d-ts-file-for-typescript-compiler">issues</a>
<a href="https://github.com/microsoft/TypeScript/issues/16749">about</a>
this error and I thought it would be useful to write a clear explanation
of what‚Äôs going on and a summary of the possible solutions.</p>
<p>This happens for two reasons:</p>
<ol>
<li>You‚Äôre explicitly including those <code>.d.ts</code> files e.g. as part of your
<code>include</code> array in <code>tsconfig.json</code> or as part of the <code>tsc</code> arguments,
and you‚Äôre asking TypeScript to output type declarations in the same
place. Then the error is pretty obvious and the fix should be too
(don‚Äôt output the generated declarations in the same place as types
you‚Äôre importing, for example using <code>outDir</code>, or don‚Äôt import those
generated declarations in the first place).</li>
<li>You‚Äôre not importing those <code>.d.ts</code> files, or you‚Äôre even explicitly
ignoring them e.g. with the <code>exclude</code> array in <code>tsconfig.json</code>, yet
TypeScript keeps using them as input and complaining that it can‚Äôt
overwrite them when generating type declarations.</li>
</ol>
<p>Here we‚Äôll go in more details about the second reason.</p>
<h2 id="the-problem" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/typescript-cannot-write-file-overwrite-input.html#the-problem"><span>The problem</span></a></h2>
<p>The main thing that you need to know is that if you‚Äôre importing a <code>.js</code>
file and there‚Äôs a matching <code>.d.ts</code> next to it, TypeScript will
<strong>always</strong> import it, even if you didn‚Äôt explicitly include those
<code>.d.ts</code> files as input, and even if you explicitly put them in the
<code>exclude</code> array. There‚Äôs no way around this.</p>
<h2 id="output-d-ts-declarations-to-a-separate-directory" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/typescript-cannot-write-file-overwrite-input.html#output-d-ts-declarations-to-a-separate-directory"><span>Output <code>.d.ts</code> declarations to a separate directory</span></a></h2>
<p>One solution is to put the generated type declarations in a separate
directory instead of next to the <code>.js</code> files. You can do that by
configuring a <code>outDir</code>, as explained in the documentation about
<a href="https://www.typescriptlang.org/docs/handbook/declaration-files/dts-from-js.html#tsconfig">creating <code>.d.ts</code> files from <code>.js</code> files</a>:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;compilerOptions&quot;</span>: {
    <span class="hljs-comment">// Tells TypeScript to read `.js` files, as normally they are</span>
    <span class="hljs-comment">// ignored as source files.</span>
    <span class="hljs-attr">&quot;allowJs&quot;</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// Generate `d.ts` files.</span>
    <span class="hljs-attr">&quot;declaration&quot;</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// This compiler run should only output `d.ts` files.</span>
    <span class="hljs-attr">&quot;emitDeclarationOnly&quot;</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// Types should go into this directory. Removing this would place</span>
    <span class="hljs-comment">// the `.d.ts` files next to the `.js` files.</span>
    <span class="hljs-attr">&quot;outDir&quot;</span>: <span class="hljs-string">&quot;dist&quot;</span>
  }
}
</code></pre>
<p>As they nicely indicate, if you don‚Äôt specify <code>outDir</code>, the <code>.d.ts</code> will
be put next to the <code>.js</code> files (which literally means they‚Äôll be
automatically considered as inputs on the next build and it will crash),
and it‚Äôs probably the way you‚Äôre using this right now.</p>
<p>Then you can tell TypeScript where to <a href="https://www.typescriptlang.org/docs/handbook/declaration-files/publishing.html">find the package types</a>
in your <code>package.json</code>:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;types&quot;</span>: <span class="hljs-string">&quot;dist&quot;</span>
}
</code></pre>
<p>But this only works for the main export (<code>import 'my-lib'</code>) and will
break if you attempt to import nested files <code>import 'my-lib/some-file'</code>.</p>
<p>If you want to support this use case, you <strong>have to</strong> ship the <code>.d.ts</code>
files next to the <code>.js</code> files.</p>
<p>So here‚Äôs a few alternative solutions and their tradeoffs.</p>
<h2 id="copy-the-js-files-next-to-the-d-ts-declarations" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/typescript-cannot-write-file-overwrite-input.html#copy-the-js-files-next-to-the-d-ts-declarations"><span>Copy the <code>.js</code> files next to the <code>.d.ts</code> declarations</span></a></h2>
<p>Since we can‚Äôt generate the <code>.d.ts</code> next to the source <code>.js</code> files (well
we can, but just once), we can instead generate the <code>.d.ts</code> files to a
<code>dist</code> directory and copy the <code>.js</code> files next to them.</p>
<p>There‚Äôs two ways you can do that, the first one I tried is to remove
<code>emitDeclarationOnly</code> so that let TypeScript compiles the source <code>.js</code>
files to the <code>outDir</code>, and the other one is to manually copy them.</p>
<p>In both cases there‚Äôs a number of caveats with that about how you import
nested files, and I‚Äôll go through the possible workarounds.</p>
<h3 id="compile-your-js-files-to-js-lol" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/typescript-cannot-write-file-overwrite-input.html#compile-your-js-files-to-js-lol"><span>Compile your JS files to JS (lol)</span></a></h3>
<p>The reason you have this error in the first place is likely because
you‚Äôre writing actual JavaScript and generating types from JSDoc.</p>
<p>One of the numerous benefits of doing that is that you don‚Äôt need to
compile your code. Your <code>src</code> is your <code>dist</code> and that‚Äôs the beauty of
it. You run what you write, no compilation, no source maps, and no
configuration of every single tool and service you use to deal with this
extra complexity.</p>
<p>You can throw away all of those benefits by letting TypeScript compile
your <code>.js</code> files to the <code>outDir</code>, by removing <code>emitDeclarationOnly</code> from
the <code>tsc</code> command or <code>tsconfig.json</code>, so that they‚Äôre put along the
generated <code>.d.ts</code> files.</p>
<p>But at that point you might as well write TypeScript in the first place.</p>
<h3 id="manually-copy-your-js-files-to-the-outdir" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/typescript-cannot-write-file-overwrite-input.html#manually-copy-your-js-files-to-the-outdir"><span>Manually copy your JS files to the <code>outDir</code></span></a></h3>
<p>A <a href="https://vccolombo.github.io/blog/tsc-how-to-copy-non-typescript-files-when-building/">better way</a>
if you want to ship your <code>.js</code> files unaltered is to copy them yourself
next to the <code>.d.ts</code> declarations.</p>
<pre><code class="hljs language-sh">tsc *.js --allowJs --declaration --emitDeclarationOnly --outDir dist &amp;&amp; cp *.js dist
</code></pre>
<p>Then you can <code>import 'my-lib/dist/some-file</code> and types will work
properly. If you want to allow deep imports though, we need to dig a bit
further.</p>
<h2 id="getting-it-to-work-with-deep-nested-imports" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/typescript-cannot-write-file-overwrite-input.html#getting-it-to-work-with-deep-nested-imports"><span>Getting it to work with deep/nested imports</span></a></h2>
<p>If you want to allow <code>import 'my-lib/some-file'</code> and don‚Äôt like the idea
of documenting <code>import 'my-lib/dist/some-file'</code>, you have again
<a href="https://stackoverflow.com/questions/67097803/how-to-let-users-import-from-subfolders-of-my-npm-package">a few options</a>.</p>
<h3 id="compile-to-the-project-root" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/typescript-cannot-write-file-overwrite-input.html#compile-to-the-project-root"><span>Compile to the project root</span></a></h3>
<p>Make sure your source files are in a subfolder, e.g. <code>src</code>, then compile
to the project root directory.</p>
<pre><code class="hljs language-sh">tsc src/*.js --allowJs --declaration --emitDeclarationOnly --outDir . &amp;&amp; cp src/*.js .
</code></pre>
<h3 id="publish-from-your-dist-directory" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/typescript-cannot-write-file-overwrite-input.html#publish-from-your-dist-directory"><span>Publish from your <code>dist</code> directory</span></a></h3>
<p>The previous solution might get a bit messy though so
<a href="https://stackoverflow.com/questions/38935176/how-to-npm-publish-specific-folder-but-as-package-root">alternatively</a>
you can use the earlier command with <code>--outDir dist</code>, but put your
<code>package.json</code> in the <code>dist</code> directory as well, and run <code>npm publish dist</code> (or <code>cd dist &amp;&amp; npm publish</code>).</p>
<p>Whether you want your <code>package.json</code> to live in the <code>dist</code> directory
(and commit it there), or run <code>cp package.json dist</code> as part of your
build command is up to you.</p>
<h3 id="write-an-exports-map" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/typescript-cannot-write-file-overwrite-input.html#write-an-exports-map"><span>Write an <code>exports</code> map</span></a></h3>
<p>If you‚Äôre not happy with the previous solutions, you can write an
<a href="https://nodejs.org/api/packages.html#packages_exports"><code>exports</code> map</a>
in your <code>package.json</code> so that <code>import 'my-lib/some-file</code> translates
to <code>my-lib/dist/some-file</code>.</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;exports&quot;</span>: {
   <span class="hljs-attr">&quot;./some-file&quot;</span>: <span class="hljs-string">&quot;./dist/some-file&quot;</span>,
   <span class="hljs-attr">&quot;./some/other-file&quot;</span>: <span class="hljs-string">&quot;./dist/some/other-file&quot;</span>
  }
}
</code></pre>
<p>That being said only the paths defined here will be allowed to be
imported, you won‚Äôt be able to import arbitrary files anymore, which
might not be a bad thing, but maybe you like the simplicity of
everything being importable by default.</p>
<h2 id="quick-and-dirty-hack-that-actually-works" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/typescript-cannot-write-file-overwrite-input.html#quick-and-dirty-hack-that-actually-works"><span>Quick and dirty hack that actually works</span></a></h2>
<p>To get the best of both worlds by generating <code>.d.ts</code> files next to your
source <code>.js</code> files without adding extra configuration and still allowing
deep imports, you need to <strong>explicitly remove the generated files before
running the compiler</strong>.</p>
<p>Simple, easy and dirty:</p>
<pre><code class="hljs language-sh">rm -f *.d.ts &amp;&amp; tsc *.js --allowJs --declaration --emitDeclarationOnly
</code></pre>
<p>Here I use <code>rm -f</code> so that it doesn‚Äôt fail if the declaration files are
not generated yet. Feel free to tweak the pattern, for example if you
have subfolders you want to include.</p>
<p>I‚Äôm not a big fan of this solution, but it‚Äôs still my favorite of all
the ones I described in this post. It seems that TypeScript wasn‚Äôt built
for simplicity, let alone for working with source <code>.js</code> files, and deep
imports don‚Äôt seem to be part of the happy path either. If you found a
better way, please <a href="https://www.codejam.info/val.html#contact">let me know</a>!</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>Bypass SQLite exclusive lock üîê</title>
    <link href="https://www.codejam.info/2021/10/bypass-sqlite-exclusive-lock.html" />
    <id>https://www.codejam.info/2021/10/bypass-sqlite-exclusive-lock.html</id>
    <updated>2021-10-14T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>There‚Äôs a <a href="https://www.sqlite.org/lockingv3.html">number of ways</a> SQLite
can lock a database file, and if you‚Äôre encountering a ‚Äúdatabase is
locked‚Äù error, according to <a href="https://stackoverflow.com/questions/151026/how-do-i-unlock-a-sqlite-database">the internet</a>,
you have two options:</p>
<ol>
<li>If you control the software that created the lock, go and fix the
problematic queries.</li>
<li>You‚Äôre fucked.</li>
</ol>
<p>By ‚Äúyou‚Äôre fucked‚Äù I mean that your seemingly only option is to <strong>copy
the whole database file and query the copy</strong>. If working off a one-time
snapshot of the database work for you, awesome, problem solved:</p>
<pre><code class="hljs language-sh">$ <span class="hljs-built_in">echo</span> .tables | sqlite3 db.sqlite
Error: database is locked
$ cp db.sqlite db-snapshot.sqlite
$ <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;.tables&#x27;</span> | sqlite3 db-snapshot.sqlite
actual_table
</code></pre>
<p>But it seems that‚Äôs not a good enough solution for many people (including myself)
and we‚Äôre desperately trying to <a href="https://stackoverflow.com/questions/7857755/is-it-possible-to-open-a-locked-sqlite-database-in-read-only-mode">perform</a>
<a href="https://www.linuxquestions.org/questions/linux-server-73/can-i-open-sqlite-datbase-in-read-only-mode-4175578075/">read-only</a>
<a href="https://github.com/skeeto/emacsql/issues/34">queries</a>
<a href="https://www.reddit.com/r/firefox/comments/aw01gq/how_to_disable_sqlite_database_locking_for/">on a</a>
<a href="https://dba.stackexchange.com/questions/45368/how-do-i-prevent-sqlite-database-locks">locked</a>
SQLite database.</p>
<p>This is especially useful for <strong>Firefox</strong> and <strong>Chrome</strong> SQLite files
because both browsers have a bad tendency to keep them permanently
locked, preventing us to access the database without closing the browser
first.</p>
<p>In my case, I want to poll a specific table, and while technically the
database is small enough that it‚Äôs not a problem to copy it over and
over to query it periodically, <strong>I just don‚Äôt like this idea</strong>
and I believe there <em>must</em> be a better way.</p>
<p>So let me tell you the better way.</p>
<h2 id="the-better-way" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/bypass-sqlite-exclusive-lock.html#the-better-way"><span>The better way</span></a></h2>
<p>SQLite <a href="https://www.sqlite.org/c3ref/open.html">allows passing</a> a
<a href="https://www.sqlite.org/uri.html"><code>file:</code> URI</a> instead of a filename
(e.g. <code>file:db.sqlite</code> instead of <code>db.sqlite</code>), which comes with the
extra ability to pass query string parameters.</p>
<p>Some of those are aliases for flags you could otherwise set when opening
the connexion, for example <a href="https://github.com/sqlite/sqlite/blob/8436f53ebe369e0d646068d3b25ea11673debf0e/src/main.c#L3023"><code>mode=ro</code></a>
is equivalent to setting <a href="https://www.sqlite.org/c3ref/c_open_autoproxy.html"><code>SQLITE_OPEN_READONLY</code></a>
and <a href="https://github.com/sqlite/sqlite/blob/8436f53ebe369e0d646068d3b25ea11673debf0e/src/main.c#L3011"><code>cache=private</code></a>
the same as <a href="https://www.sqlite.org/c3ref/c_open_autoproxy.html"><code>SQLITE_OPEN_PRIVATECACHE</code></a>.</p>
<p>But we also have other parameters that have a deeper implementation that
would otherwise be inaccessible to the SQLite user (no configuration
flags for those). In particular, <a href="https://github.com/sqlite/sqlite/blob/8436f53ebe369e0d646068d3b25ea11673debf0e/src/pager.c#L4913"><code>nolock</code></a>
and <a href="https://github.com/sqlite/sqlite/blob/8436f53ebe369e0d646068d3b25ea11673debf0e/src/pager.c#L4915"><code>immutable</code></a>.</p>
<p>While <code>nolock</code> only prevents this connection from locking the database
and doesn‚Äôt do anything about the fact a lock is already being held by
another connection, the <code>immutable</code> is especially interesting for us.
From its <a href="https://www.sqlite.org/c3ref/open.html">documentation</a>:</p>
<blockquote>
<p>The immutable parameter is a boolean query parameter that indicates
that the database file is stored on read-only media. When <code>immutable</code>
is set, SQLite assumes that the database file cannot be changed, and
so the database is opened read-only and <strong>all locking and change
detection is disabled</strong>.</p>
<p><strong>Caution:</strong> setting the immutable property on a database file that
does in fact change can result in incorrect query results and/or
<a href="https://www.sqlite.org/rescode.html#corrupt"><code>SQLITE_CORRUPT</code></a> errors.</p>
<p><strong>See also:</strong> <a href="https://www.sqlite.org/c3ref/c_iocap_atomic.html"><code>SQLITE_IOCAP_IMMUTABLE</code></a>.</p>
</blockquote>
<p>Even though <code>SQLITE_IOCAP_IMMUTABLE</code> is not an option per se, but a
particular characteristic of the IO device, we can force SQLite to treat
the database as if was on an read-only device by setting <code>immutable=1</code>,
which has the particularity of disabling all locking mechanisms,
<strong>including that of respecting existing locks</strong>.</p>
<p>With this trick, we can rewrite the previous fix:</p>
<pre><code class="hljs language-sh">$ <span class="hljs-built_in">echo</span> .tables | sqlite3 db.sqlite
Error: database is locked
$ <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;.tables&#x27;</span> | sqlite3 <span class="hljs-string">&#x27;file:db.sqlite?immutable=1&#x27;</span>
actual_table
</code></pre>
<p>This doesn‚Äôt require creating a copy of the file that you want to
query it despite it being locked by another active connection!</p>
<p>The only caveat is because SQLite doesn‚Äôt expect that file to be
updated, changes wont be reflected in that immutable connexion, so it‚Äôs
still like you‚Äôre querying a snapshot, it‚Äôs just that you don‚Äôt have to
physically copy the database in order to read it.</p>
<p>Also as mentioned earlier, if the underlying database is updated, this
might result in errors when querying over the immutable connection.
Because of that, I would recommending opening a new connection every
time you want to query the database.</p>
<h2 id="applying-it-to-a-sqlite-driver" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/bypass-sqlite-exclusive-lock.html#applying-it-to-a-sqlite-driver"><span>Applying it to a SQLite driver</span></a></h2>
<p>It‚Äôs nice to be able to do that with the CLI, but how do we do that from
a program that uses a SQLite driver? In my case I‚Äôm using
<a href="https://www.npmjs.com/package/sqlite3"><code>sqlite3</code></a> with Node.js, but the
method should be very similar in your language of choice.</p>
<p>Because the <code>immutable</code> option is only available in the <a href="https://www.sqlite.org/uri.html">URI filename</a>
format, we need to pass this kind of URI to our driver, e.g.
<code>file:db.sqlite?immutable=1</code> as opposed to <code>db.sqlite</code>.</p>
<p>The URI format is not enabled by default and you need to pass the
<a href="https://www.sqlite.org/c3ref/c_open_autoproxy.html"><code>SQLITE_OPEN_URI</code></a>
flag in order to enable it.</p>
<p>With <code>sqlite3</code>, this looks like this:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> sqlite3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;sqlite3&#x27;</span>)
<span class="hljs-keyword">const</span> db = <span class="hljs-keyword">new</span> sqlite3.Database(<span class="hljs-string">&#x27;file:db.sqlite?immutable=1&#x27;</span>, sqlite3.OPEN_READONLY | sqlite3.OPEN_URI)
</code></pre>
<p>We need to precise <code>OPEN_READONLY</code> because <code>OPEN_URI</code> alone is not a
valid mode, and by passing an explicit mode, we‚Äôre effectively
overriding the <a href="https://github.com/mapbox/node-sqlite3/blob/918052b538b0effe6c4a44c74a16b2749c08a0d2/src/database.cc#L135">default</a>
of <code>SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE | SQLITE_OPEN_FULLMUTEX</code>.</p>
<h2 id="wrapping-up" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/bypass-sqlite-exclusive-lock.html#wrapping-up"><span>Wrapping up</span></a></h2>
<p>I hope you enjoyed this trick! If you find a better way to do this, or
a way that allows to reflect underlying database updates without
reloading the connection, please <a href="https://www.codejam.info/val.html#contact">let me know</a>, I‚Äôd
love to know about it!</p>
<p>And as usual, keep hacking. üòú</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1448722067638177795">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>How long can you keep a tent and sleeping bag packed wet? üèï</title>
    <link href="https://www.codejam.info/2021/10/tent-sleeping-bag-packed-wet.html" />
    <id>https://www.codejam.info/2021/10/tent-sleeping-bag-packed-wet.html</id>
    <updated>2021-10-05T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>Camping is not always going as planned. You might hit unexpected rain,
or just a very humid weather, and might be forced to leave in unideal
conditions, where your sleeping bag or tent is still humid from rain or
condensation, and you‚Äôre not in a situation where you can properly dry
it off before packing.</p>
<p>How bad can it be if you packed your wet sleeping bag or tent? What if
you forgot it like this for a few days, or just weren‚Äôt in a situation
where you could take it out to dry the same day? How bad can this be for
your equipment? Here‚Äôs my experience.</p>
<figure class="center">
  <a href="https://photography.codejam.info/photos/P2560398.html">
    <img alt="Tents in snow" src="https://photography.codejam.info/photos/sd/P2560398.jpg">
  </a>
</figure>
<h2 id="equipment-and-context" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/tent-sleeping-bag-packed-wet.html#equipment-and-context"><span>Equipment and context</span></a></h2>
<p>My tent is a <a href="https://www.msrgear.com/ca/tents/backpacking-tents/hubba-hubba-nx-2-person-backpacking-tent/10316.html">MSR Hubba Hubba NX</a>,
and my sleeping bag is actually a <a href="https://enlightenedequipment.com/revelation-custom/">down quilt</a>
made by <a href="https://enlightenedequipment.com/">Enlightened Equipment</a>. Both
are fairly expensive so I‚Äôm always pretty cautious about them.</p>
<p>Few days ago I was camping and packed my tent in the morning after a
rainy night. It was going to rain all day so there was no chance of the
equipment drying properly before leaving.</p>
<p>This is not the first time this happens, and usually I can unpack them a
few hours later or at least the same night at home, and have them dry in
the apartment or outside if it‚Äôs nice enough. When it‚Äôs dry, I shake the
dust off the tent and pack everything nicely again. Or if I‚Äôm on a
multiday hike, I‚Äôll just set it up again somewhere else the same night,
and even if it‚Äôs still raining, the humidity is usually not a problem
unless the gear is tightly packed and cannot breathe.</p>
<figure class="center">
  <a href="https://photography.codejam.info/photos/P2640878.html">
    <img alt="Tent on an island" src="https://photography.codejam.info/photos/sd/P2640878.jpg">
  </a>
</figure>
<h2 id="the-exception" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/tent-sleeping-bag-packed-wet.html#the-exception"><span>The exception</span></a></h2>
<p>But this time, something different happened that made me forget about my
equipment. We went for a bouldering session during the day, and <strong>I took
a pretty bad fall and broke my tailbone</strong>. Not bad enough for me to go
to the hospital, but still shook me enough that I forgot about my tent
and sleeping bag during the rest of the trip (we were staying at a
chalet for the last few days).</p>
<p><strong>I left my (damp) gear packed in my hiking backpack</strong>. It‚Äôs only when
getting back home that I realized everything stayed packed wet for 4
days straight. Kinda worrying when you read online a sleeping bag
shouldn‚Äôt stay compressed more than 12 hours, let alone compressed wet,
and a tent can develop mold when stored wet for more than 24 or 48
hours.</p>
<blockquote>
<p>Generally speaking, you should not leave your sleeping bag in a
compression sack for longer than 12 hours at a time.</p>
<p>This is only a guideline though, and you shouldn‚Äôt worry if your
sleeping bag is compressed for longer than this. It is not like it
will be ruined if it‚Äôs stored for another few hours or even a day like
this.</p>
<p>‚Äî <a href="https://bigoutdooradventure.com/compression-sack-sleeping-bags-how-long-can-they-stay-compressed/">Big Outdoor Adventure, ‚ÄúCompression sack sleeping bags ‚Äì how long can they stay compressed?‚Äù</a></p>
</blockquote>
<p>What about when it‚Äôs 4 days straight or more though?</p>
<blockquote>
<p>It only takes 24 to 48 hours before mold starts to noticeably grow on
the fabric of your tent.</p>
<p>‚Äî <a href="https://bigoutdooradventure.com/compression-sack-sleeping-bags-how-long-can-they-stay-compressed/">Camping Habits, ‚ÄúHow long can you store a wet tent?‚Äù</a></p>
</blockquote>
<figure class="center">
  <a href="https://photography.codejam.info/photos/P2560533.html">
    <img alt="Tents with a sunset" src="https://photography.codejam.info/photos/sd/P2560533.jpg">
  </a>
</figure>
<h2 id="how-bad-was-it" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/tent-sleeping-bag-packed-wet.html#how-bad-was-it"><span>How bad was it?</span></a></h2>
<p>When I unpacked everything, they were both still pretty wet to the
touch. I let them dry overnight in my apartment. üôè Those are very good
and expensive equipment and I was worried that I might have ruined or
significantly damaged them by leaving them packed wet for pretty much
4 times longer than recommended.</p>
<p>The next day, I shook everything off, and it turns out the tent didn‚Äôt
develop any mold! And the sleeping bag was nicely dry and took back its
normal fluffiness. Both smelled as smokey as usual üòÜ, no worst no
better, but definitely not like mold or anything concerning.</p>
<h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/10/tent-sleeping-bag-packed-wet.html#conclusion"><span>Conclusion</span></a></h2>
<p>While you should definitely avoid doing that, if you end up in a
situation where you left your tent or sleeping bag packed wet for a
few days, maybe even a week, don‚Äôt sweat it, <strong>you probably didn‚Äôt ruin
your gear</strong>!</p>
<p>If you have high quality equipment, maybe it‚Äôll last 28 years instead of
30 because of such a mistake? But it shouldn‚Äôt be a huge deal if it
<strong>happens exceptionally</strong> and you otherwise <strong>take good care of it</strong>.</p>
<p>Did you have a similar experience where you left your gear packed in an
unideal way for longer than you would have wanted to? <a href="https://www.codejam.info/val.html#contact">Let me know</a>
what kind of gear you have, what happened and how it turned out! I‚Äôd
love to update this post and get a better idea of how different
equipment react to rough situations.</p>
<figure class="center">
  <a href="https://photography.codejam.info/photos/P1060390-Edit.html">
    <img alt="Tents in snow" src="https://photography.codejam.info/photos/sd/P1060390-Edit.jpg">
  </a>
</figure>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>Authy: reversed üîê</title>
    <link href="https://www.codejam.info/2021/09/authy-reversed.html" />
    <id>https://www.codejam.info/2021/09/authy-reversed.html</id>
    <updated>2021-09-28T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>I recently signed up for SendGrid for a new business. It seems like a
nice tool to send my transactional emails.</p>
<p>One thing with SendGrid though is that they enforce 2FA. You can‚Äôt
access your account without enabling 2FA first. That‚Äôs great, except one
thing:</p>
<p><strong>They only offer two options for 2FA: Authy and SMS.</strong></p>
<p>That‚Äôs somewhat understandable, because SendGrid belongs to Twilio, who
also owns Authy. By forcing SendGrid users on Authy, and making sure
that they can‚Äôt easily use any of the competitor 2FA apps, they boost
their Authy adoption metrics, and that will certainly make investors
happy. Users? Not so much.</p>
<p>But I‚Äôm not a Authy user, and I don‚Äôt plan to be. I definitely will not
install the Authy app just for this. ‚ÄúUse the alternative SMS 2FA
method‚Äù you‚Äôll say? But that‚Äôs less secure on top of having a poor user
experience. I‚Äôd rather <a href="https://www.codejam.info/2021/09/totp-2fa-support-any-password-manager.html">use my existing password manager for this</a>
which is much faster and more convenient.</p>
<div class="note">
<p><strong>Note:</strong> if you don‚Äôt care about the technical details and just want to
transfer your Authy secrets to another authenticator, check out
<a href="https://github.com/valeriangalliat/authy-user-client">Authy user client</a>.</p>
<p>Otherwise, keep reading, I‚Äôll give you all the details about it! ‚úåÔ∏è</p>
</div>
<h2 id="here-we-go-again" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/authy-reversed.html#here-we-go-again"><span>Here we go again</span></a></h2>
<p>Every time I face a situation like this, I reverse.
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-existing-clients.html">I love</a>
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html">reversing</a>
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-understanding-browserid.html">things</a>,
especially when it helps me make my life better. I‚Äôll spend
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html">days</a>,
even
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html">weeks</a>
doing what‚Äôs necessary to achieve what I want.</p>
<p>Maybe that means decompiling apps and running them through a debugger,
or patching APKs to wipe certificate pinning mechanism in order to
<a href="https://www.codejam.info/2021/07/intercept-macos-app-traffic-mitmproxy.html">intercept the TLS traffic through a logging proxy</a>.</p>
<p>Often though, things are even easier. In the case of Authy, they have a
<a href="https://chrome.google.com/webstore/detail/authy/gaedmjdfmmahhbjefcbgaolhhanlaolb">Chrome app</a>
that we can easily debug to understand how the protocol work. The best
thing about it? Someone already did a lot of the work and <a href="https://randomoracle.wordpress.com/2017/02/15/extracting-otp-seeds-from-authy/">documented it</a>.
Sweet.</p>
<div class="note">
<p><strong>Note:</strong> I noticed later that <a href="https://github.com/alexzorin/authy">someone wrote a similar program in Go</a>.</p>
<p>The main difference is that it‚Äôs intended to be used alongside an
existing Authy app and account, instead of replacing it completely, but
a lot of the code is the same. If Go is more your jam, check it out!</p>
</div>
<h2 id="understanding-the-implementation" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/authy-reversed.html#understanding-the-implementation"><span>Understanding the implementation</span></a></h2>
<p>That article <a href="https://randomoracle.wordpress.com/2017/02/15/extracting-otp-seeds-from-authy/">I linked earlier</a>
gives us a good starting point:</p>
<ol>
<li>Authy uses TOTP in the background.</li>
<li>They generate TOTP using SHA-1, 7 digits, and a period of 10 seconds
(whereas most implementations are SHA-1, 6 digits and 30 seconds).</li>
<li>They check the codes against the neighbouring periods, not only the
current one, which is how they allow codes to be valid for 20 seconds
even if the underlying implementation uses 10 seconds periods.</li>
<li>By debugging the <a href="https://chrome.google.com/webstore/detail/authy/gaedmjdfmmahhbjefcbgaolhhanlaolb">Chrome app</a>,
you can easily extract your Authy secrets and import them in your
favorite authenticator app or password manager.</li>
</ol>
<p>That‚Äôs awesome, but we‚Äôre not there yet. I don‚Äôt want to <em>have to use
Authy</em> (even once) in order to <em>not use Authy later</em>.</p>
<p>A mystery still remains. Since during 2FA setup they don‚Äôt ever show a
QR code or give access to a TOTP URI or plaintext secret, how do this
secret ever reach the Authy app? Is it cryptographically derived from
the phone number, the service name, and other parameters? How does the
Authy app automagically knows what secret to generate the codes with?</p>
<p>Well, as it often turns out, the easiest answer is often the right one.
By inspecting the network traffic of the Chrome app, we clearly see
that‚Ä¶ the secrets are directly retrieved from the Authy servers.</p>
<p>Now, how do we write our own code that fetches the secrets from the
Authy servers, without installing the Authy app? Let me tell you.</p>
<h2 id="documenting-the-protocol" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/authy-reversed.html#documenting-the-protocol"><span>Documenting the protocol</span></a></h2>
<p>If we install the Chrome app, use our phone number to sign up or log in,
and generate a one-time code, the following happens:</p>
<ol>
<li>The app checks the status of the given number on the Authy servers.</li>
<li>If the user doesn‚Äôt exist, it creates it.</li>
<li>Then it starts a device registration flow, which consists in sending
a code to the user‚Äôs device via a call, SMS, or a push notification
to an existing Authy app if any.</li>
<li>By inputting that code in the Chrome app, it can finalize the
registration flow and gets its own ID and ‚Äúsecret seed‚Äù.</li>
<li>It uses that seed as TOTP secret to generate a code for the next 3
periods, and sends those 3 codes along with its device ID to sync the
Authy state. This is how we retrieve the plaintext secrets for all
the services associated with that account.</li>
</ol>
<p>Additionally, all the requests contain an API key that‚Äôs public and
hardcoded in the Chrome app.</p>
<div class="note">
<p><strong>Note:</strong> the secrets for each 2FA entry are unique to each Authy
installation. This means that the secrets in the app on one device
will be different from the secrets on another device (including our own
client).</p>
<p>I expect they use that to make the secrets revocable. If you remove one
of your Authy devices, the secret seeds associated with it are going to
be invalidated and the codes generated by this device are no longer
valid.</p>
</div>
<p>With that in mind, we can write an API client.</p>
<h2 id="making-a-client" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/authy-reversed.html#making-a-client"><span>Making a client</span></a></h2>
<p>At that point you‚Äôll be interested to look at the code of <a href="https://github.com/valeriangalliat/authy-user-client">Authy user client</a>.</p>
<p>I won‚Äôt copy everything here, but I essentially made a quick
<a href="https://github.com/valeriangalliat/authy-user-client/blob/c77d5c6e56619b012079482da4d7b9d269bab485/index.js#L38">API wrapper</a>
that allows me to define every method very concisely:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> checkUserStatus = api({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.country_code}</span>-<span class="hljs-subst">${p.cellphone}</span>/status`</span>,
  <span class="hljs-attr">search</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>]
})

<span class="hljs-keyword">const</span> createUser = api({
  <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;/users/new&#x27;</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;email&#x27;</span>, <span class="hljs-string">&#x27;cellphone&#x27;</span>, <span class="hljs-string">&#x27;country_code&#x27;</span>]
})

<span class="hljs-keyword">const</span> startRegistration = api({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices/registration/start`</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;via&#x27;</span>, <span class="hljs-string">&#x27;signature&#x27;</span>, <span class="hljs-string">&#x27;device_app&#x27;</span>]
})

<span class="hljs-keyword">const</span> completeRegistration = api({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices/registration/complete`</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;pin&#x27;</span>]
})

<span class="hljs-keyword">const</span> listDevices = api({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices`</span>,
  <span class="hljs-attr">search</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;otp1&#x27;</span>, <span class="hljs-string">&#x27;otp2&#x27;</span>, <span class="hljs-string">&#x27;otp3&#x27;</span>, <span class="hljs-string">&#x27;device_id&#x27;</span>]
})

<span class="hljs-keyword">const</span> deleteDevice = api({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices/<span class="hljs-subst">${p.delete_device_id}</span>/delete`</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;otp1&#x27;</span>, <span class="hljs-string">&#x27;otp2&#x27;</span>, <span class="hljs-string">&#x27;otp3&#x27;</span>, <span class="hljs-string">&#x27;device_id&#x27;</span>]
})

<span class="hljs-keyword">const</span> enableMultiDevice = api({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices/enable`</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;otp1&#x27;</span>, <span class="hljs-string">&#x27;otp2&#x27;</span>, <span class="hljs-string">&#x27;otp3&#x27;</span>, <span class="hljs-string">&#x27;device_id&#x27;</span>]
})

<span class="hljs-keyword">const</span> disableMultiDevice = api({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices/disable`</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;otp1&#x27;</span>, <span class="hljs-string">&#x27;otp2&#x27;</span>, <span class="hljs-string">&#x27;otp3&#x27;</span>, <span class="hljs-string">&#x27;device_id&#x27;</span>]
})

<span class="hljs-keyword">const</span> sync = api({
  <span class="hljs-attr">url</span>: <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${p.authy_id}</span>/devices/<span class="hljs-subst">${p.device_id}</span>/apps/sync`</span>,
  <span class="hljs-attr">body</span>: [<span class="hljs-string">&#x27;api_key&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;otp1&#x27;</span>, <span class="hljs-string">&#x27;otp2&#x27;</span>, <span class="hljs-string">&#x27;otp3&#x27;</span>, <span class="hljs-string">&#x27;device_id&#x27;</span>]
})
</code></pre>
<p>We‚Äôll also need a method to generate a TOTP codes using Authy settings:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> base32 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;rfc-3548-b32&#x27;</span>)
<span class="hljs-keyword">const</span> totpGenerator = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;totp-generator&#x27;</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOtp</span> (<span class="hljs-params">secret</span>) </span>{
  <span class="hljs-comment">// `totpGenerator` wants Base32, Authy uses hex.</span>
  secret = base32.encode(Buffer.from(secret, <span class="hljs-string">&#x27;hex&#x27;</span>))
  <span class="hljs-keyword">return</span> totpGenerator(secret, { <span class="hljs-attr">digits</span>: <span class="hljs-number">7</span>, <span class="hljs-attr">period</span>: <span class="hljs-number">10</span> })
}
</code></pre>
<p>The main difference here is that Authy stores the TOTP secrets in
hexadecimal while most TOTP libraries and services expect Base32 as
defined in <a href="https://datatracker.ietf.org/doc/html/rfc3548#section-5">RFC 3548</a>,
so we need to do a quick conversion.</p>
<p>It‚Äôs a bit stupid because the first thing totp-generator does is
<a href="https://github.com/bellstrand/totp-generator/blob/af64a977b2aee17d0f0d3e607afa0af2a9a4814b/index.js#L11">converting the secret back to hex</a>
but there‚Äôs no way to avoid that by specifying a custom encoding, so be
it.</p>
<p>Then we also need an helper method to generate the 3 next codes in the
time period sequence:</p>
<pre><code class="hljs language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOtps</span> (<span class="hljs-params">secret</span>) </span>{
  <span class="hljs-comment">// `totpGenerator` wants Base32, Authy uses hex.</span>
  secret = base32.encode(Buffer.from(secret, <span class="hljs-string">&#x27;hex&#x27;</span>))

  <span class="hljs-keyword">const</span> now = <span class="hljs-built_in">Date</span>.now()

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">otp1</span>: totpGenerator(secret, { <span class="hljs-attr">digits</span>: <span class="hljs-number">7</span>, <span class="hljs-attr">period</span>: <span class="hljs-number">10</span>, now }),
    <span class="hljs-attr">otp2</span>: totpGenerator(secret, { <span class="hljs-attr">digits</span>: <span class="hljs-number">7</span>, <span class="hljs-attr">period</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">now</span>: now + <span class="hljs-number">10_000</span> }),
    <span class="hljs-attr">otp3</span>: totpGenerator(secret, { <span class="hljs-attr">digits</span>: <span class="hljs-number">7</span>, <span class="hljs-attr">period</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">now</span>: now + <span class="hljs-number">20_000</span> })
  }
}
</code></pre>
<p>This depends on <a href="https://github.com/bellstrand/totp-generator/pull/37">this PR on totp-generator</a>
which might or might not be merged when you read this.</p>
<p>From there I export those methods to be used in the CLI, or by other
Node.js programs.</p>
<h2 id="making-a-cli" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/authy-reversed.html#making-a-cli"><span>Making a CLI</span></a></h2>
<p>From there, we can use the awesome <a href="https://www.npmjs.com/package/prompts">prompts</a>
package to build an interactive CLI that dumps the TOTP secrets from
your Authy account.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>)
<span class="hljs-keyword">const</span> prompts = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;prompts&#x27;</span>)
<span class="hljs-keyword">const</span> uri = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;uri-tag&#x27;</span>).default
<span class="hljs-keyword">const</span> authy = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;authy-user-client&#x27;</span>)

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">prompt</span> (<span class="hljs-params">params</span>) </span>{
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> prompts({ ...params, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;value&#x27;</span> })

  <span class="hljs-keyword">if</span> (!res.value) {
    process.exit()
  }

  <span class="hljs-keyword">return</span> res.value
}

<span class="hljs-keyword">const</span> countryCode = <span class="hljs-keyword">await</span> prompt({ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;number&#x27;</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Country code:&#x27;</span>, <span class="hljs-attr">initial</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">1</span> })
<span class="hljs-keyword">const</span> phoneNumber = <span class="hljs-keyword">await</span> prompt({ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;number&#x27;</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;phoneNumber&#x27;</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Phone number:&#x27;</span>, <span class="hljs-attr">validate</span>: <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value !== <span class="hljs-string">&#x27;&#x27;</span> })

<span class="hljs-keyword">const</span> status = <span class="hljs-keyword">await</span> authy.checkUserStatus({ <span class="hljs-attr">country_code</span>: countryCode, <span class="hljs-attr">cellphone</span>: phoneNumber })
<span class="hljs-keyword">let</span> authyId = status.authy_id

<span class="hljs-keyword">if</span> (!authyId) {
  <span class="hljs-keyword">const</span> email = <span class="hljs-keyword">await</span> prompt({ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;text&#x27;</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Email:&#x27;</span> })
  <span class="hljs-keyword">const</span> registration = <span class="hljs-keyword">await</span> authy.createUser({ email, <span class="hljs-attr">country_code</span>: countryCode, <span class="hljs-attr">cellphone</span>: phoneNumber })
  authyId = registration.authy_id
}

<span class="hljs-keyword">const</span> via = <span class="hljs-keyword">await</span> prompt({
  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;select&#x27;</span>,
  <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Authentication method:&#x27;</span>,
  <span class="hljs-attr">choices</span>: [
    { <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Push&#x27;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;push&#x27;</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Call&#x27;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;call&#x27;</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;SMS&#x27;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;sms&#x27;</span> }
  ]
})

<span class="hljs-keyword">await</span> authy.startRegistration({
  <span class="hljs-attr">authy_id</span>: authyId,
  via,

  <span class="hljs-comment">// Not sure why, but works better with this. ü§∑</span>
  <span class="hljs-attr">signature</span>: crypto.randomBytes(<span class="hljs-number">32</span>).toString(<span class="hljs-string">&#x27;hex&#x27;</span>)
})

<span class="hljs-keyword">const</span> pin = <span class="hljs-keyword">await</span> prompt({ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;number&#x27;</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;PIN:&#x27;</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">validate</span>: <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value !== <span class="hljs-string">&#x27;&#x27;</span> })
<span class="hljs-keyword">const</span> registrationResponse = <span class="hljs-keyword">await</span> authy.completeRegistration({ <span class="hljs-attr">authy_id</span>: authyId, pin })

<span class="hljs-keyword">const</span> deviceId = registrationResponse.device.id
<span class="hljs-keyword">const</span> secretSeed = registrationResponse.device.secret_seed

<span class="hljs-keyword">const</span> syncResponse = <span class="hljs-keyword">await</span> authy.sync({
  <span class="hljs-attr">authy_id</span>: authyId,
  <span class="hljs-attr">device_id</span>: deviceId,
  ...authy.getOtps(secretSeed)
})

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> app <span class="hljs-keyword">of</span> syncResponse.apps) {
  <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> URL(uri<span class="hljs-string">`otpauth://totp/<span class="hljs-subst">${app.name}</span>`</span>)

  url.search = <span class="hljs-keyword">new</span> URLSearchParams(<span class="hljs-built_in">Object</span>.entries({
    <span class="hljs-comment">// Authy uses hex, everything else uses Base32.</span>
    <span class="hljs-attr">secret</span>: authy.hexToBase32(app.secret_seed),
    <span class="hljs-attr">digits</span>: app.digits,
    <span class="hljs-attr">period</span>: <span class="hljs-number">10</span>
  }))

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${app.name}</span>: <span class="hljs-subst">${url}</span>`</span>)
}
</code></pre>
<p>This will list all the associated apps with a <a href="https://github.com/google/google-authenticator/wiki/Key-Uri-Format">standard TOTP URI</a>
to be used in any compliant authenticator or password manager.</p>
<p>You can look at <a href="https://github.com/valeriangalliat/authy-user-client/blob/master/cli.js">the full source</a>
for the implementation of individual calls for more fine-grained
control!</p>
<h2 id="wrapping-up" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/authy-reversed.html#wrapping-up"><span>Wrapping up</span></a></h2>
<p>Thanks to this, we can work around services that force the Authy app for
2FA and extract the secret and settings to use them with our favorite
authenticator app.</p>
<p>Was this overkill? Hell yeah. But was it fun? Of course!</p>
<p>Still, I hope this can be useful to you if you run into the same issue.
You can just use the CLI and happily move on with your life and your
favorite TOTP provider! üéâ</p>
<div class="note">
<p><strong>Note:</strong> if you need help understanding and documenting other
undocumented APIs and protocols, <a href="https://www.codejam.info/val.html#contact">let me know</a>, I‚Äôm
currently available for <a href="https://www.codejam.info/freelance.html">contracting</a> projects
and I‚Äôll be happy to help you with that. ‚úåÔ∏è</p>
</div>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1442826926545121284">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>TOTP/2FA support with ANY password manager (you read that right)</title>
    <link href="https://www.codejam.info/2021/09/totp-2fa-support-any-password-manager.html" />
    <id>https://www.codejam.info/2021/09/totp-2fa-support-any-password-manager.html</id>
    <updated>2021-09-28T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>As I‚Äôm writing an article on <a href="https://www.codejam.info/2021/09/authy-reversed.html">how I reversed the Authy proprietary 2FA protocol</a>
to generate their codes from my own password manager and authenticator,
I realized that I didn‚Äôt write about the hack I use to <strong>support
<abbr title="Time-based one-time password">TOTP</abbr> in any password
manager</strong> (especially the ones that don‚Äôt support it out of the box).</p>
<p>So I‚Äôll start with that.</p>
<p>See, I explained some time ago <a href="https://www.codejam.info/2021/08/why-i-switched-to-firefox-lockwise-as-my-password-manager.html">why I switched to Firefox Lockwise as my password manager</a>.
In this post, I compare it to Bitwarden, and I go through some of the
<a href="https://www.codejam.info/2021/08/why-i-switched-to-firefox-lockwise-as-my-password-manager.html#cons">Lockwise cons</a>,
one of them being <a href="https://www.codejam.info/2021/08/why-i-switched-to-firefox-lockwise-as-my-password-manager.html#no-totp-support">the lack of TOTP support</a>.</p>
<p>I said that while it would be nice to have native support for TOTP, I
already had my own authenticator app based on the <a href="https://www.npmjs.com/package/totp-generator">totp-generator</a>
package. I since made that app a lot nicer and shared it on
<a href="https://totp.vercel.app/">totp.vercel.app</a>! ü¶Ñ</p>
<p>It‚Äôs called <a href="https://totp.vercel.app/">TOTP with a password manager that doesn‚Äôt support TOTP üòÖ</a>
(yes, the emoji is part of the name) because I suck at naming things and
that‚Äôs the most explicit name that I came up with.</p>
<div class="note">
<p><strong>Note:</strong> everything you need to know in order to use it is on the link
above, but if you want to learn how it works in more technical details,
keep reading!</p>
</div>
<h2 id="why-would-you-do-that" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/totp-2fa-support-any-password-manager.html#why-would-you-do-that"><span>Why would you do that?</span></a></h2>
<p>Maybe like me you really like Lockwise or another password manager
that doesn‚Äôt support TOTP, and that‚Äôs not enough of a reason to migrate
to another app like Bitwarden, especially where TOTP support only comes
in the paid version.</p>
<p>And you don‚Äôt want to install Yet Another App‚Ñ¢ to do this.</p>
<p>Maybe a bit of a niche, I‚Äôll admit.</p>
<h2 id="how-does-it-work" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/totp-2fa-support-any-password-manager.html#how-does-it-work"><span>How does it work?</span></a></h2>
<p>First things first, you probably want to <a href="https://github.com/valeriangalliat/totp">check out the repo on GitHub</a>.</p>
<p>The principle is pretty simple. Most password managers will recognize
login forms on websites (e.g. username and password fields). Upon
submission, they‚Äôll prompt you to save the credentials you just entered,
so that the next time you encounter this form, it‚Äôll be able to autofill
the boxes and you just have to click ‚Äúlog in‚Äù.</p>
<p>Additionally, if you log in later with a different username on the same
site, it‚Äôll also ask you to save it, and now every time you come back to
that form, you‚Äôll be able to chose amongst all the credentials that you
saved.</p>
<p><a href="https://totp.vercel.app/">TOTP with a password manager that doesn‚Äôt support TOTP üòÖ</a>
looks like a login form, walks like a login form, and quacks like a
login form:</p>
<pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span>
</code></pre>
<p>(Yes, it‚Äôs that easy.)</p>
<p>This means that whatever you put in there, your password manager will
prompt you to store upon submission of the form. With that trick, <strong>we
can store arbitrary data in any password manager</strong>.</p>
<p>To retrieve that data, the user simply clicks on the username or
password field and chose from the list of all the saved items. We can
then read the values directly from the form fields. For example if the
above HTML was in a <code>&lt;form id=&quot;form&quot;&gt;</code>:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { username, password } = form.elements
<span class="hljs-built_in">console</span>.log(username.value, password.value)
</code></pre>
<p>Since <a href="https://stackoverflow.com/questions/11708092/detecting-browser-autofill">it‚Äôs a bit tricky</a>
to reliably detect when inputs are autofilled (the <code>change</code> event is not
usually triggered), we‚Äôll use a Big Blue Button‚Ñ¢ that reads ‚ÄúGet
TOTP üöÄ‚Äù instead. Good enough.</p>
<figure class="center">
  <img alt="TOTP form" src="https://www.codejam.info/img/2021/09/totp-form-1.png">
</figure>
<p>When that button is clicked, we use <a href="https://www.npmjs.com/package/totp-generator">totp-generator</a>
to generate a code for the secret that‚Äôs in the password field.</p>
<p>If the TOTP settings differ from the standard SHA-1 algorithm, 6 digits
and 30 seconds period, you can also paste a somewhat standard
<a href="https://github.com/google/google-authenticator/wiki/Key-Uri-Format"><code>otpauth://</code> URI</a>
thanks to the following code:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> totp = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;totp-generator&#x27;</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">totpFromUriOrSecret</span> (<span class="hljs-params">value</span>) </span>{
  <span class="hljs-keyword">if</span> (!value.startsWith(<span class="hljs-string">&#x27;otpauth://&#x27;</span>)) {
    <span class="hljs-comment">// Directly the secret, use default options.</span>
    <span class="hljs-keyword">return</span> totp(value)
  }

  <span class="hljs-keyword">const</span> search = <span class="hljs-keyword">new</span> URLSearchParams(<span class="hljs-keyword">new</span> URL(value).search)
  <span class="hljs-keyword">const</span> { secret, algorithm, digits, period } = <span class="hljs-built_in">Object</span>.fromEntries(search)

  <span class="hljs-keyword">return</span> totp(secret, { algorithm, digits, period })
}
</code></pre>
<p>For convenience, we can automatically copy the code to the user‚Äôs clipboard:</p>
<pre><code class="hljs language-js">navigator.clipboard.writeText(code)
</code></pre>
<h2 id="scanning-qr-codes" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/totp-2fa-support-any-password-manager.html#scanning-qr-codes"><span>Scanning QR codes</span></a></h2>
<p>But that‚Äôs not enough. While some services will give us an option to
retrieve the plaintext secret or a <code>otpauth://</code> URI, a lot will only
give a QR code to scan, and some will even give <em>nothing</em> and force you
to use Authy‚Äôs proprietary TOTP implementation (luckily, I already
<a href="https://www.codejam.info/2021/09/authy-reversed.html">reversed that</a> so that you don‚Äôt have to).</p>
<p>For that, I‚Äôll add two options: scan a QR code using the device camera,
or import a QR code from an existing image (like a screenshot).</p>
<figure class="center">
  <img alt="TOTP form" src="https://www.codejam.info/img/2021/09/totp-form-2.png">
</figure>
<p>Luckily, there‚Äôs a <a href="https://www.npmjs.com/package/qr-scanner">QR scanner</a>
package that makes that really easy.</p>
<h3 id="using-the-camera" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/totp-2fa-support-any-password-manager.html#using-the-camera"><span>Using the camera</span></a></h3>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> QrScanner = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;qr-scanner&#x27;</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleTotpUri</span> (<span class="hljs-params">uri</span>) </span>{
  <span class="hljs-keyword">const</span> search = <span class="hljs-keyword">new</span> URLSearchParams(<span class="hljs-keyword">new</span> URL(uri).search)

  form.username.value = search.get(<span class="hljs-string">&#x27;issuer&#x27;</span>)
  form.password.value = uri
}

<span class="hljs-keyword">const</span> video = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">&#x27;video&#x27;</span>)

<span class="hljs-keyword">const</span> qrScanner = <span class="hljs-keyword">new</span> QrScanner(video, <span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
  qrScanner.stop()
  handleTotpUri(result)
})

qrScanner.start()
</code></pre>
<p>During the scan, the QR scanner will show the camera feed in the given
video element.</p>
<p>On successful scan, we parse the URI to get the <code>issuer</code> value (the
service that issued that secret) and fill the username field with it to
give a meaningful name to our secret. Then we can store the full URI in
the password field.</p>
<h3 id="from-file-upload" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/totp-2fa-support-any-password-manager.html#from-file-upload"><span>From file upload</span></a></h3>
<p>We‚Äôll support two ways to upload files. With a regular file input, and
with drag and drop.</p>
<p>For the file input, the following will do:</p>
<pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file&quot;</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { file } = form.elements

file.addEventListener(<span class="hljs-string">&#x27;change&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  handleFile(file.files[<span class="hljs-number">0</span>])
})
</code></pre>
<p>And for the drag and drop, the
<a href="https://www.npmjs.com/package/drag-drop">drag-drop</a> package makes it
trivial for us:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> dragDrop = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;drag-drop&#x27;</span>)

dragDrop(<span class="hljs-string">&#x27;body&#x27;</span>, {
  onDrop (files) {
    handleFile(files[<span class="hljs-number">0</span>])
  },
  onDragEnter (event) {
    <span class="hljs-built_in">document</span>.body.classList.add(<span class="hljs-string">&#x27;drag-drop&#x27;</span>)
  },
  onDragLeave (event) {
    <span class="hljs-built_in">document</span>.body.classList.remove(<span class="hljs-string">&#x27;drag-drop&#x27;</span>)
  }
})
</code></pre>
<p>Here we toggle a class on the <code>&lt;body&gt;</code> element during drag and drop to
make it obvious that we‚Äôre accepting files to be dropped here.</p>
<p>Now, all we need is to write the <code>handleFile</code> function that‚Äôs used by
both of those, where we scan the uploaded file and parse the TOTP URI in it.</p>
<pre><code class="hljs language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleFile</span> (<span class="hljs-params">file</span>) </span>{
  QrScanner.scanImage(file)
    .then(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
      handleTotpUri(result)
    })
}
</code></pre>
<h2 id="manually-editing-totp-settings" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/totp-2fa-support-any-password-manager.html#manually-editing-totp-settings"><span>Manually editing TOTP settings</span></a></h2>
<p>Lastly, we might encounter situations where we only have the secret and
specific TOTP settings (algorithm, digits and period), but no TOTP URI.</p>
<p>To support that, we need to add an ‚Äúadvanced‚Äù mode allowing to edit the
individual settings, and automatically generating the proper URI in the
password field to be stored.</p>
<p>We‚Äôll start by adding a hamburger menu that will open the detailed
settings.</p>
<figure class="center">
  <img alt="TOTP form" src="https://www.codejam.info/img/2021/09/totp-form-3.png">
</figure>
<p>This will toggle the following form:</p>
<figure class="center">
  <img alt="TOTP form" src="https://www.codejam.info/img/2021/09/totp-details-form.png">
</figure>
<p>Here, I added for convenience a ‚ÄúAuthy‚Äù button that will automatically
set the settings to 7 digits and a 10 seconds period, because that‚Äôs the
main use case I have for this.</p>
<p>When any of those settings change, I generate a new URI to put in the
password field:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { username, password, secret, algorithm, digits, period } = form.elements

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updatePasswordFromDetails</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> uri = <span class="hljs-keyword">new</span> URL(password.value.startsWith(<span class="hljs-string">&#x27;otpauth://&#x27;</span>) ? password.value : <span class="hljs-string">`otpauth://totp/<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(username.value)}</span>`</span>)
  <span class="hljs-keyword">const</span> search = <span class="hljs-keyword">new</span> URLSearchParams(uri.search)

  search.set(<span class="hljs-string">&#x27;secret&#x27;</span>, secret.value)
  search.set(<span class="hljs-string">&#x27;algorithm&#x27;</span>, algorithm.value)
  search.set(<span class="hljs-string">&#x27;digits&#x27;</span>, digits.value)
  search.set(<span class="hljs-string">&#x27;period&#x27;</span>, period.value)

  uri.search = search
  password.value = uri.toString()
}

secret.addEventListener(<span class="hljs-string">&#x27;change&#x27;</span>, updatePasswordFromDetails)
algorithm.addEventListener(<span class="hljs-string">&#x27;change&#x27;</span>, updatePasswordFromDetails)
digits.addEventListener(<span class="hljs-string">&#x27;change&#x27;</span>, updatePasswordFromDetails)
period.addEventListener(<span class="hljs-string">&#x27;change&#x27;</span>, updatePasswordFromDetails)
</code></pre>
<h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/totp-2fa-support-any-password-manager.html#conclusion"><span>Conclusion</span></a></h2>
<p>And this is it! You know everything that‚Äôs behind <a href="https://totp.vercel.app/">totp.vercel.app</a>.</p>
<p>Did you find this useful? Did you like that I explained some of the code
behind it in this blog post? Don‚Äôt hesitate to let me know and <a href="https://twitter.com/valeriangalliat">ping me on Twitter</a>!</p>
<p>Until next time, keep hacking! üêø</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1442937054854221828">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>Elixir, Ecto and Heroku Postgres: unverified SSL certificates</title>
    <link href="https://www.codejam.info/2021/09/elixir-ecto-heroku-postgres-unverified-ssl-certificates.html" />
    <id>https://www.codejam.info/2021/09/elixir-ecto-heroku-postgres-unverified-ssl-certificates.html</id>
    <updated>2021-09-24T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>This one took me a bit of time to sort out so I figured I‚Äôd write a blog
post about it in case it can help someone else.</p>
<p>I have a Phoenix Elixir application that I recently deployed on one of
my servers. While it‚Äôs running smooth, I was bugged by the following
warning that was showing only in production when starting the app:</p>
<pre><code class="hljs language-elixir">[warn] <span class="hljs-symbol">Description:</span> <span class="hljs-string">&#x27;Authenticity is not established by certificate path validation&#x27;</span>
     <span class="hljs-symbol">Reason:</span> <span class="hljs-string">&#x27;Option {verify, verify_peer} and cacertfile/cacerts is missing&#x27;</span>
</code></pre>
<p>This message was repeated 10 times during boot. Spoiler, 10 is also my
Ecto <code>:pool_size</code>, but I didn‚Äôt think about that right away.</p>
<p>There was no context around that, and since the app interacts with quite
a few things over SSL, it could have come from a lot of places.</p>
<h2 id="tracing-warnings-in-elixir-investigation-and-delusion" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/elixir-ecto-heroku-postgres-unverified-ssl-certificates.html#tracing-warnings-in-elixir-investigation-and-delusion"><span>Tracing warnings in Elixir: investigation and delusion</span></a></h2>
<p>My first reflex was to look for something similar to
<a href="https://nodejs.org/api/cli.html#cli_trace_warnings">Node.js‚Äô <code>--trace-warnings</code> option</a>.
This will add a stack trace to all warnings, making it very easy to
track where they‚Äôre from and address them.</p>
<p>Sadly, I couldn‚Äôt find anything similar with Elixir and Erlang. I
resorted to <a href="https://elixirforum.com/t/tracing-runtime-warnings/42576">asking on Elixir Forum</a>,
only to get confirmation that this wasn‚Äôt possible.</p>
<h2 id="compiling-erlang" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/elixir-ecto-heroku-postgres-unverified-ssl-certificates.html#compiling-erlang"><span>Compiling Erlang?</span></a></h2>
<p><a href="https://github.com/erlang/otp/blob/896510977b6cf1f2f4ac817394f3d5c9061f92cf/lib/ssl/src/ssl.erl#L2833">The line that logged that warning</a>
was easy to find in the Erlang <code>ssl</code> module, but that didn‚Äôt help me
identifying what code path triggers it.</p>
<p>I thought about compiling Erlang with a patch that raises an exception
instead of logging a warning there. While that wouldn‚Äôt be the quickest
solution, it would definitely make it obvious what‚Äôs triggering that
peer validation warning.</p>
<p>What was bugging me was that I was seeing this warning only in
production, not on my development machine. And I didn‚Äôt really like the
idea of compiling my patched Erlang in production to debug in
production‚Ä¶</p>
<div class="note">
<p><strong>Note:</strong> I didn‚Äôt end up compiling Erlang to trace the warning that
way, because I was lucky to find after some trial and error what was
causing it.</p>
<p>That being said, if you run into the same kind of issue and don‚Äôt find
any alternative, this is guaranteed to give you an answer, so it‚Äôs
probably worth the effort at that point!</p>
</div>
<h2 id="going-for-a-walk" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/elixir-ecto-heroku-postgres-unverified-ssl-certificates.html#going-for-a-walk"><span>Going for a walk</span></a></h2>
<p>I didn‚Äôt actually go for a walk, but that‚Äôs the kind of thoughts that
usually happen when you take a walk, or when you‚Äôre under the shower, so
I would have probably gotten that idea earlier if I did.</p>
<blockquote>
<p>If it‚Äôs happening only in production, it‚Äôs probably coming from one of
the production environment variables!</p>
</blockquote>
<p>For some reason, until then, I was focused on finding if there was
something odd about my Erlang build in production, or the CA
certificates configuration on the server, and while it could have come
from there, environment variables were an easy one to test.</p>
<p>So I configure my local machine with the production environment
variables, and bingo! I can repro the warning.</p>
<p>At that point it becomes very obvious to me that my database connection
is the culprit, because it‚Äôs the only thing in the environment that‚Äôs
related to SSL in a way or another.</p>
<h2 id="heroku-postgres-and-ssl-certificate-verification" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/elixir-ecto-heroku-postgres-unverified-ssl-certificates.html#heroku-postgres-and-ssl-certificate-verification"><span>Heroku Postgres and SSL certificate verification</span></a></h2>
<p>Now that I found the offender, it‚Äôs easier to look for a specific
solution. The first result on Google for <code>heroku postgres ssl verify</code> is
<a href="https://help.heroku.com/3DELT3RK/why-can-t-my-third-party-utility-connect-to-heroku-postgres-with-ssl">this page on the Heroku support website</a>.</p>
<p>Since for some reason it requires to be logged in with an Heroku account
to view it, I‚Äôll just quote the relevant part here:</p>
<blockquote>
<p>Heroku Postgres does not currently support verifiable certificates.
Our certificates will change when the underlying hardware has issues
and we move your database away from it.</p>
</blockquote>
<p>Sweet. So it‚Äôs actually ‚Äúintended‚Äù that I get a SSL verification warning
when connecting to my Heroku Postgres database over SSL.</p>
<p>But knowing that is not enough for me. Now I identified that this
warning was acceptable and doesn‚Äôt need to be fixed per se, I need to
mute it, so that it doesn‚Äôt adds noise to the logs.</p>
<p><strong>This is particularly important</strong> because otherwise, I would hardly
notice a new SSL verification warning that would appears in another
potentially <strong>more critical part of the codebase</strong>, leaving me with
vulnerabilities.</p>
<h2 id="muting-this-particular-warning" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/elixir-ecto-heroku-postgres-unverified-ssl-certificates.html#muting-this-particular-warning"><span>Muting this particular warning</span></a></h2>
<p><a href="https://github.com/erlang/otp/blob/896510977b6cf1f2f4ac817394f3d5c9061f92cf/lib/ssl/src/ssl.erl#L2833">As we saw earlier</a>,
for that warning to show up, we need the SSL connection‚Äôs <code>verify</code> to
be set to <code>verify_none</code>, and the <code>ssl_logger</code>'s level to be configured
to show warnings.</p>
<p>The default value of <code>verify</code> in the <code>ssl</code> module <a href="https://github.com/erlang/otp/blob/896510977b6cf1f2f4ac817394f3d5c9061f92cf/lib/ssl/src/ssl_internal.hrl#L195">is indeed <code>verify_none</code></a>,
and Ecto doesn‚Äôt seem to alter it by default. Also the default
<code>log_level</code> of the <code>ssl_logger</code> <a href="https://github.com/erlang/otp/blob/896510977b6cf1f2f4ac817394f3d5c9061f92cf/lib/ssl/src/ssl_internal.hrl#L160">is set to <code>notice</code></a>,
which is why we‚Äôre seeing that warning.</p>
<p>It seems that my only option here is to configure the SSL connection
specifically for my Ecto repository to have a log level of <code>:error</code>:</p>
<pre><code class="hljs language-elixir">config <span class="hljs-symbol">:myapp</span>, MyApp.Repo
  <span class="hljs-symbol">ssl_opts:</span> [<span class="hljs-symbol">log_level:</span> <span class="hljs-symbol">:error</span>]
</code></pre>
<p>It took more hours than I‚Äôm willing to admit to come up with this patch
that turns out to be trivial. So I‚Äôm trying to feel better about myself
by spending even more hours writing a blog post about it to explain all
the details and subtleties. üòÖ</p>
<p>If you‚Äôre here to try and solve an unverified warning issue, or trace
warnings with Elixir and Erlang in general, I hoped that it was useful
to you. Have a wonderful day!</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1441563191557849090">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>Zoom H2n: pro tips and tricks</title>
    <link href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html" />
    <id>https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html</id>
    <updated>2021-09-24T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>The <a href="https://amzn.to/2XRD6mk">Zoom H2n</a> is an awesome portable
microphone with a long battery life. It‚Äôs very versatile and delivers a
solid sound.</p>
<p>In this post, I‚Äôll give you all of the tips and tricks that I discovered
over the years using my H2n, that made me more efficient at using it and
allowed me to do even more with it.</p>
<figure class="center">
  <img alt="Zoom H2n" src="https://www.codejam.info/img/2021/09/h2n/zoom-h2n.jpg">
</figure>
<p>But first, I‚Äôll give you a little bit of backstory about how I got
there in the first place. Feel free to <a href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#my-do-to-microphone-setting">skip it</a>.</p>
<h2 id="the-story-about-my-h2n" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#the-story-about-my-h2n"><span>The story about my H2n</span></a></h2>
<p>The reason I got it in the first place was put it in my motorcycle
jacket while I ride to record clean engine sound for my
<a href="https://www.youtube.com/playlist?list=PL3gQ6-WYh7kU8QjpRSMpDknhAwvccFiMu">GoPro recordings</a>.
This is how <a href="https://www.youtube.com/c/royaljordanianR">Royal Jordanian</a>,
a famous motorcycle YouTuber, <a href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#record-motorcycle-sound-rj-style">uses his H2n</a>,
and his results are remarkable.</p>
<p>I used to have a <a href="https://amzn.to/2ZraaCh">Zoom H4n</a> because I liked
that it could act as an external sound card where I could plug XLR
microphones and jack instruments as well, but it was too big to fit in
my motorcycle jacket, which turned out to be what allowed me to get the
<a href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#record-motorcycle-sound-rj-style">best sounding audio on a motorcycle</a>.</p>
<p>Anyways, because I had that mic around when I started <a href="https://www.youtube.com/FunkyVal">making more YouTube videos</a>,
it became my main device to record voice in various settings (indoors,
outdoors, multiple people interviews, live streaming). I also use it to
record acoustic instruments.</p>
<figure class="grid grid-2">
  <img alt="Acoustic guitar recording with the H2n" src="https://www.codejam.info/img/2021/09/h2n/acoustic-1.jpg">
  <img alt="Acoustic guitar recording with the H2n (closeup)" src="https://www.codejam.info/img/2021/09/h2n/acoustic-2.jpg">
</figure>
<p>While specialized microphones might give you even better results in
specific situations, the H2n has allowed me to record high quality audio
in an impressively wide set of settings.</p>
<p>After years of using it, I have a couple of tips to share with you that
will make you even more productive with your H2n and enable you to do
even more with it.</p>
<h2 id="my-go-to-mic-setting" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#my-go-to-mic-setting"><span>My go-to mic setting</span></a></h2>
<p>The H2n has 5 built-in microphones and lets you use them in the
<a href="https://composerfocus.com/zoom-h2n-review/">following settings</a>:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Stereophonic_sound#X-Y_technique:_intensity_stereophony">X-Y stereo</a>:
2 mics in the front.</li>
<li><a href="https://en.wikipedia.org/wiki/Stereophonic_sound#M/S_technique:_mid/side_stereophony">M/S mid/side</a>:
1 mic in the back, 2 mics on the sides with adjustable recording width.</li>
<li>2-channel surround: X-Y and M/S converted to 1 stereo track.</li>
<li>4-channel surround: X-Y and M/S converted to 2 stereo tracks.</li>
</ul>
<p>I personally use X-Y stereo the vast majority of the time. If you don‚Äôt
know which one to chose, I would default to this one.</p>
<figure class="center">
  <img alt="H2n record modes" src="https://www.codejam.info/img/2021/09/h2n/record-modes.jpg">
</figure>
<p>It‚Äôs going to record from the front of the Zoom (where the screen is),
which is convenient because you‚Äôre facing the front of the mic when
you‚Äôre recording. This allows you to easily monitor the levels on the
screen, and puts the record button right in front of you.</p>
<p>That being said the H2n is well designed because the clipping light on
top is visible from both sides, meaning that if you want to record in
M/S mode, you‚Äôll still see the light while facing the back of the Zoom!</p>
<h2 id="my-go-to-gain-setting" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#my-go-to-gain-setting"><span>My go-to gain setting</span></a></h2>
<p>When I first got my H2n, I wasn‚Äôt sure where to put the gain. My usual
rule of thumb with gain is to put it <strong>as high as possible</strong> at the
source so that <strong>the highest peaks</strong> I plan to have are gonna be <strong>close
to 0 dB, but won‚Äôt clip</strong>.</p>
<p>Most of the time, I <a href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#hot-shoe-mount">mount the Zoom on top of my camera</a>,
or I <a href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#the-potholder-trick">put it on a surface</a> about an arm‚Äôs length
in front of me. In those conditions, I found that <strong>leaving the gain on
8 all the time</strong> gave me the best results. It‚Äôs perfect to record my
voice clearly and any meaningful context sound, without clipping,
and leaving enough headroom for any reasonable surprise peaks.</p>
<figure class="center">
  <img alt="H2n mic gain knob" src="https://www.codejam.info/img/2021/09/h2n/mic-gain.jpg">
</figure>
<p>Because it stays there most of the time, I ensure that all the
recordings that are made in similar conditions will have consistent
levels, so that I don‚Äôt have to adjust them one by one in post. I just
boost the gain a bit more at the track level, and add some compression
to avoid unnecessary peaking.</p>
<p>So I always leave my Zoom with a gain of 8 by default, and if I‚Äôm in a
recording setting that <a href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#mic-stand-adapter">differs from my usual use case</a>,
like singing very close to the mic through a pop filter or recording an
instrument, I‚Äôll go back to step one where I try to get the gain as high
as possible while making sure it doesn‚Äôt clip during the highest peaks I
plan to have. FWIW in those settings, I rarely needed to go below 6.</p>
<h2 id="battery-and-clock-reset-trick" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#battery-and-clock-reset-trick"><span>Battery and clock reset trick</span></a></h2>
<p>You might have noticed that the H2n internal clock is reset when you
remove the AA batteries to change or recharge them. It‚Äôs pretty
frustrating to have to configure the date and time again every time you
recharge the Zoom!</p>
<p>But there‚Äôs a neat trick that I‚Äôve found <a href="https://www.reddit.com/r/livesound/comments/ci181c/comment/evc0nt0/">on Reddit</a>.
If you change the batteries <strong>one at a time</strong>, e.g. without ever having no
battery in the Zoom at all, it will keep the clock intact!</p>
<figure class="center">
  <img alt="Changing the H2n batteries" src="https://www.codejam.info/img/2021/09/h2n/batteries.jpg">
</figure>
<h2 id="preventing-the-filename-counter-to-reset" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#preventing-the-filename-counter-to-reset"><span>Preventing the filename counter to reset</span></a></h2>
<p>By default, the H2n names files like <code>ZOOM0001.WAV</code>, incrementing the
number for every new file.</p>
<p>This is fine with me, but every time I empty the SD card, the file
resets to <code>ZOOM0001.WAV</code>! There‚Äôs no persistent internal counter like
with my camera.</p>
<p>This is annoying because I end up with conflicting file names, and I
can‚Äôt uniquely identify a specific Zoom recording by its name. Not
great.</p>
<p>If you want to keep incrementing the number after wiping your SD card
clean, just <strong>leave the latest file you recorded there</strong>! For example if
you recorded all the way to <code>ZOOM0363.WAV</code>, just leave that file there,
and the next one to be recorded will be called <code>ZOOM0364.WAV</code>.</p>
<p>If even this single file is large enough that you want to remove it as
well, you can drop an empty file instead with the same filename, and
that‚Äôll do the trick. üëå</p>
<p>But beware, if you ever reach <code>ZOOM9999.WAV</code>, the H2n will not let you
record any further and will just error with <code>DATA FULL</code>, even if there‚Äôs
still technically enough free space on the SD card.</p>
<p>For this reason, and also because it‚Äôs even easier overall, I recommend
switching to <a href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#using-date-and-time-as-filename">naming files after the date</a>,
which is something that I didn‚Äôt know was possible until very recently!</p>
<h2 id="using-date-and-time-as-filename" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#using-date-and-time-as-filename"><span>Using date and time as filename</span></a></h2>
<p>If you want something more deterministic to name files that the default
strategy of incrementing a counter that resets every time you empty the
SD card, I recommend switching to using the date file naming strategy
instead.</p>
<p>You‚Äôll find it from the <code>MENU</code> button on the right, in <code>REC</code>, <code>FILE NAME</code>, and set it to <code>DATE</code> there.</p>
<figure class="center">
  <a href="https://www.bhphotovideo.com/lit_files/67854.pdf">
    <img alt="H2n filename settings" src="https://www.codejam.info/img/2021/09/h2n/filename-setting.png">
  </a>
  <figcaption>From the operation manual</figcaption>
</figure>
<h2 id="hot-shoe-mount" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#hot-shoe-mount"><span>Hot shoe mount</span></a></h2>
<p>Because I often record <a href="https://www.youtube.com/FunkyVal">YouTube videos</a>,
I like to mount my H2n on top of my camera to get high quality audio in
my videos.</p>
<p>I know most YouTubers use the <a href="https://amzn.to/3ADspSM">Rode VideoMic</a>
or one of its declinations, but since I already had the H2n, I didn‚Äôt
want to bother buying a new mic for video.</p>
<p>It turns out the H2n can easily be mounted on top of a camera as well,
with the help of a cheap <a href="https://amzn.to/3kEML8k">hot shoe</a> <a href="https://amzn.to/2XPrIY4">adapter</a>!</p>
<figure class="center">
  <img alt="Hot shoe mount" src="https://www.codejam.info/img/2021/09/h2n/hot-shoe-mount.jpg">
</figure>
<div class="note">
<p><strong>Note:</strong> in that setup, I noticed that the H2n picked up noise from my
camera strap rubbing and bouncing on the camera body and tripod when
moving around, e.g. when vlogging.</p>
<p>To avoid that, make sure to <strong>remove the camera strap before you
record</strong>, if you usually have one attached!</p>
<p>On my camera it‚Äôs a bit annoying to do, but definitely worth it to have
a clean sound. I‚Äôm looking forward to buying the <a href="https://amzn.to/39G7uCp">Leash by Peak Design</a>,
even though it‚Äôs a bit more expensive than what I‚Äôd like to pay for a
camera strap, it‚Äôs super simple to attach and detach and that would make
my life much easier.</p>
<p><strong>Edit:</strong> I ended up buying a simple (and much cheaper) <a href="https://amzn.to/3BEqFrS">quick release
connector</a> from Amazon which does wonders with
the original strap from my camera.</p>
</div>
<h2 id="wind-muff" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#wind-muff"><span>Wind muff</span></a></h2>
<p>A wind muff is a must for outdoor recording especially if it‚Äôs a bit
windy. This is <a href="https://amzn.to/3lYlpcQ">the one I use</a>, it‚Äôs for the
H4n but works perfectly on the H2n as well!</p>
<figure class="center">
  <img alt="Wind muff" src="https://www.codejam.info/img/2021/09/h2n/wind-muff.jpg">
</figure>
<div class="note">
<p><strong>Note:</strong> if like me you‚Äôre confused between the ‚ÄúH4n Fur‚Äù and ‚ÄúH4n Pro
Fur‚Äù variations and don‚Äôt know which one to pick, keep in mind that
it‚Äôs ‚ÄúH4n‚Äù and ‚ÄúH4n Pro‚Äù furs, not a ‚ÄúPro Fur‚Ñ¢‚Äù. üòÇ</p>
<figure class="grid">
  <a href="https://amzn.to/2WaddgX">
    <img alt="H4n Fur" src="https://www.codejam.info/img/2021/09/h2n/h4n-fur.png">
  </a>
  <a href="https://amzn.to/2WaddgX">
    <img alt="H4n Pro Fur" src="https://www.codejam.info/img/2021/09/h2n/h4n-pro-fur.png">
  </a>
</figure>
</div>
<p>Zoom also provides one as part of their <a href="https://amzn.to/3i0GnqA">H2n accessory pack</a>,
and if you‚Äôre going to buy a few of the items that are part of it, it
might be cheaper to just get the pack!</p>
<h2 id="mic-stand-adapter" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#mic-stand-adapter"><span>Mic stand adapter</span></a></h2>
<p>Another thing that‚Äôs part of the <a href="https://amzn.to/3i0GnqA">accessory pack</a>
that I didn‚Äôt get but probably should have, is the <a href="https://amzn.to/39G0mWF">mic stand adapter</a>.</p>
<figure class="center">
  <img alt="Mic stand adapter" src="https://www.codejam.info/img/2021/09/h2n/mic-stand-adapter.jpg">
</figure>
<p>It allows you to mount your H2n directly on a mic stand, which is very
practical if you want to record high quality audio while singing
directly into it, recording a podcast, live streaming, voice-over or
recording acoustic instruments.</p>
<figure class="center">
  <img alt="Mic stand setup" src="https://www.codejam.info/img/2021/09/h2n/mic-stand-setup.jpg">
  <img alt="Acoustic guitar recording with the H2n (closeup)" src="https://www.codejam.info/img/2021/09/h2n/acoustic-2.jpg">
</figure>
<p>This is the stack that I personally use for this kind of work and I‚Äôm
super happy with it:</p>
<ul>
<li><a href="https://amzn.to/3i3E3yQ">Mic stand</a>, this one is a bit on the cheap
side but gets the job done. You can even put two mics on it!</li>
<li><a href="https://amzn.to/3AEMnMV">Shock mount</a>, key element to avoid noise in
the recording from vibrations around the mic. This one specifically is
compatible with the <a href="https://amzn.to/39G0mWF">H2n mic stand adapter</a>.
Double-check the diameter if you get another one.</li>
<li><a href="https://amzn.to/3zEDPnG">Pop filter</a>, to remove artifacts or
distortion from pronouncing letters like P, T, K and S very close to
the mic.</li>
<li>And obviously the <a href="https://amzn.to/39G0mWF">mic stand adapter</a> to
mount the Zoom on the whole thing.</li>
</ul>
<p>Here‚Äôs an awesome article on <a href="https://www.lewitt-audio.com/blog/do-i-need-a-shock-mount-and-a-pop-filter-for-my-microphone">why a shock mount and pop filter are important</a>
if you‚Äôre not sure if you need them or not.</p>
<h2 id="use-as-an-audio-interface" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#use-as-an-audio-interface"><span>Use as an audio interface</span></a></h2>
<p>If you have the proper cable, you can connect your H2n to your computer
via USB and use it as an audio interface, meaning that you can capture
sound from it directly from a screen recording or from your
<abbr title="Digital audio workstation">DAW</abbr>!</p>
<figure class="center">
  <img alt="Audio interface" src="https://www.codejam.info/img/2021/09/h2n/audio-interface.jpg">
</figure>
<p>They don‚Äôt seem to mention it anywhere though but keep in mind that you
specifically need a Mini-B USB connector on the H2n side (which is not
that common).</p>
<p>Again, <a href="https://amzn.to/3AFKC22">this is the cable I use</a>, but if like
me you‚Äôre gonna need so many accessories that turn out to be part of the
<a href="https://amzn.to/3i0GnqA">H2n accessory pack</a>, you might as well
get that in the first place. That being said the cable I bought is
significantly longer than the one they provide in the pack and that
comes in handy to have a bit more moving freedom during studio sessions.</p>
<p>Here‚Äôs what it looks like once plugged, to set it as input device inside
Logic:</p>
<figure class="center">
  <img alt="H2n as input interface in Logic" src="https://www.codejam.info/img/2021/09/h2n/logic-interface.png">
</figure>
<p>But if you want to use another audio interface to record instruments, MIDI, and
other mics at the same time (I personally have a <a href="https://amzn.to/2XLrCQU">Steinberg UR22mkII</a>
for that), you can‚Äôt just switch input device in your DAW like this.</p>
<p>Instead, on macOS, I recommend in <em>Audio MIDI Setup</em> to configure an
aggregate device that includes both your sound card and the H2n. This
way, you can set that aggregate device as input in your DAW and you‚Äôll
get all the channels from your sound card plus all the channels from the
Zoom!</p>
<figure class="center">
  <img alt="H2n as an aggregate defice with another sound card" src="https://www.codejam.info/img/2021/09/h2n/aggregate-device.png">
</figure>
<h2 id="record-motorcycle-sound-rj-style" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#record-motorcycle-sound-rj-style"><span>Record motorcycle sound, RJ style</span></a></h2>
<p>As I mentioned earlier <a href="https://www.youtube.com/c/royaljordanianR">Royal Jordanian</a>
is a famous motorcycle YouTuber, and makes some of the best sounding
motorcycle videos out there.</p>
<p>He records mainly with a H2n and that‚Äôs the reason I got one in the
first place! But if you‚Äôre going to record your motorcycle rides with
it, you‚Äôll quickly realize that‚Äôs not enough information.</p>
<ul>
<li>Were to put the H2n?</li>
<li>What recording mode to use?</li>
<li>What direction should the mic be facing?</li>
<li>What gain to use?</li>
</ul>
<p>Luckily, RJ once made a Q&amp;A video where he shows exactly <a href="https://youtu.be/PVULgH3mOtw?t=9">how he uses is H2n</a>.
What I love is that even though it lasts a few seconds, we can see precisely that:</p>
<ol>
<li>The mic is in X-Y stereo mode (arrow pointing to the front of the mic).</li>
<li>He puts it in his motorcycle jacket chest pocket.</li>
<li>Specifically, the mic is placed facing downwards, with the front of
the mic on his chest (so facing towards the back of the
motorcycle).</li>
</ol>
<p>This makes sense, as most of the sound is going to be heard at the
exhaust level, which is behind him, and definitely below his chest.</p>
<figure class="center">
  <img alt="H2n in motorcycle jacket chest pocket" src="https://www.codejam.info/img/2021/09/h2n/motorcycle-jacket.jpg">
</figure>
<p>This leaves us with the question of the gain. That‚Äôs gonna be very
specific to your jacket and your motorcycle in general, so you should do
a couple of tests, going at relatively high revs, to see if it‚Äôs
clipping or not. When in doubt, I would recommend using a lower gain for
this as distorted audio from recording a motorcycle engine quickly gets
unusable. Maybe start around 5 and go up or down from there!</p>
<p>I‚Äôll add from my personal experience that it‚Äôs a good idea to put the
<code>HOLD</code> mode on the right side of the H2n while riding (same button you
use to power it on but sliding it up). This will make sure that any
accidental contact with buttons around the mic won‚Äôt stop the recording
or open menus and change random things there.</p>
<h2 id="the-potholder-trick" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#the-potholder-trick"><span>The potholder trick</span></a></h2>
<p>Lastly, I‚Äôll share with you a small trick that I use when I put the Zoom
on a hard surface in front of me, like a table or a desk.</p>
<p>If you just leave it directly on the hard surface, it‚Äôll pick up all the
vibrations from it as noise, so it‚Äôs gonna be especially bad when you
take or put objects on the same surface as the Zoom is on.</p>
<p>To avoid that, I just place a potholder below it. Anything similar
should work, like a folded towel. With that, it‚Äôs much less affected by
interactions with the hard surface, giving you a cleaner sound quality
overall!</p>
<figure class="center">
  <img alt="Potholder trick" src="https://www.codejam.info/img/2021/09/h2n/potholder.jpg">
</figure>
<h2 id="zooming-out" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/zoom-h2n-pro-tips-and-tricks.html#zooming-out"><span>Zooming out</span></a></h2>
<p>That‚Äôs it for today! I hope that you learnt a thing or two today thanks
to this post. Consider subscribing to my <a href="https://www.youtube.com/FunkyVal">YouTube channel</a>
where I also share video versions of those articles (and much more).
Happy recording!</p>
<figure class="center">
  <img alt="Cheers!" src="https://www.codejam.info/img/2021/09/h2n/cheers.jpg">
</figure>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1441462405700145154">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>How I set up a minimalist Debian host with nginx and Let‚Äôs Encrypt</title>
    <link href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html" />
    <id>https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html</id>
    <updated>2021-09-22T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>It‚Äôs something I‚Äôve had to do more than once this year so I think it‚Äôs
about time to write a blog post.</p>
<div class="note">
<p><strong>Note:</strong> in this post (including the title), I use ‚ÄúLet‚Äôs Encrypt‚Äù
because it‚Äôs the term most people know and will look up, but what I mean
is technically the <abbr title="Automatic certificate management environment">ACME</abbr>
protocol with any compatible certificate authority.</p>
<p><a href="https://letsencrypt.org/">Let‚Äôs Encrypt</a> is one of those certificate
authorities, but I personally use <a href="https://zerossl.com/">ZeroSSL</a> which
is another ACME-compatible authority to provide free certificates.</p>
</div>
<h2 id="why-do-i-spawn-debian-vms" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#why-do-i-spawn-debian-vms"><span>Why do I spawn Debian VMs?</span></a></h2>
<p>Let‚Äôs start with the why I‚Äôm doing that. See, Google Cloud has
<a href="https://cloud.google.com/free/docs/gcp-free-tier/#compute">a cool thing</a>
where they allow you to run a <code>e2-micro</code> instance for free per billing
account, with up to 30 GB of storage, and as long as you pay for egress
(outgoing) traffic.</p>
<p>This is one of the cheapest ways that I know of to host a proof of
concept, <abbr title="Minimum viable product">MVP</abbr> or a very small
or lightweight project like this blog.</p>
<p>Google Cloud defaults their VM image to latest stable Debian, which I
find to be a good base for a server when you don‚Äôt want to spend a lot
of time setting things up and don‚Äôt want to think too much about it.</p>
<h2 id="why-do-i-install-nginx-and-let-s-encrypt" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#why-do-i-install-nginx-and-let-s-encrypt"><span>Why do I install nginx and Let‚Äôs Encrypt?</span></a></h2>
<p>Most of the time I spawn such a VM, it‚Äôs to run some kind of web
service over HTTPS. nginx is my favorite web server, and ACME is my
favorite way to manage TLS certificates (see note above about my usage
of the term ‚ÄúLet‚Äôs Encrypt‚Äù).</p>
<h2 id="what-about-infrastructure-as-code" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#what-about-infrastructure-as-code"><span>What about infrastructure as code?</span></a></h2>
<p>I won‚Äôt go into this topic in this blog post because there‚Äôs a fuckton
of ways you could want to code your infrastructure and provision your
servers depending on your needs.</p>
<p>This is out of scope for this article, but feel free to adapt it to
whatever tools you use! Personally, my favorite provisioning tool is
<code>/bin/sh</code> and this post is a breakdown of my script with detailed
explanations about everything it‚Äôs doing.</p>
<p>Now the context is set, let‚Äôs get into how I set up everything in a
minimalistic way (I like to keep things simple).</p>
<h2 id="preventing-the-bloat-on-debian" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#preventing-the-bloat-on-debian"><span>Preventing the bloat on Debian</span></a></h2>
<p>First things first, I start every of my Debian installations by adding
this <code>apt.conf</code> I shared on this blog over 7 years ago, to <a href="https://www.codejam.info/2014/09/keeping-debian-clean-and-minimal.html">keep Debian clean and minimal</a>.</p>
<p>The gist of it is that by default Debian packages can come with
‚Äúrecommended packages‚Äù and ‚Äúsuggested packages‚Äù, and APT automatically
installs the recommended ones by default.</p>
<div class="note">
<p><strong>Note:</strong> APT also used to install the suggested packages by default,
which is how we ended up with <code>imagemagick</code> on the system after
installing <code>nmap</code> like mentioned in the article above.</p>
<p>It looks like I wasn‚Äôt the only one to be bugged by this and this
behavior is no longer the default.</p>
</div>
<p>I like to explicitly install every package that‚Äôs not a hard dependency,
so I use the following config to make sure nothing extra is installed by
default.</p>
<pre><code class="hljs language-sh">cat &lt;&lt; <span class="hljs-string">EOF &gt; /etc/apt/apt.conf
APT::Install-Recommends false;
APT::Install-Suggests false;
APT::AutoRemove::RecommendsImportant false;
APT::AutoRemove::SuggestsImportant false;
EOF</span>
</code></pre>
<p>It also configures APT to consider previously installed recommendations
and suggestions unimportant, meaning that they‚Äôll be wiped in the next
<code>apt autoremove</code>. This won‚Äôt do anything on most fresh installations,
but if installing this configuration in an existing system, you might
want to double-check that list before removing the packages marked as
‚Äúno longer necessary‚Äù.</p>
<p>After that, APT will only install what‚Äôs strictly required by default,
and on top of the ‚Äúsuggested packages‚Äù list, it‚Äôll also display a
‚Äúrecommended packages‚Äù informational list, instead of automatically
installing them. Neat.</p>
<p>Also note that <code>apt autoremove</code>, like <code>apt remove</code>, will keep the
configuration files of the removed packages on the system, and there‚Äôs
no equivalent of <code>apt purge</code> like <code>apt autopurge</code>.</p>
<div class="note">
<p><strong>Note:</strong> I just tried out of curiosity and even though undocumented, it
looks like <a href="https://github.com/Debian/apt/blob/766b24b7f7484751950c76bc66d3d6cdeaf949a5/apt-private/private-install.cc#L608"><code>apt autopurge</code> exists</a>
and does exactly what you would expect!</p>
<p>So I would recommend running <code>apt autopurge</code> instead of <code>apt autoremove</code>
so that it also removes the configuration files of the packages it
removes.</p>
</div>
<p>Finally, if you used <code>apt remove</code> or <code>apt autoremove</code>, you can still
purge the dangling configuration files with the <a href="https://askubuntu.com/a/279432">following command</a>:</p>
<pre><code class="hljs language-sh">apt purge $(dpkg --get-selections | grep deinstall | cut -f1)
</code></pre>
<p>This will purge the configuration files of all packages that were ever
deinstalled and left with existing configuration files in place.</p>
<h2 id="installing-the-essentials" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#installing-the-essentials"><span>Installing the essentials</span></a></h2>
<p>In most Unix systems that I use, I‚Äôll install the following packages:</p>
<pre><code class="hljs language-sh">apt install tmux vim git htop ca-certificates
</code></pre>
<p>On top of that, on Debian I like to add the <code>build-essential</code> package if
I need to compile anything, as it depends on the most common tools that
are necessary to build software from source.</p>
<h2 id="my-minimalist-nginx-configuration" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#my-minimalist-nginx-configuration"><span>My minimalist nginx configuration</span></a></h2>
<p>Let‚Äôs start with installing nginx.</p>
<pre><code class="hljs language-sh">apt install nginx
</code></pre>
<p>This will put the default Debian nginx configuration in <code>/etc/nginx</code>.</p>
<p>The default configuration is too much for me. I like to write my nginx
configuration from scratch. The only file I want to keep is the
<a href="https://github.com/nginx/nginx/blob/master/conf/mime.types">default <code>mime.types</code> file</a>.</p>
<pre><code class="hljs language-sh"><span class="hljs-built_in">cd</span> /etc
mkdir nginx2
cp nginx/mime.types nginx2
rm -rf nginx
mv nginx2 nginx
</code></pre>
<p>This wipes all the default nginx configuration and only keeps the
<code>mime.types</code> file which I‚Äôll include in my custom configuration.</p>
<h3 id="trimmed-down-debian-configuration" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#trimmed-down-debian-configuration"><span>Trimmed-down Debian configuration</span></a></h3>
<p>Speaking about my custom configuration, here‚Äôs the base. Everything
there is the parts of the default <code>nginx.conf</code> on Debian that I kept.
I‚Äôll post my custom additions after.</p>
<pre><code class="hljs language-nginx"><span class="hljs-comment">#</span>
<span class="hljs-comment"># /etc/nginx/nginx.conf</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Based on a simplified Debian default.</span>
<span class="hljs-comment">#</span>

<span class="hljs-attribute">user</span> www-data;
<span class="hljs-attribute">worker_processes</span> auto;
<span class="hljs-attribute">pid</span> /run/nginx.pid;

<span class="hljs-section">events</span> {
    <span class="hljs-attribute">worker_connections</span> <span class="hljs-number">768</span>;
    <span class="hljs-comment"># multi_accept on;</span>
}

<span class="hljs-section">http</span> {
    <span class="hljs-attribute">sendfile</span> <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">tcp_nopush</span> <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">types_hash_max_size</span> <span class="hljs-number">2048</span>;
    <span class="hljs-comment"># server_tokens off;</span>

    <span class="hljs-attribute">include</span> /etc/nginx/mime.types;
    <span class="hljs-attribute">default_type</span> application/octet-stream;

    <span class="hljs-attribute">access_log</span> /var/log/nginx/access.log;
    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;

    <span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;
}
</code></pre>
<h3 id="val-s-essential-tweaks" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#val-s-essential-tweaks"><span>Val‚Äôs essential tweaks</span></a></h3>
<p>From there, I tweak a few things.</p>
<pre><code class="hljs language-diff">     sendfile on;
     tcp_nopush on;
     types_hash_max_size 2048;
<span class="hljs-deletion">-    # server_tokens off;</span>
<span class="hljs-addition">+    server_tokens off;</span>

     include /etc/nginx/mime.types;
     default_type application/octet-stream;

<span class="hljs-deletion">-    access_log /var/log/nginx/access.log;</span>
<span class="hljs-addition">+    access_log off;</span>
     error_log /var/log/nginx/error.log;

     gzip on;
<span class="hljs-addition">+    gzip_vary on;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+    # Custom list based on Debian&#x27;s `/etc/nginx/mime.types`.</span>
<span class="hljs-addition">+    gzip_types text/css text/xml application/javascript application/atom+xml application/rss+xml text/plain application/json image/svg+xml;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+    charset utf-8;</span>
 }
</code></pre>
<ul>
<li>I turn <code>server_tokens</code> off to remove the <code>Server</code> HTTP response header.</li>
<li>I turn off the default access log because I like to specify it per
virtual host and I don‚Äôt care about requests that didn‚Äôt hit a virtual
host.</li>
<li>I enable <code>gzip_vary</code> to have the <code>Vary: Accept-Encoding</code> header in the
responses. This is especially important when used with a caching
server in front, because it instructs it to not mix responses with
different <code>Accept-Encoding</code> together, preventing for example to serve
a gzip response to a client that can only handle plain text.</li>
<li>I configure more <code>gzip_types</code> than the default of just <code>text/html</code>, so
that we automatically compress most web resources. Feel free to add
more that makes sense to you here.</li>
<li>I set <code>charset</code> to <code>utf-8</code> so that <code>charset=utf-8</code> is added to the
<code>Content-Type</code> response header, e.g. <code>Content-Type: text/html; charset=utf-8</code>.</li>
</ul>
<p>But we‚Äôre still missing a very important part. The TLS configuration!</p>
<h3 id="tls-settings" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#tls-settings"><span>TLS settings</span></a></h3>
<p>I use <a href="https://ssl-config.mozilla.org/">Mozilla‚Äôs SSL configuration generator</a>
for that, with the intermediate setting, which gives me the following
(comments removed):</p>
<pre><code class="hljs language-nginx"><span class="hljs-attribute">ssl_certificate</span> /path/to/signed_cert_plus_intermediates;
<span class="hljs-attribute">ssl_certificate_key</span> /path/to/private_key;
<span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">1d</span>;
<span class="hljs-attribute">ssl_session_cache</span> shared:MozSSL:<span class="hljs-number">10m</span>;
<span class="hljs-attribute">ssl_session_tickets</span> <span class="hljs-literal">off</span>;
<span class="hljs-attribute">ssl_dhparam</span> /path/to/dhparam;
<span class="hljs-attribute">ssl_protocols</span> TLSv1.<span class="hljs-number">2</span> TLSv1.<span class="hljs-number">3</span>;
<span class="hljs-attribute">ssl_ciphers</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
<span class="hljs-attribute">ssl_prefer_server_ciphers</span> <span class="hljs-literal">off</span>;
<span class="hljs-attribute">add_header</span> Strict-Transport-Security <span class="hljs-string">&quot;max-age=63072000&quot;</span> always;
<span class="hljs-attribute">ssl_stapling</span> <span class="hljs-literal">on</span>;
<span class="hljs-attribute">ssl_stapling_verify</span> <span class="hljs-literal">on</span>;
<span class="hljs-attribute">ssl_trusted_certificate</span> /path/to/root_CA_cert_plus_intermediates;
</code></pre>
<p>I like to include it in the <code>http</code> block, after the <code>default_type</code>
directive.</p>
<p>But we don‚Äôt yet have the certificates and key files that we reference
there. We still need to generate them with Let‚Äôs Encrypt. We‚Äôll do that
a bit later, but until then, we need to comment those parts otherwise
the nginx config won‚Äôt validate and nginx won‚Äôt be able to start (or
reload).</p>
<pre><code class="hljs language-diff"><span class="hljs-deletion">-ssl_certificate /path/to/signed_cert_plus_intermediates;</span>
<span class="hljs-deletion">-ssl_certificate_key /path/to/private_key;</span>
<span class="hljs-addition">+# ssl_certificate /path/to/signed_cert_plus_intermediates;</span>
<span class="hljs-addition">+# ssl_certificate_key /path/to/private_key;</span>
 ssl_session_timeout 1d;
 ssl_session_cache shared:MozSSL:10m;
 ssl_session_tickets off;
<span class="hljs-deletion">-ssl_dhparam /path/to/dhparam;</span>
<span class="hljs-addition">+# ssl_dhparam /path/to/dhparam;</span>
 ssl_protocols TLSv1.2 TLSv1.3;
 ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
 ssl_prefer_server_ciphers off;
 add_header Strict-Transport-Security &quot;max-age=63072000&quot; always;
 ssl_stapling on;
 ssl_stapling_verify on;
<span class="hljs-deletion">-ssl_trusted_certificate /path/to/root_CA_cert_plus_intermediates;</span>
<span class="hljs-addition">+# ssl_trusted_certificate /path/to/root_CA_cert_plus_intermediates;</span>
</code></pre>
<h3 id="default-server-with-https-and-www-redirect" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#default-server-with-https-and-www-redirect"><span>Default server with HTTPS and <code>www</code> redirect</span></a></h3>
<p>I like <code><strong>http://</strong>www.codejam.info/</code> to redirect to
<code><strong>https://</strong>www.codejam.info/</code>, and also
<code>https://codejam.info/</code> to redirect to <code>https://<strong>www.</strong>codejam.info/</code>.
As a bonus, I like when <code><strong>http://</strong>codejam.info/</code>
redirects to <code><strong>https://www.</strong>codejam.info/</code> in
a single step. üòè</p>
<p>We‚Äôll also take this as an opportunity to configure the Let‚Äôs Encrypt
webroot challenge path, so that our ACME client can automatically
generate and renew certificates.</p>
<div class="note">
<p><strong>Note:</strong> it appears that the most common way people run ACME clients is
by letting it automatically modify their web server configuration file
to handle the ACME challenge endpoint <code>/.well-known/acme-challenge</code>
during the issuing or renewal.</p>
<p>Alternatively, the ‚Äúwebroot‚Äù method lets you configure the
<code>/.well-known/acme-challenge</code> path yourself on your web server to serve
an existing directory on the system. The ACME client will then just put
files in that directory to have them served by your web server, without
altering its configuration. This is a much simpler and more reliable
solution.</p>
<p>While common ACME clients like <a href="https://certbot.eff.org/">Certbot</a> and
<a href="https://github.com/acmesh-official/acme.sh">acme.sh</a> can handle a
variety of web server configurations, I hate the idea of a tool
modifying my <code>nginx.conf</code> which is why I use the webroot mode instead.</p>
</div>
<p>The following <code>server</code> blocks will do all of that. They live inside the
main <code>http</code> block which I won‚Äôt include again here.</p>
<pre><code class="hljs language-nginx"><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> default_server;
    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span> default_server;
    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl http2 default_server;
    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">443</span> ssl http2 default_server;

    <span class="hljs-attribute">location</span> / {
        <span class="hljs-attribute">return</span> <span class="hljs-number">404</span>;
    }
}

<span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span>;

    <span class="hljs-attribute">server_name</span> www.codejam.<span class="hljs-literal">info</span>;

    <span class="hljs-attribute">location</span> / {
        <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> https://$host$request_uri;
    }

    <span class="hljs-attribute">location</span> /.well-known/acme-challenge {
        <span class="hljs-attribute">root</span> /var/www/challenges;
    }
}

<span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span>;
    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl http2;
    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">443</span> ssl http2;

    <span class="hljs-attribute">server_name</span> codejam.<span class="hljs-literal">info</span>;

    <span class="hljs-attribute">location</span> / {
        <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> https://www.$host$request_uri;
    }

    <span class="hljs-attribute">location</span> /.well-known/acme-challenge {
        <span class="hljs-attribute">root</span> /var/www/challenges;
    }
}

<span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl http2;
    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">443</span> ssl http2;

    <span class="hljs-attribute">server_name</span> www.codejam.<span class="hljs-literal">info</span>;

    <span class="hljs-attribute">access_log</span> /var/log/nginx/www.codejam.<span class="hljs-literal">info</span>.access.log;
    <span class="hljs-attribute">error_log</span> /var/log/nginx/www.codejam.<span class="hljs-literal">info</span>.<span class="hljs-literal">error</span>.log;

    <span class="hljs-attribute">root</span> /var/www/www.codejam.<span class="hljs-literal">info</span>;
    <span class="hljs-attribute">index</span> index.html;

    <span class="hljs-attribute">location</span> /.well-known/acme-challenge {
        <span class="hljs-attribute">root</span> /var/www/challenges;
    }
}
</code></pre>
<p>The first block with <code>default_server</code> makes sure that nginx returns a
404 for every requests it sees for a domain that it doesn‚Äôt know about.</p>
<p>The rest should be self-explanatory.</p>
<div class="note">
<p><strong>Note:</strong> this will be good for production but because we don‚Äôt have the
certificate files yet, nginx will not accept our SSL servers. So comment
those out in the meantime, and just add the following server that will
let us generate our initial certificates:</p>
<pre><code class="hljs language-conf">server {
    listen 80 default_server;
    listen [::]:80 default_server;

    location / {
        return 404;
    }

    location /.well-known/acme-challenge {
        root /var/www/challenges;
    }
}
</code></pre>
</div>
<h3 id="enabling-starting-or-reloading-nginx" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#enabling-starting-or-reloading-nginx"><span>Enabling, starting or reloading nginx</span></a></h3>
<p>First, let‚Äôs test the configuration:</p>
<pre><code class="hljs language-sh">nginx -t
</code></pre>
<p>If successful, we can enable the nginx service if it‚Äôs not already:</p>
<pre><code class="hljs language-sh">systemctl <span class="hljs-built_in">enable</span> nginx
</code></pre>
<p>Then start it:</p>
<pre><code class="hljs language-sh">systemctl start nginx
</code></pre>
<p>Or reload its configuration if it was already running</p>
<pre><code class="hljs language-sh">systemctl reload nginx
</code></pre>
<div class="note">
<p><strong>Note:</strong> by default when installing a package that comes with a service
like nginx, Debian automatically enables it and starts it, so you
probably only need the reload command above at that point.</p>
<p>Use <code>systemctl status nginx</code> to see if it‚Äôs currently enabled and
running.</p>
</div>
<p>While in this state we don‚Äôt have proper TLS certificates to handle
HTTPS just yet, we have everything we need to automatically generate and
renew TLS certificates with the ACME protocol.</p>
<h2 id="managing-tls-certificates-with-acme-sh" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#managing-tls-certificates-with-acme-sh"><span>Managing TLS certificates with acme.sh</span></a></h2>
<p><abbr title="Automatic certificate management environment">ACME</abbr>
is the protocol behind Let‚Äôs Encrypt. <a href="https://github.com/acmesh-official/acme.sh">acme.sh</a>
is an ACME client written in pure Unix shell. It‚Äôs simple and
lightweight, unlike <a href="https://certbot.eff.org/">Certbot</a>, which is the
client that Let‚Äôs Encrypt recommends to use.</p>
<p>acme.sh is the most simple client that I found, but their default usage
instructions still do some magic that I would rather avoid, so I‚Äôll
present here my modified installation method, which doesn‚Äôt have any
magic and where you‚Äôre fully in control of every step.</p>
<h3 id="setting-up-a-restricted-user" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#setting-up-a-restricted-user"><span>Setting up a restricted user</span></a></h3>
<p>We‚Äôll do a custom installation of <a href="https://github.com/acmesh-official/acme.sh">acme.sh</a>
so that it runs <strong>with its own restricted user</strong> based on <a href="https://gist.github.com/lachesis/943769f3fac740d5848352752ac08741">this Gist</a>,
because running it as root like they show out of the box is
irresponsible.</p>
<p>First we create a <code>acme</code> user with home directory set to <code>/var/lib/acme</code>
(it‚Äôll be created automatically because we specified <code>-m</code>) and
<code>/usr/sbin/nologin</code> as login shell to deny login access to this account.</p>
<pre><code class="hljs language-sh">useradd -m -d /var/lib/acme -s /usr/sbin/nologin acme
</code></pre>
<p>We also make sure this home directory is only accessible by the <code>acme</code>
user itself.</p>
<pre><code class="hljs language-sh">chmod 700 /var/lib/acme
</code></pre>
<p>Then we prepare the webroot challenge directory that we configured
earlier in <code>nginx.conf</code>. We make sure that it‚Äôs owned by the <code>acme</code> user
and group so that it can write to this directory. The default permission
for the directory is full access for the user and read and execute
access for everyone else which is fine here.</p>
<pre><code class="hljs language-sh">mkdir /var/www/challenges
chown acme:acme /var/www/challenges
</code></pre>
<p>Next, we prepare the directory where we‚Äôll install the certificates.
This directory needs to be writable by the <code>acme</code> user but nginx (who
runs under the <code>www-data</code> user and group) needs to be able to read from
it, so we set the group to <code>www-data</code>.</p>
<p>This allows us to set the <code>710</code> permission which means full access for
the user, execute access for the group (on a directory that means it can
access files in this directory according to the files permissions but
cannot list the contents of the directory), and no permissions for
everyone else.</p>
<pre><code class="hljs language-sh">mkdir /etc/acme
chown acme:www-data /etc/acme
chmod 710 /etc/acme
</code></pre>
<p>Finally we give <code>sudo</code> access to the <code>acme</code> user, allowing it to only
run the <code>/bin/systemctl reload nginx</code> command without being prompted for
a password. Run <code>visudo</code> to safely edit the <code>/etc/sudoers</code> file and add
the following line:</p>
<pre><code class="hljs language-sh">acme	ALL=(ALL:ALL) NOPASSWD: /bin/systemctl reload nginx
</code></pre>
<p>We can now open a shell as the <code>acme</code> user to set up acme.sh there. Here
we explicitly precise <code>/bin/bash</code> as shell because we set the default
one to <code>/usr/sbin/nologin</code> for this user earlier to deny shell access.
We make sure to run a login shell using <code>-</code>.</p>
<pre><code class="hljs language-sh">su -s /bin/bash - acme
</code></pre>
<p>We‚Äôll end up in the home directory which we set earlier to <code>/var/lib/acme</code>.</p>
<h3 id="installation" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#installation"><span>Installation</span></a></h3>
<p>We can now follow the official <a href="https://github.com/acmesh-official/acme.sh#2-or-install-from-git">install from Git instructions</a>
because piping scripts from the web into <code>sh</code> is a terrible idea.</p>
<pre><code class="hljs language-sh">git <span class="hljs-built_in">clone</span> https://github.com/acmesh-official/acme.sh
<span class="hljs-built_in">cd</span> acme.sh
</code></pre>
<p>That‚Äôs where my method starts to differ. They recommend running
<code>./acme.sh --install -m my@example.com</code> which will do a number of
things:</p>
<ol>
<li>Register to <a href="https://zerossl.com/">ZeroSSL</a> with the given email address.</li>
<li>Copy the contents of the repo to <code>~/.acme.sh</code>, doing a few shebang
modifications.</li>
<li>Create a default <code>account.conf</code> and <code>acme.sh.env</code> files that we won‚Äôt
need here.</li>
<li>Generate a cron entry to renew certificates, which we can generate
later on with a more specific command.</li>
</ol>
<p>I like to keep the source code separate from the configuration and some
of those steps are unnecessary for me.</p>
<p>Instead, I don‚Äôt ‚Äúinstall‚Äù acme.sh and I just run it from its Git repo,
which will make it much easier to update the code in the future. Because
by default it stores all the configuration in <code>~/.acme.sh</code>, this has the
nice side effect of keeping the code and the configuration separate. The
code from the repo is directly usable, and all the extra state will be
put in <code>~/.acme.sh</code>.</p>
<p>We still need to explicitly register to ZeroSSL (or any of the other
<a href="https://github.com/acmesh-official/acme.sh#supported-ca">supported certificate authorities</a>):</p>
<pre><code class="hljs language-sh">./acme.sh --register-account -m y@example.com
</code></pre>
<p>We also need to set up the cron entry:</p>
<pre><code class="hljs language-sh">LE_WORKING_DIR=<span class="hljs-variable">$PWD</span> ./acme.sh --install-cronjob
</code></pre>
<p>You can check what acme.sh did by running <code>crontab -l</code>. You could also
manually configure an entry like:</p>
<pre><code class="hljs language-crontab">42 0 * * * /path/to/.acme.sh/acme.sh --cron --home /path/to/.acme.sh &gt; /dev/null
</code></pre>
<p>This would run the acme.sh cron task every day at 00:42. But their
<code>--install-cronjob</code> script generates a random minute to run the job so
that the certificate authority doesn‚Äôt get a huge burst of requests at
the same second every day, which I think is a good practice to keep.</p>
<p>From there, the commands we‚Äôll run are the same as the recommended ones
in the acme.sh readme.</p>
<h2 id="preparing-the-certificates-directory-and-dh-parameters" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#preparing-the-certificates-directory-and-dh-parameters"><span>Preparing the certificates directory and DH parameters</span></a></h2>
<p>I like to install my certificates in <code>/etc/acme</code> which we created
earlier, with a directory per domain, but this is totally arbitrary.</p>
<pre><code class="hljs language-sh">mkdir /etc/acme/codejam.info
</code></pre>
<p>We also get the <abbr title="Diffie-Hellman">DH</abbr> parameters as
recommended by <a href="https://ssl-config.mozilla.org/">Mozilla‚Äôs SSL configuration generator</a>.</p>
<pre><code class="hljs language-sh">curl https://ssl-config.mozilla.org/ffdhe2048.txt &gt; /etc/acme/ssl-dhparams.pem
</code></pre>
<div class="note">
<p><strong>Note:</strong> long story short, generating strong DH parameters is not that
easy and it‚Äôs actually <a href="https://security.stackexchange.com/a/149818">considered more secure</a>
to use ones that are proven to be strong despite being public like those
provided by Mozilla, unless the key size is considered short (1024 bits
or less as of today‚Äôs standards), then using shared DH parameters could
introduce more security risks than it would prevent.</p>
</div>
<h3 id="generating-our-certificate" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#generating-our-certificate"><span>Generating our certificate</span></a></h3>
<pre><code class="hljs language-sh">./acme.sh --issue -d codejam.info -d www.codejam.info -w /var/www/challenges
</code></pre>
<p>This will issue a certificate for <code>codejam.info</code> with <code>www.codejam.info</code>
as alternate name (you can put as many alternate names as you want with
subsequent <code>-d</code> parameters), meaning that the certificate will be valid
for all of those domains. You can also generate a wildcard certificate
but this requires going through automated DNS validation which I won‚Äôt
cover in this blog post.</p>
<h3 id="installing-the-certificate" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#installing-the-certificate"><span>Installing the certificate</span></a></h3>
<p>In the previous step, acme.sh generated the key and certificate files in
its own state directory, but it‚Äôs not recommended to hardcode those
paths. That‚Äôs why we configure certificate installation paths as well as
a reload command:</p>
<pre><code class="hljs language-sh">./acme.sh --install-cert -d codejam.info \
    --key-file /etc/acme/codejam.info/privkey.pem \
    --cert-file /etc/acme/codejam.info/cert.pem \
    --fullchain-file /etc/acme/codejam.info/fullchain.pem \
    --ca-file /etc/acme/codejam.info/chain.pem \
    --reloadcmd <span class="hljs-string">&#x27;sudo systemctl reload nginx&#x27;</span>
</code></pre>
<p>This will not only install the files in the specified locations and run
the reload command, but will also save those to your domain
configuration so that acme.sh knows knows where to install the
certificates and how to reload the server during the cron job.</p>
<p>But we commented out the certificate files in <code>nginx.conf</code> earlier
because they didn‚Äôt exist yet. We can now edit the config (as root) to
reference those files we just installed.</p>
<pre><code class="hljs language-diff"><span class="hljs-deletion">-# ssl_certificate /path/to/signed_cert_plus_intermediates;</span>
<span class="hljs-deletion">-# ssl_certificate_key /path/to/private_key;</span>
<span class="hljs-addition">+ssl_certificate /etc/acme/codejam.info/fullchain.pem;</span>
<span class="hljs-addition">+ssl_certificate_key /etc/acme/codejam.info/privkey.pem;</span>
 ssl_session_timeout 1d;
 ssl_session_cache shared:MozSSL:10m;
 ssl_session_tickets off;
<span class="hljs-deletion">-# ssl_dhparam /path/to/dhparam;</span>
<span class="hljs-addition">+ssl_dhparam /etc/acme/ssl-dhparams.pem;</span>
 ssl_protocols TLSv1.2 TLSv1.3;
 ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
 ssl_prefer_server_ciphers off;
 add_header Strict-Transport-Security &quot;max-age=63072000&quot; always;
 ssl_stapling on;
 ssl_stapling_verify on;
<span class="hljs-deletion">-# ssl_trusted_certificate /path/to/root_CA_cert_plus_intermediates;</span>
<span class="hljs-addition">+ssl_trusted_certificate /etc/acme/codejam.info/chain.pem;</span>
</code></pre>
<p>Verify the config is valid with <code>nginx -t</code> and run a final <code>systemctl reload nginx</code> to apply the changes.</p>
<h2 id="bonus-http-basic-authentication" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#bonus-http-basic-authentication"><span>Bonus: HTTP basic authentication</span></a></h2>
<p>You don‚Äôt want your website to be public just yet but still want to test
it from there? Add basic authentication to it!</p>
<pre><code class="hljs language-sh">apt install apache2-utils
htpasswd -c /etc/nginx/htpasswd &lt;user&gt;
</code></pre>
<p>Then in <code>nginx.conf</code>, add the following to the <code>server</code> block you want
to add authentication to:</p>
<pre><code class="hljs language-nginx"><span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">auth_basic</span> <span class="hljs-string">&quot;Private&quot;</span>;
    <span class="hljs-attribute">auth_basic_user_file</span> /etc/nginx/htpasswd;
}
</code></pre>
<p>Here, ‚Äúprivate‚Äù is the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/WWW-Authenticate#directives">basic authentication <code>realm</code> parameter</a>
and could be literally anything. It doesn‚Äôt even seem to be shown in
browser UIs anymore so it doesn‚Äôt really matter.</p>
<h2 id="wrapping-up" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/minimalist-debian-nginx-let-s-encrypt.html#wrapping-up"><span>Wrapping up</span></a></h2>
<p>At that point, you should have a working HTTPS server with auto-renewed
certificates. I hope this post was useful to you!</p>
<div class="note">
<p><strong>Note:</strong> if you‚Äôre looking to integrate Let‚Äôs Encrypt or similar on
your server but this post was too technical for you, <a href="https://www.codejam.info/val.html#contact">let me know</a>,
I‚Äôm available for <a href="https://www.codejam.info/freelance.html">contracting</a> projects and
I‚Äôll be happy to help you with that. ‚úåÔ∏è</p>
</div>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1440704576059961362">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>Vercel custom log drain (dump HTTP traffic for free on a Vercel app)</title>
    <link href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html" />
    <id>https://www.codejam.info/2021/09/vercel-custom-log-drain.html</id>
    <updated>2021-09-21T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>In the <a href="https://www.codejam.info/2021/09/free-static-hosting-server-side-analytics.html">previous post</a>, we
compared the different services providing free static website hosting,
and their options to access server-side web analytics or raw HTTP logs.</p>
<p><a href="https://vercel.com/">Vercel</a> was the only one to allow accessing
traffic data for free, but it‚Äôs not the easiest thing to do. In this
article, I‚Äôll show you how.</p>
<div class="note">
<p><strong>Note:</strong> if you‚Äôre in a rush, go straight to the <a href="https://github.com/valeriangalliat/vercel-custom-log-drain">GitHub repo</a>
which contains the full code for a working integration that allows you
to manage arbitrary log drains!</p>
<p>I also give you the link to the <a href="https://vercel.com/integrations/custom-log-drain">live integration that I use for myself</a>,
and you can use it too!</p>
<p>Otherwise, if you‚Äôre interested in the underlying implementation, read
on.</p>
</div>
<p>I‚Äôll assume that you already have an account with Vercel and deployed
your app there. This shouldn‚Äôt be too bad, but if you like to keep
things simple, you might want to read a few tips of mine about <a href="https://www.codejam.info/2021/09/vercel-without-preview-deployments.html">keeping Vercel clean and silent</a>.</p>
<p>Neither of Vercel‚Äôs UI, CLI and API directly allow to manage log drains.
While <a href="https://vercel.com/docs/rest-api#integrations/log-drains">the API has endpoints to manage log drains</a>,
those are only available to Vercel integrations, and are denied when
called with a <a href="https://vercel.com/account/tokens">regular user token</a>
like the ones the CLI and web app use.</p>
<p>This means that we‚Äôll need to create our own Vercel integration in order
to have an integration token that will let us call the log drains API.</p>
<h2 id="how-does-a-vercel-integration-work" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html#how-does-a-vercel-integration-work"><span>How does a Vercel integration work</span></a></h2>
<ul>
<li>A Vercel integration is a web app hosted on your own domain, which
needs to respond to a ‚ÄúVercel callback‚Äù page.</li>
<li>Vercel will redirect the user to that page when they try to install
your integration, providing a <code>code</code> and <code>next</code> query parameters.</li>
<li>You can exchange the <code>code</code> parameter for a Vercel API OAuth access token.</li>
<li>You‚Äôre expected to redirect to the URL provided in the <code>next</code>
parameter once the installation is complete.</li>
</ul>
<p>Most integrations will store the OAuth access token and refresh token
that are exchanged during that process to be able to query the API on
behalf of the user later on, but for cost and time reasons, <strong>I want to
keep my integration stateless</strong>. This means that I‚Äôll perform the log
drain operations only during the installation process, and <strong>will
instantly forget the token</strong>.</p>
<p>Because of that, we‚Äôll have to remove the integration and add it again
if we want to configure a new log drain. Log drains are specific to an
integration, meaning that when you remove the integration, the log
drains are removed with it too.</p>
<p>I could have built a stateful application where I allow to fully manage
log drains, but then I would need to charge for it to pay for the
hosting and development costs, and at that point I believe that most
users who are willing to pay will be happy to pay for Logtrail,
Sematext, Datadog, LogDNA and others that already have an official
Vercel integration.</p>
<div class="note">
<p><strong>Note:</strong> if I‚Äôm wrong with that assumption, and you would pay a monthly
fee for a service that allows you to fully manage your Vercel log drains
with arbitrary URLs, <a href="https://www.codejam.info/val.html#contact">let me know</a>. If there‚Äôs enough
demand I‚Äôll consider building something!</p>
</div>
<h2 id="creating-our-own-vercel-integration" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html#creating-our-own-vercel-integration"><span>Creating our own Vercel integration</span></a></h2>
<p>For this, head to the <a href="https://vercel.com/dashboard/integrations/console">Vercel integrations console</a>,
which lists you all the integrations that you have created, and allows
you to create new ones.</p>
<p>Click the ‚Äúcreate‚Äù button. In that form, you need to fill a bunch of
details about your integration that should be pretty obvious.</p>
<p>You‚Äôll need to include the redirect URL. If you want to use <a href="https://github.com/valeriangalliat/vercel-custom-log-drain">the repo I mentioned earlier</a>,
it‚Äôs going to be on the <code>/vercel/callback</code> path, on the domain you‚Äôre
going to host it on.</p>
<p>You can ignore the webhook and configuration URLs unless you want to
build a stateful version that allows editing the log drains after
installation (then you‚Äôd need the configuration URL specifically).</p>
<h3 id="making-the-form" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html#making-the-form"><span>Making the form</span></a></h3>
<p>We‚Äôll go for a very basic HTML form that allows selecting between
<code>json</code>, <code>ndjson</code> and <code>syslog</code> as the log drain type, which are the only
formats supported by Vercel as of writing, as well as the URL to the log
drain we want to add.</p>
<pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;type&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;json&quot;</span>&gt;</span>json<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;ndjson&quot;</span>&gt;</span>ndjson<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;syslog&quot;</span>&gt;</span>syslog<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;URL&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
</code></pre>
<p>See the <a href="https://github.com/valeriangalliat/vercel-custom-log-drain/blob/master/form.html">full HTML</a>
with a tiny layer of CSS.</p>
<h3 id="serving-the-form" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html#serving-the-form"><span>Serving the form</span></a></h3>
<p>I‚Äôll use <a href="https://www.fastify.io/">Fastify</a> to handle the HTTP requests,
but <a href="https://expressjs.com/">Express</a> would have worked just fine for
this too.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>)
<span class="hljs-keyword">const</span> fastify = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fastify&#x27;</span>)

<span class="hljs-keyword">const</span> form = fs.readFileSync(<span class="hljs-string">&#x27;form.html&#x27;</span>, <span class="hljs-string">&#x27;utf8&#x27;</span>)

<span class="hljs-keyword">const</span> app = fastify({ <span class="hljs-attr">logger</span>: <span class="hljs-literal">true</span> })

app.get(<span class="hljs-string">&#x27;/vercel/callback&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!req.query.code || !req.query.next) {
    <span class="hljs-keyword">return</span> res.type(<span class="hljs-string">&#x27;text/plain&#x27;</span>).send(<span class="hljs-string">&#x27;Hello!&#x27;</span>)
  }

  res.type(<span class="hljs-string">&#x27;text/html&#x27;</span>).send(form)
})


app.listen(process.env.PORT || <span class="hljs-number">8080</span>, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (err) {
    app.log.error(err)
    process.exit(<span class="hljs-number">1</span>)
  }
})
</code></pre>
<p>This gets us running with a simple app that serves the form we just
built on <code>/vercel/callback</code>.</p>
<p>If called without <code>code</code> and <code>next</code> parameters, it means we‚Äôre not being
redirected from Vercel integration installation, and we just show a
simple message to say hello, because the form wouldn‚Äôt be useful when
it‚Äôs not called from Vercel.</p>
<h3 id="handling-the-form" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html#handling-the-form"><span>Handling the form</span></a></h3>
<p>First, we‚Äôll need to trade the <code>code</code> parameter for a Vercel OAuth
access token. We can do that by calling the <code>https://api.vercel.com/v2/oauth/access_token</code>.</p>
<p>This requires us to configure the OAuth client ID and client secret that
were provided to you at the end of the <a href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html#creating-our-own-vercel-integration">integration creation</a>,
as well as the redirect URL that we defined during creation.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> qs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;querystring&#x27;</span>)
<span class="hljs-keyword">const</span> fetch = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;node-fetch&#x27;</span>)
<span class="hljs-keyword">const</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./config&#x27;</span>)

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getToken</span> (<span class="hljs-params">code</span>) </span>{
  <span class="hljs-keyword">const</span> url = <span class="hljs-string">&#x27;https://api.vercel.com/v2/oauth/access_token&#x27;</span>

  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> fetch(url, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/x-www-form-urlencoded&#x27;</span>
    },
    <span class="hljs-attr">body</span>: qs.stringify({
      <span class="hljs-attr">client_id</span>: config.clientId,
      <span class="hljs-attr">client_secret</span>: config.clientSecret,
      code,
      <span class="hljs-attr">redirect_uri</span>: config.redirectUri
    })
  })

  <span class="hljs-keyword">if</span> (!res.ok) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${url}</span> responded with <span class="hljs-subst">${res.status}</span>`</span>)
  }

  <span class="hljs-keyword">const</span> json = <span class="hljs-keyword">await</span> res.json()

  <span class="hljs-keyword">return</span> json.access_token
}
</code></pre>
<p>With that token, we can call the log drains endpoint to create a new log
drain.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createLogDrain</span> (<span class="hljs-params">token, body</span>) </span>{
  <span class="hljs-keyword">const</span> url = <span class="hljs-string">&#x27;https://api.vercel.com/v1/integrations/log-drains&#x27;</span>

  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> fetch(url, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>,
      <span class="hljs-attr">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-built_in">JSON</span>.stringify(body)
  })

  <span class="hljs-keyword">if</span> (!res.ok) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${url}</span> responded with <span class="hljs-subst">${res.status}</span>`</span>)
  }
}
</code></pre>
<p>Now, we can put those together when handling the <code>POST</code> form submission,
as well as redirecting to the <code>next</code> URL at the end.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> formBody = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fastify-formbody&#x27;</span>)

app.register(formBody)

app.post(<span class="hljs-string">&#x27;/vercel/callback&#x27;</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">if</span> (!req.query.code || !req.query.next || !req.body.type || !req.body.url) {
    <span class="hljs-keyword">return</span> res.code(<span class="hljs-number">400</span>)
  }

  <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> getToken(req.query.code)

  <span class="hljs-keyword">await</span> createLogDrain(token, {
    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;custom-log-drain&#x27;</span>,
    <span class="hljs-attr">type</span>: req.body.type,
    <span class="hljs-attr">url</span>: req.body.url
  })

  res.redirect(req.query.next)
})
</code></pre>
<p>You can see <a href="https://github.com/valeriangalliat/vercel-custom-log-drain/blob/master/index.js">the full code on GitHub</a>.</p>
<p>After deploying that code, you should be able to use your custom
integration from the integration marketplace to configure any log drain
you want for your Vercel apps.</p>
<p>You can hack on this code if you want to allow setting up the log drain
only on certain apps and not globally (see other <a href="https://vercel.com/docs/rest-api#integrations/log-drains/create-a-log-drain/request-parameters">request parameters</a>),
or make it stateful with the option to edit and remove existing log
drains without having to reinstall the integration.</p>
<h2 id="making-a-simple-log-drain-with-nginx" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html#making-a-simple-log-drain-with-nginx"><span>Making a simple log drain with nginx</span></a></h2>
<p>Now, we only solved half of the problem. We can configure any URL as a
log drain on our Vercel apps, but we don‚Äôt have a URL to put there yet!
Most of the logging software as a service apps already have
<a href="https://vercel.com/integrations#logging">an integration on the marketplace</a>.</p>
<p>Instead, we want to provide our own URL to handle the logs, in a way
that‚Äôs the cheapest as possible, or ideally free.</p>
<p>For that, we‚Äôre going to leverage the Google Cloud free tier, which
includes one <code>e2-micro</code> instance for free per billing account.</p>
<p>It should be easy to get one running and to install nginx on it.</p>
<div class="note">
<p><strong>Note:</strong> if you‚Äôre interested in how I do the initial configuration of
a Debian Google Cloud VM, I‚Äôll have an article about that very soon.
Stay tuned!</p>
</div>
<p>Then, we‚Äôre going to use a cool ‚Äúhack‚Äù that allows us to configure nginx
to append the <code>POST</code> body of an endpoint directly to the file of our
choice. This is essentially the definition of a simple HTTP log
drain.</p>
<p>First, we‚Äôll define a <code>postdata</code> log format that logs the plain
unescaped request body to the log file:</p>
<pre><code class="hljs language-nginx"><span class="hljs-section">http</span> {
    <span class="hljs-attribute">log_format</span> postdata escape=<span class="hljs-literal">none</span> $request_body;
}
</code></pre>
<p>But we can‚Äôt just us it like this. By default, nginx won‚Äôt bother
reading the request body if it‚Äôs not doing anything with it, which means
it won‚Äôt be included in the log variables.</p>
<p>There‚Äôs two ways to force nginx to read the request body. One is with the
<a href="https://github.com/openresty/echo-nginx-module">nginx <code>echo</code> module</a>,
and the other one (fully native) leverages a hack with the <code>proxy_pass</code>
directive.</p>
<p>In both cases, you‚Äôll be able to configure <code>https://your.domain/vercel/drain</code>
as a Vercel log drain. I find that NDJSON works best with this format.</p>
<h3 id="with-echo-read-request-body" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html#with-echo-read-request-body"><span>With <code>echo_read_request_body</code></span></a></h3>
<pre><code class="hljs language-nginx"><span class="hljs-comment"># Make sure this is loaded, method may vary depending on your setup.</span>
<span class="hljs-attribute">load_module</span> modules/ngx_http_echo_module.so;

<span class="hljs-section">server</span> {
    <span class="hljs-attribute">location</span> /vercel/drain {
        <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;

        <span class="hljs-attribute">if</span> ($request_method = POST) {
            <span class="hljs-comment"># Wherever you want to store your logs.</span>
            <span class="hljs-attribute">access_log</span> /path/to/vercel.log postdata;

            <span class="hljs-comment"># Required to force nginx to read the request body,</span>
            <span class="hljs-comment"># otherwise it won&#x27;t log anything.</span>
            echo_read_request_body;
        }
    }
}
</code></pre>
<h3 id="with-proxy-pass-hack" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html#with-proxy-pass-hack"><span>With <code>proxy_pass</code> hack</span></a></h3>
<p>If you don‚Äôt want to load <code>ngx_http_echo_module</code>, you can instead use
the native <code>proxy_pass</code> directive to force nginx to read the request
body.</p>
<p>Since <code>proxy_pass</code> needs to proxy to <em>something</em>, the trick consists
into defining a ‚Äúblack hole‚Äù endpoint to proxy to. Because <code>proxy_pass</code>
will need to read the whole HTTP body in order to forward it, it will
become accessible to our log format.</p>
<pre><code class="hljs language-nginx"><span class="hljs-section">server</span> {
    <span class="hljs-attribute">location</span> /vercel/empty {
      <span class="hljs-attribute">return</span> <span class="hljs-number">204</span>;
    }

    <span class="hljs-attribute">location</span> /vercel/drain {
        <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;

        <span class="hljs-attribute">if</span> ($request_method = POST) {
            <span class="hljs-attribute">access_log</span> /path/to/vercel.log postdata;

            <span class="hljs-comment"># Adapt this to whatever your server responds to, or</span>
            <span class="hljs-comment"># feel free to use `$scheme`, `$server_name`, `$host`,</span>
            <span class="hljs-comment"># `$server_port` and so on.</span>
            <span class="hljs-attribute">proxy_pass</span> http://localhost/vercel/empty;
        }
    }
}
</code></pre>
<h2 id="wrapping-up" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html#wrapping-up"><span>Wrapping up</span></a></h2>
<p>You should now have everything you need to store your Vercel logs in
plain text files on a Google Cloud free tier VM (or wherever else you
wanted to)!</p>
<p>You‚Äôre now free to <code>grep</code> through them or do whatever magic you want
with the data to get all the stats and insights that you want. And all
of that for free (or nearly).</p>
<div class="note">
<p><strong>Note:</strong> if you need to forward your Vercel logs to a custom endpoint
but this article was too technical for you, feel free to <a href="https://www.codejam.info/val.html#contact">contact me</a>,
I‚Äôm available for <a href="https://www.codejam.info/freelance.html">freelance work</a> and I‚Äôll be
happy to help you with that. ‚úåÔ∏è</p>
</div>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1440401250927857668">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>Free static hosting with server-side analytics</title>
    <link href="https://www.codejam.info/2021/09/free-static-hosting-server-side-analytics.html" />
    <id>https://www.codejam.info/2021/09/free-static-hosting-server-side-analytics.html</id>
    <updated>2021-09-21T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>This blog has been hosted on <a href="https://pages.github.com/">GitHub Pages</a>
for a while, but I was getting frustrated of not having any idea of the
traffic it was getting, and I was really curious to find out.</p>
<p>The only way to get traffic insights on GitHub pages is through
client-side analytics scripts, which is technically very unreliable, and
I‚Äôd rather not get any data than getting data that I cannot trust, and
which on top of that negatively impacts the performance of my site.</p>
<p>What I want is raw access to HTTP logs, which is the only proper source
of truth for this.</p>
<p>In the first part of this series, I‚Äôll compare different free static
hosting services and their options to get access to server-side
analytics or logs. Then, I‚Äôll show you <a href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html">in the second part</a>
how to retrieve logs on a Vercel app, which is the only service I found
to provide HTTP logs as part of their free offer!</p>
<h2 id="github-pages" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/free-static-hosting-server-side-analytics.html#github-pages"><span>GitHub Pages</span></a></h2>
<p><a href="https://pages.github.com/">GitHub Pages</a> is the easiest option to host
a static website for free, especially if you‚Äôre already working with
GitHub, but it doesn‚Äôt have an option to access HTTP logs.</p>
<p>The only method they document is using Google Analytics or a similar
script, but that‚Äôs not an acceptable solution to me. Let‚Äôs move on.</p>
<h2 id="netlify" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/free-static-hosting-server-side-analytics.html#netlify"><span>Netlify</span></a></h2>
<p><a href="https://www.netlify.com/">Netlify</a> is my next favorite way to deploy a
static website. They also have a <a href="https://www.netlify.com/products/analytics/">Netlify Analytics</a>,
product, an analytics platform based on server logs, which is exactly
what I want!</p>
<p>As they point out in their marketing page, it‚Äôs ‚Äúdata right from the
source of truth‚Äù, it‚Äôs got ‚Äúbetter performance‚Äù, ‚Äúmore accurate
numbers‚Äù, ‚Äúbetter privacy‚Äù and gives you access to extra metrics you can
only get on the server side.</p>
<p>To me this the only proper way to get traffic analytics on the web.</p>
<p>But they price that feature at $9 per month per site, which to be honest
is pretty decent if you have a website that‚Äôs generating some cash, but
my blog is not and my current budget is closer to $0.</p>
<h2 id="cloudflare" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/free-static-hosting-server-side-analytics.html#cloudflare"><span>Cloudflare</span></a></h2>
<p><a href="https://www.cloudflare.com/">Cloudflare</a> also has a free static hosting
offer. They‚Äôve got a <a href="https://www.cloudflare.com/web-analytics/">Cloudflare Analytics</a>
product, but the free version is only powered by a client-side script,
which as we saw earlier, is useless.</p>
<p>Otherwise, the option to have analytics based on server logs starts with
the ‚Äúpro‚Äù plan that‚Äôs $20 per month. Too much for me.</p>
<p>They also offer <a href="https://www.cloudflare.com/products/cloudflare-logs/">Cloudflare Logs</a>
which seems like it would at least give access to raw HTTP logs, but the
pricing is not mentioned and you need to contact their sales department
to maybe get access to it. Doesn‚Äôt look good.</p>
<h2 id="render" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/free-static-hosting-server-side-analytics.html#render"><span>Render</span></a></h2>
<p><a href="https://render.com/">Render</a> is another service with free static
hosting, and a it‚Äôs a very well built product. Simple and efficient. Out
of all the websites in this list, it‚Äôs the one with my favorite UI so
far. Gets shit done, no bullshit. üòç</p>
<p>I especially love the fact that they allow to configure any public Git
URL to pull from, without forcing you to connect with GitHub or another
hosted Git provider through OAuth like it‚Äôs the case with <a href="https://www.codejam.info/2021/09/free-static-hosting-server-side-analytics.html#vercel">Vercel</a>.</p>
<p>Sadly, while you can <a href="https://render.com/docs/log-streams">configure a syslog drain</a>,
it only forward application logs and doesn‚Äôt include edge load balancer
HTTP logs, which is the only thing I care about.</p>
<h2 id="google-cloud-free-tier-vm" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/free-static-hosting-server-side-analytics.html#google-cloud-free-tier-vm"><span>Google Cloud free tier VM</span></a></h2>
<p>While it‚Äôs very different from the other managed services I mention in
this list, <a href="https://cloud.google.com/free/docs/gcp-free-tier/#compute">Google Cloud</a>
allows you to run a <code>e2-micro</code> instance constantly for free.</p>
<p>The <code>e2-micro</code> instance has access to 0.25 vCPU and can burst up to 2
vCPUs. It‚Äôs got 1 GB of RAM, and you‚Äôre allowed up to 30 GB of storage
for free. You can even assign it a static IP that will stay free as long
as it‚Äôs in use.</p>
<p>It‚Äôs a pretty underpowered machine but will be way fine for serving
static websites, for example with nginx, as long as it doesn‚Äôt have a
ridiculous amount of traffic.</p>
<p>The only caveat is that you still have to <a href="https://cloud.google.com/vpc/network-pricing">pay for traffic</a>.</p>
<p>Ingress traffic is free (data going in the VM), but you‚Äôll have to pay
for egress traffic (data going out of the VM). In other words, this
means that someone uploading a large file to your VM will be nearly
free, but serving a large file to someone will impact your billing.</p>
<p>Typically this is low enough to be negligible, but Google will be happy
to charge your credit card for $0.03 every month.</p>
<p>And because <em>you‚Äôre the server</em>, you can do whatever the fuck you want,
like logging HTTP traffic to <code>/var/log</code>.</p>
<p>This solution requires a bit of system administration knowledge, but if
like me, you find it to be exciting and a lot of fun, it‚Äôs definitely a
good solution. That being said you‚Äôll also be responsible of managing
the VM, keeping it up-to-date, and fixing any issue that might happen
with it, otherwise you website might get some downtime.</p>
<h2 id="vercel" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/free-static-hosting-server-side-analytics.html#vercel"><span>Vercel</span></a></h2>
<p>Finally, <a href="https://vercel.com/">Vercel</a> also has free static hosting. Yay!</p>
<p>They even have a <a href="https://vercel.com/analytics">Vercel Analytics</a>
product, but it‚Äôs mostly focused on performance, and the data is
captured on the client side. Makes sense for performance data, but not
what I want.</p>
<p>They also have <a href="https://vercel.com/docs/deployments/logs">logs</a>, which
can even be <a href="https://vercel.com/docs/deployments/logs#persistence">persisted</a>,
through <a href="https://vercel.com/integrations#logging">logging integrations</a>.</p>
<p>This is great, but the whole point I‚Äôm doing this comparison is because
I want a <em>free</em> hosting with logs. If I‚Äôm not willing to pay for
hosting, I‚Äôm not going to pay for Logtrail, Sematext, Datadog or LogDNA. üòÜ</p>
<p>The good news is that the logging integrations are built on top of <a href="https://vercel.com/docs/rest-api#integrations/log-drains">log
drains</a>, and
Vercel allows to <a href="https://vercel.com/docs/integrations">create custom integrations</a>.
This means that we can create our own custom integration, and for
example, configure a log drain that forwards the logs to‚Ä¶ a <a href="https://www.codejam.info/2021/09/free-static-hosting-server-side-analytics.html#google-cloud-free-tier-vm">Google Cloud free tier VM</a>!</p>
<p>This is the best of both words, because Google Cloud won‚Äôt charge for
ingress (and sending data to it is indeed ingress), so we‚Äôll only pay
for the egress of our SSH session where we query the log files, but
that‚Äôs going to be negligible.</p>
<p>In <a href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html">the next post</a>, I‚Äôll show you how to set
up Vercel with a custom integration to forward logs to a Google Cloud VM
(or the log drain of your choice). See you there!</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1440401245991170048">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>Using Vercel without preview deployments</title>
    <link href="https://www.codejam.info/2021/09/vercel-without-preview-deployments.html" />
    <id>https://www.codejam.info/2021/09/vercel-without-preview-deployments.html</id>
    <updated>2021-09-21T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p><a href="https://vercel.com/">Vercel</a> is a cool hosting service and is my go-to
for free static hosting. Why? While I prefer the experience of
<a href="https://pages.github.com/">GitHub Pages</a>, <a href="https://www.netlify.com/">Netlify</a>
and <a href="https://render.com/">Render</a>, Vercel <a href="https://www.codejam.info/2021/09/free-static-hosting-server-side-analytics.html">is the only one</a>
to allow raw access to HTTP logs for free. GitHub Pages and Render don‚Äôt
have this feature and Netlify charges a premium fee for it that‚Äôs over
my budget for a small website.</p>
<p>And while I don‚Äôt use client-side analytics scripts (because they
technically cannot be reliable), I like to have a sense of my website
traffic through HTTP logs (the only proper source of truth).</p>
<div class="note">
<p><strong>Note:</strong> if you‚Äôre interested in this topic, I specifically wrote an
article on <a href="https://www.codejam.info/2021/09/vercel-custom-log-drain.html">how to get access to raw HTTP logs on a Vercel website</a>.
Check it out!</p>
</div>
<h2 id="the-problem-with-vercel" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-without-preview-deployments.html#the-problem-with-vercel"><span>The problem with Vercel</span></a></h2>
<p>Vercel works. It works well. But it doesn‚Äôt fit my workflow at all.</p>
<p>I like to keep things simple and minimal, and have the least amount of
noise possible. Vercel likes to make things complicated, over-engineered
(relative to what I‚Äôm doing with it), and noisy.</p>
<p>Let‚Äôs take the example of this very blog, if I wanted to host it on
Vercel. The <a href="https://github.com/valeriangalliat/blog">source</a> is on
GitHub, I keep my Markdown files neatly in the <code>master</code> branch, I
render them to HTML using a <a href="https://github.com/valeriangalliat/blog/blob/03a140f7c02e540b4bf97c470261d23e3a156fad/Makefile#L49">dependency-based incremental build system</a>
(also known as makefile) in the <code>gh-pages</code> branch (could be called
anything else but hey, it was once hosted on GitHub Pages after all).</p>
<p>I don‚Äôt <em>need</em> to re-render the whole site every time I deploy, which is
why I commit the HTML files on a separate branch, instead of asking
Vercel or any other hosting platform to compile everything from <code>master</code>
on every deploy. This keeps things <em>fast as fuck</em> and low energy.</p>
<h3 id="preview-deployments" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-without-preview-deployments.html#preview-deployments"><span>Preview deployments</span></a></h3>
<p>By default, Vercel expects every branch to be deployable, and they have
that cool feature of automatically deploying every single commit to a
random URL (preview deployments). I don‚Äôt need preview deployments for
my blog, but there‚Äôs no way to turn them off.</p>
<h3 id="very-verbose-vercel" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-without-preview-deployments.html#very-verbose-vercel"><span>Very verbose Vercel</span></a></h3>
<p>They also have the annoying habit of posting a comment on every GitHub
PR and commit with the deployment URL by default. I hate noise and this
is pure noise for me. Luckily there‚Äôs a non-intuitive way of turning it
off and I‚Äôll show you how.</p>
<h3 id="managing-garbage" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-without-preview-deployments.html#managing-garbage"><span>Managing garbage</span></a></h3>
<p>Finally, because each PR and commit is going to trigger a deployment
with a not-so-temporary URL. This creates a lot of old, unused, garbage
deployments, and Vercel doesn‚Äôt know when you don‚Äôt need them anymore
and consider them garbage (for me, like, instantly, for anything that‚Äôs
not the latest production build).</p>
<p>You can either remove them manually (sad), or you can periodically run a
command that does just that for you (also sad, but less sad), and I‚Äôll
show you how.</p>
<p>Let‚Äôs get into it.</p>
<h2 id="turning-off-preview-deployments-kinda" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-without-preview-deployments.html#turning-off-preview-deployments-kinda"><span>Turning off preview deployments (kinda)</span></a></h2>
<p>I guess that the whole point of Vercel is to offer preview deployments,
so they didn‚Äôt really consider the use case where you would want to
remove them.</p>
<p>But if you go in your project settings, under the Git section, you can
configure a ‚Äúignored build step‚Äù command.</p>
<figure class="center">
  <img alt="Ignored build step" src="https://www.codejam.info/img/2021/09/vercel-ignored-build-step.png">
</figure>
<p>It‚Äôs a command whose exit code will determine whether Vercel will
actually deploy the branch. When the command errors out (exits with a
nonzero code), a new build will be triggered, but if the commands
succeeds (exits with 0), this build will be ignored.</p>
<p>You can <a href="https://vercel.com/docs/projects/overview#ignored-build-step">run Git commands there</a>,
but I like to keep it simple and just rely on the <code>VERCEL_ENV</code>
environment variable to only allow builds on the production branch
(<code>gh-pages</code> in my case) as defined in ‚Äúproduction branch‚Äù.</p>
<figure class="center">
  <img alt="Production branch" src="https://www.codejam.info/img/2021/09/vercel-production-branch.png">
</figure>
<p>By using the following command, I can effectively ignore all builds that
are not in the production branch.</p>
<pre><code class="hljs language-sh">[ <span class="hljs-string">&quot;<span class="hljs-variable">$VERCEL_ENV</span>&quot;</span> != production ]
</code></pre>
<p>This uses the
<a href="https://man7.org/linux/man-pages/man1/test.1.html"><code>test(1)</code></a> command
(commonly aliased to <code>[</code>) to exit with an error when we‚Äôre on the
production branch, in order to trigger a build.</p>
<p>The ignored build will still show up in your deployments list as
‚Äúcancelled‚Äù deployments, and there‚Äôs no way around that, but I show you
below <a href="https://www.codejam.info/2021/09/vercel-without-preview-deployments.html#garbage-collecting-dangling-deployments">how to garbage collect them</a>.</p>
<h2 id="getting-rid-of-bot-comments" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-without-preview-deployments.html#getting-rid-of-bot-comments"><span>Getting rid of bot comments</span></a></h2>
<p>By default Vercel will comment on every PR and commit with the link to
the deployment.</p>
<p>To avoid that, create a <code>vercel.json</code> file in every branch where you
want to turn this off, with the following content:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;github&quot;</span>: {
    <span class="hljs-attr">&quot;silent&quot;</span>: <span class="hljs-literal">true</span>
  }
}
</code></pre>
<div class="note">
<p><strong>Note:</strong> if you used the previous trick to only run builds in the
production branch, you only need to add this configuration there.</p>
</div>
<h2 id="garbage-collecting-dangling-deployments" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-without-preview-deployments.html#garbage-collecting-dangling-deployments"><span>Garbage collecting dangling deployments</span></a></h2>
<p>Vercel knows to create preview deployments, but doesn‚Äôt know when to
delete them. This means that you need to more or less manually delete
the old preview deployments that are not needed anymore.</p>
<p>It usually doesn‚Äôt cause any harm to have hundreds of older versions of
your website available on random public URLs that most likely only your
team knows about. I just don‚Äôt like them being <em>there</em> in the first
place.</p>
<figure class="center">
  <img alt="Dangling deployments" src="https://www.codejam.info/img/2021/09/vercel-dangling-deployments.png">
  <figcaption>I don't know about you, but that makes me anxious.</figcaption>
</figure>
<p>With the <a href="https://vercel.com/docs/cli">Vercel CLI</a>, which you can
install with <code>npm install -g vercel</code>, you can use the <a href="https://vercel.com/docs/cli#commands/remove"><code>vercel remove</code></a>
command to remove deployments.</p>
<p>Specifically, to remove everything but deployments with an active production or preview URL, run:</p>
<pre><code class="hljs language-sh">vercel remove &lt;project&gt; --safe
</code></pre>
<figure class="center">
  <img alt="Clean deployments" src="https://www.codejam.info/img/2021/09/vercel-clean-deployments.png">
  <figcaption>Now this is better!</figcaption>
</figure>
<h2 id="final-thoughts" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/09/vercel-without-preview-deployments.html#final-thoughts"><span>Final thoughts</span></a></h2>
<p>I‚Äôm not blaming Vercel for all of this, I‚Äôm happy they provide this
service for free and <a href="https://www.codejam.info/2021/09/free-static-hosting-server-side-analytics.html">they‚Äôre the only ones</a>
to include HTTP logs access in the free offer.</p>
<p>Sadly their approach to deploying websites if very far from mine, and
this requires me to work around those default behaviors to have
something that fits me better.</p>
<p>If you‚Äôre in a similar situation, I hope you found this post useful!</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1440401242522406912">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>Tracking the value of an Ethereum or Binance Smart Chain token in real time</title>
    <link href="https://www.codejam.info/2021/08/ethereum-binance-token-real-time-value.html" />
    <id>https://www.codejam.info/2021/08/ethereum-binance-token-real-time-value.html</id>
    <updated>2021-08-23T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>If you want to programmatically track the value of a crypto token on
Ethereum or the Binance Smart Chain, you‚Äôre in the right place, because
I recently wanted to do that as well.</p>
<p>There was very little beginner content about this online and it was
pretty hard to figure out without any prior cryptocurrency knowledge,
but it turned out to be technically pretty trivial, so I figured I would
write a quick blog post about this.</p>
<p>For the example I‚Äôll use the <a href="https://www.binance.org/en/smartChain">Binance Smart Chain</a>
with <a href="https://pancakeswap.info/token/0x54626300818e5c5b44db0fcf45ba4943ca89a9e2">CheCoin</a>,
a token that‚Äôs exchanged through a <a href="https://pancakeswap.finance/">PancakeSwap</a>
pool, but my understanding is that this should be applicable with pretty
much the same code to <a href="https://ethereum.org/en/">Ethereum</a> and
<a href="https://uniswap.org/">Uniswap</a>.</p>
<h2 id="first-attempt-trying-to-scrape-existing-sites" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/ethereum-binance-token-real-time-value.html#first-attempt-trying-to-scrape-existing-sites"><span>First attempt: trying to scrape existing sites</span></a></h2>
<p>Sites like <a href="https://poocoin.app/tokens/0x54626300818e5c5b44db0fcf45ba4943ca89a9e2">PooCoin</a>
and <a href="https://www.dextools.io/app/pancakeswap/pair-explorer/0x194850932e48753cbeedf0af85022152148addc6">DEXTools</a>
show a live graph of the token transactions, which is exactly the kind
of data we‚Äôd need to see the real-time value.</p>
<p>At the time I didn‚Äôt know about DEXTools which seems actually pretty
easy to scrape. On PooCoin though, all the data seems to come from
<code>https://bsc-dataseed1.defibit.io/</code>, with a JSON-wrapped binary format
for requests and responses that‚Äôs totally obscure.</p>
<p>Googling that domain leads me to Binance‚Äôs <a href="https://docs.binance.org/smart-chain/developer/rpc.html">JSON-RPC</a>
documentation, but it‚Äôs not instantly clear from this page or the linked
resources how to concretely encode and decode the binary protocol.</p>
<h2 id="filling-the-gap" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/ethereum-binance-token-real-time-value.html#filling-the-gap"><span>Filling the gap</span></a></h2>
<p>I grab a beer with my friend <a href="https://www.damiengonot.com/">Damien</a>
who‚Äôs much more knowledgable than me about cryptocurrencies, and he
instantly recognizes the <a href="https://ethereum.org/en/developers/docs/apis/json-rpc/">Ethereum JSON-RPC API</a>,
which is actually well documented and comes with a number of clients for
different languages (<a href="https://web3js.readthedocs.io/">web3.js</a> being a
popular JavaScript one). Sweet.</p>
<p>Since the Binance Smart Chain is forked off Ethereum, they share a lot
of similarities, meaning we can use web3.js to connect to the JSON-RPC
API of a Binance node. My understanding is that most nodes don‚Äôt expose
the API publicly but Binance conveniently provides a list of
<a href="https://docs.binance.org/smart-chain/developer/rpc.html">public nodes</a>
to access it.</p>
<p>With that, there‚Äôs a number of ways we can determine the value of a
token, and we‚Äôll explore two below: dividing the pool balances, and
polling the latest transactions.</p>
<h2 id="first-method-dividing-the-pool-balances" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/ethereum-binance-token-real-time-value.html#first-method-dividing-the-pool-balances"><span>First method: dividing the pool balances</span></a></h2>
<p>The token I‚Äôm interested in is exchanged with PancakeSwap, a fork of
Uniswap for the Binance Smart Chain. Uniswap and PancakeSwap allow
trading (swapping) between two tokens with smart contracts through a
<a href="https://youtu.be/cizLhxSKrAc">liquidity pool</a>.</p>
<p>The main exchange for CheCoin is <a href="https://pancakeswap.info/pool/0x194850932e48753cbeedf0af85022152148addc6">a pool</a>
that holds both CheCoin and <a href="https://www.binance.org/en/blog/what-is-wbnb/">wrapped BNB</a>,
allowing to easily trade between the two tokens.</p>
<p>Because Uniswap follows the <a href="https://decrypt.co/resources/what-is-uniswap">constant product market maker model</a>,
the value of the tokens in the pool is directly related to the reserves
of each token. This means that by dividing the reserve of wBNB in the pool
by the reserve of CheCoin, we can get the value of CheCoin in wBNB at
that point in time.</p>
<p>We can then poll the pool balance to get the value of CheCoin in real
time. Giving a USD value is then a matter of fetching the current wBNB
value in USD (which I won‚Äôt cover here but should be easier) and
applying that to the CheCoin value.</p>
<p>Now, this is great, but how to do that concretely? Let‚Äôs start by doing
it from Etherscan (for Ethereum) or BscScan (Etherscan fork for the
Binance Smart Chain) and then port that logic to web3.js.</p>
<h3 id="doing-the-operation-manually-on-bscscan" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/ethereum-binance-token-real-time-value.html#doing-the-operation-manually-on-bscscan"><span>Doing the operation manually on BscScan</span></a></h3>
<p>While the PancakeSwap UI conveniently gives us the address of the
CheCoin / wBNB pool, let‚Äôs figure it as if we only knew the address of
the CheCoin token contract: <code>0x54626300818e5c5b44db0fcf45ba4943ca89a9e2</code>.</p>
<p>By <a href="https://bscscan.com/address/0x54626300818e5c5b44db0fcf45ba4943ca89a9e2">browsing that address on BscScan</a>,
we can see that we‚Äôre in the presence of a BEP-20 token. By going in the
‚Äúcontract‚Äù tab, we get the Solidity code behind that smart contract,
as well as the contract JSON <abbr title="Application binary interface">ABI</abbr>,
which will be useful for later.</p>
<p>Then by opening ‚Äúread contract‚Äù, we can see the read-only functions
exposed by the CheCoin smart contract. The read-only functions don‚Äôt
require a gas fee, so we can query them right from the interface.
BscScan makes it especially convenient by automatically calling the
functions that don‚Äôt take any parameter and showing directly the value.</p>
<p><code>uniswapV2Pair</code> is one of those functions without arguments, that return
an address: <code>0x194850932e48753cbeedf0af85022152148addc6</code>. This is the
address of the main exchange liquidity pool for that token.</p>
<p>Following <a href="https://bscscan.com/address/0x194850932e48753cbeedf0af85022152148addc6">that address</a>
on BscScan leads us to the contract for the liquidity pool. We can see
it‚Äôs a <code>PancakePair</code> contract. In its read contract, we find a
<code>getReserves</code> function that returns 3 values: <code>_reserve0</code>, <code>_reserve1</code>
and <code>_blockTimestampLast</code>.</p>
<p>A bit further, we can read <code>token0</code> which contains the address of the
CheCoin token, and <code>token1</code> which is the address of the wBNB token.</p>
<p>With that we know that <code>_reserve0</code> is the CheCoin balance and
<code>_reserve1</code> the wBNB balance. By dividing the wBNB balance by the
CheCoin balance, we get the current CheCoin price in wBNB. At the time
of writing:</p>
<pre><code class="hljs">898088729263450811395 / 19062285402212133851022386471 = 0.000000047113381754
</code></pre>
<h3 id="a-note-about-token-decimals" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/ethereum-binance-token-real-time-value.html#a-note-about-token-decimals"><span>A note about token decimals</span></a></h3>
<p>This works here because it happens that both CheCoin and wBNB tokens use
18 decimals internally. There is <a href="https://ethereum.stackexchange.com/questions/99747/what-unit-are-the-uniswap-pancakeswap-router-functions-expecting">no guarantee</a>
that the tokens will use 18 decimals, even though it seems to be pretty
common. For example, the <a href="https://pancakeswap.info/token/0xb27adaffb9fea1801459a1a81b17218288c097cc">PooCoin</a>
token uses 8 decimals only, meaning that the above formula doesn‚Äôt give
us the proper price of PooCoin.</p>
<p>You can find the number of decimals in the <code>decimals</code> function of the
read contract of the token. For example for <a href="https://bscscan.com/address/0x54626300818e5c5b44db0fcf45ba4943ca89a9e2#readContract">CheCoin</a>,
<a href="https://bscscan.com/address/0xb27adaffb9fea1801459a1a81b17218288c097cc#readContract">PooCoin</a>
and <a href="https://bscscan.com/address/0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c#readContract">wBNB</a>.</p>
<p>If we take the current balances of the PooCoin / wBNB pool, this gives
us:</p>
<pre><code class="hljs">(4450271521514080442547 / 1e18) / (59678440268618 / 1e8) = 0.007457084168894177

</code></pre>
<p>Which is an accurate reading for the current price of PooCoin in wBNB.</p>
<h3 id="a-note-about-the-pair-address" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/ethereum-binance-token-real-time-value.html#a-note-about-the-pair-address"><span>A note about the pair address</span></a></h3>
<p>We saw earlier that the CheCoin token included a <code>uniswapV2Pair</code>
function to get the pair address, but it‚Äôs not the case of every token,
for example PooCoin doesn‚Äôt have any.</p>
<p>Instead, Uniswap provides a neat ‚Äúfactory‚Äù contract that we can call
with two tokens to retrieve the pair address. In my case, I‚Äôll look at
the PancakeSwap version, where the factory address <a href="https://docs.pancakeswap.finance/code/smart-contracts/pancakeswap-exchange/factory-v2">is documented</a>
to be <code>0xca143ce32fe78f1f7019d7d551a6402fc5350c73</code>.</p>
<p>Visiting that address on BscScan and going in the read contract, we can
call the <code>getPair</code> function, for example with the addresses of PooCoin (<code>0xb27adaffb9fea1801459a1a81b17218288c097cc</code>) and
wBNB (<code>0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c</code>). It returns
<code>0x0c5da0f07962dd0256c079248633f2b43cad6f62</code>, which is effectively
the address of the <a href="https://pancakeswap.info/pool/0x0c5da0f07962dd0256c079248633f2b43cad6f62">PooCoin / wBNB pool</a>.</p>
<p>Now we know how to calculate the price of the token we want, let‚Äôs
script this with web3.js.</p>
<h3 id="getting-the-contracts-abi" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/ethereum-binance-token-real-time-value.html#getting-the-contracts-abi"><span>Getting the contracts ABI</span></a></h3>
<p>The first important thing here is that to be able to call methods on a
smart contract, you need to know the contract <abbr title="Application binary interface">ABI</abbr>.</p>
<p>This is typically a JSON file, that BscScan shows at the bottom of the <a href="https://bscscan.com/address/0x54626300818e5c5b44db0fcf45ba4943ca89a9e2">contract tab</a>.</p>
<p>While <a href="https://ethereum.stackexchange.com/questions/26648/how-to-find-solidity-code-for-a-contract-address/26654">there is no obligation</a>
to publish the source code and ABI of a contract on the blockchain, it
seems to be <a href="https://docs.binance.org/smart-chain/developer/deploy/verify.html">common practice</a>
to publish it to Etherscan / BscScan for discoverability and
verifiability, so we can usually grab it from there.</p>
<p>In our case, we‚Äôll need the ABI for the
<a href="https://bscscan.com/address/0x54626300818e5c5b44db0fcf45ba4943ca89a9e2#code">CheCoin</a>,
<a href="https://bscscan.com/address/0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c#code">wBNB</a>,
<a href="https://bscscan.com/address/0x194850932e48753cbeedf0af85022152148addc6#code"><code>PancakePair</code></a>
and <a href="https://bscscan.com/address/0xca143ce32fe78f1f7019d7d551a6402fc5350c73#code"><code>PancakeFactory</code></a>
contracts. Copy the ABI JSON and put them respectively in
<code>checoin.json</code>, <code>wbnb.json</code> and <code>pair.json</code> and <code>factory.json</code>.</p>
<p>I you need to do that programmatically, you can check out the <a href="https://docs.bscscan.com/api-endpoints/contracts#get-contract-abi-for-verified-contract-source-codes">BscScan API</a>
or <a href="https://docs.etherscan.io/api-endpoints/contracts#get-contract-abi-for-verified-contract-source-codes">Etherscan API</a>
that feature an endpoint to fetch a given contract ABI.</p>
<h3 id="calling-the-smart-contracts" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/ethereum-binance-token-real-time-value.html#calling-the-smart-contracts"><span>Calling the smart contracts</span></a></h3>
<p>Now, we got everything we need to call the contracts with <a href="https://web3js.readthedocs.io/">web3.js</a>.</p>
<p>If you read everything I wrote until now, the code should be
self-explanatory.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> Web3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;web3&#x27;</span>)

<span class="hljs-keyword">const</span> checoinAbi = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./checoin&#x27;</span>)
<span class="hljs-keyword">const</span> wbnbAbi = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./wbnb&#x27;</span>)
<span class="hljs-keyword">const</span> pairAbi = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./pair&#x27;</span>)
<span class="hljs-keyword">const</span> factoryAbi = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./factory&#x27;</span>)

<span class="hljs-comment">// See &lt;https://docs.pancakeswap.finance/code/smart-contracts/pancakeswap-exchange/factory-v2&gt;.</span>
<span class="hljs-keyword">const</span> factoryAddress = <span class="hljs-string">&#x27;0xca143ce32fe78f1f7019d7d551a6402fc5350c73&#x27;</span>

<span class="hljs-keyword">const</span> checoinAddress = <span class="hljs-string">&#x27;0x54626300818e5c5b44db0fcf45ba4943ca89a9e2&#x27;</span>
<span class="hljs-keyword">const</span> wbnbAddress = <span class="hljs-string">&#x27;0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c&#x27;</span>

<span class="hljs-comment">// See &lt;https://docs.binance.org/smart-chain/developer/rpc.html&gt;.</span>
<span class="hljs-keyword">const</span> rpcEndpoint = <span class="hljs-string">&#x27;https://bsc-dataseed1.defibit.io&#x27;</span>

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> web3 = <span class="hljs-keyword">new</span> Web3(rpcEndpoint)

  <span class="hljs-keyword">const</span> checoinContract = <span class="hljs-keyword">new</span> web3.eth.Contract(checoinAbi, checoinAddress)
  <span class="hljs-keyword">const</span> wbnbContract = <span class="hljs-keyword">new</span> web3.eth.Contract(wbnbAbi, wbnbAddress)
  <span class="hljs-keyword">const</span> factoryContract = <span class="hljs-keyword">new</span> web3.eth.Contract(factoryAbi, factoryAddress)

  <span class="hljs-comment">// If token provides `uniswapV2Pair`.</span>
  <span class="hljs-comment">// const pairAddress = await checoinContract.methods.uniswapV2Pair().call()</span>

  <span class="hljs-comment">// Generic method.</span>
  <span class="hljs-keyword">const</span> pairAddress = <span class="hljs-keyword">await</span> factoryContract.methods.getPair(checoinAddress, wbnbAddress).call()

  <span class="hljs-keyword">const</span> pairContract = <span class="hljs-keyword">new</span> web3.eth.Contract(pairAbi, pairAddress)

  <span class="hljs-keyword">const</span> checoinDecimals = <span class="hljs-keyword">await</span> checoinContract.methods.decimals().call()
  <span class="hljs-keyword">const</span> wbnbDecimals = <span class="hljs-keyword">await</span> wbnbContract.methods.decimals().call()
  <span class="hljs-keyword">const</span> reserves = <span class="hljs-keyword">await</span> pairContract.methods.getReserves().call()

  <span class="hljs-keyword">const</span> checoin = reserves[<span class="hljs-number">0</span>] / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, checoinDecimals)
  <span class="hljs-keyword">const</span> wbnb = reserves[<span class="hljs-number">1</span>] / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, wbnbDecimals)
  <span class="hljs-keyword">const</span> timestamp = reserves[<span class="hljs-number">2</span>]

  <span class="hljs-built_in">console</span>.log(timestamp, checoin, wbnb, (wbnb / checoin).toFixed(<span class="hljs-number">18</span>), (checoin / wbnb).toFixed(<span class="hljs-number">18</span>))
}

main()
</code></pre>
<p>This displays the latest block timestamp, the current CheCoin balance,
wBNB balance, then the price of CheCoin in wBNB, and the price of wBNB
in CheCoin.</p>
<h2 id="second-method-polling-the-latest-transactions" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/ethereum-binance-token-real-time-value.html#second-method-polling-the-latest-transactions"><span>Second method: polling the latest transactions</span></a></h2>
<p>The pool balances method works well, and while the value we get matches
exactly the one displayed by PancakeSwap on the pool view, it can differ
a bit from the one we see on PooCoin, because the latter uses the price
of the last transaction as token price instead of dealing with the
balances.</p>
<p>Let‚Äôs do the same thing with our script. Because it‚Äôs <a href="https://ethereum.stackexchange.com/questions/1381/how-do-i-parse-the-transaction-receipt-log-with-web3-js">a bit of a pain in the ass</a>
to parse binary transaction logs with web3.js, we‚Äôll use
<a href="https://docs.ethers.io/">Ethers.js</a> which makes things much easier for
us on that aspect.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { ethers } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;ethers&#x27;</span>)

<span class="hljs-keyword">const</span> checoinAbi = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./checoin&#x27;</span>)
<span class="hljs-keyword">const</span> wbnbAbi = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./wbnb&#x27;</span>)
<span class="hljs-keyword">const</span> pairAbi = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./pair&#x27;</span>)
<span class="hljs-keyword">const</span> factoryAbi = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./factory&#x27;</span>)

<span class="hljs-comment">// See &lt;https://docs.pancakeswap.finance/code/smart-contracts/pancakeswap-exchange/factory-v2&gt;.</span>
<span class="hljs-keyword">const</span> factoryAddress = <span class="hljs-string">&#x27;0xca143ce32fe78f1f7019d7d551a6402fc5350c73&#x27;</span>

<span class="hljs-keyword">const</span> checoinAddress = <span class="hljs-string">&#x27;0x54626300818e5c5b44db0fcf45ba4943ca89a9e2&#x27;</span>
<span class="hljs-comment">// const checoinAddress = &#x27;0xb27adaffb9fea1801459a1a81b17218288c097cc&#x27; //poocoin</span>
<span class="hljs-keyword">const</span> wbnbAddress = <span class="hljs-string">&#x27;0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c&#x27;</span>

<span class="hljs-comment">// See &lt;https://docs.binance.org/smart-chain/developer/rpc.html&gt;.</span>
<span class="hljs-keyword">const</span> rpcEndpoint = <span class="hljs-string">&#x27;https://bsc-dataseed1.defibit.io&#x27;</span>

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> provider = <span class="hljs-keyword">new</span> ethers.providers.JsonRpcProvider(rpcEndpoint)

  <span class="hljs-keyword">const</span> checoinContract = <span class="hljs-keyword">new</span> ethers.Contract(checoinAddress, checoinAbi, provider)
  <span class="hljs-keyword">const</span> wbnbContract = <span class="hljs-keyword">new</span> ethers.Contract(wbnbAddress, wbnbAbi, provider)
  <span class="hljs-keyword">const</span> factoryContract = <span class="hljs-keyword">new</span> ethers.Contract(factoryAddress, factoryAbi, provider)

  <span class="hljs-comment">// If token provides `uniswapV2Pair`.</span>
  <span class="hljs-comment">// const pairAddress = await checoinContract.uniswapV2Pair()</span>

  <span class="hljs-comment">// Generic method.</span>
  <span class="hljs-keyword">const</span> pairAddress = <span class="hljs-keyword">await</span> factoryContract.getPair(checoinAddress, wbnbAddress)

  <span class="hljs-keyword">const</span> checoinDecimals = <span class="hljs-keyword">await</span> checoinContract.decimals()
  <span class="hljs-keyword">const</span> wbnbDecimals = <span class="hljs-keyword">await</span> wbnbContract.decimals()

  <span class="hljs-keyword">const</span> pairInterface = <span class="hljs-keyword">new</span> ethers.utils.Interface(pairAbi)

  <span class="hljs-keyword">const</span> logs = <span class="hljs-keyword">await</span> provider.getLogs({ <span class="hljs-attr">address</span>: pairAddress })

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> log <span class="hljs-keyword">of</span> logs) {
    <span class="hljs-keyword">const</span> parsed = pairInterface.parseLog(log)

    <span class="hljs-keyword">if</span> (parsed.name !== <span class="hljs-string">&#x27;Swap&#x27;</span>) {
      <span class="hljs-keyword">continue</span>
    }

    <span class="hljs-keyword">let</span> type, che, bnb

    <span class="hljs-keyword">if</span> (parsed.args.amount1Out.isZero()) {
      type = <span class="hljs-string">&#x27;buy&#x27;</span>
      bnb = parsed.args.amount1In / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, wbnbDecimals)
      che = parsed.args.amount0Out / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, checoinDecimals)
    } <span class="hljs-keyword">else</span> {
      type = <span class="hljs-string">&#x27;sell&#x27;</span>
      che = parsed.args.amount0In / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, checoinDecimals)
      bnb = parsed.args.amount1Out / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, wbnbDecimals)
    }

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${type}</span> che=<span class="hljs-subst">${che}</span> bnb=<span class="hljs-subst">${bnb}</span> tx=<span class="hljs-subst">${log.transactionHash}</span> blk=<span class="hljs-subst">${log.blockNumber}</span>`</span>)
  }
}

main()
</code></pre>
<p>Everything until defining <code>wbnbDecimals</code> is the same as the previous
example, but with Ethers.js instead of web3.js.</p>
<p>Then, Ethers.js conveniently provides us with an <code>Interface</code> class that
lets us decode binary logs from a given ABI. Very nice.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> pairInterface = <span class="hljs-keyword">new</span> ethers.utils.Interface(pairAbi)
</code></pre>
<p>We call the <code>getLogs</code> function on the <code>pairAddress</code>, getting all logs
from the latest block.</p>
<div class="note">
<p><strong>Note:</strong> for testing purpose, feel free to check the last few blocks of
the pair on Etherscan or BscScan, and request logs from an older block
so that you get some data more consistently:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> logs = <span class="hljs-keyword">await</span> provider.getLogs({ <span class="hljs-attr">address</span>: pairAddress, <span class="hljs-attr">fromBlock</span>: <span class="hljs-number">10289051</span> })
</code></pre>
</div>
<p>For each log, the interface we instantiated earlier from the ABI allows
us to parse the log. We get back an object with the transaction name
(here, we care about <code>Swap</code> transactions) as well as the transaction
arguments.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> log <span class="hljs-keyword">of</span> logs) {
  <span class="hljs-keyword">const</span> parsed = pairInterface.parseLog(log)

  <span class="hljs-keyword">if</span> (parsed.name !== <span class="hljs-string">&#x27;Swap&#x27;</span>) {
    <span class="hljs-keyword">continue</span>
  }

  <span class="hljs-built_in">console</span>.log(parsed.args)
}
</code></pre>
<p>With Uniswap / PancakeSwap, there are 4 arguments to a swap:
<code>amount0In</code>, <code>amount1In</code>, <code>amount0Out</code>, <code>amount1Out</code>, where <code>amount0</code>
are the values for <code>token0</code> of the pair, and <code>amount1</code> the values for
<code>token1</code> of the pair.</p>
<p>While it appears that a swap can sometimes take two inputs (and I have
yet to understand why), it seems somewhat reliable to check if
<code>amount1Out</code> is zero to tell if this transaction is a buy or a sell of
<code>token0</code>.</p>
<p>Then, we just need to do the decimals conversion dance like we did
before in order to display accurate values. Here I log the transaction
type (buy or sell), CheCoin amount, wBNB amount, as well as the
transaction hash and block number.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">let</span> type, che, bnb

<span class="hljs-keyword">if</span> (parsed.args.amount1Out.isZero()) {
  type = <span class="hljs-string">&#x27;buy&#x27;</span>
  bnb = parsed.args.amount1In / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, wbnbDecimals)
  che = parsed.args.amount0Out / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, checoinDecimals)
} <span class="hljs-keyword">else</span> {
  type = <span class="hljs-string">&#x27;sell&#x27;</span>
  che = parsed.args.amount0In / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, checoinDecimals)
  bnb = parsed.args.amount1Out / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, wbnbDecimals)
}

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${type}</span> che=<span class="hljs-subst">${che}</span> bnb=<span class="hljs-subst">${bnb}</span> tx=<span class="hljs-subst">${log.transactionHash}</span> blk=<span class="hljs-subst">${log.blockNumber}</span>`</span>)
</code></pre>
<h3 id="actually-polling" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/ethereum-binance-token-real-time-value.html#actually-polling"><span>Actually polling</span></a></h3>
<p>The previous script will only log the latest transaction once, then
exit. If you want to poll in real time the latest transactions and log
them to the console, it‚Äôs easily done with an infinite loop.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">let</span> fromBlock = <span class="hljs-string">&#x27;latest&#x27;</span>

<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-keyword">const</span> logs = <span class="hljs-keyword">await</span> provider.getLogs({ <span class="hljs-attr">address</span>: pairAddress, fromBlock })

  <span class="hljs-keyword">if</span> (logs.length) {
    <span class="hljs-comment">// `fromBlock` is inclusive so poll from next block.</span>
    fromBlock = logs[logs.length - <span class="hljs-number">1</span>].blockNumber + <span class="hljs-number">1</span>
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> log <span class="hljs-keyword">of</span> logs) {
    <span class="hljs-comment">// Previous code goes here.</span>
  }

  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>))
}
</code></pre>
<p>Here, we poll every second (adjust to something reasonable for the
current volume of transactions of the token you‚Äôre watching), making
sure to request the next block in the next poll to avoid duplicates
(because the <code>fromBlock</code> parameter is otherwise inclusive).</p>
<h2 id="final-word" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/ethereum-binance-token-real-time-value.html#final-word"><span>Final word</span></a></h2>
<p>While everything looked pretty complex and obscure at first sight, with
no cryptocurrency background, it turned out to be fairly simple after
understanding a couple concepts like liquidity pools and how to navigate
and invoke smart contracts.</p>
<p>As a cryptocurrency noob, this blog post if what I wish I found when I
first started looking at how to programmatically determine the live
value of a token. I hope it made things a bit easier for you. Cheers!</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1429921911509819395">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>Using your lock screen as login screen on Linux</title>
    <link href="https://www.codejam.info/2021/08/lock-screen-as-login-screen-linux.html" />
    <id>https://www.codejam.info/2021/08/lock-screen-as-login-screen-linux.html</id>
    <updated>2021-08-22T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>For a very long time I wasn‚Äôt using a <a href="https://wiki.archlinux.org/title/Display_manager">display manager</a>
(also known as login manager). I just had <a href="https://github.com/valeriangalliat/dotfiles/blob/master/zsh/zshrc.home#L6">this line</a>
in my <code>~/.zshrc</code> to automatically start a X session after logging in on
TTY1, effectively using the TTY login prompt as my login manager:</p>
<pre><code class="hljs language-sh"><span class="hljs-comment"># Start X on login on TTY1</span>
<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$DISPLAY</span>&quot;</span> ] &amp;&amp; [ <span class="hljs-string">&quot;<span class="hljs-variable">$XDG_VTNR</span>&quot;</span> -eq 1 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">exec</span> startx
<span class="hljs-keyword">fi</span>
</code></pre>
<p>The only drawback to this was that I had to type my username, which is
redundant as this is a single-user system, and more importantly, that
the X session was considered to be a TTY session by logind, because
there‚Äôs no way to upgrade a TTY session to a graphical session.</p>
<p>This affects a number of semantics, especially the way logind deals with
<a href="https://github.com/systemd/systemd/issues/14053#issuecomment-564138746">detecting idle</a>,
which is an issue if we want to use logind‚Äôs <code>IdleAction</code> for example to
suspend the system after a period of inactivity.</p>
<p>Using a display manager makes sure to register the session as graphical
and fixes that issue, but I didn‚Äôt like to introduce another graphical
interface that‚Äôs not consistent with the rest of my system, and I‚Äôd
rather not get into configuring it extensively and theming it.</p>
<h2 id="logging-in-to-a-lock-screen" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/lock-screen-as-login-screen-linux.html#logging-in-to-a-lock-screen"><span>Logging in to a lock screen?</span></a></h2>
<p>Since I‚Äôm the only user of my laptop, I don‚Äôt need a fancy interface to
select among a list of users and such, and it felt like my lock screen
would be a perfect fit as a login screen. I use i3lock which I configure
to just show a background and let me type my password to unlock the
screen.</p>
<p>While i3lock itself is not meant to be used like this, you can achieve
this with a combination of LightDM autologin feature, and starting
i3lock first thing in your <code>~/.xprofile</code>:</p>
<pre><code class="hljs language-sh"><span class="hljs-comment"># Lock screen before actually starting, to be used with autologin</span>
i3lock -n
</code></pre>
<div class="note">
<p><strong>Note:</strong> I use the <code>-n</code> (<code>--nofork</code>) option here so that i3lock blocks
the start script until it‚Äôs unlocked.</p>
</div>
<p>And the following in <code>/etc/lightdm/lightdm.conf</code> (where <code>foo</code> is your
username):</p>
<pre><code class="hljs language-conf">[Seat:*]
autologin-user=foo
</code></pre>
<p>This results in LightDM acting as a totally transparent display manager,
allowing the logind session to be considered graphical, and i3lock being
started first thing in the session, blocking until it‚Äôs unlocked to
start the actual window manager.</p>
<p>It‚Äôs so far the lightest way I‚Äôve found to start a graphical session
without it being considered a TTY by logind, while still being prompted
for my password. I hope you find this useful!</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>dmenumoji: dmenu with built-in libxft-bgra and emoji support üí™</title>
    <link href="https://www.codejam.info/2021/08/dmenu-libxft-bgra-emoji-support.html" />
    <id>https://www.codejam.info/2021/08/dmenu-libxft-bgra-emoji-support.html</id>
    <updated>2021-08-22T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<h2 id="tldr" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/dmenu-libxft-bgra-emoji-support.html#tldr"><span>TLDR</span></a></h2>
<p>To get dmenu to work with emojis, you need to compile it from source
against <a href="https://aur.archlinux.org/packages/libxft-bgra/">libxft-bgra</a> (from <a href="https://gitlab.freedesktop.org/xorg/lib/libxft/-/merge_requests/1">this PR</a>),
after removing the <code>iscol</code> check in <code>drw.c</code> that prevents colored fonts
to be used, and configuring a colored font in <code>config.h</code> or
<code>config.def.h</code> (see patches below).</p>
<p>Go check out <a href="https://github.com/valeriangalliat/dmenumoji">dmenumoji</a>
that does all that work for you!</p>
<h2 id="the-story" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/dmenu-libxft-bgra-emoji-support.html#the-story"><span>The story</span></a></h2>
<p>A couple weeks ago, during my daily procrastination routine (I like to
procrastinate in the mornings right after meditating and taking a cold
shower), I figured it would be nice to have some kind of emoji picker on
my Arch Linux rig.</p>
<p>I quickly found <a href="https://askubuntu.com/questions/1045915/how-to-insert-an-emoji-into-a-text-in-ubuntu-18-04-and-later">this thread</a>,
sadly a lot of the solutions there are specific to particular desktop
environments, and I‚Äôm not using any. Although <a href="https://github.com/tom-james-watson/Emote">Emote</a>
looks promising, and has an <a href="https://aur.archlinux.org/packages/emote">AUR package</a>,
it <a href="https://github.com/tom-james-watson/Emote/issues/44">fails to paste in terminals</a>.
Since I spend most of my time in terminals so this is not an option.</p>
<p>That‚Äôs when I find about <a href="https://github.com/fdw/rofimoji"><code>rofimoji</code></a>
which is even already packaged on Arch, and it‚Äôs definitely an awesome
piece of software, but I‚Äôm a dmenu user and I would rather keep things
consistent.</p>
<p>Since I like the idea of a dmenu-based emoji picker, I start looking
specifically for that and find <a href="https://github.com/porras/dmenu-emoji">dmenu-emoji</a>,
which despite the name, is actually meant to be used with Rofi, but also
claims to work with dmenu. But when I try it with plain dmenu, the
emojis only show up as empty squares. Not ideal.</p>
<h2 id="making-dmenu-show-emojis" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/dmenu-libxft-bgra-emoji-support.html#making-dmenu-show-emojis"><span>Making dmenu show emojis</span></a></h2>
<p>Trying to figure that issue, I stumble upon <a href="https://youtu.be/0QkByBugq_4">this video</a>
which explains that you need to compile dmenu from source against
<a href="https://aur.archlinux.org/packages/libxft-bgra/">libxft-bgra</a>, a patched version of libXft from <a href="https://gitlab.freedesktop.org/xorg/lib/libxft/-/merge_requests/1">this PR</a>
that adds support for colored (BGRA) glyphs, all of that after patching
dmenu itself to remove a workaround that they added to prevent crashes
with libXft‚Äôs lack of support for BGRA glyphs, that dropped support for
colored fonts in the first place.</p>
<p>Typically this is done on Arch by installing <a href="https://aur.archlinux.org/packages/libxft-bgra/">libxft-bgra</a> from the AUR,
and applying the following patch to the dmenu source, as explained in
the video.</p>
<pre><code class="hljs language-diff"><span class="hljs-comment">diff --git a/drw.c b/drw.c</span>
<span class="hljs-comment">index 4cdbcbe..c1c265c 100644</span>
<span class="hljs-comment">--- a/drw.c</span>
<span class="hljs-comment">+++ b/drw.c</span>
<span class="hljs-meta">@@ -133,19 +133,6 @@</span> xfont_create(Drw *drw, const char *fontname, FcPattern *fontpattern)
 		die(&quot;no font specified.&quot;);
 	}
 
<span class="hljs-deletion">-	/* Do not allow using color fonts. This is a workaround for a BadLength</span>
<span class="hljs-deletion">-	 * error from Xft with color glyphs. Modelled on the Xterm workaround. See</span>
<span class="hljs-deletion">-	 * https://bugzilla.redhat.com/show_bug.cgi?id=1498269</span>
<span class="hljs-deletion">-	 * https://lists.suckless.org/dev/1701/30932.html</span>
<span class="hljs-deletion">-	 * https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=916349</span>
<span class="hljs-deletion">-	 * and lots more all over the internet.</span>
<span class="hljs-deletion">-	 */</span>
<span class="hljs-deletion">-	FcBool iscol;</span>
<span class="hljs-deletion">-	if(FcPatternGetBool(xfont-&gt;pattern, FC_COLOR, 0, &amp;iscol) == FcResultMatch &amp;&amp; iscol) {</span>
<span class="hljs-deletion">-		XftFontClose(drw-&gt;dpy, xfont);</span>
<span class="hljs-deletion">-		return NULL;</span>
<span class="hljs-deletion">-	}</span>
<span class="hljs-deletion">-</span>
 	font = ecalloc(1, sizeof(Fnt));
 	font-&gt;xfont = xfont;
 	font-&gt;pattern = pattern;
</code></pre>
<p>I tried all of that, but still had the same issue! One important detail
that was missing from that video was that dmenu doesn‚Äôt support
<a href="https://github.com/valeriangalliat/dotfiles/blob/47506803600b0e5b194e35c56a835b54aae72f32/x11/fonts.conf">fontconfig‚Äôs fallback fonts</a>,
and you need to <a href="https://bbs.archlinux.org/viewtopic.php?id=255799">explicitly configure</a>
an emoji font in dmenu‚Äôs source, as you can see in <a href="https://github.com/LukeSmithxyz/dmenu/blob/3a6bc67fbd6df190b002d33f600a6465cad9cfb8/config.h#L8">Luke‚Äôs dmenu</a>.</p>
<pre><code class="hljs language-diff"><span class="hljs-comment">diff --git a/config.def.h b/config.def.h</span>
<span class="hljs-comment">index 1edb647..b55c45c 100644</span>
<span class="hljs-comment">--- a/config.def.h</span>
<span class="hljs-comment">+++ b/config.def.h</span>
<span class="hljs-meta">@@ -4,7 +4,8 @@</span>
 static int topbar = 1;                      /* -b  option; if 0, dmenu appears at bottom     */
 /* -fn option overrides fonts[0]; default X11 font or font set */
 static const char *fonts[] = {
<span class="hljs-deletion">-	&quot;monospace:size=10&quot;</span>
<span class="hljs-addition">+	&quot;monospace:size=10&quot;,</span>
<span class="hljs-addition">+	&quot;emoji:size=10&quot;</span>
 };
 static const char *prompt      = NULL;      /* -p  option; prompt to the left of input field */
 static const char *colors[SchemeLast][2] = {
</code></pre>
<p>After doing so, the emojis did show up! üéâ</p>
<h2 id="automating-the-build" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/dmenu-libxft-bgra-emoji-support.html#automating-the-build"><span>Automating the build</span></a></h2>
<p>This is great, but it still takes a lot of manual steps, and needs root
access to install libxft-bgra globally. I think this is unnecessary, and
I figured it would be cool to compile dmenu <em>statically</em> against the
patched libXft instead, without touching to the system.</p>
<p>This is something that can be done easily with the following patch,
assuming that the libxft-bgra source is in <code>../libxft</code> relative do the
dmenu source.</p>
<pre><code class="hljs language-diff"><span class="hljs-comment">diff --git a/config.mk b/config.mk</span>
<span class="hljs-comment">index 05d5a3e..05300a6 100644</span>
<span class="hljs-comment">--- a/config.mk</span>
<span class="hljs-comment">+++ b/config.mk</span>
<span class="hljs-meta">@@ -13,8 +13,8 @@</span> XINERAMALIBS  = -lXinerama
 XINERAMAFLAGS = -DXINERAMA
 
 # freetype
<span class="hljs-deletion">-FREETYPELIBS = -lfontconfig -lXft</span>
<span class="hljs-deletion">-FREETYPEINC = /usr/include/freetype2</span>
<span class="hljs-addition">+FREETYPELIBS = -lfontconfig -lfreetype -lXrender -lX11 -L../libxft/src/.libs -l:libXft.a</span>
<span class="hljs-addition">+FREETYPEINC = /usr/include/freetype2 -I$(PWD)/../libxft/include</span>
 # OpenBSD (uncomment)
 #FREETYPEINC = $(X11INC)/freetype2
 
</code></pre>
<p>Then libXft can be compiled with:</p>
<pre><code class="hljs language-sh">./autogen.sh
make
</code></pre>
<p>And dmenu with:</p>
<pre><code class="hljs language-sh">make
</code></pre>
<div class="note">
<p><strong>Note:</strong> libXft needs <code>xorg-util-macros</code> to be installed in order to
generate the man pages. Since I don‚Äôt really need that, I added a
further <a href="https://github.com/valeriangalliat/dmenumoji/blob/master/libxft.patch">patch</a>
that removes the check for this library, and build with <code>make SUBDIRS=src</code>
to ignore the <code>man</code> directory.</p>
</div>
<p>This leaves us with a statically linked version of dmenu against
libxft-bgra with proper support for colored glyphs. ü•≥</p>
<figure class="center">
  <img alt="dmenumoji in action" src="https://raw.githubusercontent.com/valeriangalliat/dmenumoji/master/preview.png">
  <figcaption>dmenumoji in action</figcaption>
</figure>
<p>Now, all we need is to combine all the earlier patches to a
<code>dmenu.patch</code>, and make a neat <a href="https://github.com/valeriangalliat/dmenumoji/blob/master/Makefile">makefile</a>
to do all that work for us, including cloning the dmenu and libXft
repositories, applying the BGRA patch as well as our dmenu patch, and
compiling everything.</p>
<pre><code class="hljs language-makefile"><span class="hljs-section">all: dmenu/dmenu</span>

<span class="hljs-section">dmenu/dmenu: dmenu libxft/src/.libs/libXft.a</span>
	make -C <span class="hljs-variable">$&lt;</span>

<span class="hljs-section">dmenu:</span>
	git clone --branch 5.0 https://git.suckless.org/dmenu
	patch -d <span class="hljs-variable">$@</span> &lt; dmenu.patch

<span class="hljs-section">libxft/src/.libs/libXft.a: libxft</span>
	cd <span class="hljs-variable">$&lt;</span> &amp;&amp; ./autogen.sh &amp;&amp; make SUBDIRS=src

<span class="hljs-section">libxft: libxft-bgra.patch</span>
	git clone https://gitlab.freedesktop.org/xorg/lib/libxft.git
	@<span class="hljs-comment"># Remove check for xorg-util-macros that&#x27;s only used to add `.1` at the</span>
	@<span class="hljs-comment"># end of a man page we&#x27;re not gonna use.</span>
	patch -d <span class="hljs-variable">$@</span> &lt; libxft.patch
	patch -d <span class="hljs-variable">$@</span> -p1 &lt; <span class="hljs-variable">$&lt;</span>

<span class="hljs-section">libxft-bgra.patch:</span>
	curl -o <span class="hljs-variable">$@</span> https://gitlab.freedesktop.org/xorg/lib/libxft/-/merge_requests/1.patch
</code></pre>
<p>With that, a simple <code>make</code> command gives us a fully working dmenu with
emoji support. You can find all of that (and more) in the <a href="https://github.com/valeriangalliat/dmenumoji">dmenumoji</a>
repo I created to bundle everything together!</p>
<h2 id="bonus-dynamically-linked-against-a-custom-location" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/dmenu-libxft-bgra-emoji-support.html#bonus-dynamically-linked-against-a-custom-location"><span>Bonus: dynamically linked against a custom location</span></a></h2>
<p>Out of curiosity, I wanted to see what it would take, to dynamically
link to our patched version of libXft without installing it in the
standard library path (e.g. <code>/usr/lib</code>).</p>
<p>It turns out that you can pass linker options to the compiler through
the <code>-Wl</code> option, which allows us to use <code>-rpath</code> to append our custom
libXft directory (specifically the <code>src/.libs</code> path which is where
libXft builds the shared libraries) to the runtime library search path
of the executable.</p>
<pre><code class="hljs language-diff"><span class="hljs-comment">diff --git a/config.mk b/config.mk</span>
<span class="hljs-comment">index 05d5a3e..d3b05c5 100644</span>
<span class="hljs-comment">--- a/config.mk</span>
<span class="hljs-comment">+++ b/config.mk</span>
<span class="hljs-meta">@@ -13,8 +13,8 @@</span> XINERAMALIBS  = -lXinerama
 XINERAMAFLAGS = -DXINERAMA
 
 # freetype
<span class="hljs-deletion">-FREETYPELIBS = -lfontconfig -lXft</span>
<span class="hljs-deletion">-FREETYPEINC = /usr/include/freetype2</span>
<span class="hljs-addition">+FREETYPELIBS = -lfontconfig -lXft -Wl,-rpath $(PWD)/../libxft/src/.libs</span>
<span class="hljs-addition">+FREETYPEINC = /usr/include/freetype2 -I$(PWD)/../libxft/include</span>
 # OpenBSD (uncomment)
 #FREETYPEINC = $(X11INC)/freetype2
 
</code></pre>
<p>With that, our dmenu executable will know at runtime to dynamically load
our locally built libXft that has BGRA support, as long as we don‚Äôt move
it from the nonstandard path we hardcoded there.</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1429543626640592898">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>Super fast boot on Linux with EFISTUB üöÄ</title>
    <link href="https://www.codejam.info/2021/08/super-fast-boot-linux-efistub.html" />
    <id>https://www.codejam.info/2021/08/super-fast-boot-linux-efistub.html</id>
    <updated>2021-08-10T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<p>My friend <a href="https://www.damiengonot.com/">Damien</a> was recently installing
Arch Linux on a new rig, and while doing so he mentioned to me that he
installed it without GRUB.</p>
<p>So I ask him what other bootloader he used, and he‚Äôs like, no, I didn‚Äôt
use a bootloader, just <code>efibootmgr</code>.</p>
<p>I didn‚Äôt know this was possible, so I looked into it and quickly found
about EFISTUB.</p>
<h2 id="what-is-efistub" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/super-fast-boot-linux-efistub.html#what-is-efistub"><span>What is EFISTUB</span></a></h2>
<p><a href="https://wiki.archlinux.org/title/EFISTUB">EFISTUB</a> allows ‚ÄúEFI firmware
to load the kernel as an EFI executable‚Äù. It was introduced in Linux
3.3, released in 2012. I should have known about that before. üòÖ</p>
<p>As the wiki says a bit later:</p>
<blockquote>
<p>UEFI is designed to remove the need for an intermediate bootloader
such as GRUB. If your motherboard has a good UEFI implementation, it
is possible to embed the kernel parameters within a UEFI boot entry
and for the motherboard to boot Arch directly.</p>
</blockquote>
<h2 id="configuring-efistub" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/super-fast-boot-linux-efistub.html#configuring-efistub"><span>Configuring EFISTUB</span></a></h2>
<p>With <code>efibootmgr</code>, you can add an EFI boot entry that contains all the
parameters you need to properly boot the kernel, including in my case,
LUKS encryption and hibernation.</p>
<p>Here‚Äôs the command I used:</p>
<pre><code class="hljs language-sh">efibootmgr \
    --disk /dev/sda \
    --part 1 \
    --create \
    --label Linux \
    --loader /vmlinuz-linux \
    --unicode <span class="hljs-string">&#x27;cryptdevice=/dev/sda2:luks:allow-discards root=/dev/vg0/root resume=/dev/vg0/swap rw initrd=\initramfs-linux.img&#x27;</span>
</code></pre>
<p>Here, my EFI partition is <code>/dev/sda1</code>, and <code>/dev/sda2</code> is a LUKS
encrypted partition that uses LVM to have a <code>root</code> and a <code>swap</code> volume.
The swap is used to suspend to disk (hibernate). This setup is explained
in more details <a href="https://www.codejam.info/2021/08/2019/06/arch-linux-laptop-uefi-encrypted-disk-hibernation.html#installation">in this post</a>.</p>
<p>If your motherboard has a compliant EFI implementation, that‚Äôs all you
should need to remove the need for an intermediate bootloader!</p>
<p>After rebooting, it worked flawlessly, and what stroke me was how fast
it was to boot! Definitely worth giving it a shot. Also don‚Äôt forget to
<code>pacman -Rns grub</code> if it works for you. üòõ</p>
<p><strong>Fun fact:</strong> this is so simple to do you can fit the previous command
in a tweet!</p>
<blockquote>
<p>TIL you can use Linux EFISTUB to boot without an intermediate
bootloader (here with encryption and hibernation).</p>
<pre><code class="hljs language-sh">efibootmgr -d /dev/sda -p 1 -c -l /vmlinuz-linux -u <span class="hljs-string">&#x27;cryptdevice=/dev/sda2:luks:allow-discards root=/dev/vg0/root resume=/dev/vg0/swap rw initrd=\initramfs-linux.img&#x27;</span>
</code></pre>
<p>‚Äî <a href="https://twitter.com/valeriangalliat">@valeriangalliat</a>, <a href="https://twitter.com/valeriangalliat/status/1419304289751678980">July 25, 2021</a></p>
</blockquote>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1419304289751678980">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>A journey to scripting Firefox Sync / Lockwise: complete OAuth</title>
    <link href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html" />
    <id>https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html</id>
    <updated>2021-08-08T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<div class="note">
<p>This article is part of a series about scripting Firefox Sync / Lockwise.</p>
<ol>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-existing-clients.html">A journey to scripting Firefox Sync / Lockwise: existing clients</a></li>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html">A journey to scripting Firefox Sync / Lockwise: figuring the protocol</a></li>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-understanding-browserid.html">A journey to scripting Firefox Sync / Lockwise: understanding BrowserID</a></li>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html">A journey to scripting Firefox Sync / Lockwise: hybrid OAuth</a></li>
<li>A journey to scripting Firefox Sync / Lockwise: complete OAuth</li>
</ol>
</div>
<p>OK, this grew a bit out of hand. It all started a month ago when I just
wanted to programmatically access my Firefox Lockwise passwords. This
brought me on a long journey where I got to play with <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-existing-clients.html">legacy clients from 8 years ago</a>,
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html">the Firefox Accounts and Firefox Sync APIs</a>,
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-understanding-browserid.html">the low level details of the BrowserID protocol</a>
and finally <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html">its modern counterpart OAuth</a>.</p>
<p>But as I explained <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#going-further">at the end of the last article</a>,
this approach still had room for improvement as we weren‚Äôt using the
full benefits of OAuth. In particular, we still needed access to the
<em>plaintext user password</em> in order to authenticate to Firefox Accounts,
which results in <em>a ‚Äúgod mode‚Äù session token</em> that gives <em>full,
unrestricted access</em> to the user account, including fetching their
<em>primary key material</em> which is a requirement in order to decrypt the
Firefox Sync collections.</p>
<p>This is unideal and we can do better. The good thing is that even though
it wasn‚Äôt exactly easy to figure out, it‚Äôs possible.</p>
<h2 id="logging-in-with-oauth" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#logging-in-with-oauth"><span>Logging in with OAuth</span></a></h2>
<p>The first thing we‚Äôll need to change is logging in with OAuth instead of
email/password.</p>
<p>The <a href="https://github.com/mozilla/fxa-crypto-relier/tree/master/docs">fxa-crypto-relier</a>
package is of great help for understanding how it works, but it seems to
be designed solely with browser extensions in mind, and is not directly
usable for us on the CLI. Otherwise, the <a href="https://mozilla.github.io/ecosystem-platform/docs/process/integration-with-fxa">integration with Firefox Accounts</a>
page seems to be the main documentation about implementing OAuth.</p>
<p>It notably mentions that the <a href="https://mozilla.github.io/ecosystem-platform/docs/process/integration-with-fxa#preparing-for-production">OAuth endpoints</a>
can be <a href="https://accounts.firefox.com/.well-known/openid-configuration">dynamically discovered</a>
through the standard <a href="https://openid.net/connect/">OpenID Connect protocol</a>,
meaning that our OAuth authorization endpoint will concretely be
<code>https://accounts.firefox.com/authorization</code>.</p>
<p>The <a href="https://mozilla.github.io/ecosystem-platform/docs/process/integration-with-fxa#user-authentication-with-oauth-20--openid-connect-in-a-nutshell">user authentication in a nutshell</a>
part does a great job at explaining the Firefox Accounts OAuth flow:</p>
<blockquote>
<ol>
<li>Create a state token (randomly generated and unguessable) and
associate it with a local session.</li>
<li>Send <a href="https://mozilla.github.io/ecosystem-platform/docs/process/integration-with-fxa#authorization-query-parameters"><code>/authorization</code> request</a>
to Firefox Accounts. Upon completion, Firefox Accounts redirects
back to your app with state and code.</li>
<li>Confirm the returned state token by comparing it with the state
token associated with the local session.</li>
<li>Exchange the code for an access token and possibly a refresh token.</li>
<li>If you asked for <code>scope=profile</code> you can fetch user profile
information, using the access token, from the FxA profile server.</li>
<li>Associate the profile information with the local session and create
an account in the local application database as needed.</li>
</ol>
</blockquote>
<p>Sweet and simple. Since we don‚Äôt have our own OAuth credentials
(<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#sending-emails-how-about-no">mostly because I don‚Äôt like sending emails</a>),
we‚Äôll <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#harvesting-a-client-id-from-the-android-app">keep using the client ID from the Android app</a>.</p>
<h3 id="generating-the-authorization-url" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#generating-the-authorization-url"><span>Generating the authorization URL</span></a></h3>
<p>Let‚Äôs start by building the authorization URL. The parameters we need
<a href="https://mozilla.github.io/ecosystem-platform/docs/process/integration-with-fxa#authorization-query-parameters">are listed here</a>.</p>
<blockquote>
<ol>
<li><code>client_id</code> (required).</li>
<li><code>scope</code> (required). This is a space separated string. Review the
list of <a href="https://mozilla.github.io/ecosystem-platform/docs/process/integration-with-fxa#scopes">scopes</a>.</li>
<li><code>state</code> (required). This must be a randomly generated unguessable string.</li>
<li><code>code_challenge</code> (required for PKCE). This is a hash of a randomly
generated string.</li>
<li><code>code_challenge_method</code> (required for PKCE) As of this writing only
<code>S256</code> is supported.</li>
<li><code>access_type</code> (suggested). This should be either <code>online</code> or <code>offline</code>.</li>
</ol>
</blockquote>
<p>I omitted other parameters that are not relevant to us. Let‚Äôs look in
more details at the ones we‚Äôll use.</p>
<dl>
<dt><code>scope</code></dt>
<dd>
<p>We use the scope <code>https://identity.mozilla.com/apps/oldsync</code> because
<a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/oauth/scopes.md#url-scopes">it is the one we need</a>
to access Firefox Sync data.</p>
<p>While <code>oldsync</code> here makes me feel like there must be something ‚Äúnew‚Äù
somewhere, it seems to be the latest and greatest way to access the Sync
data, so be it.</p>
</dd>
<dt><code>state</code></dt>
<dd>
<p>The <a href="https://auth0.com/docs/protocols/state-parameters">state parameter</a>
is designed to mitigate CSRF attacks. We‚Äôll mimic what
fxa-crypto-relier does and create <a href="https://github.com/mozilla/fxa-crypto-relier/blob/168f4a6c47de9021a0d9ae23a3e6757013a38dbd/src/relier/OAuthUtils.js#L77">16 bytes worth of random data</a>
and encode it <a href="https://github.com/mozilla/fxa-crypto-relier/blob/168f4a6c47de9021a0d9ae23a3e6757013a38dbd/src/relier/util.js#L32">as a Base64URL string</a>.
They also trim that final string to 16 characters but it seems that
this is mostly for code reuse purpose rather than out of actual
necessity so we‚Äôll leave that part alone.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> state = crypto.randomBytes(<span class="hljs-number">16</span>).toString(<span class="hljs-string">&#x27;base64url&#x27;</span>)
</code></pre>
</dd>
<dt><code>code_challenge</code> and <code>code_challenge_method</code></dt>
<dd>
<p>The code challenge is a standard <a href="https://auth0.com/docs/flows/authorization-code-flow-with-proof-key-for-code-exchange-pkce">PKCE</a>
challenge, and the challenge method is <code>S256</code> (the only one
supported). Those parameters are <strong>required for public clients</strong>.
While it‚Äôs not mentioned on the previous page, it‚Äôs made clear on the
<a href="https://github.com/mozilla/fxa/blob/f6bc0268a9be12407456fa42494243f336d81a38/packages/fxa-auth-server/docs/api.md#request-body-18">Firefox Accounts API documentation</a>:</p>
<blockquote>
<p>Required for public OAuth clients, who must authenticate their
authorization code use via PKCE.</p>
</blockquote>
<p>Since the Android app we took the client ID from is a public client,
we‚Äôll pass those parameters.</p>
<p>Note that even though the <code>code_challenge_method</code> is
<a href="https://mozilla.github.io/ecosystem-platform/docs/process/integration-with-fxa#authorization-query-parameters">documented</a>
with a lowercase <code>s</code>, it‚Äôs actually <a href="https://github.com/mozilla/fxa/blob/e5df5808be80f7e846e8ea973ed72bee454b027f/packages/fxa-auth-server/lib/routes/validators.js#L116">validated as uppercase</a>.
I fixed it in the quote earlier to prevent unnecessary issues.</p>
</dd>
<dt><code>access_type</code></dt>
<dd>
<p>We set it to <code>offline</code> to get back a refresh token. This step is
optional but keep it in mind if you want to be able to refresh the
token without user interaction.</p>
</dd>
</dl>
<p>This gives us the following piece of code:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>)
<span class="hljs-keyword">const</span> qs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;querystring&#x27;</span>)

<span class="hljs-keyword">const</span> authorizationUrl = <span class="hljs-string">&#x27;https://accounts.firefox.com/authorization&#x27;</span>
<span class="hljs-keyword">const</span> scope = <span class="hljs-string">&#x27;https://identity.mozilla.com/apps/oldsync&#x27;</span>
<span class="hljs-keyword">const</span> clientId = <span class="hljs-string">&#x27;...&#x27;</span>

<span class="hljs-comment">// To prevent CSRF attacks.</span>
<span class="hljs-keyword">const</span> state = crypto.randomBytes(<span class="hljs-number">16</span>).toString(<span class="hljs-string">&#x27;base64url&#x27;</span>)

<span class="hljs-comment">// Dead simple PKCE challenge implementation.</span>
<span class="hljs-keyword">const</span> codeVerifier = crypto.randomBytes(<span class="hljs-number">32</span>).toString(<span class="hljs-string">&#x27;base64url&#x27;</span>)
<span class="hljs-keyword">const</span> codeChallenge = crypto.createHash(<span class="hljs-string">&#x27;sha256&#x27;</span>).update(codeVerifier).digest(<span class="hljs-string">&#x27;base64url&#x27;</span>)

<span class="hljs-keyword">const</span> params = {
  <span class="hljs-attr">client_id</span>: clientId,
  scope,
  state,
  <span class="hljs-attr">code_challenge_method</span>: <span class="hljs-string">&#x27;S256&#x27;</span>,
  <span class="hljs-attr">code_challenge</span>: codeChallenge,
  <span class="hljs-attr">access_type</span>: <span class="hljs-string">&#x27;offline&#x27;</span>
}

<span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${authorizationUrl}</span>?<span class="hljs-subst">${qs.stringify(params)}</span>`</span>

<span class="hljs-built_in">console</span>.log(url)
</code></pre>
<p>The code verifier is <a href="https://datatracker.ietf.org/doc/html/rfc7636#section-4.1">defined by PKCE</a>
as a string of <a href="https://github.com/mozilla/fxa-crypto-relier/blob/168f4a6c47de9021a0d9ae23a3e6757013a38dbd/src/relier/OAuthUtils.js#L78">43 Base64URL charaters</a>,
which is effectively 32 bytes of entropy, hence <code>crypto.randomBytes(32)</code>.</p>
<blockquote>
<p>It is <strong>recommended</strong> that the output of a suitable random number
generator be used to create a 32-octet sequence. The octet sequence is
then Base64URL encoded to produce a 43-octet URL safe string to use as
the code verifier.</p>
</blockquote>
<p>The code challenge is also defined as a Base64URL encoded SHA-256 hash
of the code verifier, giving us a working two lines client
implementation of PKCE.</p>
<div class="note">
<p><strong>Note:</strong> I didn‚Äôt use a library like <a href="https://www.npmjs.com/package/pkce-challenge">pkce-challenge</a>
here because of a weird validation quirk in the Firefox Accounts OAuth
token endpoint that we‚Äôll use later.</p>
<p>While the <a href="https://datatracker.ietf.org/doc/html/rfc7636#section-4.1">PKCE spec</a>
defines the alphabet of the code verifier as <code>ALPHA / DIGIT / &quot;-&quot; / &quot;.&quot; / &quot;_&quot; / &quot;~&quot;</code>,
the OAuth endpoint <a href="https://github.com/mozilla/fxa/blob/e5df5808be80f7e846e8ea973ed72bee454b027f/packages/fxa-auth-server/lib/oauth/validators.js#L29">limits it to a Base64URL alphabet</a>
(ironically with a link to the RFC), leaving out the <code>.</code> and <code>~</code>
characters, and resulting in validation issues when using the
pkce-challenge library.</p>
<p>That being said this quirk is only for the <a href="https://github.com/mozilla/fxa/blob/e5df5808be80f7e846e8ea973ed72bee454b027f/packages/fxa-auth-server/lib/routes/oauth/token.js#L353"><code>https://oauth.accounts.firefox.com/v1/token</code></a>
endpoint as exposed by Mozilla through OpenID Connect, but the alternate
endpoint <a href="https://github.com/mozilla/fxa/blob/e5df5808be80f7e846e8ea973ed72bee454b027f/packages/fxa-auth-server/lib/routes/oauth/token.js#L382"><code>https://api.accounts.firefox.com/v1/oauth/token</code></a>
performs <a href="https://github.com/mozilla/fxa/blob/e5df5808be80f7e846e8ea973ed72bee454b027f/packages/fxa-auth-server/lib/routes/validators.js#L22">proper validation</a>
and otherwise seems to behave in a consistent way, so it‚Äôs possible to
use it instead.</p>
<p>For now we just implement our Base64URL compatible PKCE challenge, since
it‚Äôs also a good way to see how PKCE works for learning purpose.</p>
</div>
<p>By visiting the generated URL, the user will be prompted to sign in with
their Firefox Account, and will be redirected to the configured OAuth
redirect URL, with an authorization code in the query string.</p>
<figure class="center">
  <img alt="Sign in to Firefox Sync page" src="https://www.codejam.info/img/2021/08/sign-in-firefox-sync.png">
</figure>
<p>Since we didn‚Äôt register our own OAuth app, and we borrowed the Android
client ID instead, we‚Äôre going to be redirected to the URL that‚Äôs
configured for the Android app. This is fine for educational purpose but
we‚Äôd need to register for proper OAuth credentials for this to be usable
in production.</p>
<p>As a good security practice to not leave the code in the URL, this page
will itself redirect to another page without the code in the URL, so we
can‚Äôt just extract it from there.</p>
<p>In order to grab the code and go on with the OAuth flow, we‚Äôll intercept
the redirect in the developer tools network tab. Make sure to tick the
persist/preserve logs option before logging in, otherwise the request
including the code will be wiped during the redirect. To find it more
easily, filter only HTML documents. The one we‚Äôre looking for starts
with <code>https://lockbox.firefox.com/fxa/android-redirect.html?code=</code>.</p>
<figure class="center">
  <img alt="Network tab intercepting OAuth redirect" src="https://www.codejam.info/img/2021/08/network-tab.png">
</figure>
<p>In the headers section on the right we can copy the value of the <code>code</code>
parameter, which we can feed to our script to continue the
authentication. Brilliant.</p>
<div class="note">
<p><strong>Note:</strong> for a legitimate OAuth client where you control the redirect
URL, don‚Äôt forget to validate that the <code>state</code> parameter matches the one
you originally passed in the authorization URL!</p>
</div>
<h3 id="trading-the-oauth-code-for-an-access-token" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#trading-the-oauth-code-for-an-access-token"><span>Trading the OAuth code for an access token</span></a></h3>
<p>The next step is to trade the code we get back from the OAuth flow for a
proper token. Thanks to the <a href="https://accounts.firefox.com/.well-known/openid-configuration">OpenID Connect configuration</a>,
we know that the token endpoint is <code>https://oauth.accounts.firefox.com/v1/token</code>.
A quick search leads us to its <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/oauth/api.md#post-v1token">API documentation</a>.</p>
<p>This is where we‚Äôll send the code from the redirect URL, as well as the
PKCE code verifier we created earlier. But first we need to prompt the
user for the code. In a basic CLI, this would look something like this:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> readline = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;readline&#x27;</span>)

<span class="hljs-keyword">const</span> rl = readline.createInterface({ <span class="hljs-attr">input</span>: process.stdin, <span class="hljs-attr">output</span>: process.stdout })

<span class="hljs-keyword">const</span> code = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> rl.question(<span class="hljs-string">&#x27;Code: &#x27;</span>, resolve))
  .finally(<span class="hljs-function">() =&gt;</span> rl.close())
</code></pre>
<p>Then we can prepare the payload and send it to the token endpoint.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> fetch = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;node-fetch&#x27;</span>)

<span class="hljs-keyword">const</span> tokenEndpoint = <span class="hljs-string">&#x27;https://oauth.accounts.firefox.com/v1/token&#x27;</span>

<span class="hljs-keyword">const</span> oauthToken = <span class="hljs-keyword">await</span> fetch(tokenEndpoint, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>
  },
  <span class="hljs-attr">body</span>: <span class="hljs-built_in">JSON</span>.stringify({
    <span class="hljs-attr">client_id</span>: clientId,
    <span class="hljs-attr">grant_type</span>: <span class="hljs-string">&#x27;authorization_code&#x27;</span>,
    <span class="hljs-attr">code_verifier</span>: codeVerifier,
    code
  })
})
  .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.json())

<span class="hljs-built_in">console</span>.log(oauthToken)
</code></pre>
<p>We get back an object that includes the OAuth access token, as well as a
refresh token if we specified <code>access_type: 'offline'</code> earlier.</p>
<p>This is great, but it doesn‚Äôt actually allows us to connect to Firefox
Sync. Why? Because as we saw in the <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#unmasking-the-x-keyid-header">previous post</a>,
and specifically in <a href="https://github.com/mozilla-services/tokenserver#using-oauth">the TokenServer documentation</a>,
we need the <code>kid</code> field of some kind of encryption key that we
definitely don‚Äôt have.</p>
<blockquote>
<p>To access the user‚Äôs Sync data using OAuth, the client must obtain an
FxA OAuth <code>access_token</code> with scope <code>https://identity.mozilla.com/apps/oldsync</code>,
and the corresponding encryption key as a JWK. They send the OAuth
token in the <code>Authorization</code> header, and the <code>kid</code> field of the
encryption key in the <code>X-KeyID</code> header.</p>
</blockquote>
<p>This is not helping me a lot, but definitely just the access token we
managed to get is not enough. Previously, when we had the user‚Äôs
password and a session token for their Firefox Account, we could easily
compute the Sync key and hash it to <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#actually-computing-the-x-keyid-header">make the <code>X-KeyID</code> header</a>
with the <code>keyRotationTimestamp</code>, but with our OAuth token, we can do
none of that anymore.</p>
<h2 id="getting-scoped-keys-the-theory" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#getting-scoped-keys-the-theory"><span>Getting scoped keys: the theory</span></a></h2>
<p>By browsing the Firefox Ecosystem Platform, where I was already reading
about <a href="https://mozilla.github.io/ecosystem-platform/docs/process/integration-with-fxa">how to integrate with Firefox Accounts</a>,
I find a page about <a href="https://mozilla.github.io/ecosystem-platform/docs/process/becoming-a-sync-client">becoming a Sync client</a>.</p>
<p>Sadly, this page is not very useful at the moment.</p>
<figure class="center">
  <img alt="Becoming a Sync client ridiculous documentation" src="https://www.codejam.info/img/2021/08/becoming-a-sync-client.png">
</figure>
<p>When we first <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#unmasking-the-x-keyid-header">started playing with OAuth</a>,
we encountered <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1455219">a Bugzilla issue</a>
for the TokenServer to accept OAuth tokens. This issue contains <a href="https://docs.google.com/document/d/1IvQJFEBFz0PnL4uVlIvt8fBS_IPwSK-avK0BRIHucxQ">a link
to the OAuth flow spec on Google Docs</a>
titled ‚ÄúScoped encryption keys for Firefox Accounts‚Äù, and the first
thing in there is a note that it now <a href="https://mozilla.github.io/ecosystem-platform/docs/fxa-engineering/fxa-scoped-keys">lives on the Firefox Ecosystem Platform</a>.</p>
<p>It is nested in the ‚Äútopic deep dives‚Äù category of the ‚Äúfor FxA
engineers‚Äù group, which explains why I didn‚Äôt notice it before, and
makes me feel like I‚Äôm probably not the target audience of this
document. üòÜ</p>
<div class="note">
<p><strong>Note:</strong> this document is approximately 6000 words. That‚Äôs about as
long as one blog post in this series. Is it as useful though?
Definitely.</p>
<p><a href="https://mozilla.github.io/ecosystem-platform/docs/fxa-engineering/fxa-scoped-keys">Scoped encryption keys for Firefox Accounts</a>
is a masterpiece on end-to-end encryption, explaining in details how
they derive scoped keys for third-party apps to encrypt the user‚Äôs data,
in a way that algorithmically requires the user‚Äôs password, but without
exposing it to the app in question. All of that with support for
changing the primary password, as well as rotating and revoking keys.</p>
<p>While it‚Äôs very technical and requires some base cryptography knowledge,
it‚Äôs a fantastic piece that I would definitely recommend reading carefully
if you‚Äôre interested in this topic. Even if you‚Äôre new to cryptography,
you might end up opening dozens if not hundreds of tabs to understand
what‚Äôs going on, but it‚Äôll sure be worth the journey.</p>
</div>
<p>In this document, we notably read that Mozilla implemented <em>an extension
to OAuth</em> in order to securely share encryption keys with third-party
apps.</p>
<blockquote>
<p>To achieve this, we propose an extension to the standard OAuth
authorization flow by which relying applications can obtain encryption
keys in a secure and controlled manner.</p>
</blockquote>
<p>They describe this in the <a href="https://mozilla.github.io/ecosystem-platform/docs/fxa-engineering/fxa-scoped-keys#protocol-flow">protocol flow</a>
section, which I‚Äôll sum up here (fasten your seatbelts).</p>
<ol>
<li>Generate a <a href="https://neuromancer.sk/std/nist/P-256">P-256 elliptic curve</a>
keypair (P-256 stands for ‚Äú256-bit prime field Weierstrass curve‚Äù,
and is also known as <code>secp256r1</code> and <code>prime256v1</code>) to be used for
<a href="https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman"><abbr title="Elliptic curve Diffie‚ÄìHellman">ECDH</abbr></a>.</li>
<li>Send the public key as a Base64URL encoded <a href="https://datatracker.ietf.org/doc/html/rfc7517"><abbr title="JSON Web Key">JWK</abbr></a>
in the OAuth parameters under <code>keys_jwk</code>.</li>
</ol>
<p>This will make the token endpoint return not only the access and refresh
tokens, but also a <code>keys_jwe</code> property. It‚Äôs formatted with
<a href="https://datatracker.ietf.org/doc/html/rfc7516#section-3.1"><abbr title="JSON Web Encryption">JWE</abbr> compact serialization</a>,
meaning that we have 5 Base64URL encoded segments separated by <code>.</code>: a
JSON header, an encryption key (empty in our case), the encryption <a href="https://en.wikipedia.org/wiki/Initialization_vector"><abbr title="Initialization vector">IV</abbr></a>,
the <a href="https://en.wikipedia.org/wiki/Ciphertext">ciphertext</a>, and the
<a href="https://en.wikipedia.org/wiki/Galois/Counter_Mode">AES-GCM</a>
authentication tag.</p>
<ol start="3">
<li>Split the individual segments from <code>keys_jwe</code> and decode them.</li>
<li>Use the ephemeral public key that‚Äôs included in the JSON header as
<code>epk</code> to perform ECDH against the private key of our initial P-256
keypair.</li>
</ol>
<div class="note">
<p><strong>Note:</strong> according to Mozilla‚Äôs documentation, it seems that the key
we just established with ECDH should allow to decrypt the ciphertext
segment, which is a JWK of the application scoped key, including the
<code>kid</code> field that we need to transmit to the TokenServer. In practice we
just get unusable garbage, so something was definitely missing.</p>
<p>The following step is not documented by Mozilla. It‚Äôs what <a href="https://github.com/mozilla/application-services/blob/e16821a601f7e4cedea5af8ab24486467f3fd9bf/components/support/jwcrypto/src/ec.rs#L130">the Rust code</a>
behind the browser and mobile apps is doing, as well as <a href="https://github.com/mozilla/send/blob/7130c2e7b05e43cf1a6eb0ea534982f4dff780ea/app/fxa.js#L7">the code</a>
from the (now dead) Firefox Send app.</p>
</div>
<ol start="5">
<li>Perform <a href="https://datatracker.ietf.org/doc/html/rfc7518#section-4.6">Concat KDF</a>
(<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#deriving-the-shared-secret-with-concat-kdf">I‚Äôll come back to this later</a>)
on the previously derived key using a carefully crafted <code>OtherInfo</code>
buffer to obtain a symmetric key.</li>
<li>Use that key to decrypt the ciphertext segment with AES-256-GCM,
using the IV and authentication tag included in the payload, as well
as the raw Base64URL encoded header as <a href="https://datatracker.ietf.org/doc/html/rfc5084#section-1.5"><abbr title="Additional authenticated data">AAD</abbr></a>.</li>
</ol>
<p>The result JWK is our scoped key, and includes the <code>kid</code> field that we
need to send to the TokenServer in the <code>X-KeyID</code> header. The symmetric
key in the <code>k</code> field is the one we‚Äôll be able to use to encrypt and
decrypt the user‚Äôs data for that scope.</p>
<p><a href="https://mozilla.github.io/ecosystem-platform/docs/fxa-engineering/fxa-scoped-keys#granting-access-to-sync-data">In the case of Firefox Sync</a>,
that <code>k</code> field is a 64 bytes key bundle, that can be decoded and split
in two 32 bytes slices to obtain the Sync encryption key and HMAC key
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html#derive-sync-key">as we‚Äôve done before</a>.</p>
<p>Now that‚Äôs a lot to unpack, so let‚Äôs go through all of this again in
details, and this time with some actual code.</p>
<h2 id="getting-scoped-keys-the-code" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#getting-scoped-keys-the-code"><span>Getting scoped keys: the code</span></a></h2>
<p>Let‚Äôs go back to <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#generating-the-authorization-url">the code to make the authorization URL</a>
and include the <code>keys_jwk</code> field, that we found about earlier.</p>
<h3 id="sending-our-ecdh-public-key-in-keys-jwk" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#sending-our-ecdh-public-key-in-keys-jwk"><span>Sending our ECDH public key in <code>keys_jwk</code></span></a></h3>
<p>First, we generate a <a href="https://neuromancer.sk/std/nist/P-256">P-256 elliptic curve</a>
keypair. It stands for ‚Äú256-bit prime field Weierstrass curve‚Äù, and it‚Äôs
also known as <code>secp256r1</code> and <code>prime256v1</code>.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { promisify } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>)

<span class="hljs-keyword">const</span> kp = <span class="hljs-keyword">await</span> promisify(crypto.generateKeyPair)(<span class="hljs-string">&#x27;ec&#x27;</span>, {
  <span class="hljs-attr">namedCurve</span>: <span class="hljs-string">&#x27;P-256&#x27;</span>
})
</code></pre>
<p>Then we serialize the public key as a Base64URL encoded JWK.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> publicJwk = kp.publicKey.export({ <span class="hljs-attr">format</span>: <span class="hljs-string">&#x27;jwk&#x27;</span> })
<span class="hljs-keyword">const</span> keysJwk = Buffer.from(<span class="hljs-built_in">JSON</span>.stringify(publicJwk)).toString(<span class="hljs-string">&#x27;base64url&#x27;</span>)
</code></pre>
<p>Finally, we add it to the parameters of our initial example.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> params = {
  <span class="hljs-attr">client_id</span>: clientId,
  scope,
  state,
  <span class="hljs-attr">code_challenge_method</span>: <span class="hljs-string">&#x27;S256&#x27;</span>,
  <span class="hljs-attr">code_challenge</span>: codeChallenge,
  <span class="hljs-attr">access_type</span>: <span class="hljs-string">&#x27;offline&#x27;</span>,
  <span class="hljs-attr">keys_jwk</span>: keysJwk
}
</code></pre>
<p>Indeed, after going through the OAuth flow and inputting the result
code, we now get back an extra <code>keys_jwe</code> parameter <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#trading-the-oauth-code-for-an-access-token">from the token endpoint</a>!
I‚Äôll continue from this step where we have the result of the token
endpoint in a <code>oauthToken</code> variable.</p>
<h3 id="parsing-keys-jwe" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#parsing-keys-jwe"><span>Parsing <code>keys_jwe</code></span></a></h3>
<p>Because <code>keys_jwe</code> is formatted according to <a href="https://datatracker.ietf.org/doc/html/rfc7516#section-3.1">JWE compact serialization</a>
it‚Äôs made of 5 Base64URL encoded segments separated by a <code>.</code>, so let‚Äôs
parse it.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> rawSegments = oauthToken.keys_jwe.split(<span class="hljs-string">&#x27;.&#x27;</span>)
<span class="hljs-keyword">const</span> rawHeader = rawSegments[<span class="hljs-number">0</span>]
<span class="hljs-keyword">const</span> segments = rawSegments.map(<span class="hljs-function"><span class="hljs-params">segment</span> =&gt;</span> Buffer.from(segment, <span class="hljs-string">&#x27;base64&#x27;</span>))
<span class="hljs-keyword">const</span> header = <span class="hljs-built_in">JSON</span>.parse(segments[<span class="hljs-number">0</span>])
<span class="hljs-keyword">const</span> iv = segments[<span class="hljs-number">2</span>]
<span class="hljs-keyword">const</span> ciphertext = segments[<span class="hljs-number">3</span>]
<span class="hljs-keyword">const</span> authTag = segments[<span class="hljs-number">4</span>]
</code></pre>
<p>We left alone <code>segments[1]</code> because as we saw, it‚Äôs defined as an
encryption key by the JWE format but is not used in this protocol.</p>
<p>The parsed header looks something like this:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;enc&quot;</span>: <span class="hljs-string">&quot;A256GCM&quot;</span>,
  <span class="hljs-attr">&quot;alg&quot;</span>: <span class="hljs-string">&quot;ECDH-ES&quot;</span>,
  <span class="hljs-attr">&quot;kid&quot;</span>: <span class="hljs-string">&quot;IGJXkJzwHacMq2Qc52NZ_FBmt-uksqyXs8jC-pViIXM&quot;</span>,
  <span class="hljs-attr">&quot;epk&quot;</span>: {
    <span class="hljs-attr">&quot;kty&quot;</span>: <span class="hljs-string">&quot;EC&quot;</span>,
    <span class="hljs-attr">&quot;crv&quot;</span>: <span class="hljs-string">&quot;P-256&quot;</span>,
    <span class="hljs-attr">&quot;x&quot;</span>: <span class="hljs-string">&quot;UmI2Qm4DLbawF4E6UlmMvYAEomULFEBQiiJ7rxaQnY8&quot;</span>,
    <span class="hljs-attr">&quot;y&quot;</span>: <span class="hljs-string">&quot;cSC0O-tPAeJXl2s-2ACCxN6wCpDRnhB_ginYIBmfTgU&quot;</span>
  }
}
</code></pre>
<p>The <code>epk</code> property contains a JWK representation of the public key
matching the private key that Firefox Accounts used for its part of
ECDH. We‚Äôll refer to it as <code>peerKey</code>. In combination with the private
key from the initial P-256 keypair <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#sending-our-ecdh-public-key-in-keys-jwk">we created earlier</a>
in the <code>kp</code> variable, we can establish a shared secret through ECDH.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> peerKey = crypto.createPublicKey({
  <span class="hljs-attr">key</span>: header.epk,
  <span class="hljs-attr">format</span>: <span class="hljs-string">&#x27;jwk&#x27;</span>
})

<span class="hljs-keyword">const</span> ikm = crypto.diffieHellman({
  <span class="hljs-attr">privateKey</span>: kp.privateKey,
  <span class="hljs-attr">publicKey</span>: peerKey
})
</code></pre>
<p>We‚Äôll name this shared secret <code>ikm</code>, for input keying material, as we‚Äôre
effectively going to use it as input for a key derivation function.</p>
<h3 id="deriving-the-shared-secret-with-concat-kdf" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#deriving-the-shared-secret-with-concat-kdf"><span>Deriving the shared secret with Concat KDF</span></a></h3>
<p>Here, we use <a href="https://datatracker.ietf.org/doc/html/rfc7518#section-4.6">Concat KDF</a>,
defined in more details in section 5.8.1 of <a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-56Ar2.pdf">NIST SP 800-56A</a>
‚ÄúThe single step key derivation function‚Äù to derive that shared secret
into the actual decryption key for our ciphertext.</p>
<div class="note">
<p><strong>Note:</strong> this process is not part of any public documentation at the
time of writing, and is the result of more hours that I‚Äôm willing to
admit, going through Mozilla‚Äôs codebase on GitHub, between the
<a href="https://github.com/mozilla/"><code>mozilla</code></a>,
<a href="https://github.com/mozilla-lockwise/"><code>mozilla-lockwise</code></a>,
<a href="https://github.com/mozilla-mobile/"><code>mozilla-mobile</code></a> and
<a href="https://github.com/mozilla-services/"><code>mozilla-services</code></a> organizations.</p>
<p>I was trying to understand specifically how the Lockwise mobile app
manages to access the Firefox Sync passwords, and it took me a while to
realize that the mobile apps were calling into native Rust code that was
taking care of the heavy lifting for OAuth and encryption (especially
because the <a href="https://en.wikipedia.org/wiki/Snake_case">snake case</a>
functions <a href="https://github.com/mozilla/application-services/blob/e16821a601f7e4cedea5af8ab24486467f3fd9bf/components/fxa-client/src/internal/oauth.rs#L311">from the Rust code</a>
are converted to <a href="https://en.wikipedia.org/wiki/Camel_case">camel case</a>
in <a href="https://github.com/mozilla-lockwise/lockwise-android/blob/d3c0511f73c34e8759e1bb597f2d3dc9bcc146f0/app/src/main/java/mozilla/lockbox/store/AccountStore.kt#L298">other</a>
<a href="https://github.com/mozilla-lockwise/lockwise-ios/blob/4d68f1283558a20e240527a8235c779becb1aa08/lockbox-ios/Store/AccountStore.swift#L186">languages</a>).</p>
<p>The most interesting part was the <a href="https://github.com/mozilla/application-services/blob/e16821a601f7e4cedea5af8ab24486467f3fd9bf/components/fxa-client/src/internal/oauth.rs#L325"><code>handle_oauth_response</code></a>,
function, which calls into <a href="https://github.com/mozilla/application-services/blob/e16821a601f7e4cedea5af8ab24486467f3fd9bf/components/fxa-client/src/internal/scoped_keys.rs#L58"><code>decrypt_keys_jwe</code></a>,
<a href="https://github.com/mozilla/application-services/blob/e16821a601f7e4cedea5af8ab24486467f3fd9bf/components/support/jwcrypto/src/ec.rs#L60"><code>decrypt_jwe</code></a>,
<a href="https://github.com/mozilla/application-services/blob/e16821a601f7e4cedea5af8ab24486467f3fd9bf/components/support/jwcrypto/src/ec.rs#L94"><code>derive_shared_secret</code></a>,
and finally <a href="https://github.com/mozilla/application-services/blob/e16821a601f7e4cedea5af8ab24486467f3fd9bf/components/support/jwcrypto/src/ec.rs#L130"><code>get_secret_from_ikm</code></a>
where we get the Concat KDF implementation details.</p>
<p>I later found the <a href="https://github.com/mozilla/send/blob/7130c2e7b05e43cf1a6eb0ea534982f4dff780ea/app/fxa.js#L7">implementation in Firefox Send</a>
which was also really useful to figure this out.</p>
</div>
<p><a href="https://crypto.stackexchange.com/a/85672">This answer on Stack Exchange</a>
gives a great overview of how Concat KDF works:</p>
<blockquote>
<p>Concat KDF hashes the concatenation of a 4-byte counter initialized at 1
(big-endian), the shared secret obtained by ECDH, and some other
information passed as input. The counter is incremented and the process
is repeated until enough data was produced.</p>
</blockquote>
<p>Since in our case the output key length is equal to the hash length
(they‚Äôre both 256 bits), we only need a partial implementation of Concat
KDF that performs a single iteration and doesn‚Äôt bother trimming the
output to the desired length.</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// For readability, helper to return a big-endian unsigned 32 bits</span>
<span class="hljs-comment">// integer as a buffer.</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uint32BE</span> (<span class="hljs-params">number</span>) </span>{
  <span class="hljs-keyword">const</span> buffer = Buffer.alloc(<span class="hljs-number">4</span>)
  buffer.writeUInt32BE(number)
  <span class="hljs-keyword">return</span> buffer
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sha256</span> (<span class="hljs-params">buffer</span>) </span>{
  <span class="hljs-keyword">return</span> crypto.createHash(<span class="hljs-string">&#x27;sha256&#x27;</span>).update(buffer).digest()
}

<span class="hljs-comment">// Partial implementation of Concat KDF that only does a single</span>
<span class="hljs-comment">// iteration and no trimming, because the length of the derived key we</span>
<span class="hljs-comment">// need matches the hash length.</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">concatKdf</span> (<span class="hljs-params">key, otherInfo</span>) </span>{
  <span class="hljs-keyword">return</span> sha256(Buffer.concat([uint32BE(<span class="hljs-number">1</span>), key, otherInfo]))
}
</code></pre>
<p>That being said, for fun, here‚Äôs my understanding of a full Concat KDF
function (I‚Äôm not a cryptography expert though so get that properly
reviewed if you‚Äôre going to use it).</p>
<details>
  <summary>See the implementation</summary>
<pre><code class="hljs language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">concatKdf</span> (<span class="hljs-params">key, keyLengthBits, otherInfo</span>) </span>{
  <span class="hljs-keyword">const</span> hashLengthBits = <span class="hljs-number">256</span>
  <span class="hljs-keyword">const</span> hashLengthBytes = <span class="hljs-built_in">Math</span>.ceil(hashLengthBits / <span class="hljs-number">8</span>)
  <span class="hljs-keyword">const</span> keyLengthBytes = <span class="hljs-built_in">Math</span>.ceil(keyLengthBits / <span class="hljs-number">8</span>)
  <span class="hljs-keyword">const</span> out = Buffer.alloc(keyLengthBytes)
  <span class="hljs-keyword">const</span> iterations = <span class="hljs-built_in">Math</span>.ceil(keyLengthBytes / hashLengthBytes)

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; iterations; i++) {
    <span class="hljs-keyword">const</span> hash = sha256(Buffer.concat([uint32BE(i + <span class="hljs-number">1</span>), key, otherInfo]))
    <span class="hljs-keyword">const</span> offset = hashLengthBytes * i
    hash.copy(out, offset)
  }

  <span class="hljs-keyword">return</span> out
}
</code></pre>
</details>
<p>Anyways, we need to compute the <code>OtherInfo</code> parameter first. Concat KDF
only defines it <a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-56Ar2.pdf">as a bit string</a>
(see section 5.8.1.2), but Mozilla crafts a very specific one that we
need to reproduce. From their <a href="https://github.com/mozilla/application-services/blob/e16821a601f7e4cedea5af8ab24486467f3fd9bf/components/support/jwcrypto/src/ec.rs#L142">Rust code</a>
and the <a href="https://github.com/mozilla/send/blob/7130c2e7b05e43cf1a6eb0ea534982f4dff780ea/app/fxa.js#L7">Firefox Send JavaScript code</a>,
I ended up with:</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// Internal Mozilla format for Concat KDF `OtherInfo`, copied from</span>
<span class="hljs-comment">// Firefox Application Services and Firefox Send code.</span>
<span class="hljs-keyword">const</span> otherInfo = Buffer.concat([
  uint32BE(header.enc.length),
  Buffer.from(header.enc),
  uint32BE(<span class="hljs-number">0</span>),
  uint32BE(<span class="hljs-number">0</span>),
  uint32BE(<span class="hljs-number">256</span>)
])
</code></pre>
<details>
  <summary>See the original code for comparison</summary>
<p><a href="https://github.com/mozilla/application-services/blob/e16821a601f7e4cedea5af8ab24486467f3fd9bf/components/support/jwcrypto/src/ec.rs#L142">In Rust</a>:</p>
<pre><code class="hljs language-rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">get_secret_from_ikm</span></span>(
    ikm: InputKeyMaterial,
    apu: &amp;<span class="hljs-built_in">str</span>,
    apv: &amp;<span class="hljs-built_in">str</span>,
    alg: &amp;<span class="hljs-built_in">str</span>,
) -&gt; <span class="hljs-built_in">Result</span>&lt;digest::Digest&gt; {
    <span class="hljs-keyword">let</span> secret = ikm.derive(|z| {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> buf: <span class="hljs-built_in">Vec</span>&lt;<span class="hljs-built_in">u8</span>&gt; = <span class="hljs-built_in">vec!</span>[];

        <span class="hljs-comment">// Concat KDF (1 iteration since `keyLen &lt;= hashLen`).</span>
        <span class="hljs-comment">// See RFC 7518 section 4.6 for reference.</span>
        buf.extend_from_slice(&amp;<span class="hljs-number">1u32</span>.to_be_bytes());
        buf.extend_from_slice(&amp;z);

        <span class="hljs-comment">// `OtherInfo`</span>
        buf.extend_from_slice(&amp;(alg.len() <span class="hljs-keyword">as</span> <span class="hljs-built_in">u32</span>).to_be_bytes());
        buf.extend_from_slice(alg.as_bytes());
        buf.extend_from_slice(&amp;(apu.len() <span class="hljs-keyword">as</span> <span class="hljs-built_in">u32</span>).to_be_bytes());
        buf.extend_from_slice(apu.as_bytes());
        buf.extend_from_slice(&amp;(apv.len() <span class="hljs-keyword">as</span> <span class="hljs-built_in">u32</span>).to_be_bytes());
        buf.extend_from_slice(apv.as_bytes());
        buf.extend_from_slice(&amp;<span class="hljs-number">256u32</span>.to_be_bytes());

        digest::digest(&amp;digest::SHA256, &amp;buf)
    })?;
    <span class="hljs-literal">Ok</span>(secret)
}
</code></pre>
<p><a href="https://github.com/mozilla/send/blob/7130c2e7b05e43cf1a6eb0ea534982f4dff780ea/app/fxa.js#L7">In JavaScript</a>:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> TextEncoder()

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOtherInfo</span> (<span class="hljs-params">enc</span>) </span>{
  <span class="hljs-keyword">const</span> name = encoder.encode(enc)
  <span class="hljs-keyword">const</span> length = <span class="hljs-number">256</span>
  <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(name.length + <span class="hljs-number">16</span>)
  <span class="hljs-keyword">const</span> dv = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DataView</span>(buffer)
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(buffer)
  <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>

  dv.setUint32(i, name.length)
  i += <span class="hljs-number">4</span>
  result.set(name, i)
  i += name.length
  dv.setUint32(i, <span class="hljs-number">0</span>)
  i += <span class="hljs-number">4</span>
  dv.setUint32(i, <span class="hljs-number">0</span>)
  i += <span class="hljs-number">4</span>
  dv.setUint32(i, length)

  <span class="hljs-keyword">return</span> result
}
</code></pre>
</details>
<p>We can now derive that <code>OtherInfo</code> together with the input key material
we established earlier to get the decryption key.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> key = concatKdf(ikm, otherInfo)
</code></pre>
<h3 id="decrypting-the-ciphertext" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#decrypting-the-ciphertext"><span>Decrypting the ciphertext</span></a></h3>
<p>Finally, we have everything we need to decrypt the ciphertext of the JWE
that <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#parsing-keys-jwe">we got back earlier</a>.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> decipher = crypto.createDecipheriv(<span class="hljs-string">&#x27;aes-256-gcm&#x27;</span>, key, iv)

decipher.setAuthTag(authTag)
decipher.setAAD(rawHeader)

<span class="hljs-keyword">const</span> keys = <span class="hljs-built_in">JSON</span>.parse(Buffer.concat([
  decipher.update(ciphertext),
  decipher.final()
]))

<span class="hljs-built_in">console</span>.log(keys)
</code></pre>
<p>This gives us something like this:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;https://identity.mozilla.com/apps/oldsync&quot;</span>: {
    <span class="hljs-attr">&quot;kty&quot;</span>: <span class="hljs-string">&quot;oct&quot;</span>,
    <span class="hljs-attr">&quot;scope&quot;</span>: <span class="hljs-string">&quot;https://identity.mozilla.com/apps/oldsync&quot;</span>,
    <span class="hljs-attr">&quot;k&quot;</span>: <span class="hljs-string">&quot;e_9j35zPyTng1QT1ioegeZxPQOVUS10FdMNV1YIZuJ8zJIvQ-OZMiHiy3tLCMcc_mKTEopDpjzS9kqq-FmS4og&quot;</span>,
    <span class="hljs-attr">&quot;kid&quot;</span>: <span class="hljs-string">&quot;1628100899317-sLLG5AsHn9Fc1gPhW_rfaQ&quot;</span>
  }
}
</code></pre>
<p>If we had requested an <a href="https://mozilla.github.io/ecosystem-platform/docs/fxa-engineering/fxa-scoped-keys#application-specific-keys">application specific key</a>,
we would have gotten back a 32 bytes scoped key <a href="https://mozilla.github.io/ecosystem-platform/docs/fxa-engineering/fxa-scoped-keys#deriving-scoped-keys-ks">as defined in ‚Äúderiving scoped keys‚Äù</a>.</p>
<p>However since we requested the special scope
<code>https://identity.mozilla.com/apps/oldsync</code> which is meant to give
access to Firefox Sync in a backwards compatible way, <a href="https://mozilla.github.io/ecosystem-platform/docs/fxa-engineering/fxa-scoped-keys#granting-access-to-sync-data">it‚Äôs treated a bit differently</a>
and we get 64 bytes of key material, the same that we previously
<a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html#derive-sync-key">derived from the user‚Äôs primary key</a>
using HKDF in the <code>deriveKeys</code> function of our non-OAuth implementation.</p>
<p>The main difference is that here, the Firefox Accounts login page
<a href="https://github.com/mozilla/fxa-crypto-relier/blob/168f4a6c47de9021a0d9ae23a3e6757013a38dbd/src/deriver/ScopedKeys.js#L107">is the one</a>
to perform HKDF, so that we never get access to the user‚Äôs primary key,
which is a cool security feature.</p>
<h2 id="putting-it-all-together" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#putting-it-all-together"><span>Putting it all together</span></a></h2>
<p>Because the JWK we get back after decrypting <code>keys_jwe</code> from that custom
OAuth dance contains the same 64 bytes of key material that we used to
derive from the user‚Äôs primary key, it means that by splitting it in two
32 bytes slices, we get the exact same Sync encryption key and HMAC key
than before.</p>
<p>As importantly, this JWK also contains the <code>kid</code> field which is the
missing piece of the puzzle to be able to <a href="https://github.com/mozilla-services/tokenserver#using-oauth">call the TokenServer</a>
in order to get the Firefox Sync API credentials.</p>
<blockquote>
<p>To access the user‚Äôs Sync data using OAuth, the client must obtain an
FxA OAuth <code>access_token</code> with scope <code>https://identity.mozilla.com/apps/oldsync</code>,
and the corresponding encryption key as a JWK. They send the OAuth
token in the <code>Authorization</code> header, <strong>and the <code>kid</code> field of the
encryption key in the <code>X-KeyID</code> header</strong>.</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> tokenServerUrl = <span class="hljs-string">&#x27;https://token.services.mozilla.com&#x27;</span>

<span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">`<span class="hljs-subst">${tokenServerUrl}</span>/1.0/sync/1.5`</span>, {
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-attr">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${oauthToken.access_token}</span>`</span>,
    <span class="hljs-string">&#x27;X-KeyID&#x27;</span>: keys[scope].kid
  }
})
  .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.json())
</code></pre>
<p>From there, the rest of the code is going to be <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html#actually-calling-firefox-sync">the same as our original BrowserID implementation</a>!</p>
<p>The only difference is that we already have the Sync key bundle in our
JWK, so we don‚Äôt need the <code>deriveKeys</code> function anymore. Instead, we
only to need to split the <code>k</code> field to separate the encryption key from
the HMAC key:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> rawBundle = Buffer.from(keys[scope].k, <span class="hljs-string">&#x27;base64&#x27;</span>)

<span class="hljs-keyword">const</span> syncKeyBundle = {
  <span class="hljs-attr">encryptionKey</span>: rawBundle.slice(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>),
  <span class="hljs-attr">hmacKey</span>: rawBundle.slice(<span class="hljs-number">32</span>, <span class="hljs-number">64</span>)
}
</code></pre>
<p>This is enough to decrypt the response of <code>storage/crypto/keys</code>, which
in turn gives us the keys to decrypt the user‚Äôs passwords, bookmarks
and other collections.</p>
<h2 id="the-code-all-the-code" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#the-code-all-the-code"><span>The code, all the code!</span></a></h2>
<p>If you were to take all the small blocks of code from this post and put
them together, you would get something like this:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { promisify } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>)
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>)
<span class="hljs-keyword">const</span> qs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;querystring&#x27;</span>)
<span class="hljs-keyword">const</span> readline = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;readline&#x27;</span>)
<span class="hljs-keyword">const</span> fetch = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;node-fetch&#x27;</span>)

<span class="hljs-keyword">const</span> authorizationUrl = <span class="hljs-string">&#x27;https://accounts.firefox.com/authorization&#x27;</span>
<span class="hljs-keyword">const</span> tokenEndpoint = <span class="hljs-string">&#x27;https://oauth.accounts.firefox.com/v1/token&#x27;</span>
<span class="hljs-keyword">const</span> tokenServerUrl = <span class="hljs-string">&#x27;https://token.services.mozilla.com&#x27;</span>
<span class="hljs-keyword">const</span> scope = <span class="hljs-string">&#x27;https://identity.mozilla.com/apps/oldsync&#x27;</span>
<span class="hljs-keyword">const</span> clientId = <span class="hljs-string">&#x27;e7ce535d93522896&#x27;</span>

<span class="hljs-comment">// For readability, helper to return a big-endian unsigned 32 bits</span>
<span class="hljs-comment">// integer as a buffer.</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uint32BE</span> (<span class="hljs-params">number</span>) </span>{
  <span class="hljs-keyword">const</span> buffer = Buffer.alloc(<span class="hljs-number">4</span>)
  buffer.writeUInt32BE(number)
  <span class="hljs-keyword">return</span> buffer
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sha256</span> (<span class="hljs-params">buffer</span>) </span>{
  <span class="hljs-keyword">return</span> crypto.createHash(<span class="hljs-string">&#x27;sha256&#x27;</span>).update(buffer).digest()
}

<span class="hljs-comment">// Partial implementation of Concat KDF that only does a single</span>
<span class="hljs-comment">// iteration and no trimming, because the length of the derived key we</span>
<span class="hljs-comment">// need matches the hash length.</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">concatKdf</span> (<span class="hljs-params">key, otherInfo</span>) </span>{
  <span class="hljs-keyword">return</span> sha256(Buffer.concat([uint32BE(<span class="hljs-number">1</span>), key, otherInfo]))
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">// To prevent CSRF attacks.</span>
  <span class="hljs-keyword">const</span> state = crypto.randomBytes(<span class="hljs-number">16</span>).toString(<span class="hljs-string">&#x27;base64url&#x27;</span>)

  <span class="hljs-comment">// Dead simple PKCE challenge implementation.</span>
  <span class="hljs-keyword">const</span> codeVerifier = crypto.randomBytes(<span class="hljs-number">32</span>).toString(<span class="hljs-string">&#x27;base64url&#x27;</span>)
  <span class="hljs-keyword">const</span> codeChallenge = crypto.createHash(<span class="hljs-string">&#x27;sha256&#x27;</span>).update(codeVerifier).digest(<span class="hljs-string">&#x27;base64url&#x27;</span>)

  <span class="hljs-comment">// Keypair to obtain a shared secret from Firefox Accounts via ECDH.</span>
  <span class="hljs-keyword">const</span> kp = <span class="hljs-keyword">await</span> promisify(crypto.generateKeyPair)(<span class="hljs-string">&#x27;ec&#x27;</span>, {
    <span class="hljs-attr">namedCurve</span>: <span class="hljs-string">&#x27;P-256&#x27;</span>
  })

  <span class="hljs-keyword">const</span> publicJwk = kp.publicKey.export({ <span class="hljs-attr">format</span>: <span class="hljs-string">&#x27;jwk&#x27;</span> })
  <span class="hljs-keyword">const</span> keysJwk = Buffer.from(<span class="hljs-built_in">JSON</span>.stringify(publicJwk)).toString(<span class="hljs-string">&#x27;base64url&#x27;</span>)

  <span class="hljs-keyword">const</span> params = {
    <span class="hljs-attr">client_id</span>: clientId,
    scope,
    state,
    <span class="hljs-attr">code_challenge_method</span>: <span class="hljs-string">&#x27;S256&#x27;</span>,
    <span class="hljs-attr">code_challenge</span>: codeChallenge,
    <span class="hljs-attr">access_type</span>: <span class="hljs-string">&#x27;offline&#x27;</span>,
    <span class="hljs-attr">keys_jwk</span>: keysJwk
  }

  <span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${authorizationUrl}</span>?<span class="hljs-subst">${qs.stringify(params)}</span>`</span>

  <span class="hljs-built_in">console</span>.log(url)

  <span class="hljs-keyword">const</span> rl = readline.createInterface({ <span class="hljs-attr">input</span>: process.stdin, <span class="hljs-attr">output</span>: process.stdout })

  <span class="hljs-keyword">const</span> code = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> rl.question(<span class="hljs-string">&#x27;Code: &#x27;</span>, resolve))
    .finally(<span class="hljs-function">() =&gt;</span> rl.close())

  <span class="hljs-keyword">const</span> oauthToken = <span class="hljs-keyword">await</span> fetch(tokenEndpoint, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-built_in">JSON</span>.stringify({
      <span class="hljs-attr">client_id</span>: clientId,
      <span class="hljs-attr">grant_type</span>: <span class="hljs-string">&#x27;authorization_code&#x27;</span>,
      <span class="hljs-attr">code_verifier</span>: codeVerifier,
      code
    })
  })
    .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.json())

  <span class="hljs-keyword">const</span> rawSegments = oauthToken.keys_jwe.split(<span class="hljs-string">&#x27;.&#x27;</span>)
  <span class="hljs-keyword">const</span> rawHeader = rawSegments[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">const</span> segments = rawSegments.map(<span class="hljs-function"><span class="hljs-params">segment</span> =&gt;</span> Buffer.from(segment, <span class="hljs-string">&#x27;base64&#x27;</span>))
  <span class="hljs-keyword">const</span> header = <span class="hljs-built_in">JSON</span>.parse(segments[<span class="hljs-number">0</span>])
  <span class="hljs-keyword">const</span> iv = segments[<span class="hljs-number">2</span>]
  <span class="hljs-keyword">const</span> ciphertext = segments[<span class="hljs-number">3</span>]
  <span class="hljs-keyword">const</span> authTag = segments[<span class="hljs-number">4</span>]

  <span class="hljs-keyword">const</span> peerKey = crypto.createPublicKey({
    <span class="hljs-attr">key</span>: header.epk,
    <span class="hljs-attr">format</span>: <span class="hljs-string">&#x27;jwk&#x27;</span>
  })

  <span class="hljs-keyword">const</span> ikm = crypto.diffieHellman({
    <span class="hljs-attr">privateKey</span>: kp.privateKey,
    <span class="hljs-attr">publicKey</span>: peerKey
  })

  <span class="hljs-comment">// Internal Mozilla format for Concat KDF `OtherInfo`, copied from</span>
  <span class="hljs-comment">// Firefox Application Services and Firefox Send code.</span>
  <span class="hljs-keyword">const</span> otherInfo = Buffer.concat([
    uint32BE(header.enc.length),
    Buffer.from(header.enc),
    uint32BE(<span class="hljs-number">0</span>),
    uint32BE(<span class="hljs-number">0</span>),
    uint32BE(<span class="hljs-number">256</span>)
  ])

  <span class="hljs-keyword">const</span> key = concatKdf(ikm, otherInfo)
  <span class="hljs-keyword">const</span> decipher = crypto.createDecipheriv(<span class="hljs-string">&#x27;aes-256-gcm&#x27;</span>, key, iv)

  decipher.setAuthTag(authTag)
  decipher.setAAD(rawHeader)

  <span class="hljs-keyword">const</span> keys = <span class="hljs-built_in">JSON</span>.parse(Buffer.concat([
    decipher.update(ciphertext),
    decipher.final()
  ]))

  <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">`<span class="hljs-subst">${tokenServerUrl}</span>/1.0/sync/1.5`</span>, {
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-attr">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${oauthToken.access_token}</span>`</span>,
      <span class="hljs-string">&#x27;X-KeyID&#x27;</span>: keys[scope].kid
    }
  })
    .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.json())

  <span class="hljs-keyword">const</span> rawBundle = Buffer.from(keys[scope].k)

  <span class="hljs-keyword">const</span> syncKeyBundle = {
    <span class="hljs-attr">encryptionKey</span>: rawBundle.slice(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>),
    <span class="hljs-attr">hmacKey</span>: rawBundle.slice(<span class="hljs-number">32</span>, <span class="hljs-number">64</span>)
  }

  <span class="hljs-built_in">console</span>.log(token)
  <span class="hljs-built_in">console</span>.log(syncKeyBundle)
}

main()
</code></pre>
<p>From there, you have everything you need to <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html#actually-calling-firefox-sync">actually call Firefox Sync</a>
and decrypt its responses. This piece of code is already long enough so
I won‚Äôt include that part again here.</p>
<p>Needless to say this code is not production ready, and can be considered
to be more of an academic resource for learning purpose. If you‚Äôre going
to use it, please refactor it in a more maintainable way and add proper
error handling! Also if you need help integrating Firefox Accounts to
your app, feel free to <a href="https://www.codejam.info/val.html#contact">reach out</a>, I‚Äôm open to
contracting work.</p>
<h2 id="a-note-about-granular-scopes" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#a-note-about-granular-scopes"><span>A note about granular scopes</span></a></h2>
<p>Mozilla‚Äôs <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/oauth/scopes.md#url-scopes">OAuth scopes documentation</a>
mentions a set of scopes that would allow granular access to the Sync
data, for instance <code>https://identity.mozilla.com/apps/oldsync/bookmarks</code>
to get access to the user‚Äôs bookmarks data only but not other
collections, <code>https://identity.mozilla.com/apps/oldsync#read</code> to get
read-only access, or even
<code>https://identity.mozilla.com/apps/oldsync/history#write</code> for write-only
access to just the history collection.</p>
<p>Because the encryption key is shared by every Firefox Sync client, we
can decrypt any of the user‚Äôs Sync collections, even if we had requested
a more restricted scope.</p>
<p>The permissions are instead implemented at the API level, so that for
instance, a Sync client with a ‚Äúbookmarks‚Äù scope in its OAuth token
cannot retrieve data from the ‚Äúhistory‚Äù collection, <a href="https://mozilla.github.io/ecosystem-platform/docs/fxa-engineering/fxa-scoped-keys#granting-access-to-sync-data">as explained here</a>:</p>
<blockquote>
<p>The existing Sync service does not support using different encryption
keys to access different subsets of its data, so we must give the same
key material for scope <code>sync</code> or for <code>sync:bookmarks</code>. But we can
enforce access restrictions at the service level by ensuring that an
access token with scope <code>sync:bookmarks</code> cannot be used to retrieve
the user‚Äôs encrypted history data.</p>
</blockquote>
<p>Similarly, I assume that read/write restrictions are also ensured at
the service level, by only allowing <code>GET</code> requests for clients with a
<code>#read</code> scope, or <code>POST</code>, <code>PUT</code> and <code>DELETE</code> for <code>#write</code> clients.</p>
<p>In practice though, I couldn‚Äôt find any such restriction in <a href="https://github.com/mozilla-services/syncstorage-rs"><code>syncstorage-rs</code></a>,
the code behind the Firefox Sync API. I also found out that I couldn‚Äôt
request granular scopes during the OAuth process. When I requested a
collection-specific scope, a read-only or a write-only scope, the OAuth
token endpoint didn‚Äôt return a <code>keys_jwe</code> even though I specified
<code>keys_jwk</code> as part of the authorization parameters.</p>
<p>This makes me think that while the granular scopes are documented,
they‚Äôre not yet implemented, and the only way to get access to Firefox
Sync data right now is to request full access.</p>
<p>Please let me know if I missed something, or if this was to change!</p>
<h2 id="a-note-about-client-id-and-redirect-url" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#a-note-about-client-id-and-redirect-url"><span>A note about client ID and redirect URL</span></a></h2>
<p>In this post, for convenience and learning purpose, we used the public
OAuth client ID <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#harvesting-a-client-id-from-the-android-app">from the Android app</a>,
because we‚Äôd otherwise need to <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#sending-emails-how-about-no">email Mozilla</a>
to ‚Äúdocument our expectations and timelines‚Äù to get proper OAuth
credentials.</p>
<p>As we saw, I‚Äôm not interested in documenting my expectations and
timeline. This means that we need to inspect the network traffic during
the OAuth redirect to harvest the authorization code and inject it back
in our script. But if you‚Äôre reading this, you might be have a real-life
application that justifies getting your own OAuth credentials. If it‚Äôs
your case, everything you need to know is <a href="https://mozilla.github.io/ecosystem-platform/docs/process/integration-with-fxa">here</a>.</p>
<p>Lastly, even if I could configure my own OAuth redirect URL, the current
flow doesn‚Äôt make it convenient to build a CLI or embedded application.
Maybe accessing Firefox Sync collections from a TV, toaster, or a remote
headless server isn‚Äôt the top use cases one would think of, but I
wouldn‚Äôt be surprised if someone came up with applications for those.</p>
<p>For example, Google have an <a href="https://developers.google.com/identity/protocols/oauth2/limited-input-device">alternative flow for limited input devices</a>
which works by displaying a short URL and code to the user to grant
permissions to an embedded application from a more capable device.</p>
<p>They also support <a href="https://www.codejam.info/2021/02/google-oauth-from-cli-application.html">a copy/paste method</a>
where instead of being redirected, the user gets back a code to paste in
the application, making it convenient for a CLI running on a remote
headless server, where you otherwise would need to setup SSH port
forwarding or similar to support a loopback redirect URL.</p>
<p>While Google discourages this method, it solves a real use case for me
and I think that it‚Äôs a good inspiration for future improvements to the
Firefox Accounts OAuth flow. The limited input device method is also a
nice fallback!</p>
<h2 id="a-note-about-security-and-more" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#a-note-about-security-and-more"><span>A note about security, and more‚Ä¶</span></a></h2>
<p>I strongly believe that proper security is achieved by ensuring that the
most secure options are the easiest to implement and to use by design.
Obviously this is idealistic and not always possible.</p>
<p>In the case of Lockwise and Firefox Sync, not only the OAuth method was
far from obvious to learn about, but I think that the <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#sending-emails-how-about-no">manual process</a>
required to create new OAuth clients adds some unnecessary friction to
building a more secure web.</p>
<p>While the complete OAuth flow we explored in this posts brings great
security improvements by introducing a mechanism to grant third-party
access to the user‚Äôs data without revealing their password and primary
key, it is in practice much harder to implement than the Firefox
Accounts ‚Äúgod mode‚Äù session token that I started with, which also
happens to comes with a fully featured JS client and easy to find
real-world examples online.</p>
<p>Overall, it feels to me that Mozilla doesn‚Äôt expect people to be
interested in building third-party apps off Firefox Sync. For example
<a href="https://github.com/mozilla/fxa/issues/5794#issuecomment-652025759">in this response on GitHub</a>
they seem surprised that someone would try to authenticate to Firefox
Accounts from their own code, or <a href="https://www.mail-archive.com/sync-dev@mozilla.org/msg01711.html">in this email thread reply</a>,
Ryan is curious about why one would want to programmatically access
Firefox Sync data, and the fact the <a href="https://mozilla.github.io/ecosystem-platform/docs/fxa-engineering/fxa-scoped-keys">scoped encryption keys</a>
documentation is hidden in a ‚Äúfor FxA engineers‚Äù section shows that they
only expect Mozillians to build off those blocks.</p>
<p>It‚Äôs undeniable that the openness of Let‚Äôs Encrypt (alright, also the
fact it‚Äôs free) greatly contributed to its whopping success, and the
<a href="https://letsencrypt.org/docs/client-options/">literally hundreds</a> of
third-party clients and integrations demonstrate that. I think that the
ecosystem Mozilla built around Firefox Accounts and Firefox Sync
features some awesome pieces of technology and infrastructure that are
well worth basing off and extending, and I could see it having a similar
success if it was more inviting to integrate with.</p>
<h2 id="closing-thoughts" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#closing-thoughts"><span>Closing thoughts</span></a></h2>
<p>After nearly 20,000 words, this is the end of this in-depth exploration
of Lockwise, Firefox Sync and their underlying APIs and protocols.</p>
<p>This series is the result of the distillation of <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#documentation">FORTY TWO pieces of content online</a>
as well as learning from the code of <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#code">11 different repositories</a>.</p>
<p>While I thought that I would just quickly put together a CLI app to my
access my Lockwise passwords, my quest for perfection pushed me to
continue and spend <strong>a whole month</strong> to grasp all the details of the
protocol, and not only have functional code to read and write to Firefox
Sync, but more importantly write everything down in a comprehensive way,
that I believe is the most up-to-date, accurate and practical
documentation on the topic as of the time of writing.</p>
<p>In this last post, we saw how to leverage the full OAuth flow to access
Firefox Sync collections without ever gaining access to the user‚Äôs
password and primary key, effectively delegating more of the security
responsibilities to Firefox Accounts.</p>
<p>Generally, we gained a deep understanding of how Firefox Accounts and
Firefox Sync implement end-to-end encryption for its user data, and how
they do so in a way that‚Äôs reviewable, and that we tested by interacting
at a low level with their APIs and encryption schemes. While I‚Äôm not
qualified to tell if this is bulletproof for any possible threat model,
I definitely feel <em>even more confident</em> using Lockwise as my password
manager after reviewing its underlying implementation.</p>
<p>I‚Äôm grateful for Mozilla to share their source code and publicly document
the protocols they use and designed, even if it was not always perfectly
accurate or up-to-date. Their work allowed me to deepen my understanding
of cryptography in order to build a compatible client, and I believe
that the schemes behind Firefox Accounts and Sync encryption are
exemplary in respect to encrypting user data end-to-end, without
sacrificing too much (if any) convenience or flexibility.</p>
<h2 id="bonus-references" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#bonus-references"><span>Bonus: references</span></a></h2>
<p>Let‚Äôs use the following script to extract all the references from this
series.</p>
<pre><code class="hljs language-sh">grep -Eoh <span class="hljs-string">&#x27;[(&lt;]http[^)]+[)&gt;]&#x27;</span> 2021/08/scripting-firefox-sync-lockwise-* \
  | sed <span class="hljs-string">&#x27;s/^.//;s/.$//&#x27;</span> | sed <span class="hljs-string">&#x27;s/#.*$//&#x27;</span> \
  | sort | uniq -c
</code></pre>
<p>With some quick filtering and formatting, here‚Äôs the list!</p>
<h3 id="documentation" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#documentation"><span>Documentation</span></a></h3>
<table>
<thead>
<tr>
<th style="text-align:right">References</th>
<th>Domain</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">1</td>
<td><code>auth0.com</code></td>
<td><a href="https://auth0.com/docs/applications/confidential-and-public-applications">Confidential and public applications</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>auth0.com</code></td>
<td><a href="https://auth0.com/docs/flows/authorization-code-flow-with-proof-key-for-code-exchange-pkce">Authorization code flow with proof key for code exchange (PKCE)</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>auth0.com</code></td>
<td><a href="https://auth0.com/docs/protocols/state-parameters">Prevent attacks and redirect users with OAuth 2.0 state parameters</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>base64.guru</code></td>
<td><a href="https://base64.guru/standards/base64url">Base64URL</a></td>
</tr>
<tr>
<td style="text-align:right">3</td>
<td><code>bugzilla.mozilla.org</code></td>
<td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1455219">Accept FxA OAuth tokens for authorization in TokenServer</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>crypto.stackexchange.com</code></td>
<td><a href="https://crypto.stackexchange.com/a/85672">How does the Concat KDF work?</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>datatracker.ietf.org</code></td>
<td><a href="https://datatracker.ietf.org/doc/html/rfc5084">Using AES-CCM and AES-GCM authenticated encryption in the cryptographic message syntax (CMS)</a></td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td><code>datatracker.ietf.org</code></td>
<td><a href="https://datatracker.ietf.org/doc/html/rfc7516">JSON Web Encryption (JWE)</a></td>
</tr>
<tr>
<td style="text-align:right">3</td>
<td><code>datatracker.ietf.org</code></td>
<td><a href="https://datatracker.ietf.org/doc/html/rfc7517">JSON Web Key (JWK)</a></td>
</tr>
<tr>
<td style="text-align:right">4</td>
<td><code>datatracker.ietf.org</code></td>
<td><a href="https://datatracker.ietf.org/doc/html/rfc7518">JSON Web Algorithms (JWA)</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>datatracker.ietf.org</code></td>
<td><a href="https://datatracker.ietf.org/doc/html/rfc7636">Proof key for code exchange by OAuth public clients</a></td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td><code>docs.google.com</code></td>
<td><a href="https://docs.google.com/document/d/1IvQJFEBFz0PnL4uVlIvt8fBS_IPwSK-avK0BRIHucxQ">Scoped encryption keys for Firefox Accounts</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>en.wikipedia.org</code></td>
<td><a href="https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman">Elliptic curve Diffie‚ÄìHellman</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>github.com</code></td>
<td><a href="https://github.com/mozilla/fxa-auth-server/blob/master/fxa-oauth-server/docs/api.md">Firefox Accounts OAuth server API</a></td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td><code>github.com</code></td>
<td><a href="https://github.com/mozilla/fxa-auth-server/wiki/onepw-protocol">onepw protocol</a></td>
</tr>
<tr>
<td style="text-align:right">9</td>
<td><code>github.com</code></td>
<td><a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/api.md">Firefox Accounts authentication server API</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>github.com</code></td>
<td><a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/oauth/api.md">Firefox Accounts OAuth server API</a></td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td><code>github.com</code></td>
<td><a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/oauth/scopes.md">OAuth scopes</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>github.com</code></td>
<td><a href="https://github.com/mozilla/fxa-crypto-relier/tree/master/docs">Firefox Accounts scoped key relier documentation</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>github.com</code></td>
<td><a href="https://github.com/mozilla/fxa/issues/5794">Unable to sign in with fxa-js-client</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>github.com</code></td>
<td><a href="https://github.com/mozilla/fxa/pull/5993">Unified fxa-auth-client</a></td>
</tr>
<tr>
<td style="text-align:right">3</td>
<td><code>github.com</code></td>
<td><a href="https://github.com/mozilla/hawk/blob/main/API.md">Hawk introduction</a></td>
</tr>
<tr>
<td style="text-align:right">11</td>
<td><code>github.com</code></td>
<td><a href="https://github.com/mozilla/id-specs/blob/prod/browserid/index.md">BrowserID specification</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>hacks.mozilla.org</code></td>
<td><a href="https://hacks.mozilla.org/2011/07/introducing-browserid-easier-and-safer-authentication-on-the-web/">Introducing BrowserID ‚Äì easier and safer authentication on the web</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>medium.com</code></td>
<td><a href="https://medium.com/mozilla-tech/how-firefox-sync-keeps-your-secrets-if-tls-fails-14420d45885c">How Firefox Sync keeps your secrets if TLS fails</a></td>
</tr>
<tr>
<td style="text-align:right">8</td>
<td><code>mozilla.github.io</code></td>
<td><a href="https://mozilla.github.io/ecosystem-platform/docs/fxa-engineering/fxa-scoped-keys">Scoped encryption keys for Firefox Accounts</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>mozilla.github.io</code></td>
<td><a href="https://mozilla.github.io/ecosystem-platform/docs/process/becoming-a-sync-client">Becoming a Sync client</a></td>
</tr>
<tr>
<td style="text-align:right">9</td>
<td><code>mozilla.github.io</code></td>
<td><a href="https://mozilla.github.io/ecosystem-platform/docs/process/integration-with-fxa">Integration with FxA</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>mozilla.github.io</code></td>
<td><a href="https://mozilla.github.io/id-specs/docs/formats/keys/">BrowserID specs - public key format</a></td>
</tr>
<tr>
<td style="text-align:right">4</td>
<td><code>mozilla-services.readthedocs.io</code></td>
<td><a href="https://mozilla-services.readthedocs.io/en/latest/storage/apis-1.5.html">SyncStorage API v1.5</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>mozilla-services.readthedocs.io</code></td>
<td><a href="https://mozilla-services.readthedocs.io/en/latest/sync/index.html">Sync client documentation</a></td>
</tr>
<tr>
<td style="text-align:right">5</td>
<td><code>mozilla-services.readthedocs.io</code></td>
<td><a href="https://mozilla-services.readthedocs.io/en/latest/sync/storageformat5.html">Global storage version 5</a></td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td><code>neuromancer.sk</code></td>
<td><a href="https://neuromancer.sk/std/nist/P-256">Standard curve database - P-256</a></td>
</tr>
<tr>
<td style="text-align:right">3</td>
<td><code>nodejs.org</code></td>
<td><a href="https://nodejs.org/api/crypto.html">Node.js documentation - <code>crypto</code></a></td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td><code>nvlpubs.nist.gov</code></td>
<td><a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-56Ar2.pdf">Recommendation for pair-wise key establishment schemes using discrete logarithm cryptography</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>openid.net</code></td>
<td><a href="https://openid.net/connect/">OpenID Connect</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>stackoverflow.com</code></td>
<td><a href="https://stackoverflow.com/questions/35313330/firefox-sync-api-does-it-exist">Firefox Sync API - does it exist?</a></td>
</tr>
<tr>
<td style="text-align:right">3</td>
<td><code>vladikoff.github.io</code></td>
<td><a href="https://vladikoff.github.io/app-services-site/docs/accounts/welcome.html">About Firefox Accounts</a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>mail-archive.com</code></td>
<td><a href="https://www.mail-archive.com/sync-dev@mozilla.org/msg01710.html">Getting <code>X-KeyID</code></a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><code>mail-archive.com</code></td>
<td><a href="https://www.mail-archive.com/sync-dev@mozilla.org/msg01711.html">Re: Getting <code>X-KeyID</code></a></td>
</tr>
<tr>
<td style="text-align:right">4</td>
<td><code>npmjs.com</code></td>
<td><a href="https://www.npmjs.com/package/browserid-crypto">browserid-crypto</a></td>
</tr>
<tr>
<td style="text-align:right">3</td>
<td><code>npmjs.com</code></td>
<td><a href="https://www.npmjs.com/package/fxa-js-client">fxa-js-client</a></td>
</tr>
</tbody>
</table>
<h3 id="code" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html#code"><span>Code</span></a></h3>
<table>
<thead>
<tr>
<th style="text-align:right">References</th>
<th>Path</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">1</td>
<td><a href="https://github.com/mozilla/application-services/blob/e16821a601f7e4cedea5af8ab24486467f3fd9bf/components/fxa-client/src/internal/oauth.rs"><code>mozilla/application-services/components/fxa-client/src/internal/oauth.rs</code></a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><a href="https://github.com/mozilla/application-services/blob/e16821a601f7e4cedea5af8ab24486467f3fd9bf/components/fxa-client/src/internal/scoped_keys.rs"><code>mozilla/application-services/components/fxa-client/src/internal/scoped_keys.rs</code></a></td>
</tr>
<tr>
<td style="text-align:right">5</td>
<td><a href="https://github.com/mozilla/application-services/blob/e16821a601f7e4cedea5af8ab24486467f3fd9bf/components/support/jwcrypto/src/ec.rs"><code>mozilla/application-services/components/support/jwcrypto/src/ec.rs</code></a></td>
</tr>
<tr>
<td style="text-align:right">3</td>
<td><a href="https://github.com/mozilla/browserid-crypto/blob/69b23d9d70dfbf9bccdf5330545aebb12657c496/lib/algs/ds.js"><code>mozilla/browserid-crypto/lib/algs/ds.js</code></a></td>
</tr>
<tr>
<td style="text-align:right">3</td>
<td><a href="https://github.com/mozilla/browserid-crypto/blob/69b23d9d70dfbf9bccdf5330545aebb12657c496/lib/algs/rs.js"><code>mozilla/browserid-crypto/lib/algs/rs.js</code></a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><a href="https://github.com/mozilla/fxa/blob/6027041fe4d7accb37e0704271545a0bff80adfd/packages/fxa-auth-server/lib/routes/sign.js"><code>mozilla/fxa/packages/fxa-auth-server/lib/routes/sign.js</code></a></td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td><a href="https://github.com/mozilla/fxa/blob/96161f37753101c1a64d9588d5cdc5434243e91f/packages/fxa-js-client/client/FxAccountClient.js"><code>mozilla/fxa/packages/fxa-js-client/client/FxAccountClient.js</code></a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><a href="https://github.com/mozilla/fxa/blob/d1283314c15d81a85f08dcba5bce329db7c6fd51/packages/fxa-auth-server/lib/routes/oauth/key_data.js"><code>mozilla/fxa/packages/fxa-auth-server/lib/routes/oauth/key_data.js</code></a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><a href="https://github.com/mozilla/fxa/blob/e5df5808be80f7e846e8ea973ed72bee454b027f/packages/fxa-auth-server/lib/oauth/validators.js"><code>mozilla/fxa/packages/fxa-auth-server/lib/oauth/validators.js</code></a></td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td><a href="https://github.com/mozilla/fxa/blob/e5df5808be80f7e846e8ea973ed72bee454b027f/packages/fxa-auth-server/lib/routes/oauth/token.js"><code>mozilla/fxa/packages/fxa-auth-server/lib/routes/oauth/token.js</code></a></td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td><a href="https://github.com/mozilla/fxa/blob/e5df5808be80f7e846e8ea973ed72bee454b027f/packages/fxa-auth-server/lib/routes/validators.js"><code>mozilla/fxa/packages/fxa-auth-server/lib/routes/validators.js</code></a></td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td><a href="https://github.com/mozilla/fxa-crypto-relier/blob/168f4a6c47de9021a0d9ae23a3e6757013a38dbd/src/deriver/ScopedKeys.js"><code>mozilla/fxa-crypto-relier/src/deriver/ScopedKeys.js</code></a></td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td><a href="https://github.com/mozilla/fxa-crypto-relier/blob/168f4a6c47de9021a0d9ae23a3e6757013a38dbd/src/relier/OAuthUtils.js"><code>mozilla/fxa-crypto-relier/src/relier/OAuthUtils.js</code></a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><a href="https://github.com/mozilla/fxa-crypto-relier/blob/168f4a6c47de9021a0d9ae23a3e6757013a38dbd/src/relier/util.js"><code>mozilla/fxa-crypto-relier/src/relier/util.js</code></a></td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td><a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-auth-client"><code>mozilla/fxa/packages/fxa-auth-client</code></a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-auth-server"><code>mozilla/fxa/packages/fxa-auth-server</code></a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server"><code>mozilla/fxa/packages/fxa-content-server</code></a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><a href="https://github.com/mozilla-lockwise/lockwise-android/search?q=clientId&amp;type=code"><code>mozilla-lockwise/lockwise-android</code></a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><a href="https://github.com/mozilla/PyFxA"><code>mozilla/PyFxA</code></a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><a href="https://github.com/mozilla/PyFxA/blob/6c3f803b3c27c665f417b0c5bd3ca79add8e2027/fxa/core.py"><code>mozilla/PyFxA/fxa/core.py</code></a></td>
</tr>
<tr>
<td style="text-align:right">3</td>
<td><a href="https://github.com/mozilla/send/blob/7130c2e7b05e43cf1a6eb0ea534982f4dff780ea/app/fxa.js"><code>mozilla/send/app/fxa.js</code></a></td>
</tr>
<tr>
<td style="text-align:right">3</td>
<td><a href="https://github.com/mozilla-services/syncclient"><code>mozilla-services/syncclient</code></a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><a href="https://github.com/mozilla-services/syncclient/blob/efe0d49a8bd00d341b6e926f6783325b3fe7b676/syncclient/client.py"><code>mozilla-services/syncclient/syncclient/client.py</code></a></td>
</tr>
<tr>
<td style="text-align:right">3</td>
<td><a href="https://github.com/mozilla-services/syncstorage-rs"><code>mozilla-services/syncstorage-rs</code></a></td>
</tr>
<tr>
<td style="text-align:right">19</td>
<td><a href="https://github.com/mozilla-services/tokenserver"><code>mozilla-services/tokenserver</code></a></td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td><a href="https://github.com/mozilla-services/tokenserver/blob/39239dd7a8d6b8270e22c9b6fef3f6be147e0df4/tokenserver/views.py"><code>mozilla-services/tokenserver/tokenserver/views.py</code></a></td>
</tr>
<tr>
<td style="text-align:right">5</td>
<td><a href="https://github.com/zaach/node-fx-sync"><code>zaach/node-fx-sync</code></a></td>
</tr>
</tbody>
</table>
<div class="note">
<p>Check out the other posts in this series!</p>
<ol>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-existing-clients.html">A journey to scripting Firefox Sync / Lockwise: existing clients</a></li>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html">A journey to scripting Firefox Sync / Lockwise: figuring the protocol</a></li>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-understanding-browserid.html">A journey to scripting Firefox Sync / Lockwise: understanding BrowserID</a></li>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html">A journey to scripting Firefox Sync / Lockwise: hybrid OAuth</a></li>
<li>A journey to scripting Firefox Sync / Lockwise: complete OAuth</li>
</ol>
</div>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1424714983137583105">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
  <entry>
    <title>A journey to scripting Firefox Sync / Lockwise: hybrid OAuth</title>
    <link href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html" />
    <id>https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html</id>
    <updated>2021-08-08T04:00:00.000Z</updated>
    <content type="html"><![CDATA[<div class="note">
<p>This article is part of a series about scripting Firefox Sync / Lockwise.</p>
<ol>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-existing-clients.html">A journey to scripting Firefox Sync / Lockwise: existing clients</a></li>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html">A journey to scripting Firefox Sync / Lockwise: figuring the protocol</a></li>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-understanding-browserid.html">A journey to scripting Firefox Sync / Lockwise: understanding BrowserID</a></li>
<li>A journey to scripting Firefox Sync / Lockwise: hybrid OAuth</li>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html">A journey to scripting Firefox Sync / Lockwise: complete OAuth</a></li>
</ol>
</div>
<p>Welcome to <s>the last post</s> of this series about scripting Firefox
Sync! So far we‚Äôve managed to <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-existing-clients.html">run the Sync clients we found in the wild</a>
(dating from 8 years ago), and taking inspiration from them, plus all
the available documentation online, we <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html">built our own client</a>,
which required us to <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-understanding-browserid.html">deconstruct the BrowserID protocol</a>.</p>
<p>And while I was pretty satisfied with this, there was still one little
thing bugging me.</p>
<p>See, while I was reading everything possible online about the Firefox
Accounts, Firefox Sync and BrowserID protocols in order to make this
work, including the code of the production clients and servers involved,
I stumbled upon <a href="https://github.com/mozilla/fxa/blob/6027041fe4d7accb37e0704271545a0bff80adfd/packages/fxa-auth-server/lib/routes/sign.js#L54">this comment</a>
in the Firefox Accounts server <code>/certificate/sign</code> endpoint, that we use
to sign a BrowserID public key and get back a certificate:</p>
<blockquote>
<pre><code class="hljs language-js"><span class="hljs-comment">// This is a legacy endpoint that&#x27;s typically only used by clients</span>
<span class="hljs-comment">// connected to Sync, so assume `service=sync` for metrics logging</span>
<span class="hljs-comment">// purposes unless we&#x27;re told otherwise.</span>
</code></pre>
<blockquote>
<pre><code class="hljs language-js"><span class="hljs-comment">// This is a legacy endpoint that&#x27;s typically only used by clients</span>
<span class="hljs-comment">// connected to Sync.</span>
</code></pre>
<blockquote>
<pre><code class="hljs language-js"><span class="hljs-comment">// This is a legacy endpoint.</span>
</code></pre>
</blockquote>
</blockquote>
</blockquote>
<p>I don‚Äôt like the idea of using a legacy endpoint when writing new code.
There must be something better.</p>
<h2 id="exploring-oauth" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#exploring-oauth"><span>Exploring OAuth</span></a></h2>
<p>While the TokenServer <a href="https://github.com/mozilla-services/tokenserver#using-oauth">documents OAuth</a>
as an alternative to BrowserID to get credentials, it‚Äôs unclear how to
use it. All that page says is ‚Äúthe client must obtain an OAuth access
token and the corresponding encryption key as a JWK‚Äù, but doesn‚Äôt mention
where to get the OAuth token and the corresponding key.</p>
<p>The BrowserID instructions weren‚Äôt necessarily clearer, but at least it
had the competitive advantage of having multiple working implementations
in the wild that made it easier to understand how it works. OAuth was
a different kind of beast.</p>
<h3 id="sending-emails-how-about-no" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#sending-emails-how-about-no"><span>Sending emails? How about no</span></a></h3>
<p>The <a href="https://mozilla.github.io/ecosystem-platform/">Firefox Ecosystem Platform</a>
documents <a href="https://mozilla.github.io/ecosystem-platform/docs/process/integration-with-fxa">how to integrate with Firefox Accounts</a>
using OAuth, but the first thing we can read there is:</p>
<blockquote>
<p>Before starting integration, please send a request to
fxa-staff[at]mozilla.com to request a short meeting so we can all
document our expectations and timelines.</p>
</blockquote>
<p>Follow a bit later by:</p>
<blockquote>
<p>Register for staging OAuth credentials by filing a <a href="https://bugzilla.mozilla.org/">deployment bug</a>.</p>
</blockquote>
<p>The last thing I want to do is <em>send an email</em> to Mozilla to <em>document
my expectations</em>, and <em>file a bug</em> to get credentials. <strong>I just want to
programmatically access my Firefox Sync data!</strong></p>
<p>By looking up <code>fxa browserid oauth</code> on Google, one of the countless
searches I made to try and understand what‚Äôs going on, I found <a href="https://vladikoff.github.io/app-services-site/docs/accounts/welcome.html">this document</a>,
which states a couple more things.</p>
<blockquote>
<p>All new relying services should integrate with Firefox Accounts via
the <a href="https://github.com/mozilla/fxa-oauth-server/blob/master/docs/api.md">OAuth 2.0 API</a>.
There is also a legacy API based on the BrowserID protocol, which is
available only in some Firefox user agents and is not recommended for
new applications.</p>
</blockquote>
<p>This confirms what I had only read in a code comment on the Firefox
Accounts server so far. <strong>The BrowserID protocol is indeed deprecated</strong>,
and it‚Äôs not just <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-understanding-browserid.html">the browserid-crypto package that‚Äôs unmaintained</a>
as I initially thought.</p>
<blockquote>
<p>The OAuth 2.0 API is the preferred method of integrating with Firefox
Accounts. To delegate authentication to Firefox Accounts in this
manner, you will first need to register for OAuth relier credentials,
then add support for a HTTP redirection-based login flow to your service.</p>
<p>Firefox Accounts integration is currently recommended only for
Mozilla-hosted services. We are exploring the possibility of allowing
non-Mozilla services to delegated authentication to Firefox Accounts,
and would welcome discussion of potential use cases on the mailing
list.</p>
</blockquote>
<p>This matches the documentation I found earlier about the fact that we
need to contact Mozilla in order to register for OAuth credentials. At
that point it seems like a dead end, and I‚Äôm considering to build my
client on top of the legacy BrowserID API, since it still works after
all, and I spent so much time to understand it in depth anyways.</p>
<h3 id="circling-back" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#circling-back"><span>Circling back</span></a></h3>
<p>Going back to the <a href="https://github.com/mozilla/fxa-oauth-server/blob/master/docs/api.md">OAuth 2.0 API</a>
link from the former quote, this points to a page in an archived repo on
Github, <a href="https://github.com/mozilla/fxa-oauth-server/blob/master/docs/api.md"><code>mozilla/fxa-oauth-server/docs/api.md</code></a>,
itself saying that the page moved to <a href="https://github.com/mozilla/fxa-auth-server/blob/master/fxa-oauth-server/docs/api.md"><code>mozilla/fxa-auth-server/fxa-oauth-server/docs/api.md</code></a>,
which is also an archived repo, and with no link this time.</p>
<p>I noticed before that Mozilla archived many of its repos because they
moved to a monorepo in <a href="https://github.com/mozilla/fxa"><code>mozilla/fxa</code></a>,
which contains the latest version of <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-auth-server">fxa-auth-server</a>
and its <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/api.md">API</a>,
an API that I had already encountered multiple times since <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-existing-clients.html">the beginning</a>
of this series. Maybe there‚Äôs some hope?</p>
<p>We do have a <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/api.md#oauth">whole OAuth section</a>
in there, but I pretty much instantly hit a wall when I see that all
those endpoints require an OAuth client ID, which is part of the OAuth
credentials I‚Äôm supposed to email Mozilla in order to get.</p>
<p>It feels like I‚Äôm going in circles. üßê</p>
<h2 id="harvesting-a-client-id-from-the-android-app" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#harvesting-a-client-id-from-the-android-app"><span>Harvesting a <code>client_id</code> from the Android app</span></a></h2>
<p>While those endpoints require a client ID, it‚Äôs not necessary to provide
a client secret for public clients (see <a href="https://auth0.com/docs/applications/confidential-and-public-applications">OAuth grant types</a>).
And because the client ID of public clients is‚Ä¶ public, we should be
able to easily borrow one from any of the public clients out there (for
instance, mobile apps), whether it‚Äôs from the source code, by
decompiling the app, or by inspecting its traffic. And indeed, there is
one directly in the <a href="https://github.com/mozilla-lockwise/lockwise-android/search?q=clientId&amp;type=code"><code>lockwise-android</code></a>
repo!</p>
<p>With that client ID in hand, we can start playing with <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/api.md#oauth">the endpoints we found earlier</a>.
At first, I‚Äôm thinking that I have to do some kind of OAuth login dance,
with the usual redirect URL and code challenge, but it turns out
<a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/api.md#post-oauthtoken">it‚Äôs not a requirement if we already have a session token</a>,
which we do by logging in directly with the user‚Äôs credentials.</p>
<p>That part was not documented anywhere else, probably because it‚Äôs not
meant to be used by third-party developers like me, but more by <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server">the code</a>
behind <a href="https://accounts.firefox.com/">accounts.firefox.com</a>.</p>
<p>The <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html#sign-in-to-firefox-accounts">fxa-js-client I‚Äôm using</a>
even <a href="https://github.com/mozilla/fxa/blob/96161f37753101c1a64d9588d5cdc5434243e91f/packages/fxa-js-client/client/FxAccountClient.js#L2671">has a method for it</a>,
where I can specify a <code>scope</code> of <code>https://identity.mozilla.com/apps/oldsync</code>
<a href="https://github.com/mozilla-services/tokenserver#using-oauth">as documented</a>,
and I do get back a valid OAuth token. Sweet.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> scope = <span class="hljs-string">&#x27;https://identity.mozilla.com/apps/oldsync&#x27;</span>
<span class="hljs-keyword">const</span> oauthToken = <span class="hljs-keyword">await</span> client.createOAuthToken(creds.sessionToken, clientId, { scope })
</code></pre>
<h2 id="unmasking-the-x-keyid-header" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#unmasking-the-x-keyid-header"><span>Unmasking the <code>X-KeyID</code> header</span></a></h2>
<p>Now that‚Äôs not enough to authenticate to the TokenServer, I also <a href="https://github.com/mozilla-services/tokenserver#using-oauth">need to pass</a>
‚Äúthe <code>kid</code> field of the encryption key in the <code>X-KeyID</code> header‚Äù.</p>
<p>This is not really obvious to me because I don‚Äôt have a <code>kid</code> field in
any of the encryption keys I have been manipulating so far. I found out
later where that <code>kid</code> should otherwise come from, and let me tell you
it was a whole journey of its own. I‚Äôll develop that <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html">in the 5th post of this series</a>.
Wait, didn‚Äôt I say earlier that this one was the last post?</p>
<p>When googling <code>firefox sync &quot;x-keyid&quot;</code>, there was essentially 3 results.</p>
<ol>
<li><a href="https://github.com/mozilla-services/tokenserver">The very page I came from</a>.</li>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1455219">A Bugzilla issue</a>
by <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-understanding-browserid.html#ryan">our friend Ryan</a>
for the TokenServer to accept OAuth tokens.</li>
<li><a href="https://www.mail-archive.com/search?l=sync-dev@mozilla.org&amp;q=subject:%22%22&amp;o=newest&amp;f=1">The <code>sync-dev@mozilla.org</code> mailing list on mail-archive.com</a>,
not a specific thread but it turned out that the latest messages on the list before <a href="https://www.mail-archive.com/sync-dev@mozilla.org/msg01714.html">it gets migrated to Google Groups</a> earlier this year were <a href="https://www.mail-archive.com/sync-dev@mozilla.org/msg01710.html">about the <code>X-KeyID</code> header</a>.</li>
</ol>
<p>The second link doesn‚Äôt say anything about <code>X-KeyID</code>, and while it links
a few other resources, they don‚Äôt mention this header either (but they
turned out to be critical when I later tried to <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html">implement the full OAuth flow</a>).</p>
<p>Finally, in the mailing list thread, the <abbr title="Original poster">OP</abbr>
seems to be trying to do exactly the same thing as me, and they
apparently got a step further because they have a whole algorithm to
compute the <code>X-KeyID</code> header, involving a number of parameters I don‚Äôt
have and some key derivation logic. I‚Äôm not sure where that algorithm
comes from, but what‚Äôs clear from the mail is that it‚Äôs not working.</p>
<p><a href="https://www.mail-archive.com/sync-dev@mozilla.org/msg01711.html">Ryan delivers one more time</a>
by replying with an explanation and a link to the production code
generating the said key.</p>
<blockquote>
<p>For legacy backwards compatibility reasons, the key-derivation for
Sync is different than the derivation for general FxA scoped keys. The
simplest way to explain the differences is probably to link to the
<a href="https://github.com/mozilla/fxa-crypto-relier/blob/168f4a6c47de9021a0d9ae23a3e6757013a38dbd/src/deriver/ScopedKeys.js#L107">code we have here</a>,
which does the derivation.</p>
</blockquote>
<p>This is both a good and a bad news for me.</p>
<p>The good news is that with the algorithm from the original message of
the thread, plus the code in Ryan‚Äôs link, I should be able to generate a
working <code>X-KeyID</code> which might be all I need to make my OAuth version work!</p>
<p>The bad news is that this key deriving code I‚Äôm going to rely on is
called <code>_deriveLegacySyncKey</code>, and you know form the beginning of this
very post that I don‚Äôt like using code that‚Äôs called ‚Äúlegacy‚Äù, because
it most necessarily means that there‚Äôs a better alternative.</p>
<p>But let‚Äôs put that aside for now. This will be an adventure for another
day. For now we‚Äôre so close to getting this code work that I can‚Äôt just
move on to something else right now.</p>
<h2 id="tracking-keyrotationtimestamp" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#tracking-keyrotationtimestamp"><span>Tracking <code>keyRotationTimestamp</code></span></a></h2>
<p>I start with the Python code form the original email:</p>
<pre><code class="hljs language-python">kid = <span class="hljs-built_in">str</span>(keyRotationTimestamp) + <span class="hljs-string">&#x27;-&#x27;</span> + base64.urlsafe_b64encode(tmp[:<span class="hljs-number">16</span>]).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>).rstrip(<span class="hljs-string">&#x27;=&#x27;</span>)
</code></pre>
<p>The first thing we see is that we need <code>keyRotationTimestamp</code>, and I
happen to not have encountered anything named <code>keyRotationTimestamp</code>
yet.</p>
<p>I look it up on the <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/api.md">API documentation of Firefox Accounts</a>
which I‚Äôm already on, hoping that it‚Äôs returned by some endpoint there
but no luck.</p>
<figure class="center">
  <a href="https://www.flickr.com/photos/71204861@N07/7297048442">
    <img alt="Fuck" src="https://www.codejam.info/img/2021/08/fuck.jpg">
  </a>
</figure>
<p>What follows is a number of searches:</p>
<ul>
<li><code>keyRotationTimestamp</code></li>
<li><code>keyRotationTimestamp mozilla</code></li>
<li><code>keyRotationTimestamp site:github.com</code></li>
</ul>
<p>Followed by me searching that string directly <a href="https://github.com/search?q=keyRotationTimestamp&amp;type=code">on all of GitHub</a>
and browsing the first couple pages of results (out of 49) without luck.</p>
<p>Then I tried to <a href="https://github.com/mozilla/fxa/search?q=keyRotationTimestamp&amp;type=code">scope my search to the <code>mozilla/fxa</code> repo</a>
which had been a good source of information in the past, and bingo! The
first result is from <a href="https://github.com/mozilla/fxa/blob/d1283314c15d81a85f08dcba5bce329db7c6fd51/packages/fxa-auth-server/lib/routes/oauth/key_data.js">the <code>/account/scoped-key-data</code> endpoint of fxa-auth-server</a>
(you know, the Firefox Accounts server), which do return the
<code>keyRotationTimestamp</code>! It‚Äôs just that the documentation I checked
earlier doesn‚Äôt include the details of the payload <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/api.md#post-accountscoped-key-data">for this endpoint</a>.</p>
<p>This one too, <a href="https://github.com/mozilla/fxa/blob/96161f37753101c1a64d9588d5cdc5434243e91f/packages/fxa-js-client/client/FxAccountClient.js#L2718">has a neat matching function in fxa-js-client</a>
and I can move to the next step.</p>
<h2 id="actually-computing-the-x-keyid-header" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#actually-computing-the-x-keyid-header"><span>Actually computing the <code>X-KeyID</code> header</span></a></h2>
<p>Let‚Äôs get back one more time to the Python code from the email we‚Äôre
trying to adapt.</p>
<pre><code class="hljs language-python">kid = <span class="hljs-built_in">str</span>(keyRotationTimestamp) + <span class="hljs-string">&#x27;-&#x27;</span> + base64.urlsafe_b64encode(tmp[:<span class="hljs-number">16</span>]).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>).rstrip(<span class="hljs-string">&#x27;=&#x27;</span>)
</code></pre>
<p>Now we figured the first part, the rest is the Base64URL representation
of the first 16 bytes of <code>tmp</code>, which is the result of some key
derivation. According to the email thread, the key derivation part
isn‚Äôt working, so we‚Äôre not going to try to port it, but Base64URL
encoding the first 16 bytes of a key reminds me of something.</p>
<p>We can also see this pattern in <a href="https://github.com/mozilla/fxa-crypto-relier/blob/168f4a6c47de9021a0d9ae23a3e6757013a38dbd/src/deriver/ScopedKeys.js#L107">the code Ryan pointed to</a>
in order to address the key derivation issue:</p>
<pre><code class="hljs language-js">scopedKey.kid = options.keyRotationTimestamp + <span class="hljs-string">&#x27;-&#x27;</span> + base64url(kHash.slice(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>))
</code></pre>
<p>While it‚Äôs not immediately clear to me what <code>kHash</code> is, the
<code>base64url(kHash.slice(0, 16))</code> is again awfully familiar. It is exactly
what we used to do <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html#compute-client-state">to compute the <code>X-Client-State</code> header</a>
for the BrowserID version!</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> clientState = sha256(syncKey).slice(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>).toString(<span class="hljs-string">&#x27;hex&#x27;</span>)
</code></pre>
<p>This is especially promising since <a href="https://github.com/mozilla-services/tokenserver/blob/39239dd7a8d6b8270e22c9b6fef3f6be147e0df4/tokenserver/views.py#L247">the Python code behind the TokenServer</a>
also calls it <code>client_state</code>:</p>
<pre><code class="hljs language-python">kid = request.headers.get(<span class="hljs-string">&#x27;X-KeyID&#x27;</span>)
keys_changed_at, client_state = parse_key_id(kid)
</code></pre>
<p>So I try to combine the <code>keyRotationTimestamp</code> I just retrieved with the
hexadecimal representation of my previous <code>X-Client-State</code>, and guess
what. It works!</p>
<h2 id="i-want-to-see-the-code" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#i-want-to-see-the-code"><span>I want to see the code!</span></a></h2>
<p>The great news is that this not only makes our code use the latest and
greatest way to connect to Firefox Sync, without relying on anything
legacy or deprecated, but it also makes our implementation much simpler!</p>
<p>Here‚Äôs the updated version of the code we previously built in this
series, up to getting the Sync token from the TokenServer. <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html#actually-calling-firefox-sync">Calling the Sync API</a>
from there is not affected, so I won‚Äôt include it again here.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>)
<span class="hljs-keyword">const</span> fetch = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;node-fetch&#x27;</span>)
<span class="hljs-keyword">const</span> AuthClient = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fxa-js-client&#x27;</span>)

<span class="hljs-keyword">const</span> authServerUrl = <span class="hljs-string">&#x27;https://api.accounts.firefox.com/v1&#x27;</span>
<span class="hljs-keyword">const</span> tokenServerUrl = <span class="hljs-string">&#x27;https://token.services.mozilla.com&#x27;</span>
<span class="hljs-keyword">const</span> scope = <span class="hljs-string">&#x27;https://identity.mozilla.com/apps/oldsync&#x27;</span>
<span class="hljs-keyword">const</span> clientId = <span class="hljs-string">&#x27;...&#x27;</span>
<span class="hljs-keyword">const</span> email = <span class="hljs-string">&#x27;...&#x27;</span>
<span class="hljs-keyword">const</span> pass = <span class="hljs-string">&#x27;...&#x27;</span>

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> AuthClient(authServerUrl)

  <span class="hljs-keyword">const</span> creds = <span class="hljs-keyword">await</span> client.signIn(email, pass, {
    <span class="hljs-attr">keys</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">reason</span>: <span class="hljs-string">&#x27;login&#x27;</span>
  })

  <span class="hljs-keyword">const</span> accountKeys = <span class="hljs-keyword">await</span> client.accountKeys(creds.keyFetchToken, creds.unwrapBKey)
  <span class="hljs-keyword">const</span> oauthToken = <span class="hljs-keyword">await</span> client.createOAuthToken(creds.sessionToken, clientId, { scope })
  <span class="hljs-keyword">const</span> scopedKeyData = <span class="hljs-keyword">await</span> client.getOAuthScopedKeyData(creds.sessionToken, clientId, scope)

  <span class="hljs-keyword">const</span> syncKey = Buffer.from(accountKeys.kB, <span class="hljs-string">&#x27;hex&#x27;</span>)
  <span class="hljs-keyword">const</span> clientState = crypto.createHash(<span class="hljs-string">&#x27;sha256&#x27;</span>).update(syncKey).digest().slice(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>).toString(<span class="hljs-string">&#x27;base64url&#x27;</span>)
  <span class="hljs-keyword">const</span> keyId = <span class="hljs-string">`<span class="hljs-subst">${scopedKeyData[scope].keyRotationTimestamp}</span>-<span class="hljs-subst">${clientState}</span>`</span>

  <span class="hljs-comment">// See &lt;https://github.com/mozilla-services/tokenserver#using-oauth&gt;.</span>
  <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">`<span class="hljs-subst">${tokenServerUrl}</span>/1.0/sync/1.5`</span>, {
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-attr">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${oauthToken.access_token}</span>`</span>,
      <span class="hljs-string">&#x27;X-KeyID&#x27;</span>: keyId
    }
  })
    .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.json())
}

main()
</code></pre>
<p>Here‚Äôs the equivalent code from the previous article for comparison:</p>
<details>
  <summary>Legacy BrowserID code</summary>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { promisify } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>)
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>)
<span class="hljs-keyword">const</span> fetch = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;node-fetch&#x27;</span>)
<span class="hljs-keyword">const</span> AuthClient = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fxa-js-client&#x27;</span>)
<span class="hljs-keyword">const</span> njwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;njwt&#x27;</span>)

<span class="hljs-keyword">const</span> authServerUrl = <span class="hljs-string">&#x27;https://api.accounts.firefox.com/v1&#x27;</span>
<span class="hljs-keyword">const</span> tokenServerUrl = <span class="hljs-string">&#x27;https://token.services.mozilla.com&#x27;</span>
<span class="hljs-keyword">const</span> email = <span class="hljs-string">&#x27;...&#x27;</span>
<span class="hljs-keyword">const</span> pass = <span class="hljs-string">&#x27;...&#x27;</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">base64to10</span> (<span class="hljs-params">data</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">BigInt</span>(<span class="hljs-string">&#x27;0x&#x27;</span> + Buffer.from(data, <span class="hljs-string">&#x27;base64&#x27;</span>).toString(<span class="hljs-string">&#x27;hex&#x27;</span>)).toString(<span class="hljs-number">10</span>)
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> AuthClient(authServerUrl)

  <span class="hljs-keyword">const</span> creds = <span class="hljs-keyword">await</span> client.signIn(email, pass, {
    <span class="hljs-attr">keys</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">reason</span>: <span class="hljs-string">&#x27;login&#x27;</span>
  })

  <span class="hljs-keyword">const</span> accountKeys = <span class="hljs-keyword">await</span> client.accountKeys(creds.keyFetchToken, creds.unwrapBKey)

  <span class="hljs-keyword">const</span> kp = <span class="hljs-keyword">await</span> promisify(crypto.generateKeyPair)(<span class="hljs-string">&#x27;rsa&#x27;</span>, {
    <span class="hljs-attr">modulusLength</span>: <span class="hljs-number">2048</span>
  })

  <span class="hljs-keyword">const</span> jwk = kp.publicKey.export({ <span class="hljs-attr">format</span>: <span class="hljs-string">&#x27;jwk&#x27;</span> })

  <span class="hljs-keyword">const</span> publicKey = {
    <span class="hljs-attr">algorithm</span>: jwk.algorithm.slice(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>),
    <span class="hljs-attr">n</span>: base64to10(jwk.n),
    <span class="hljs-attr">e</span>: base64to10(jwk.e)
  }

  <span class="hljs-comment">// Time interval in milliseconds until the certificate will expire, up to a</span>
  <span class="hljs-comment">// maximum of 24 hours as documented in &lt;https://github.com/mozilla/fxa/blob/f6bc0268a9be12407456fa42494243f336d81a38/packages/fxa-auth-server/docs/api.md#request-body-32&gt;.</span>
  <span class="hljs-keyword">const</span> duration = <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span>

  <span class="hljs-keyword">const</span> { cert } = <span class="hljs-keyword">await</span> client.certificateSign(creds.sessionToken, publicKey, duration)

  <span class="hljs-comment">// Generate an &quot;identity assertion&quot; which is a JWT as documented in</span>
  <span class="hljs-comment">// &lt;https://github.com/mozilla/id-specs/blob/prod/browserid/index.md#identity-assertion&gt;.</span>
  <span class="hljs-keyword">const</span> signedObject = njwt.create({ <span class="hljs-attr">aud</span>: tokenServerUrl, <span class="hljs-attr">iss</span>: authServerUrl }, kp.privateKey, <span class="hljs-string">&#x27;RS256&#x27;</span>)
    .setClaim(<span class="hljs-string">&#x27;exp&#x27;</span>, <span class="hljs-built_in">Date</span>.now() + duration)
    .compact()

  <span class="hljs-comment">// Certs are separated by a `~` as documented in &lt;https://github.com/mozilla/id-specs/blob/prod/browserid/index.md#backed-identity-assertion&gt;.</span>
  <span class="hljs-keyword">const</span> backedAssertion = [cert, signedObject].join(<span class="hljs-string">&#x27;~&#x27;</span>)

  <span class="hljs-comment">// See &lt;https://github.com/mozilla-services/tokenserver#using-browserid&gt;.</span>
  <span class="hljs-keyword">const</span> syncKey = Buffer.from(accountKeys.kB, <span class="hljs-string">&#x27;hex&#x27;</span>)
  <span class="hljs-keyword">const</span> clientState = crypto.createHash(<span class="hljs-string">&#x27;sha256&#x27;</span>).update(syncKey).digest().slice(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>).toString(<span class="hljs-string">&#x27;hex&#x27;</span>)

  <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">`<span class="hljs-subst">${tokenServerUrl}</span>/1.0/sync/1.5`</span>, {
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-attr">Authorization</span>: <span class="hljs-string">`BrowserID <span class="hljs-subst">${backedAssertion}</span>`</span>,
      <span class="hljs-string">&#x27;X-Client-State&#x27;</span>: clientState
    }
  })
    .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.json())
}

main()
</code></pre>
</details>
<p>But while this is a solid improvement from what we had previously built
since the beginning of this series, there‚Äôs still a bit more to unwrap.</p>
<h2 id="going-further" tabindex="-1"><a class="header-anchor" href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#going-further"><span>Going further</span></a></h2>
<p>You can probably tell by now that I love digging into rabbit holes and
I‚Äôm eternally unsatisfied.</p>
<p>While I thought that I had found the last piece of the puzzle with the
OAuth method described in this post, in order to integrate with Firefox Sync as
cleanly as possible, it occurred to me that <em>something was off</em> as I was
trying to explain it.</p>
<p>One of the main benefits of OAuth is to be able to grant <em>granular
permissions</em> to a third-party service, without giving them <em>knowledge of
your password</em>.</p>
<p>Yet with the solution from this post, not only do we still need to have
knowledge of the user‚Äôs password in order to login with the
email/password scheme and derive the Sync encryption keys, but this
method also grants us a Firefox Accounts session token which allows us
to do <em>virtually anything</em> to that user account through the API. <strong>This
defeats both advantages of OAuth mentioned above; permissions are not
granular and we have access to the plaintext password.</strong></p>
<div class="float-wrapper">
  <figure class="left">
    <img alt="God mode quote context" src="https://www.codejam.info/img/2021/08/god-mode.png">
  </figure>
  <div class="float-inner">
<p>This authentication scheme is even referred by Ryan as ‚Äúgod mode‚Äù in <a href="https://docs.google.com/document/d/1IvQJFEBFz0PnL4uVlIvt8fBS_IPwSK-avK0BRIHucxQ/edit?disco=AAAABgay7bs">a comment</a>
on <a href="https://docs.google.com/document/d/1IvQJFEBFz0PnL4uVlIvt8fBS_IPwSK-avK0BRIHucxQ">the OAuth flow spec on Google Docs</a>
(that I encountered <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-hybrid-oauth.html#unmasking-the-x-keyid-header">earlier</a> through <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1455219">a Bugzilla issue</a>).</p>
<blockquote>
<p>Imagine a third-party browser that does its own Sync implementation,
being able to authenticate to our Sync service using standard
OAuth-style flow rather than the ‚Äúgod mode‚Äù integration that [they]
currently do, where they basically prompt for full access to your
account.</p>
</blockquote>
<p>This is a concern that‚Äôs also addressed in the introduction of the
document:</p>
<blockquote>
<p>Key material can only be accessed through a bespoke authorization
protocol that is [‚Ä¶] <strong>far too powerful</strong>. The protocol gives the
application complete control of the user‚Äôs Firefox Account, and hands
it a copy of their master key material. There is currently no
provision for scoping access down to a subset of data or capabilities.</p>
</blockquote>
  </div>
</div>
<p>In the <a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html">final article</a>
(for real this time, I promise) we‚Äôll see how to use the full OAuth flow
to authenticate to Firefox Accounts and access Firefox Sync, so that we
never have knowledge of the user‚Äôs password, and request only the
permissions that we need instead of full access.</p>
<div class="note">
<p>Check out the other posts in this series!</p>
<ol>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-existing-clients.html">A journey to scripting Firefox Sync / Lockwise: existing clients</a></li>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-figuring-the-protocol.html">A journey to scripting Firefox Sync / Lockwise: figuring the protocol</a></li>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-understanding-browserid.html">A journey to scripting Firefox Sync / Lockwise: understanding BrowserID</a></li>
<li>A journey to scripting Firefox Sync / Lockwise: hybrid OAuth</li>
<li><a href="https://www.codejam.info/2021/08/scripting-firefox-sync-lockwise-complete-oauth.html">A journey to scripting Firefox Sync / Lockwise: complete OAuth</a></li>
</ol>
</div>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1424462810998886416">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå
</section>
]]></content>
  </entry>
</feed>
