<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Intercept a macOS app traffic using mitmproxy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>document.documentElement.classList.add(localStorage.theme || ((matchMedia && matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light'))</script>
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github-20220617.css">
  <link rel="stylesheet" href="/css/main-20250606.css">
  <link rel="icon" href="/favicon.ico" data-emoji="üèïÔ∏è">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="Intercept a macOS app traffic using mitmproxy">
  <meta property="og:description" content="I‚Äôll take as an example for this use case a project of mine that exposes a hidden endpoint of the Spotify app, allowing to see the friend activity feed (what your friends are currently playing).">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
      <li><a href="/now.html">Now</a></li>
      <li class="pull"><button title="Toggle theme" class="change-color-theme">üåù</button></li>
    </ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>Intercept a macOS app traffic using mitmproxy</h1>
<p class="date">July 20, 2021</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>I‚Äôll take as an example for this use case <a href="https://github.com/valeriangalliat/spotify-buddylist">a project of mine</a>
that exposes a hidden endpoint of the Spotify app, allowing to see the
friend activity feed (what your friends are currently playing).</p>
<p>In most cases I‚Äôll try to reverse a web app directly in the browser by
monitoring the HTTP calls in the network tab of the developer tools, but
the Spotify web player doesn‚Äôt support the friend activity feature, it‚Äôs
only available in the desktop app, so this wasn‚Äôt an option here.</p>
<p>In this post, I‚Äôll go through the steps necessary to intercept the
Spotify macOS app traffic using <a href="https://mitmproxy.org/">mitmproxy</a>, but
this could work with other apps as well.</p>
<h2 id="what-s-an-intercepting-proxy" tabindex="-1"><a class="header-anchor" href="#what-s-an-intercepting-proxy"><span>What‚Äôs an intercepting proxy?</span></a></h2>
<p>An intercepting proxy like <a href="https://mitmproxy.org/">mitmproxy</a> uses <a href="https://en.wikipedia.org/wiki/HTTP_tunnel">HTTP tunnelling</a>
to forward (and optionally capture) all the traffic that is sent to it.</p>
<p>Typically, you can configure a specific app, browser, or the whole
system to use a HTTP proxy to forward requests, so that, instead of
connecting directly to the desired hosts, it sends the traffic to the
configured proxy.</p>
<p>This can be useful for a number of reasons, and in our case, it allows
us to configure a proxy that we control, so that we can inspect the HTTP
traffic going through it.</p>
<h2 id="installing-and-running-mitmproxy" tabindex="-1"><a class="header-anchor" href="#installing-and-running-mitmproxy"><span>Installing and running mitmproxy</span></a></h2>
<p>Assuming you use <a href="https://brew.sh/">Homebrew</a>:</p>
<pre><code class="hljs language-sh">brew install mitmproxy
mitmproxy
</code></pre>
<p>This starts a terminal interface that will show all the requests going
through the proxy. Press <kbd>?</kbd> to see the keybindings.</p>
<p>By default the proxy runs on <code>localhost:8080</code>.</p>
<h2 id="first-try-macos-network-proxy-settings" tabindex="-1"><a class="header-anchor" href="#first-try-macos-network-proxy-settings"><span>First try: macOS network proxy settings</span></a></h2>
<p>The first thing I usually try for this is to configure the proxy
settings <a href="https://support.apple.com/en-ca/guide/mac-help/mchlp2591/mac">directly at the system level</a>,
because most apps don‚Äôt allow configuring a proxy in their settings. On
macOS, this will be in ‚ÄúSystem Preferences‚Äù, ‚ÄúNetwork‚Äù, ‚ÄúAdvanced‚Ä¶‚Äù,
‚ÄúProxies‚Äù, ‚ÄúWeb Proxy (HTTP)‚Äù.</p>
<p>But when opening the Spotify app, I only see a single authentication
request going through (interestingly), but definitely not the whole
traffic. It appears that the Spotify app currently ignores the system
proxy settings.</p>
<p>For other apps, especially ones that don‚Äôt allow configuring a proxy
inside the app, this might work.</p>
<h2 id="second-try-spotify-supports-app-level-proxy-settings" tabindex="-1"><a class="header-anchor" href="#second-try-spotify-supports-app-level-proxy-settings"><span>Second try: Spotify supports app-level proxy settings!</span></a></h2>
<p>To my surprise, Spotify allows you to configure a proxy directly inside
the app. Go in ‚ÄúSpotify‚Äù, ‚ÄúPreferences‚Äù, ‚ÄúShow advanced settings‚Äù,
‚ÄúProxy settings‚Äù to configure <code>localhost:8080</code> as a proxy.</p>
<figure class="center">
  <img alt="Spotfiy proxy" src="../../img/2021/07/spotify-proxy.png">
</figure>
<p>But after restarting the app we get an error in the mitmproxy console:</p>
<pre><code class="hljs">Warn: [::1]:65468: Client TLS handshake failed. The client may not trust the proxy&#x27;s certificate for login5.spotify.com (OpenSSL Error([(&#x27;SSL routines&#x27;, &#x27;ssl3_read_bytes&#x27;, &#x27;sslv3 alert certificate unknown&#x27;)]))
</code></pre>
<p>This is because to inspect HTTPS traffic, mitmproxy needs to use its own
SSL certificate, otherwise all we would see would be the encrypted
traffic between the app and Spotify servers.</p>
<h2 id="configuring-the-mitmproxy-ca-certificate" tabindex="-1"><a class="header-anchor" href="#configuring-the-mitmproxy-ca-certificate"><span>Configuring the mitmproxy CA certificate</span></a></h2>
<p>mitmproxy comes with a <abbr title="Certificate authority">CA</abbr>
certificate that trusts the certificate used by mitmproxy to
terminate the SSL connection. By <a href="https://docs.mitmproxy.org/stable/concepts-certificates/">adding this CA certificate</a>
to the <a href="https://support.apple.com/en-ca/guide/keychain-access/kyca2431/mac">system list of trusted certificate</a>,
the app should allow the traffic to go through (unless it does <a href="https://security.stackexchange.com/questions/29988/what-is-certificate-pinning">certificate pinning</a>).</p>
<p>To do this, open the <code>~/.mitmproxy</code> directory which contains the
certificate files, open Keychain Access, and drop
<code>mitmproxy-ca-cert.pem</code> into it.</p>
<p>By default, macOS will not trust that new certificate, so you need to
double-click on it, and in the ‚ÄúTrust‚Äù section, set ‚ÄúAlways Trust‚Äù.</p>
<p>After restarting the Spotify app, you should now see the traffic going
through in mitmproxy.</p>
<figure class="center">
  <img alt="mitmproxy screenshot" src="../../img/2021/07/mitmproxy.png">
</figure>
<div class="note">
<p><strong>Note:</strong> I usually delete the certificate after I‚Äôm done inspecting
requests, just to be safe.</p>
</div>
<h2 id="identifying-the-friend-activity-endpoint" tabindex="-1"><a class="header-anchor" href="#identifying-the-friend-activity-endpoint"><span>Identifying the friend activity endpoint</span></a></h2>
<p>Then it‚Äôs a matter of browsing all the requests in the mitmproxy UI.</p>
<p>Here, it‚Äôll be particularly handy to use the filter function by pressing
<kbd>F</kbd>. This allows us to specify a <a href="https://docs.mitmproxy.org/stable/concepts-filters/">filter pattern</a>.</p>
<p>For example, if I know the URL I‚Äôm looking for contains the string
<code>buddylist</code>, I can type that in the filter prompt, which equals to the
command <code>set view_filter 'buddylist'</code>, so that mitmproxy only shows the
matching calls.</p>
<p>If I didn‚Äôt know this string was part of the URL, but instead wanted to
match on the body, which I know contains the string <code>shaktirockgym</code> (one
of my Spotify friends), I can use <code>~b shaktirockgym</code> as a filter.</p>
<p>Then, most of the work will be about <code>curl</code>ing the endpoints to get
successful responses, identifying what headers are necessary, what
parameters to pass, how to deal with authentication and other security
means the app have in place.</p>
<p>This should be enough to get you started on reversing a macOS app
network requests, to build your own client, scripts or whatnot. Happy
hacking!</p>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Join the discussion on <a href="https://twitter.com/valeriangalliat/status/1417924036789739520">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
  </div>
  <footer>
    <div class="footer-inner">
      <figure>
        <a href="/val.html">
          <img alt="The author (Val) in front of a mountain" src="/img/profile.jpg">
        </a>
      </figure>
      <div class="footer-content">
        <p>
          Made with üß° by <a href="/val.html">Val</a>.
          Generated from a <abbr title="Pull requests welcome!"><a href="https://github.com/valeriangalliat/blog/tree/master/2021/07/intercept-macos-app-traffic-mitmproxy.md">public repository</a></abbr>.
        </p>
        <ul class="social">
          <li>
            <a href="https://twitter.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Twitter</title>
                <use href="/img/icons/407-twitter.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://github.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>GitHub</title>
                <use href="/img/icons/433-github.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.instagram.com/funkyval_/">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Instagram</title>
                <use href="/img/icons/403-instagram.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.youtube.com/@FunkyVal">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>YouTube</title>
                <use href="/img/icons/414-youtube.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://ko-fi.com/funkyval">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Buy me a coffee!</title>
                <use href="/img/icons/219-heart.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="/feed.xml">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>RSS</title>
                <use href="/img/icons/412-rss.svg#icon"></use>
              </svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20230317.js"></script>
</body>
</html>
