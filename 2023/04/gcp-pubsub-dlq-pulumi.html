<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Configuring a GCP Pub/Sub dead letter queue with Pulumi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>document.documentElement.classList.add(localStorage.theme || ((matchMedia && matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light'))</script>
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/github-20220617.css">
  <link rel="stylesheet" href="/css/main-20230317.css">
  <link rel="icon" href="/favicon.ico" data-emoji="üèïÔ∏è">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="CodeJam">
  <meta property="og:title" content="Configuring a GCP Pub/Sub dead letter queue with Pulumi">
  <meta property="og:description" content="I‚Äôve been playing a bit with Pulumi lately, and it quickly became one of my favorite infrastructure as code tools. It feels like the power of AWS CDK which lets you code your infrastructure in a full-fledged scripting language, but without being limited to AWS!">
  <meta property="og:image" content="https://www.codejam.info/img/profile.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@valeriangalliat">
  <meta name="twitter:creator" content="@valeriangalliat">
</head>
<body class="post">
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/val.html">About</a></li>
      <li><a href="/now.html">Now</a></li>
      <li class="pull"><button title="Toggle theme" class="change-color-theme">üåù</button></li>
    </ul>
  </nav>
  <header>
    <div class="header-inner">
      <div class="content">
<h1>Configuring a GCP Pub/Sub dead letter queue with Pulumi</h1>
<p class="date">April 9, 2023</p>
      </div>
    </div>
  </header>
  <div class="content">
<p>I‚Äôve been playing a bit with <a href="https://www.pulumi.com/">Pulumi</a> lately,
and it quickly became one of my favorite infrastructure as code tools.
It feels like the power of <a href="https://aws.amazon.com/cdk/">AWS CDK</a> which
lets you code your infrastructure in a full-fledged scripting language,
but without being limited to AWS!</p>
<p>I like coding my infrastructure in TypeScript because the typing,
autocomplete and IDE integrations makes it particularly nice to discover
the SDK on the fly as you‚Äôre creating your infrastructure, so that‚Äôs
what I‚Äôll use in the examples.</p>
<p>Today, we‚Äôre gonna see how to programmatically create a Pub/Sub topic
and subscription on GCP, with a matching dead letter queue. Finally,
we‚Äôll add a monitoring alert policy to warn us when our
<abbr title="Dead letter queue">DLQ</abbr> is not empty.</p>
<h2 id="getting-started" tabindex="-1"><a class="header-anchor" href="#getting-started"><span>Getting started</span></a></h2>
<p>If you already have Pulumi installed, and an existing project, you can
skip this. In order to install Pulumi on macOS, run:</p>
<pre><code class="hljs language-sh">brew install pulumi
</code></pre>
<p>Create an account on Pulumi if you don‚Äôt have one already, then create a
new directory for your project, and inside it, run:</p>
<pre><code class="hljs language-sh">pulumi new gcp-typescript
</code></pre>
<p>Follow the instructions to initialize your project and connect it to
your GCP account.</p>
<p>Finally, you can remove the default code from <code>index.ts</code> that creates a
test bucket.</p>
<h2 id="creating-a-topic-and-a-subscription" tabindex="-1"><a class="header-anchor" href="#creating-a-topic-and-a-subscription"><span>Creating a topic and a subscription</span></a></h2>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> gcp <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@pulumi/gcp&#x27;</span>

<span class="hljs-keyword">const</span> topic = <span class="hljs-keyword">new</span> gcp.<span class="hljs-property">pubsub</span>.<span class="hljs-title class_">Topic</span>(<span class="hljs-string">&#x27;hello-world-topic&#x27;</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;hello-world&#x27;</span> })

<span class="hljs-keyword">const</span> subscription = <span class="hljs-keyword">new</span> gcp.<span class="hljs-property">pubsub</span>.<span class="hljs-title class_">Subscription</span>(<span class="hljs-string">&#x27;hello-world-subscription&#x27;</span>, {
  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;hello-world&#x27;</span>,
  <span class="hljs-attr">topic</span>: topic.<span class="hljs-property">id</span>
})
</code></pre>
<p>This will create a topic and a basic pull subscription, that you can‚Ä¶
subscribe to using the Google Cloud SDK in your favorite language.</p>
<h2 id="adding-the-dead-letter-queue" tabindex="-1"><a class="header-anchor" href="#adding-the-dead-letter-queue"><span>Adding the dead letter queue</span></a></h2>
<p>On GCP, a dead letter queue consists in configuring an existing
subscription to send messages that failed a number of times to another
topic. Having a subscription on that dead letter topic, even if it has
no consumer, lets us store those messages for a period of time, so we
can eventually do something with them.</p>
<p>Here‚Äôs our DLQ:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">const</span> dlqTopic = <span class="hljs-keyword">new</span> gcp.<span class="hljs-property">pubsub</span>.<span class="hljs-title class_">Topic</span>(<span class="hljs-string">&#x27;hello-world-dl-topic&#x27;</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;helo-world-dl&#x27;</span> })

<span class="hljs-keyword">new</span> gcp.<span class="hljs-property">pubsub</span>.<span class="hljs-title class_">Subscription</span>(<span class="hljs-string">&#x27;hello-world-dl-subscription&#x27;</span>, {
  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;hello-world-dl&#x27;</span>,
  <span class="hljs-attr">topic</span>: dlqTopic.<span class="hljs-property">id</span>
})
</code></pre>
<p>Then we can add the dead letter policy to our existing subscription:</p>
<pre><code class="hljs language-diff:ts"> <span class="hljs-keyword">const</span> subscription = <span class="hljs-keyword">new</span> gcp.<span class="hljs-property">pubsub</span>.<span class="hljs-title class_">Subscription</span>(<span class="hljs-string">&#x27;hello-world-subscription&#x27;</span>, {
   <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;hello-world&#x27;</span>,
   <span class="hljs-attr">topic</span>: topic.<span class="hljs-property">name</span>,
<span class="hljs-addition">+  <span class="hljs-attr">deadLetterPolicy</span>: {</span>
<span class="hljs-addition">+    <span class="hljs-attr">deadLetterTopic</span>: dlqTopic.<span class="hljs-property">id</span>,</span>
<span class="hljs-addition">+    <span class="hljs-attr">maxDeliveryAttempts</span>: <span class="hljs-number">5</span></span>
<span class="hljs-addition">+  }</span>
 })
</code></pre>
<p><code>maxDepliveryAttempts</code> is optional and defaults to 5. When a messaged
failed to be delivered that many times, it‚Äôll be sent to the DLQ.</p>
<p>You may also like to tweak your subscription‚Äôs retry policy at that
point. By default, it retries a failed message immediately, but you can
configure an exponential backoff instead:</p>
<pre><code class="hljs language-diff:ts"> <span class="hljs-keyword">const</span> subscription = <span class="hljs-keyword">new</span> gcp.<span class="hljs-property">pubsub</span>.<span class="hljs-title class_">Subscription</span>(<span class="hljs-string">&#x27;hello-world-subscription&#x27;</span>, {
   <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;hello-world&#x27;</span>,
   <span class="hljs-attr">topic</span>: topic.<span class="hljs-property">id</span>,
<span class="hljs-addition">+  <span class="hljs-attr">retryPolicy</span>: {</span>
<span class="hljs-addition">+    <span class="hljs-attr">minimumBackoff</span>: <span class="hljs-string">&#x27;10s&#x27;</span>,</span>
<span class="hljs-addition">+    <span class="hljs-attr">maximumBackoff</span>: <span class="hljs-string">&#x27;600s&#x27;</span></span>
<span class="hljs-addition">+  },</span>
   <span class="hljs-attr">deadLetterPolicy</span>: {
     <span class="hljs-attr">deadLetterTopic</span>: dlqTopic.<span class="hljs-property">id</span>,
     <span class="hljs-attr">maxDeliveryAttempts</span>: <span class="hljs-number">5</span>
   }
 })
</code></pre>
<p>While you don‚Äôt have precise control over the exponential backoff
behavior, you can tweak the minimum and maximum duration that Pub/Sub
will wait before retrying a message. Anything in between is out of your
control.</p>
<h2 id="handling-permissions" tabindex="-1"><a class="header-anchor" href="#handling-permissions"><span>Handling permissions</span></a></h2>
<p>But we‚Äôre not done yet! If you go to your subscription page, you‚Äôll
notice the following issues warnings:</p>
<figure class="center">
  <img alt="Permission issues with dead letter queue" srcset="../../img/2023/04/pubsub-dlq-warning.png 2x">
</figure>
<blockquote>
<p>‚ùóÔ∏è <strong>Assign Publisher role</strong></p>
<p>The Cloud Pub/Sub service account for this project needs the publisher
role to publish dead-lettered messages to the dead letter topic.</p>
<p>‚ùóÔ∏è <strong>Assign Subscriber role</strong></p>
<p>The Cloud Pub/Sub service account for this project needs the subscriber
role to forward messages from this subscription to the dead letter topic.</p>
</blockquote>
<p>You can identify the Pub/Sub service account in your IAM principals
list, by ticking ‚Äúinclude Google-provided role grants‚Äù. It‚Äôs always
under the form <code>service-{projectId}@gcp-sa-pubsub.iam.gserviceaccount.com</code>.</p>
<p>We can fix that in our Pulumi code by adding the following:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> pulumi <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@pulumi/pulumi&#x27;</span>

<span class="hljs-keyword">const</span> project = gcp.<span class="hljs-property">organizations</span>.<span class="hljs-title function_">getProjectOutput</span>()

<span class="hljs-keyword">const</span> pubSubServiceAccountPublisherPolicy =
  gcp.<span class="hljs-property">organizations</span>.<span class="hljs-title function_">getIAMPolicyOutput</span>({
    <span class="hljs-attr">bindings</span>: [
      {
        <span class="hljs-attr">role</span>: <span class="hljs-string">&#x27;roles/pubsub.publisher&#x27;</span>,
        <span class="hljs-attr">members</span>: [
          pulumi.<span class="hljs-property">interpolate</span><span class="hljs-string">`serviceAccount:service-<span class="hljs-subst">${project.<span class="hljs-built_in">number</span>}</span>@gcp-sa-pubsub.iam.gserviceaccount.com`</span>
        ]
      }
    ]
  })

<span class="hljs-keyword">const</span> pubSubServiceAccountSubscriberPolicy =
  gcp.<span class="hljs-property">organizations</span>.<span class="hljs-title function_">getIAMPolicyOutput</span>({
    <span class="hljs-attr">bindings</span>: [
      {
        <span class="hljs-attr">role</span>: <span class="hljs-string">&#x27;roles/pubsub.subscriber&#x27;</span>,
        <span class="hljs-attr">members</span>: [
          pulumi.<span class="hljs-property">interpolate</span><span class="hljs-string">`serviceAccount:service-<span class="hljs-subst">${project.<span class="hljs-built_in">number</span>}</span>@gcp-sa-pubsub.iam.gserviceaccount.com`</span>
        ]
      }
    ]
  })

<span class="hljs-keyword">new</span> gcp.<span class="hljs-property">pubsub</span>.<span class="hljs-title class_">TopicIAMPolicy</span>(<span class="hljs-string">&#x27;hello-world-dl-topic-policy&#x27;</span>, {
  <span class="hljs-attr">topic</span>: dlqTopic.<span class="hljs-property">name</span>,
  <span class="hljs-attr">policyData</span>: pubSubServiceAccountPublisherPolicy.<span class="hljs-property">policyData</span>
})

<span class="hljs-keyword">new</span> gcp.<span class="hljs-property">pubsub</span>.<span class="hljs-title class_">SubscriptionIAMPolicy</span>(<span class="hljs-string">&#x27;hello-world-subscription-policy&#x27;</span>, {
  <span class="hljs-attr">subscription</span>: subscription.<span class="hljs-property">name</span>,
  <span class="hljs-attr">policyData</span>: pubSubServiceAccountSubscriberPolicy.<span class="hljs-property">policyData</span>
})
</code></pre>
<p>Now our Pub/Sub DLQ page should be all green!</p>
<h2 id="getting-alerted-for-new-messages-in-the-dlq" tabindex="-1"><a class="header-anchor" href="#getting-alerted-for-new-messages-in-the-dlq"><span>Getting alerted for new messages in the DLQ</span></a></h2>
<p>The first thing you usually do when you create a DLQ is add a mechanism
to <em>know</em> when messages hit the DLQ, so that you can act on them.</p>
<p>When it comes to alert policies, I typically create them in the GCP
console, then I use the ‚Äúdownload as JSON‚Äù button in the policy details.
I can use this verbatim inside Pulumi‚Äôs <code>gcp.monitoring.AlertPolicy</code>
constructor!</p>
<p>Here‚Äôs what I‚Äôve got when I made an alert policy to get notified when
any of my subscriptions whose name ends with <code>-dl</code> has undelivered
messages.</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">const</span> notificationChannels = [
  <span class="hljs-string">&#x27;projects/{projectId}/notificationChannels/{channelId}&#x27;</span>
]

<span class="hljs-keyword">new</span> gcp.<span class="hljs-property">monitoring</span>.<span class="hljs-title class_">AlertPolicy</span>(<span class="hljs-string">&#x27;alert-policy-pubsub-dl&#x27;</span>, {
  <span class="hljs-attr">alertStrategy</span>: {
    <span class="hljs-attr">autoClose</span>: <span class="hljs-string">&#x27;604800s&#x27;</span>
  },
  <span class="hljs-attr">combiner</span>: <span class="hljs-string">&#x27;OR&#x27;</span>,
  <span class="hljs-attr">conditions</span>: [
    {
      <span class="hljs-attr">conditionThreshold</span>: {
        <span class="hljs-attr">aggregations</span>: [
          {
            <span class="hljs-attr">alignmentPeriod</span>: <span class="hljs-string">&#x27;300s&#x27;</span>,
            <span class="hljs-attr">perSeriesAligner</span>: <span class="hljs-string">&#x27;ALIGN_MEAN&#x27;</span>
          }
        ],
        <span class="hljs-attr">comparison</span>: <span class="hljs-string">&#x27;COMPARISON_GT&#x27;</span>,
        <span class="hljs-attr">duration</span>: <span class="hljs-string">&#x27;0s&#x27;</span>,
        <span class="hljs-attr">filter</span>: <span class="hljs-string">`
              resource.type = &quot;pubsub_subscription&quot;
          AND metric.type = &quot;pubsub.googleapis.com/subscription/num_undelivered_messages&quot;
          AND resource.labels.subscription_id = ends_with(&quot;-dl&quot;)
        `</span>,
        <span class="hljs-attr">thresholdValue</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">trigger</span>: {
          <span class="hljs-attr">count</span>: <span class="hljs-number">1</span>
        }
      },
      <span class="hljs-attr">displayName</span>: <span class="hljs-string">&#x27;Cloud Pub/Sub Subscription - Unacked messages&#x27;</span>
    }
  ],
  notificationChannels,
  <span class="hljs-attr">displayName</span>: <span class="hljs-string">&#x27;Pub/Sub messages in dead letter&#x27;</span>
})
</code></pre>
<p>Just put the ID of your notification channel in the array on top. To
find it, you can use the following command that will list all your
notification channels including their full ID:</p>
<pre><code class="hljs language-sh">gcloud alpha monitoring channels list
</code></pre>
<section class="post-footer">
  <h3>Want to leave a comment?</h3>
  <p>
    Start a conversation on <a href="https://twitter.com/valeriangalliat">Twitter</a> or send me an <a href="mailto:val@codejam.info">email</a>! üíå<br>
    This post helped you? <a href="https://ko-fi.com/funkyval">Buy me a coffee</a>! üçª
  </p>
</section>
  </div>
  <footer>
    <div class="footer-inner">
      <figure>
        <a href="/val.html">
          <img alt="The author (Val) in front of a mountain" src="/img/profile.jpg">
        </a>
      </figure>
      <div class="footer-content">
        <p>
          Made with üß° by <a href="/val.html">Val</a>.
          Generated from a <abbr title="Pull requests welcome!"><a href="https://github.com/valeriangalliat/blog/tree/master/2023/04/gcp-pubsub-dlq-pulumi.md">public repository</a></abbr>.
        </p>
        <ul class="social">
          <li>
            <a href="https://twitter.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Twitter</title>
                <use href="/img/icons/407-twitter.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://github.com/valeriangalliat">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>GitHub</title>
                <use href="/img/icons/433-github.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.instagram.com/funkyval_/">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Instagram</title>
                <use href="/img/icons/403-instagram.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://www.youtube.com/@FunkyVal">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>YouTube</title>
                <use href="/img/icons/414-youtube.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="https://ko-fi.com/funkyval">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>Buy me a coffee!</title>
                <use href="/img/icons/219-heart.svg#icon"></use>
              </svg>
            </a>
          </li>
          <li>
            <a href="/feed.xml">
              <svg width="16" height="16" viewBox="0 0 16 16">
                <title>RSS</title>
                <use href="/img/icons/412-rss.svg#icon"></use>
              </svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </footer>
  <script src="/js/emojicon.js"></script>
  <script src="/js/main-20230317.js"></script>
</body>
</html>
